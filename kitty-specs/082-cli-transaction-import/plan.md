# Implementation Plan: CLI Transaction Import Commands

**Branch**: `082-cli-transaction-import` | **Date**: 2026-01-28 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/kitty-specs/082-cli-transaction-import/spec.md`

## Summary

Add CLI commands to wrap existing `transaction_import_service.py` methods, enabling mobile AI workflows to import purchase transactions and inventory adjustments via command line. This is a thin CLI wrapper layer - no new business logic required.

**Key Implementation**:
- 3 new CLI commands: `import-purchases`, `import-adjustments`, `validate-import`
- Wrap existing `transaction_import_service.import_purchases()` and `import_adjustments()`
- Add `--dry-run`, `--json`, and `--resolve-mode` flags following catalog-import pattern
- ImportResult already has to_dict() style methods for JSON serialization

## Technical Context

**Language/Version**: Python 3.10+
**Primary Dependencies**: argparse (existing CLI), transaction_import_service.py (existing)
**Storage**: SQLite via SQLAlchemy (no changes)
**Testing**: pytest (existing test patterns)
**Target Platform**: Desktop CLI (existing import_export_cli.py)
**Project Type**: Single project - CLI enhancement
**Performance Goals**: N/A (batch import, not real-time)
**Constraints**: Must reuse existing service layer (no duplicate logic)
**Scale/Scope**: 3 new CLI commands, ~200-300 lines of wrapper code

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

✅ **Service Layer Reuse**: CLI wraps existing services, no duplicate business logic
✅ **CLI/UI Parity**: Adds CLI access to existing UI-only functionality
✅ **Pattern Consistency**: Follows existing catalog-import CLI pattern exactly
✅ **No Unnecessary Complexity**: Thin wrappers only, no new abstractions

## Project Structure

### Documentation (this feature)

```
kitty-specs/082-cli-transaction-import/
├── plan.md              # This file
├── spec.md              # Feature specification
├── checklists/
│   └── requirements.md  # Quality checklist
└── tasks/               # Work packages (generated by /spec-kitty.tasks)
```

### Source Code (repository root)

```
src/
├── utils/
│   └── import_export_cli.py    # ADD: import-purchases, import-adjustments, validate-import commands
├── services/
│   └── transaction_import_service.py  # EXISTING: import_purchases(), import_adjustments()
│   └── import_export_service.py       # EXISTING: ImportResult class
└── tests/
    └── services/
        └── test_transaction_import_cli.py  # NEW: CLI command tests
```

**Structure Decision**: Single project - add commands to existing CLI file, add tests to existing test directory.

## Key Implementation Decisions

### 1. CLI Command Pattern (Copy catalog-import)

```python
# Parser setup
import_purchases_parser = subparsers.add_parser(
    "import-purchases", help="Import purchase transactions from JSON"
)
import_purchases_parser.add_argument("input_file", help="JSON file path")
import_purchases_parser.add_argument("-d", "--dry-run", action="store_true")
import_purchases_parser.add_argument("--json", action="store_true")
import_purchases_parser.add_argument(
    "--resolve-mode", choices=["interactive", "auto", "strict"], default="interactive"
)
```

### 2. JSON Output Format

```python
def result_to_json(result: ImportResult) -> dict:
    return {
        "success": result.failed == 0,
        "imported": result.successful,
        "skipped": result.skipped,
        "errors": result.errors,
        "warnings": result.warnings,
        "entity_counts": result.entity_counts
    }
```

### 3. FK Resolution Modes

The existing `transaction_import_service` already handles FK resolution internally. The `--resolve-mode` flag will control behavior:
- `interactive`: Existing behavior (prompt on conflict) - DEFAULT
- `auto`: Use best-match without prompting
- `strict`: Fail on any unresolved FK

**Note**: The existing service may need minor extension to support these modes. Research phase will confirm.

## Dependencies

| Dependency | Status | Notes |
|------------|--------|-------|
| `transaction_import_service.import_purchases()` | ✅ Exists | Lines 363-407, supports dry_run |
| `transaction_import_service.import_adjustments()` | ✅ Exists | Lines 614-661, supports dry_run |
| `ImportResult` class | ✅ Exists | Lines 73-228, has errors/warnings structure |
| `import_export_cli.py` | ✅ Exists | CLI infrastructure ready |

## Risks

| Risk | Mitigation |
|------|------------|
| FK resolution modes may need service changes | Research existing resolver; may need WP for service extension |
| JSON output format not standardized | Define format in spec, document clearly |
| Dry-run already implemented in services | Confirmed - services already support dry_run=True |

## Complexity Tracking

No constitution violations - this is a simple CLI wrapper feature.
