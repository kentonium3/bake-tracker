# Work Packages: CLI Import/Export Parity

**Inputs**: Design documents from `/kitty-specs/054-cli-import-export-parity/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md

**Tests**: No explicit testing requested by stakeholders.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`. Treat this file as the high-level checklist; keep deep implementation detail inside the prompt files.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Backup/Restore Commands (Priority: P1) MVP

**Goal**: Implement 4 backup/restore commands wrapping `coordinated_export_service` for 16-entity coordinated backup operations.
**Independent Test**: Run `backup` command and verify 16 entity JSON files + manifest.json created. Run `restore` on output and verify import succeeds.
**Prompt**: `tasks/WP01-backup-restore-commands.md`

### Included Subtasks
- [x] T001 Add `backup` subparser with `-o OUTPUT_DIR` and `--zip` arguments
- [x] T002 Implement `backup_cmd()` function calling `export_complete()`
- [x] T003 [P] Add `restore` subparser with `BACKUP_DIR`, `--mode`, and `--interactive` arguments
- [x] T004 [P] Implement `restore_cmd()` function calling `import_complete()`
- [x] T005 [P] Add `backup-list` subparser with `--dir BACKUPS_DIR` argument
- [x] T006 [P] Implement `backup_list_cmd()` scanning directories for manifest.json
- [x] T007 [P] Add `backup-validate` subparser with `BACKUP_DIR` positional arg
- [x] T008 [P] Implement `backup_validate_cmd()` wrapping existing `validate_export()`
- [x] T009 Wire all 4 commands in `main()` dispatch logic

### Implementation Notes
- Follow existing `export_complete_cmd()` pattern at line 194
- `backup` is alias for friendlier UX; internally calls same `export_complete()` service
- `restore` wraps `import_complete()` with mode and interactive options
- `backup-list` scans directory for subdirs containing `manifest.json`, displays metadata
- `backup-validate` reuses existing `validate_export_cmd()` logic

### Parallel Opportunities
- T003-T008 can proceed in parallel after T001-T002 establish the pattern

### Dependencies
- None (starting package)

### Risks & Mitigations
- Service function `import_complete()` may not exist in coordinated_export_service -> Verify during implementation; may need catalog_import_service instead

---

## Work Package WP02: Context-Rich Aug Commands (Priority: P1)

**Goal**: Implement 3 context-rich "aug" commands for AI-workflow exports/imports using `denormalized_export_service` and `enhanced_import_service`.
**Independent Test**: Run `aug-export -t products`, verify `aug_products.json` created with `aug_` prefix. Run `aug-import` on file.
**Prompt**: `tasks/WP02-context-rich-aug-commands.md`

### Included Subtasks
- [x] T010 Add `aug-export` subparser with `-t TYPE` and `-o OUTPUT` arguments
- [x] T011 Implement `aug_export_cmd()` dispatching to correct `export_*_context_rich()` function
- [x] T012 Add type mapping for 7 entity types + `all` convenience option
- [x] T013 [P] Add `aug-import` subparser with positional `INPUT_FILE`, `--interactive`, `--skip-on-error`
- [x] T014 [P] Implement `aug_import_cmd()` calling `import_context_rich_export()`
- [x] T015 [P] Integrate CLIFKResolver for `--interactive` mode
- [x] T016 [P] Add `aug-validate` subparser with `INPUT_FILE` positional arg
- [x] T017 [P] Implement `aug_validate_cmd()` using `detect_format()` for validation
- [x] T018 Wire all 3 commands in `main()` dispatch logic

### Implementation Notes
- Entity types: ingredients, products, recipes, materials, material-products, finished-units, finished-goods, all
- Use existing CLIFKResolver class (lines 344-537) for interactive mode
- `aug-export -t all` calls `export_all_context_rich()` convenience function
- Output files use `aug_` prefix per F053

### Parallel Opportunities
- T013-T17 can proceed in parallel after T010-T12 establish the export pattern

### Dependencies
- None (can run in parallel with WP01)

### Risks & Mitigations
- Context-rich export functions may use different signature -> Verify in denormalized_export_service

---

## Work Package WP03: Catalog Commands (Priority: P2)

**Goal**: Implement 3 catalog import/export commands for selective entity operations using `catalog_import_service`.
**Independent Test**: Run `catalog-export --entities ingredients,products`, verify 2 JSON files created. Run `catalog-import --mode augment` on output.
**Prompt**: `tasks/WP03-catalog-commands.md`

### Included Subtasks
- [x] T019 Add `catalog-export` subparser with `-o OUTPUT_DIR` and `--entities` arguments
- [x] T020 Implement `catalog_export_cmd()` aggregating individual entity exports
- [x] T021 Define catalog entity type list: ingredients, products, recipes, finished-goods, materials, material-products, suppliers
- [x] T022 [P] Add `catalog-import` subparser with `INPUT_DIR`, `--mode`, `--interactive`, `--dry-run`
- [x] T023 [P] Implement `catalog_import_cmd()` calling `import_catalog()`
- [x] T024 [P] Add `catalog-validate` subparser with `INPUT_DIR` positional arg
- [x] T025 [P] Implement `catalog_validate_cmd()` for schema validation
- [x] T026 Wire all 3 commands in `main()` dispatch logic

### Implementation Notes
- Catalog entity types differ from backup (7 vs 16) - focus on catalog-specific entities
- `catalog-export` aggregates existing entity export functions, not a single service call
- `catalog-import` wraps `import_catalog()` from catalog_import_service
- Default exports all 7 entity types when `--entities` not specified

### Parallel Opportunities
- T022-T25 can proceed in parallel after T019-T21 establish the export pattern

### Dependencies
- Depends on WP01 or WP02 establishing command patterns

### Risks & Mitigations
- No existing `catalog-export` service function -> Must aggregate individual exports

---

## Work Package WP04: Entity-Specific Export Commands (Priority: P2-P3)

**Goal**: Add 6 new entity-specific export commands for materials, suppliers, and purchases following existing `export-ingredients` pattern.
**Independent Test**: Run each new `export-*` command and verify JSON output matches UI export format.
**Prompt**: `tasks/WP04-entity-specific-exports.md`

### Included Subtasks
- [x] T027 [P] Add `export-materials` subparser and handler function
- [x] T028 [P] Add `export-material-products` subparser and handler function
- [x] T029 [P] Add `export-material-categories` subparser and handler function
- [x] T030 [P] Add `export-material-subcategories` subparser and handler function
- [x] T031 [P] Add `export-suppliers` subparser and handler function
- [x] T032 [P] Add `export-purchases` subparser and handler function
- [x] T033 Import required service functions from `import_export_service`
- [x] T034 Wire all 6 commands in `main()` dispatch logic

### Implementation Notes
- Follow exact pattern from existing `export_ingredients()` at line 81
- Each command: subparser with `file` positional arg, handler calling `export_*_to_json()`
- Service functions exist in `import_export_service.py` (verify)

### Parallel Opportunities
- All T027-T32 can proceed in parallel - independent file/entity

### Dependencies
- None (can run in parallel with other packages)

### Risks & Mitigations
- Export functions may not exist for all entities -> Verify in import_export_service

---

## Work Package WP05: Documentation Update (Priority: P3)

**Goal**: Update module docstring and help text for all new commands. Document AI workflow patterns.
**Independent Test**: Run `python -m src.utils.import_export_cli --help` and verify all commands listed. Run each command with `--help`.
**Prompt**: `tasks/WP05-documentation-update.md`

### Included Subtasks
- [x] T035 Update module-level docstring with new command reference
- [x] T036 Add usage examples for backup/restore workflow
- [x] T037 [P] Add usage examples for aug export -> modify -> aug import workflow
- [x] T038 [P] Add usage examples for catalog operations
- [x] T039 [P] Verify all commands have accurate `help=` strings in subparsers
- [x] T040 Update CLI epilog with comprehensive examples

### Implementation Notes
- Follow existing docstring format at top of module (lines 1-43)
- Include examples for primary AI workflow: aug-export -> external modification -> aug-import
- Document mobile JSON ingestion pattern

### Parallel Opportunities
- T037-T39 can proceed in parallel

### Dependencies
- Depends on WP01-WP04 completion (commands must exist before documenting)

### Risks & Mitigations
- None significant

---

## Dependency & Execution Summary

- **Sequence**: WP01 and WP02 can run in parallel (both P1). WP03 and WP04 can run in parallel after patterns established. WP05 last.
- **Parallelization**: WP01 || WP02 -> WP03 || WP04 -> WP05
- **MVP Scope**: WP01 (Backup/Restore) delivers critical data protection capability. WP02 (Aug Commands) enables AI workflows.

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Add backup subparser | WP01 | P1 | No |
| T002 | Implement backup_cmd | WP01 | P1 | No |
| T003 | Add restore subparser | WP01 | P1 | Yes |
| T004 | Implement restore_cmd | WP01 | P1 | Yes |
| T005 | Add backup-list subparser | WP01 | P1 | Yes |
| T006 | Implement backup_list_cmd | WP01 | P1 | Yes |
| T007 | Add backup-validate subparser | WP01 | P1 | Yes |
| T008 | Implement backup_validate_cmd | WP01 | P1 | Yes |
| T009 | Wire backup commands in main() | WP01 | P1 | No |
| T010 | Add aug-export subparser | WP02 | P1 | No |
| T011 | Implement aug_export_cmd | WP02 | P1 | No |
| T012 | Add entity type mapping | WP02 | P1 | No |
| T013 | Add aug-import subparser | WP02 | P1 | Yes |
| T014 | Implement aug_import_cmd | WP02 | P1 | Yes |
| T015 | Integrate CLIFKResolver | WP02 | P1 | Yes |
| T016 | Add aug-validate subparser | WP02 | P1 | Yes |
| T017 | Implement aug_validate_cmd | WP02 | P1 | Yes |
| T018 | Wire aug commands in main() | WP02 | P1 | No |
| T019 | Add catalog-export subparser | WP03 | P2 | No |
| T020 | Implement catalog_export_cmd | WP03 | P2 | No |
| T021 | Define catalog entity types | WP03 | P2 | No |
| T022 | Add catalog-import subparser | WP03 | P2 | Yes |
| T023 | Implement catalog_import_cmd | WP03 | P2 | Yes |
| T024 | Add catalog-validate subparser | WP03 | P2 | Yes |
| T025 | Implement catalog_validate_cmd | WP03 | P2 | Yes |
| T026 | Wire catalog commands in main() | WP03 | P2 | No |
| T027 | Add export-materials command | WP04 | P2 | Yes |
| T028 | Add export-material-products command | WP04 | P2 | Yes |
| T029 | Add export-material-categories command | WP04 | P2 | Yes |
| T030 | Add export-material-subcategories command | WP04 | P2 | Yes |
| T031 | Add export-suppliers command | WP04 | P3 | Yes |
| T032 | Add export-purchases command | WP04 | P3 | Yes |
| T033 | Import required service functions | WP04 | P2 | No |
| T034 | Wire entity export commands in main() | WP04 | P2 | No |
| T035 | Update module docstring | WP05 | P3 | No |
| T036 | Add backup/restore examples | WP05 | P3 | No |
| T037 | Add aug workflow examples | WP05 | P3 | Yes |
| T038 | Add catalog operation examples | WP05 | P3 | Yes |
| T039 | Verify help strings | WP05 | P3 | Yes |
| T040 | Update CLI epilog | WP05 | P3 | No |
