# Work Packages: Architecture Hardening - Service Boundaries & Session Management

**Inputs**: Design documents from `/kitty-specs/060-architecture-hardening-service-boundaries/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: Each WP includes test requirements for session atomicity and feature validation.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

**Parallelization Strategy**: Per user request, Codex can be used for parallel execution of WP04-07 after WP01 completes. WP02 and WP03 are sequential (critical path).

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- **[C]** indicates Codex-suitable for parallel agent execution.

---

## Work Package WP01: Session Ownership Foundation (Priority: P0)

**Goal**: Establish the session parameter pattern contract and test infrastructure to validate atomicity.
**Independent Test**: Transaction rollback tests pass; pattern documented and auditable.
**Prompt**: `tasks/WP01-session-ownership-foundation.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [x] T001 Create `test_session_atomicity.py` with rollback verification tests
- [x] T002 Add session ownership pattern documentation to `docs/design/`
- [x] T003 Audit existing services for pattern compliance (batch_production, assembly, recipe, ingredient, inventory_item)
- [x] T004 [P] Create `session_helper.py` utility module with nullcontext pattern (optional)

### Implementation Notes
- The gold standard pattern is in `batch_production_service.py` lines 279-281
- Use `nullcontext(session) if session is not None else session_scope()`
- Test must verify that nested calls with shared session roll back atomically

### Parallel Opportunities
- T004 (helper module) can proceed in parallel with T001-T003

### Dependencies
- None (foundational)

### Risks & Mitigations
- Risk: Test infrastructure too coupled to specific services
- Mitigation: Use generic multi-service test fixtures

---

## Work Package WP02: Event Service Session Normalization (Priority: P0)

**Goal**: Add optional session parameter to event service helpers so planning services can include event reads in their transactions.
**Independent Test**: Event service methods work both with and without session parameter.
**Prompt**: `tasks/WP02-event-service-normalization.md`
**Estimated Size**: ~320 lines

### Included Subtasks
- [x] T005 Add `session=None` to `get_production_progress()` (line 1927)
- [x] T006 [P] Add `session=None` to `get_assembly_progress()` (line 2005)
- [x] T007 [P] Add `session=None` to `get_shopping_list()` (line 946)
- [x] T008 Update event_service tests for session pass-through
- [x] T009 Verify backward compatibility (no session still works)

### Implementation Notes
- Follow the if/else session pattern from existing services
- Each method should: use provided session if given, open own session_scope if not
- Do NOT commit when session is provided

### Parallel Opportunities
- T005, T006, T007 can all proceed in parallel (different methods)

### Dependencies
- Depends on WP01 (pattern established)

### Risks & Mitigations
- Risk: Breaking existing callers
- Mitigation: session=None default ensures backward compatibility

---

## Work Package WP03: Planning Orchestration Session Discipline (Priority: P1)

**Goal**: Thread session through planning services and remove internal commits.
**Independent Test**: Planning operations see uncommitted changes from same transaction; shopping list doesn't auto-commit.
**Prompt**: `tasks/WP03-planning-orchestration.md`
**Estimated Size**: ~420 lines

### Included Subtasks
- [x] T010 Update `progress.py` to pass session to event service calls (lines 98, 154)
- [x] T011 Remove `session.commit()` from `shopping_list.py` (lines 223, 266)
- [x] T012 Update `feasibility.py` to return cost/assignment blockers distinctly
- [x] T013 Implement `available_to_assemble` via feasibility service
- [x] T014 Update planning orchestration tests
- [ ] T015 Verify shopping list backward compatibility

### Implementation Notes
- progress.py line 98 calls `event_service.get_production_progress(event_id)` - add session param
- progress.py line 154 calls `event_service.get_assembly_progress(event_id)` - add session param
- shopping_list.py lines 223, 266 have `session.commit()` - REMOVE these
- feasibility.py should return `{"inventory_blockers": [...], "cost_blockers": [...], "assignment_blockers": [...]}`

### Parallel Opportunities
- T010, T011, T012 can proceed in parallel (different files)
- T013 depends on T012 (feasibility changes)

### Dependencies
- Depends on WP02 (event service accepts session)

### Risks & Mitigations
- Risk: Removing commits breaks standalone shopping list usage
- Mitigation: T015 specifically tests backward compatibility

---

## Work Package WP04: Planning Snapshot Aggregated Ingredients (Priority: P1) [C]

**Goal**: Complete the TODO at line 293 of planning_service.py to populate aggregated ingredients.
**Independent Test**: Planning snapshot contains complete ingredient aggregation with costs.
**Prompt**: `tasks/WP04-planning-snapshot-ingredients.md`
**Estimated Size**: ~380 lines
**Codex Parallelizable**: YES - after WP01 completes

### Included Subtasks
- [ ] T016 Implement aggregated ingredient calculation in `planning_service.py`
- [ ] T017 Include slug, display_name, quantity, unit, cost_per_unit fields
- [ ] T018 Ensure yield ratios respected from recipe service
- [ ] T019 Snapshot cost at plan calculation time
- [ ] T020 Add tests for snapshot completeness
- [ ] T021 [P] Update export/import for aggregated ingredients

### Implementation Notes
- Use `get_aggregated_ingredients()` from recipe_service (already has session param)
- Calculate total quantity needed across all recipes in plan
- Snapshot cost_per_unit at calculation time (don't use live lookup later)
- Structure: `{"ingredient_slug": str, "display_name": str, "quantity": float, "unit": str, "cost_per_unit": float}`

### Parallel Opportunities
- T021 (export/import) can proceed once T016-T19 are complete

### Dependencies
- Depends on WP01 (session pattern for recipe service calls)

### Risks & Mitigations
- Risk: Incorrect yield ratio calculations
- Mitigation: TDD with known recipe/yield scenarios

---

## Work Package WP05: Staleness Detection Enhancements (Priority: P1) [C]

**Goal**: Add missing mutation detection for Composition updates and FinishedUnit yield changes.
**Independent Test**: Plan marked stale when Composition or FinishedUnit yield changes.
**Prompt**: `tasks/WP05-staleness-detection.md`
**Estimated Size**: ~400 lines
**Codex Parallelizable**: YES - after WP01 completes

### Included Subtasks
- [ ] T022 Add `updated_at` to Composition model (line 99 of composition.py)
- [ ] T023 Add `_get_latest_composition_updated_timestamp()` helper in planning_service.py
- [ ] T024 Add `_get_latest_finished_unit_timestamp()` helper in planning_service.py
- [ ] T025 Update `_check_staleness_impl()` to call new helpers
- [ ] T026 Add tests for each mutation type
- [ ] T027 Document schema change for export/reset/import

### Implementation Notes
- Composition model change: `updated_at = Column(DateTime, nullable=False, default=utc_now, onupdate=utc_now)`
- Schema change requires export/reset/import cycle per constitution
- FinishedUnit already has updated_at - just need to check it in staleness logic
- Follow pattern of existing staleness checks (lines 515-555 of planning_service.py)

### Parallel Opportunities
- T022 (model change) must be first
- T023, T024 can proceed in parallel after T022
- T25, T26 depend on T23, T24

### Dependencies
- Depends on WP01

### Risks & Mitigations
- Risk: Schema change breaks existing data
- Mitigation: Export full database before change; test import

---

## Work Package WP06: Assembly Nested FG Ledger (Priority: P1) [C]

**Goal**: Create consumption records for nested FinishedGood consumption in assembly.
**Independent Test**: Assembly with nested FG creates consumption record with cost snapshot.
**Prompt**: `tasks/WP06-assembly-nested-fg-ledger.md`
**Estimated Size**: ~360 lines
**Codex Parallelizable**: YES - after WP01 completes

### Included Subtasks
- [ ] T028 Identify nested FG consumption points in `assembly_service.py`
- [ ] T029 Create consumption records with cost snapshot at consumption time
- [ ] T030 Include lot tracking for nested finished goods
- [ ] T031 Update export to include nested consumption records
- [ ] T032 Add tests for ledger completeness

### Implementation Notes
- Follow pattern from packaging consumption (lines 456-464 of assembly_service.py)
- Use existing `AssemblyFinishedUnitConsumption` or create similar model
- Snapshot `total_cost` at consumption time (from inventory calculation)
- Include optional `lot_id` for traceability

### Parallel Opportunities
- T028, T029, T030 are sequential (same file, same logic flow)
- T031 (export) can start once T29 is complete

### Dependencies
- Depends on WP01 (follows assembly_service pattern)

### Risks & Mitigations
- Risk: Cost snapshot timing incorrect
- Mitigation: Follow existing packaging consumption pattern exactly

---

## Work Package WP07: Deprecate Production Service (Priority: P2) [C]

**Goal**: Remove old production service method and migrate all callers.
**Independent Test**: No references to `production_service.record_production` remain in codebase.
**Prompt**: `tasks/WP07-deprecate-production-service.md`
**Estimated Size**: ~280 lines
**Codex Parallelizable**: YES - after WP01 completes

### Included Subtasks
- [ ] T033 Delete deprecated `production_tab.py` file
- [ ] T034 Remove `record_production()` from `production_service.py`
- [ ] T035 Migrate tests to use `batch_production_service`
- [ ] T036 Remove unused imports referencing old service
- [ ] T037 Verify no remaining references in codebase

### Implementation Notes
- production_tab.py is already marked DEPRECATED (lines 1-15)
- Only 1 active caller (production_tab.py line 337) - file is being deleted
- test_production_service.py has 14+ references - migrate to batch_production_service tests
- Use `grep -r "production_service.record_production"` to find all references

### Parallel Opportunities
- T033, T034, T36 can proceed in parallel (different files)
- T035 is the main work (test migration)
- T037 is final verification

### Dependencies
- Depends on WP01

### Risks & Mitigations
- Risk: Missing hidden callers
- Mitigation: T037 does comprehensive codebase search

---

## Dependency & Execution Summary

### Critical Path (Sequential)
```
WP01 → WP02 → WP03
```

### Parallel Tracks (After WP01)
```
WP01 ─┬─► WP02 → WP03
      │
      ├─► WP04 [Codex]
      │
      ├─► WP05 [Codex]
      │
      ├─► WP06 [Codex]
      │
      └─► WP07 [Codex]
```

### Codex Parallelization Opportunities

Once WP01 completes, these work packages can be assigned to Codex agents in parallel:
- **WP04**: Planning Snapshot Aggregated Ingredients
- **WP05**: Staleness Detection Enhancements
- **WP06**: Assembly Nested FG Ledger
- **WP07**: Deprecate Production Service

**Safe because**: Each touches different files with no overlap:
- WP04: planning_service.py (aggregation), import_export_service.py
- WP05: composition.py (model), planning_service.py (staleness)
- WP06: assembly_service.py, import_export_service.py (different section)
- WP07: production_service.py, production_tab.py, tests

**Note**: WP04 and WP05 both touch planning_service.py but different sections (aggregation vs staleness). Coordinate or merge if conflicts arise.

### MVP Scope
WP01 + WP02 + WP03 form the MVP for session ownership discipline. These must complete before other WPs can be validated in integration.

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? | Codex? |
|------------|---------|--------------|----------|-----------|--------|
| T001 | Create test_session_atomicity.py | WP01 | P0 | No | No |
| T002 | Add session pattern docs | WP01 | P0 | No | No |
| T003 | Audit existing services | WP01 | P0 | No | No |
| T004 | Create session_helper module | WP01 | P0 | Yes | No |
| T005 | Session param get_production_progress | WP02 | P0 | No | No |
| T006 | Session param get_assembly_progress | WP02 | P0 | Yes | No |
| T007 | Session param get_shopping_list | WP02 | P0 | Yes | No |
| T008 | Event service tests | WP02 | P0 | No | No |
| T009 | Backward compatibility verification | WP02 | P0 | No | No |
| T010 | Update progress.py session passing | WP03 | P1 | No | No |
| T011 | Remove shopping_list commits | WP03 | P1 | Yes | No |
| T012 | Feasibility cost/assignment blockers | WP03 | P1 | Yes | No |
| T013 | Implement available_to_assemble | WP03 | P1 | No | No |
| T014 | Planning orchestration tests | WP03 | P1 | No | No |
| T015 | Shopping list backward compat | WP03 | P1 | No | No |
| T016 | Aggregated ingredient calculation | WP04 | P1 | No | Yes |
| T017 | Include required fields | WP04 | P1 | No | Yes |
| T018 | Respect yield ratios | WP04 | P1 | No | Yes |
| T019 | Snapshot cost at calculation time | WP04 | P1 | No | Yes |
| T020 | Tests for snapshot completeness | WP04 | P1 | No | Yes |
| T021 | Update export/import | WP04 | P1 | Yes | Yes |
| T022 | Add Composition.updated_at | WP05 | P1 | No | Yes |
| T023 | Composition timestamp helper | WP05 | P1 | Yes | Yes |
| T024 | FinishedUnit timestamp helper | WP05 | P1 | Yes | Yes |
| T025 | Update staleness check impl | WP05 | P1 | No | Yes |
| T026 | Tests for mutation types | WP05 | P1 | No | Yes |
| T027 | Document schema change | WP05 | P1 | No | Yes |
| T028 | Identify nested FG consumption | WP06 | P1 | No | Yes |
| T029 | Create consumption records | WP06 | P1 | No | Yes |
| T030 | Include lot tracking | WP06 | P1 | No | Yes |
| T031 | Update export for nested records | WP06 | P1 | Yes | Yes |
| T032 | Tests for ledger completeness | WP06 | P1 | No | Yes |
| T033 | Delete production_tab.py | WP07 | P2 | Yes | Yes |
| T034 | Remove record_production method | WP07 | P2 | Yes | Yes |
| T035 | Migrate tests to batch_production | WP07 | P2 | No | Yes |
| T036 | Remove unused imports | WP07 | P2 | Yes | Yes |
| T037 | Verify no remaining references | WP07 | P2 | No | Yes |

---

**Total**: 37 subtasks across 7 work packages
**Average**: 5.3 subtasks per WP (ideal range: 3-7)
**Estimated prompt sizes**: 280-420 lines per WP (within ideal range)
