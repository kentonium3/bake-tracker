# Work Packages: Purchases Tab with CRUD Operations

**Inputs**: Design documents from `/kitty-specs/043-purchases-tab-crud-operations/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, quickstart.md

**Tests**: Unit tests required for service layer (>70% coverage target per constitution).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`. Lane status is stored in YAML frontmatter (`lane: planned|doing|for_review|done`).

**Agent Assignment**:
- **Claude (Lead)**: WP01, WP02, WP03, WP05, WP07
- **Gemini (Parallel)**: WP04, WP06

---

## Work Package WP01: Service Layer Extensions (Priority: P0)

**Goal**: Extend PurchaseService with 6 new methods for filtered queries, validation, updates, and FIFO tracking.
**Independent Test**: All new methods pass unit tests; can be called from Python REPL with test data.
**Prompt**: `/tasks/WP01-service-layer-extensions.md`
**Agent**: Claude

### Included Subtasks
- [ ] T001 Implement `get_purchases_filtered()` in `src/services/purchase_service.py`
- [ ] T002 Implement `get_remaining_inventory()` in `src/services/purchase_service.py`
- [ ] T003 Implement `can_edit_purchase()` in `src/services/purchase_service.py`
- [ ] T004 Implement `can_delete_purchase()` in `src/services/purchase_service.py`
- [ ] T005 Implement `update_purchase()` in `src/services/purchase_service.py`
- [ ] T006 Implement `get_purchase_usage_history()` in `src/services/purchase_service.py`
- [ ] T007 Add unit tests for all 6 methods in `src/tests/unit/test_purchase_service.py`

### Implementation Notes
- All methods MUST follow session management pattern (accept `session: Optional[Session] = None`)
- Date range filter options: "last_30_days", "last_90_days", "last_year", "all_time"
- Default date range: "last_30_days" per clarification
- Quantity allows 1 decimal place per clarification
- See `data-model.md` for method signatures and return types

### Parallel Opportunities
- T001-T006 can be implemented in parallel (different methods, same file)
- T007 depends on T001-T006

### Dependencies
- None (foundational package)

### Risks & Mitigations
- Session management bugs â†’ Follow documented pattern exactly; test multi-step operations
- FIFO calculation errors â†’ Unit test with consumed/unconsumed fixtures

---

## Work Package WP02: Purchases Tab - List & Filters (Priority: P1) ðŸŽ¯ MVP

**Goal**: Create PurchasesTab with list view, filters, and dashboard integration (User Stories 1 & 2).
**Independent Test**: Navigate to PURCHASE mode â†’ Purchases tab shows list with filters working.
**Prompt**: `/tasks/WP02-purchases-tab-list.md`
**Agent**: Claude

### Included Subtasks
- [ ] T008 Create `PurchasesTab` class in `src/ui/tabs/purchases_tab.py`
- [ ] T009 [P] Implement header section (title, subtitle)
- [ ] T010 [P] Implement filter controls (date range dropdown, supplier dropdown, search entry)
- [ ] T011 Implement ttk.Treeview with columns (Date, Product, Supplier, Qty, Price, Total, Remaining)
- [ ] T012 Implement sorting logic (click column headers)
- [ ] T013 Implement filter application and list refresh
- [ ] T014 Add context menu (Edit, Delete, View Details placeholders)
- [ ] T015 Integrate PurchasesTab into `src/ui/dashboards/purchase_dashboard.py`

### Implementation Notes
- Follow `InventoryTab` pattern for structure (see research.md)
- Grid: row 0 = header (fixed), row 1 = controls (fixed), row 2 = treeview (weight=1)
- Default filter: "Last 30 days"
- Empty state: "No purchases found. Click 'Add Purchase' to record your first purchase."
- Column widths: Date (100), Product (200), Supplier (120), Qty (60), Price (80), Total (80), Remaining (80)

### Parallel Opportunities
- T009 and T010 can proceed in parallel (different sections)
- T012-T014 depend on T011

### Dependencies
- Depends on WP01 (service methods)

### Risks & Mitigations
- Performance with 500+ rows â†’ Use ttk.Treeview (proven pattern)
- Filter state sync â†’ Apply all filters on any change

---

## Work Package WP03: Add Purchase Dialog (Priority: P1) ðŸŽ¯ MVP

**Goal**: Implement Add Purchase dialog for primary data entry (User Story 3).
**Independent Test**: Click "Add Purchase" â†’ fill form â†’ save â†’ purchase appears in list + inventory updated.
**Prompt**: `/tasks/WP03-add-purchase-dialog.md`
**Agent**: Claude

### Included Subtasks
- [ ] T016 Create `AddPurchaseDialog` class in `src/ui/dialogs/add_purchase_dialog.py`
- [ ] T017 Implement product dropdown with type-ahead filtering
- [ ] T018 Implement date picker (default today, validate not future)
- [ ] T019 Implement quantity entry (1 decimal place allowed)
- [ ] T020 Implement unit price entry with auto-fill from last purchase
- [ ] T021 Implement supplier dropdown (default to preferred_supplier)
- [ ] T022 Implement notes text area (optional)
- [ ] T023 Implement live preview (total cost, inventory impact)
- [ ] T024 Implement validation and error display
- [ ] T025 Implement save handler calling PurchaseService.record_purchase()
- [ ] T026 Wire "Add Purchase" button in PurchasesTab to open dialog

### Implementation Notes
- Follow `AdjustmentDialog` pattern (see research.md)
- Modal: `transient(parent)` + `grab_set()`
- Callback pattern: `on_save: Optional[Callable]`
- Auto-fill: Call `get_last_price_any_supplier(product_id)` on product selection
- Supplier default: If product.preferred_supplier exists, pre-select it

### Parallel Opportunities
- T017-T022 can be developed in parallel (different form fields)
- T23-T25 depend on form fields

### Dependencies
- Depends on WP01 (get_last_price_any_supplier already exists)
- Depends on WP02 (button location)

### Risks & Mitigations
- Product dropdown performance â†’ Lazy load, limit to recent + filtered
- Validation UX â†’ Show inline errors, don't close on failure

---

## Work Package WP04: Edit Purchase Dialog (Priority: P2)

**Goal**: Implement Edit Purchase dialog for correcting errors (User Story 4).
**Independent Test**: Select purchase â†’ Edit â†’ change price â†’ save â†’ list shows updated values.
**Prompt**: `/tasks/WP04-edit-purchase-dialog.md`
**Agent**: Gemini (parallel with WP03)

### Included Subtasks
- [ ] T027 Create `EditPurchaseDialog` class in `src/ui/dialogs/edit_purchase_dialog.py`
- [ ] T028 Pre-fill all fields from existing purchase
- [ ] T029 Make product field read-only (display only, not editable)
- [ ] T030 Implement quantity validation (new_qty >= consumed_qty)
- [ ] T031 Implement preview showing cost changes and FIFO impact
- [ ] T032 Implement save handler calling PurchaseService.update_purchase()
- [ ] T033 Wire Edit action in PurchasesTab context menu

### Implementation Notes
- Reuse structure from AddPurchaseDialog where possible
- Call `can_edit_purchase()` on quantity change to validate
- Show warning if FIFO costs will be recalculated
- Product field: Use CTkLabel instead of dropdown

### Parallel Opportunities
- Can proceed in parallel with WP03 after WP01 completes
- T27-T32 sequential; T33 depends on WP02

### Dependencies
- Depends on WP01 (can_edit_purchase, update_purchase)
- Depends on WP02 for context menu integration

### Risks & Mitigations
- FIFO recalculation confusion â†’ Clear preview of impact before save

---

## Work Package WP05: Delete Purchase (Priority: P2)

**Goal**: Implement delete validation and confirmation flow (User Story 5).
**Independent Test**: Try delete consumed purchase â†’ blocked with details; delete unconsumed â†’ succeeds.
**Prompt**: `/tasks/WP05-delete-purchase.md`
**Agent**: Claude

### Included Subtasks
- [ ] T034 Implement delete handler in PurchasesTab
- [ ] T035 Call `can_delete_purchase()` for validation
- [ ] T036 Create error dialog showing usage details (when blocked)
- [ ] T037 Create confirmation dialog showing what will be deleted (when allowed)
- [ ] T038 Call `PurchaseService.delete_purchase()` on confirmation
- [ ] T039 Refresh list after successful deletion

### Implementation Notes
- Error dialog: Show consumed quantity and recipe names
- Confirmation dialog: "This will delete the purchase AND remove X units from inventory."
- Use `CTkInputDialog` or custom dialog for confirmation

### Parallel Opportunities
- Can proceed after WP02 context menu exists

### Dependencies
- Depends on WP01 (can_delete_purchase, delete_purchase)
- Depends on WP02 (context menu)

### Risks & Mitigations
- Accidental deletion â†’ Require explicit confirmation; show cascade impact

---

## Work Package WP06: View Details Dialog (Priority: P3)

**Goal**: Implement purchase details with usage history (User Story 6).
**Independent Test**: View Details â†’ shows purchase info + usage history + remaining inventory.
**Prompt**: `/tasks/WP06-view-details-dialog.md`
**Agent**: Gemini (parallel with WP05)

### Included Subtasks
- [ ] T040 Create `PurchaseDetailsDialog` class in `src/ui/dialogs/purchase_details_dialog.py`
- [ ] T041 Implement purchase info section (date, supplier, price, notes)
- [ ] T042 Implement inventory tracking section (original, used, remaining)
- [ ] T043 Implement usage history table (date, recipe, quantity, cost)
- [ ] T044 Add "Edit Purchase" quick action button
- [ ] T045 Wire View Details action in PurchasesTab context menu

### Implementation Notes
- Read-only dialog (no save, just close)
- Call `get_remaining_inventory()` and `get_purchase_usage_history()`
- Usage table: Simple ttk.Treeview with 4 columns
- Edit button opens EditPurchaseDialog and closes details

### Parallel Opportunities
- Can proceed in parallel with WP05 after WP01 completes
- T40-T44 sequential; T45 depends on WP02

### Dependencies
- Depends on WP01 (get_remaining_inventory, get_purchase_usage_history)
- Depends on WP02 (context menu)
- Depends on WP04 (Edit Purchase dialog for quick action)

### Risks & Mitigations
- Performance with large usage history â†’ Limit to 50 most recent

---

## Work Package WP07: Integration & Polish (Priority: P3)

**Goal**: Final integration, testing, and polish.
**Independent Test**: Full CRUD workflow works end-to-end; all acceptance scenarios pass.
**Prompt**: `/tasks/WP07-integration-polish.md`
**Agent**: Claude

### Included Subtasks
- [ ] T046 Verify all components wire together correctly
- [ ] T047 Add keyboard shortcuts (Delete key, Ctrl+N for new)
- [ ] T048 Verify double-click opens details
- [ ] T049 Test edge cases (empty list, no results, long names)
- [ ] T050 Run unit tests and verify >70% service coverage
- [ ] T051 Manual testing with real data
- [ ] T052 Fix any UI polish issues discovered

### Implementation Notes
- Test all 6 user stories against acceptance criteria
- Verify filter persistence across tab switches
- Check empty state messages

### Parallel Opportunities
- None (integration is sequential)

### Dependencies
- Depends on WP01-WP06 all complete

### Risks & Mitigations
- Last-minute bugs â†’ Allow time for iteration

---

## Dependency & Execution Summary

```
WP01 (Service Layer) â”€â”€â”¬â”€â”€> WP02 (Tab UI) â”€â”€â”€â”€â”€â”€â”€> WP05 (Delete) â”€â”€â”
                       â”‚                                            â”‚
                       â”œâ”€â”€> WP03 (Add Dialog) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                       â”‚                                            â”œâ”€â”€> WP07 (Integration)
                       â”œâ”€â”€> WP04 (Edit Dialog) [Gemini] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                       â”‚                                            â”‚
                       â””â”€â”€> WP06 (View Details) [Gemini] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Parallelization**:
- After WP01 completes, WP02/WP03 (Claude) and WP04/WP06 (Gemini) can proceed in parallel
- WP05 can start after WP02 context menu exists
- WP07 is sequential after all others

**MVP Scope**: WP01 + WP02 + WP03 = Functional Purchases tab with Add capability

---

## Subtask Index (Reference)

| Subtask | Summary | Work Package | Priority | Parallel? |
|---------|---------|--------------|----------|-----------|
| T001 | get_purchases_filtered() | WP01 | P0 | Yes |
| T002 | get_remaining_inventory() | WP01 | P0 | Yes |
| T003 | can_edit_purchase() | WP01 | P0 | Yes |
| T004 | can_delete_purchase() | WP01 | P0 | Yes |
| T005 | update_purchase() | WP01 | P0 | Yes |
| T006 | get_purchase_usage_history() | WP01 | P0 | Yes |
| T007 | Unit tests for service methods | WP01 | P0 | No |
| T008 | PurchasesTab class structure | WP02 | P1 | No |
| T009 | Header section | WP02 | P1 | Yes |
| T010 | Filter controls | WP02 | P1 | Yes |
| T011 | Treeview list | WP02 | P1 | No |
| T012 | Sorting logic | WP02 | P1 | No |
| T013 | Filter application | WP02 | P1 | No |
| T014 | Context menu | WP02 | P1 | No |
| T015 | Dashboard integration | WP02 | P1 | No |
| T016 | AddPurchaseDialog class | WP03 | P1 | No |
| T017 | Product dropdown | WP03 | P1 | Yes |
| T018 | Date picker | WP03 | P1 | Yes |
| T019 | Quantity entry | WP03 | P1 | Yes |
| T020 | Unit price with auto-fill | WP03 | P1 | Yes |
| T021 | Supplier dropdown | WP03 | P1 | Yes |
| T022 | Notes text area | WP03 | P1 | Yes |
| T023 | Live preview | WP03 | P1 | No |
| T024 | Validation | WP03 | P1 | No |
| T025 | Save handler | WP03 | P1 | No |
| T026 | Wire Add button | WP03 | P1 | No |
| T027 | EditPurchaseDialog class | WP04 | P2 | No |
| T028 | Pre-fill fields | WP04 | P2 | No |
| T029 | Read-only product | WP04 | P2 | No |
| T030 | Quantity validation | WP04 | P2 | No |
| T031 | Preview changes | WP04 | P2 | No |
| T032 | Save handler | WP04 | P2 | No |
| T033 | Wire Edit action | WP04 | P2 | No |
| T034 | Delete handler | WP05 | P2 | No |
| T035 | Validation check | WP05 | P2 | No |
| T036 | Error dialog | WP05 | P2 | No |
| T037 | Confirmation dialog | WP05 | P2 | No |
| T038 | Delete call | WP05 | P2 | No |
| T039 | List refresh | WP05 | P2 | No |
| T040 | PurchaseDetailsDialog class | WP06 | P3 | No |
| T041 | Purchase info section | WP06 | P3 | No |
| T042 | Inventory tracking section | WP06 | P3 | No |
| T043 | Usage history table | WP06 | P3 | No |
| T044 | Edit quick action | WP06 | P3 | No |
| T045 | Wire View Details action | WP06 | P3 | No |
| T046 | Component wiring | WP07 | P3 | No |
| T047 | Keyboard shortcuts | WP07 | P3 | No |
| T048 | Double-click behavior | WP07 | P3 | No |
| T049 | Edge case testing | WP07 | P3 | No |
| T050 | Unit test verification | WP07 | P3 | No |
| T051 | Manual testing | WP07 | P3 | No |
| T052 | UI polish fixes | WP07 | P3 | No |
