# Implementation Plan: Core API Standardization

**Branch**: `094-core-api-standardization` | **Date**: 2026-02-03 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/kitty-specs/094-core-api-standardization/spec.md`

## Summary

This feature standardizes the service layer API by:
1. Converting ~40+ `get_*` functions from returning `None` to raising domain-specific exceptions
2. Converting ~30+ functions returning `Tuple[bool, ...]` to using exceptions
3. Completing type hints across ~60+ service functions

The existing exception infrastructure in `src/services/exceptions.py` provides a solid foundation with `ServiceError` base class and specific exceptions like `IngredientNotFoundBySlug`, `ValidationError`, etc.

## Technical Context

**Language/Version**: Python 3.10+
**Primary Dependencies**: SQLAlchemy 2.x, CustomTkinter
**Storage**: SQLite with WAL mode
**Testing**: pytest
**Target Platform**: macOS/Windows desktop
**Project Type**: Single project (desktop app)
**Constraints**: Must not break existing UI functionality

## Constitution Check

*GATE: Must pass before Phase 0 research.*

- [x] Layered architecture maintained (UI -> Services -> Models)
- [x] Service layer isolation preserved
- [x] Exception hierarchy follows existing patterns
- [x] Test coverage maintained (>70% for service layer)

## Project Structure

### Documentation (this feature)

```
kitty-specs/094-core-api-standardization/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Research findings (not needed - patterns are clear)
├── data-model.md        # Not needed - no schema changes
└── tasks.md             # Task tracking (generated by /spec-kitty.tasks)
```

### Source Code

```
src/
├── services/
│   ├── exceptions.py           # Add new exception types here
│   ├── ingredient_service.py   # Major updates needed
│   ├── recipe_service.py       # Major updates needed
│   ├── product_service.py      # Updates needed
│   ├── event_service.py        # Updates needed
│   ├── ...                     # Other service files
└── utils/
    └── validators.py           # Tuple returns to convert

src/tests/services/             # Update tests for exception behavior
```

**Structure Decision**: Single project desktop app with existing layered architecture.

## Analysis Results

### FR-1: Functions Returning Optional (Need Exception Pattern)

**High-Priority Files (UI-facing services):**

| File | Functions Returning Optional | Notes |
|------|------------------------------|-------|
| `ingredient_service.py` | `get_ingredient()` already raises | Good pattern to follow |
| `recipe_service.py` | `get_recipe_by_slug()`, `get_recipe_by_name()` | Need updates |
| `product_service.py` | `get_preferred_product()` | Review context |
| `event_service.py` | `get_event_by_id()`, `get_event_by_name()` | Need updates |
| `finished_good_service.py` | `get_finished_good_by_id()`, `get_finished_good_by_slug()` | Need updates |
| `finished_unit_service.py` | `get_finished_unit_by_id()`, `get_finished_unit_by_slug()` | Need updates |
| `package_service.py` | `get_package_by_id()`, `get_package_by_name()` | Need updates |
| `recipient_service.py` | `get_recipient_by_name()` | Need updates |
| `supplier_service.py` | `get_supplier()`, `get_supplier_by_uuid()` | Need updates |
| `composition_service.py` | `get_composition_by_id()`, `get_composition()` | Need updates |
| `unit_service.py` | `get_unit_by_code()` | Need updates |

**Lower-Priority Files (internal services):**

| File | Functions | Notes |
|------|-----------|-------|
| `ingredient_hierarchy_service.py` | `get_ingredient_by_id()`, `get_ingredient_with_ancestors()` | Internal use |
| `material_catalog_service.py` | `get_category()`, `get_subcategory()`, `get_material()`, `get_product()` | Internal use |
| `material_hierarchy_service.py` | `get_material_with_parents()` | Internal use |
| `recipe_snapshot_service.py` | `get_snapshot_by_id()`, etc. | Internal use |
| `plan_snapshot_service.py` | `get_plan_snapshot()` | Internal use |

**Total: ~50+ functions need updates**

### FR-2: Tuple Return Patterns to Convert

| File | Functions | Pattern |
|------|-----------|---------|
| `utils/validators.py` | 9 functions | `Tuple[bool, str]` or `Tuple[bool, list]` |
| `unit_converter.py` | 5 functions | `Tuple[bool, float, str]` |
| `material_unit_converter.py` | 4 functions | `Tuple[bool, Optional[...], Optional[str]]` |
| `ingredient_service.py` | 2 functions | `Tuple[bool, str]`, `Tuple[bool, str, Dict]` |
| `purchase_service.py` | 4 functions | `Tuple[bool, str]` |
| `migration_service.py` | 2 functions | `Tuple[bool, str]` |
| `planning_service.py` | 1 function | `Tuple[bool, Optional[str]]` |

**Total: ~27 functions need conversion**

### FR-3: Type Hints Audit

Many functions already have type hints. Focus areas:
- Functions with `session=None` parameter lacking `Optional[Session]` type
- Functions returning complex types (Dict, List of dicts)
- Private implementation functions (`_impl` functions)

## Implementation Strategy

### Phased Approach

**Phase 1: Exception Infrastructure (Foundation)**
- Add missing exception types to `exceptions.py`
- Create exception factory/helpers if needed
- Update CLAUDE.md with patterns

**Phase 2: Core Service Functions (High-Impact)**
- Convert high-priority `get_*` functions to raise exceptions
- Update calling code in UI and other services
- Update tests

**Phase 3: Validation Functions (Tuple Elimination)**
- Convert `validators.py` functions to raise `ValidationError`
- Convert unit converter functions
- Update calling code

**Phase 4: Type Hints Completion**
- Add missing type hints to service functions
- Run mypy validation
- Fix type errors

### New Exception Types Needed

Based on analysis, these exception types need to be added:

```python
# Recipe-related
RecipeNotFoundBySlug
RecipeNotFoundByName

# Event-related
EventNotFoundById
EventNotFoundByName

# Finished Goods
FinishedGoodNotFoundById
FinishedGoodNotFoundBySlug
FinishedUnitNotFoundById
FinishedUnitNotFoundBySlug

# Package
PackageNotFoundById
PackageNotFoundByName

# Composition
CompositionNotFoundById

# Unit
UnitNotFoundByCode

# Material Catalog
MaterialCategoryNotFound
MaterialSubcategoryNotFound
MaterialNotFound
MaterialProductNotFound

# Hierarchy
IngredientNotFoundById (if not exists)
```

## Parallel Work Analysis

### Dependency Graph

```
Phase 1 (Foundation)
    └── Phase 2a (recipe/ingredient services) ─┐
    └── Phase 2b (event/package services)     ─┼─> Phase 4 (Type Hints)
    └── Phase 3 (validators/converters)       ─┘
```

### Work Distribution

- **Sequential work**: Phase 1 must complete first (exception types)
- **Parallel streams**: Phases 2a, 2b, and 3 can be done in parallel after Phase 1
- **File boundaries**: Each WP should own specific files to avoid conflicts

### Coordination Points

- After Phase 1: Verify all exception types are available
- After Phases 2-3: Integration test to verify UI still works
- Phase 4: Can be done incrementally alongside other work

## Risk Mitigation

1. **Breaking UI**: Test thoroughly after each service update
2. **Missed call sites**: Use grep to find all callers before changing function
3. **Test updates**: Update tests in same commit as function changes

## Next Steps

1. Proceed to `/spec-kitty.tasks` to generate work packages
2. Organize WPs by service file groups
3. Implement in phases with parallel work where possible
