# Work Packages: Finished Goods Quantity Specification

**Inputs**: Design documents from `/kitty-specs/071-finished-goods-quantity-specification/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: Unit tests for service layer methods (TDD approach per constitution).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Service Layer Foundation (Priority: P0)

**Goal**: Implement quantity-aware CRUD methods in event_service.py with unit tests.
**Independent Test**: Service methods pass unit tests; can be called from Python REPL.
**Prompt**: `tasks/WP01-service-layer-foundation.md`
**Estimated Size**: ~300 lines

### Included Subtasks
- [x] T001 Implement `get_event_fg_quantities()` in `src/services/event_service.py`
- [x] T002 Implement `set_event_fg_quantities()` in `src/services/event_service.py`
- [ ] T003 Implement `remove_event_fg()` in `src/services/event_service.py`
- [ ] T004 Write unit tests in `src/tests/services/test_event_service_fg_quantities.py`

### Implementation Notes
- Follow session management pattern: accept `session` parameter, delegate to `_impl` function
- Use existing `set_event_finished_goods()` as reference for replace pattern
- Database CHECK constraint enforces `quantity > 0` - service validates before insert
- Tests should cover: happy path, invalid event, empty list, invalid FG IDs

### Parallel Opportunities
- T001, T002, T003 can be implemented in parallel (different functions)
- T004 should be written alongside or after the methods

### Dependencies
- None (starting package)

### Risks & Mitigations
- Session detachment: Follow session parameter pattern per CLAUDE.md
- FK violations: Filter to available FGs before insert (existing pattern)

---

## Work Package WP02: UI Component Enhancement (Priority: P1)

**Goal**: Extend FGSelectionFrame with quantity input fields and live validation.
**Independent Test**: Component displays quantity fields, validates input, returns (fg_id, quantity) tuples.
**Prompt**: `tasks/WP02-ui-component-enhancement.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [ ] T005 Add `CTkEntry` quantity inputs to FGSelectionFrame in `src/ui/components/fg_selection_frame.py`
- [ ] T006 Add live validation with colored feedback in `src/ui/components/fg_selection_frame.py`
- [ ] T007 Implement quantity pre-population via `set_quantities()` method
- [ ] T008 Update `get_selected()` to return `List[Tuple[int, int]]` (fg_id, quantity)

### Implementation Notes
- Add quantity entry next to each checkbox in `populate_finished_goods()` loop
- Track quantities with `Dict[int, ctk.StringVar]` (fg_id â†’ quantity string)
- Validation pattern: empty OK, positive integer OK, zero/negative/non-int â†’ orange text
- Reference: `src/ui/dialogs/adjustment_dialog.py:258-306` for validation pattern

### Parallel Opportunities
- T005 and T006 are coupled (both modify same method)
- T007 and T008 can be done after T005/T006

### Dependencies
- Depends on WP01 (service methods must exist for integration testing)

### Risks & Mitigations
- Breaking existing FG selection: Preserve current checkbox behavior
- Tab order: Set proper focus order for efficient data entry

---

## Work Package WP03: Planning Tab Integration (Priority: P1) ðŸŽ¯ MVP

**Goal**: Wire up service layer to UI; complete end-to-end workflow.
**Independent Test**: User can enter quantities, save, close event, reopen, see quantities preserved.
**Prompt**: `tasks/WP03-planning-tab-integration.md`
**Estimated Size**: ~280 lines

### Included Subtasks
- [ ] T009 Update `_show_fg_selection()` to load quantities via `get_event_fg_quantities()` in `src/ui/planning_tab.py`
- [ ] T010 Update `_on_fg_selection_save()` to save quantities via `set_event_fg_quantities()` in `src/ui/planning_tab.py`
- [ ] T011 Add status bar feedback for save success/error in `src/ui/planning_tab.py`
- [ ] T012 End-to-end validation: manual test of complete workflow

### Implementation Notes
- Load quantities in same session scope as available FGs query
- Save uses replace pattern: all current (fg_id, quantity) pairs sent to service
- Status bar: "Saved X finished goods" or error message in red

### Parallel Opportunities
- T009 and T010 modify different methods (can be parallel)
- T011 is small, can be done with either
- T012 requires all prior work complete

### Dependencies
- Depends on WP01 (service layer) and WP02 (UI component)

### Risks & Mitigations
- Data loss: Ensure replace pattern preserves user intent
- UX confusion: Clear feedback on save success

---

## Dependency & Execution Summary

```
WP01 (Service) â”€â”€â”¬â”€â”€â–º WP02 (UI) â”€â”€â”¬â”€â”€â–º WP03 (Integration) ðŸŽ¯ MVP
                 â”‚                â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    (both needed)
```

- **Sequence**: WP01 â†’ WP02 â†’ WP03
- **Parallelization**: WP02 can start once WP01 service methods are defined (stub tests OK)
- **MVP Scope**: All three work packages required for minimum viable feature

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Implement get_event_fg_quantities() | WP01 | P0 | Yes |
| T002 | Implement set_event_fg_quantities() | WP01 | P0 | Yes |
| T003 | Implement remove_event_fg() | WP01 | P0 | Yes |
| T004 | Write service unit tests | WP01 | P0 | No |
| T005 | Add CTkEntry quantity inputs | WP02 | P1 | No |
| T006 | Add live validation | WP02 | P1 | No |
| T007 | Implement quantity pre-population | WP02 | P1 | No |
| T008 | Update get_selected() return type | WP02 | P1 | No |
| T009 | Update _show_fg_selection() | WP03 | P1 | Yes |
| T010 | Update _on_fg_selection_save() | WP03 | P1 | Yes |
| T011 | Add status bar feedback | WP03 | P1 | Yes |
| T012 | End-to-end validation | WP03 | P1 | No |
