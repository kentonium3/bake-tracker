# Work Packages: Unit Reference Table & UI Dropdowns

**Inputs**: Design documents from `/kitty-specs/022-unit-reference-table/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, quickstart.md

**Tests**: Tests are included as this project has TDD requirements (Constitution IV).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/planned/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Includes precise file paths.

## Path Conventions
- **Single project**: `src/`, `src/tests/`
- All paths relative to repository root.

---

## Work Package WP01: Unit Model & Seeding (Priority: P1) MVP [DONE]

**Goal**: Create the Unit model and seed all 27 units on database initialization.
**Independent Test**: Fresh database startup creates units table with exactly 27 units across 4 categories.
**Prompt**: `tasks/done/WP01-unit-model-and-seeding.md`
**User Story**: US4 - Reference Table Seeded on First Launch

### Included Subtasks
- [x] T001 Create Unit model in `src/models/unit.py`
- [x] T002 [P] Update `src/models/__init__.py` to export Unit
- [x] T003 Create `seed_units()` function in `src/services/database.py`
- [x] T004 Call `seed_units()` from `init_database()` function
- [x] T005 [P] Write tests for Unit model in `src/tests/test_unit_model.py`
- [x] T006 [P] Write tests for seeding in `src/tests/test_unit_seeding.py`

### Implementation Notes
1. Unit model follows BaseModel pattern (id, uuid, created_at, updated_at)
2. Seeding uses existing constants from `src/utils/constants.py`
3. Seeding must be idempotent (check if empty before inserting)
4. Use sort_order field to control display ordering within categories

### Parallel Opportunities
- T002, T005, T006 can run in parallel after T001 is complete

### Dependencies
- None (foundational package)

### Risks & Mitigations
- Duplicate seeding on restart: Use idempotent check (count == 0)
- Missing units: Verify 27 units in test assertions

---

## Work Package WP02: Unit Service Layer (Priority: P1) MVP [DONE]

**Goal**: Create helper functions for querying units by category and formatting for dropdowns.
**Independent Test**: Service functions return correct units filtered by category with proper formatting.
**Prompt**: `tasks/done/WP02-unit-service-layer.md`

### Included Subtasks
- [x] T007 Create `src/services/unit_service.py` with query functions
- [x] T008 Implement `get_all_units()` function
- [x] T009 Implement `get_units_by_category(category)` function
- [x] T010 Implement `get_units_for_dropdown(categories)` with category headers
- [x] T011 [P] Write tests for unit_service in `src/tests/test_unit_service.py`

### Implementation Notes
1. `get_units_for_dropdown()` returns list formatted for CTkComboBox with "-- Category --" headers
2. Follow session management patterns from CLAUDE.md (accept optional session parameter)
3. Order by category sort_order, then by unit sort_order

### Parallel Opportunities
- T011 can run in parallel with T008-T010 using TDD approach

### Dependencies
- Depends on WP01 (Unit model must exist)

### Risks & Mitigations
- Session management: Follow established patterns, accept session=None parameter

---

## Work Package WP03: Product Form Dropdown (Priority: P1) MVP [DONE]

**Goal**: Replace free-form package_unit entry with dropdown selection showing all units grouped by category.
**Independent Test**: Add Product form shows unit dropdown; selected unit is saved correctly.
**Prompt**: `tasks/done/WP03-product-form-dropdown.md`
**User Story**: US1 - Select Unit from Dropdown When Adding Product

### Included Subtasks
- [x] T012 Verify product form location (`src/ui/ingredients_tab.py` line ~1412)
- [x] T013 Import unit_service and replace CTkOptionMenu with CTkComboBox
- [x] T014 Populate dropdown with all units using `get_units_for_dropdown(['weight', 'volume', 'count', 'package'])`
- [x] T015 Handle category header selection (skip non-selectable headers)
- [x] T016 Ensure selected unit is stored correctly on save
- [x] T017 Verify existing product edit populates dropdown with current value

### Implementation Notes
1. Current implementation uses `CTkOptionMenu` with only 7 hardcoded units - replace with `CTkComboBox`
2. Use `state="readonly"` to prevent free-form entry
3. Category headers formatted as "-- Weight --" are non-selectable
4. Pre-select current value when editing existing products
5. Dropdown shows all 27 units (all categories appropriate for products)

### Parallel Opportunities
- None within this package (sequential UI changes)

### Dependencies
- Depends on WP02 (unit_service functions)

### Risks & Mitigations
- CTkOptionMenu to CTkComboBox change: Different API (variable vs set/get) - update save handler
- CTkComboBox doesn't support non-selectable items natively: Validate selection and reset if header selected

---

## Work Package WP04: Ingredient Form Dropdowns (Priority: P2) [DONE]

**Goal**: Replace density_volume_unit and density_weight_unit text entries with filtered dropdowns.
**Independent Test**: Ingredient form shows volume-only dropdown for density_volume_unit and weight-only for density_weight_unit.
**Prompt**: `tasks/done/WP04-ingredient-form-dropdowns.md`
**User Story**: US2 - Select Density Units When Defining Ingredient

### Included Subtasks
- [x] T018 Modify `src/ui/forms/ingredient_form.py` density_volume_unit field
- [x] T019 Replace density_volume_unit entry with CTkComboBox (VOLUME units only)
- [x] T020 Modify density_weight_unit field
- [x] T021 Replace density_weight_unit entry with CTkComboBox (WEIGHT units only)
- [x] T022 Ensure selected units are stored correctly on save
- [x] T023 Verify existing ingredient edit populates dropdowns with current values

### Implementation Notes
1. density_volume_unit shows only: tsp, tbsp, cup, ml, l, fl oz, pt, qt, gal
2. density_weight_unit shows only: oz, lb, g, kg
3. These fields are already present in ingredient_form.py as CTkComboBox - verify and enhance
4. Existing pattern at lines 247-278 can be adapted

### Parallel Opportunities
- T018-T019 can run in parallel with T020-T021 (different fields)

### Dependencies
- Depends on WP02 (unit_service functions)
- Can run in parallel with WP03 (different forms)

### Risks & Mitigations
- Existing dropdown may already use correct pattern: Verify current implementation first

---

## Work Package WP05: Recipe Ingredient Dropdown (Priority: P2) [DONE]

**Goal**: Replace unit text entry with dropdown showing weight, volume, and count units (no package units).
**Independent Test**: Add recipe ingredient shows appropriate unit dropdown; selected unit is saved correctly.
**Prompt**: `tasks/done/WP05-recipe-ingredient-dropdown.md`
**User Story**: US3 - Select Unit When Adding Recipe Ingredient

### Included Subtasks
- [x] T024 Identify recipe form or dialog handling RecipeIngredient creation
- [x] T025 Import unit_service to recipe ingredient form
- [x] T026 Replace unit text entry with CTkComboBox
- [x] T027 Populate dropdown with `get_units_for_dropdown(['weight', 'volume', 'count'])` (exclude 'package')
- [x] T028 Ensure selected unit is stored correctly on save
- [x] T029 Verify existing recipe ingredient edit populates dropdown with current value

### Implementation Notes
1. Package units (bag, box, etc.) are excluded - recipes use measurement units
2. Find where RecipeIngredient unit is set (likely recipe_form.py or separate dialog)
3. Pre-select current value when editing existing recipe ingredients

### Parallel Opportunities
- None within this package

### Dependencies
- Depends on WP02 (unit_service functions)
- Can run in parallel with WP03 and WP04 (different forms)

### Risks & Mitigations
- Recipe ingredient form may be complex (nested in recipe form): Trace code path carefully

---

## Dependency & Execution Summary

```
WP01 (Model & Seeding)
   │
   ▼
WP02 (Service Layer)
   │
   ├──────────┬──────────┐
   ▼          ▼          ▼
WP03 [P]   WP04 [P]   WP05 [P]
(Product)  (Ingredient) (Recipe)
```

- **Sequence**: WP01 → WP02 → (WP03, WP04, WP05 in parallel)
- **Parallelization**: WP03, WP04, WP05 can all run in parallel once WP02 is complete
- **MVP Scope**: WP01 + WP02 + WP03 constitute minimal release (Product dropdown is P1 priority)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Create Unit model | WP01 | P1 | No |
| T002 | Update models __init__.py | WP01 | P1 | Yes |
| T003 | Create seed_units() function | WP01 | P1 | No |
| T004 | Call seed_units() from init_database() | WP01 | P1 | No |
| T005 | Write Unit model tests | WP01 | P1 | Yes |
| T006 | Write seeding tests | WP01 | P1 | Yes |
| T007 | Create unit_service.py | WP02 | P1 | No |
| T008 | Implement get_all_units() | WP02 | P1 | No |
| T009 | Implement get_units_by_category() | WP02 | P1 | No |
| T010 | Implement get_units_for_dropdown() | WP02 | P1 | No |
| T011 | Write unit_service tests | WP02 | P1 | Yes |
| T012 | Verify product form location | WP03 | P1 | No |
| T013 | Replace CTkOptionMenu with CTkComboBox | WP03 | P1 | No |
| T014 | Populate product dropdown | WP03 | P1 | No |
| T015 | Handle category header selection | WP03 | P1 | No |
| T016 | Ensure unit stored on save | WP03 | P1 | No |
| T017 | Verify product edit pre-selection | WP03 | P1 | No |
| T018 | Modify density_volume_unit field | WP04 | P2 | Yes |
| T019 | Replace with volume dropdown | WP04 | P2 | Yes |
| T020 | Modify density_weight_unit field | WP04 | P2 | Yes |
| T021 | Replace with weight dropdown | WP04 | P2 | Yes |
| T022 | Ensure density units stored on save | WP04 | P2 | No |
| T023 | Verify ingredient edit pre-selection | WP04 | P2 | No |
| T024 | Identify recipe ingredient form | WP05 | P2 | No |
| T025 | Import unit_service to recipe form | WP05 | P2 | No |
| T026 | Replace with unit dropdown | WP05 | P2 | No |
| T027 | Populate with measurement units | WP05 | P2 | No |
| T028 | Ensure unit stored on save | WP05 | P2 | No |
| T029 | Verify recipe ingredient edit pre-selection | WP05 | P2 | No |
