# Work Packages: Recipe Template & Snapshot System

**Inputs**: Design documents from `/kitty-specs/037-recipe-template-snapshot/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, quickstart.md

**Tests**: Included per Constitution requirement (>70% service layer coverage).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/planned/` generated by `/spec-kitty.tasks`.

## Parallelization Strategy

```
WP01 (Models) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â”‚
   â”œâ”€â”€â†’ WP02 (Snapshot Service) â”€â”€â†’ WP03 (Production Integration) â”€â”€â†’ WP04 (Migration)
   â”‚         â”‚                              â”‚
   â”‚         â””â”€â”€â†’ WP08 (History View)       â””â”€â”€â†’ WP05 (Scale Factor UI)
   â”‚
   â”œâ”€â”€â†’ WP06 (Variant Service & UI) [PARALLEL with WP02]
   â”‚
   â””â”€â”€â†’ WP07 (Production Readiness) [PARALLEL with WP02, WP06]
```

**Gemini Parallel Execution Windows**:
1. After WP01: Run WP02 + WP06 + WP07 in parallel (different files)
2. After WP02: Run WP03 + WP08 in parallel
3. After WP03: Run WP04 + WP05 in parallel

---

## Work Package WP01: Models Layer (Priority: P1) ðŸŽ¯ MVP Foundation

**Goal**: Create RecipeSnapshot model and update Recipe/ProductionRun models with new fields.
**Independent Test**: All models import without errors; CHECK constraints prevent invalid data.
**Prompt**: `tasks/planned/WP01-models-layer.md`

### Included Subtasks
- [ ] T001 [P] Create RecipeSnapshot model in `src/models/recipe_snapshot.py`
- [ ] T002 [P] Add base_recipe_id, variant_name, is_production_ready to Recipe in `src/models/recipe.py`
- [ ] T003 [P] Add recipe_snapshot_id FK to ProductionRun in `src/models/production_run.py`
- [ ] T004 Update `src/models/__init__.py` to export RecipeSnapshot
- [ ] T005 [P] Create unit tests in `src/tests/models/test_recipe_snapshot_model.py`

### Implementation Notes
- T001-T003 can run in parallel (different files)
- RecipeSnapshot fields: recipe_id (FK RESTRICT), production_run_id (UNIQUE), scale_factor (default 1.0), snapshot_date, recipe_data (JSON), ingredients_data (JSON), is_backfilled (default False)
- Recipe new fields: base_recipe_id (nullable, self-ref, SET NULL), variant_name (nullable), is_production_ready (default False)
- ProductionRun: Add recipe_snapshot_id (nullable initially for migration)
- CHECK constraint: base_recipe_id != id

### Parallel Opportunities
- T001, T002, T003, T005 are all parallel-safe (different files)

### Dependencies
- None (starting package)

### Risks & Mitigations
- Self-referential FK complexity â†’ Use explicit CHECK constraint
- JSON column in SQLite â†’ Use Text type with json.dumps/loads

---

## Work Package WP02: Snapshot Service (Priority: P1) ðŸŽ¯ MVP

**Goal**: Create snapshot service with CRUD operations following session management patterns.
**Independent Test**: Can create snapshot, retrieve by recipe_id, immutability enforced.
**Prompt**: `tasks/planned/WP02-snapshot-service.md`

### Included Subtasks
- [ ] T006 Create `src/services/recipe_snapshot_service.py` with create_recipe_snapshot()
- [ ] T007 Add get_recipe_snapshots(recipe_id) function
- [ ] T008 Add get_snapshot_by_production_run(production_run_id) function
- [ ] T009 Create unit tests in `src/tests/services/test_recipe_snapshot_service.py`

### Implementation Notes
- Follow session=None pattern from CLAUDE.md
- create_recipe_snapshot() must denormalize recipe data to JSON
- No update methods (immutability)
- Use json.dumps for recipe_data and ingredients_data

### Parallel Opportunities
- After completion: WP03 and WP08 can proceed in parallel

### Dependencies
- Depends on WP01 (RecipeSnapshot model)

### Risks & Mitigations
- Session detachment â†’ Follow CLAUDE.md patterns exactly
- JSON serialization errors â†’ Add validation and error handling

---

## Work Package WP03: Production Integration (Priority: P1) ðŸŽ¯ MVP

**Goal**: Modify batch_production_service to create snapshot before production.
**Independent Test**: Production run creates snapshot; costs calculated from snapshot data.
**Prompt**: `tasks/planned/WP03-production-integration.md`

### Included Subtasks
- [ ] T010 Modify `record_batch_production()` to create snapshot FIRST
- [ ] T011 Update cost calculation to use snapshot ingredient data
- [ ] T012 Add scale_factor parameter to production flow
- [ ] T013 Create integration tests in `src/tests/services/test_batch_production_service.py`

### Implementation Notes
- Snapshot creation must be FIRST operation in production transaction
- Scale factor affects ingredient quantities: base_quantity Ã— scale_factor Ã— num_batches
- Expected yield: base_yield Ã— scale_factor Ã— num_batches
- Must pass session through entire chain

### Parallel Opportunities
- After completion: WP04 and WP05 can proceed in parallel

### Dependencies
- Depends on WP02 (snapshot service)

### Risks & Mitigations
- Breaking existing production â†’ Comprehensive integration tests
- FIFO consumption errors â†’ Preserve existing consume_fifo() logic

---

## Work Package WP04: Migration Script (Priority: P1)

**Goal**: Backfill snapshots for existing ProductionRuns with is_backfilled flag.
**Independent Test**: All existing production runs have snapshots; is_backfilled=True for migrated data.
**Prompt**: `tasks/planned/WP04-migration-script.md`

### Included Subtasks
- [ ] T014 Create migration script in `scripts/migrate_production_snapshots.py`
- [ ] T015 Handle is_backfilled flag for migrated snapshots
- [ ] T016 Add dry-run mode and validation
- [ ] T017 Test migration with sample_data.json

### Implementation Notes
- Query all ProductionRuns with recipe_id but no recipe_snapshot_id
- For each: create snapshot from current recipe state, set is_backfilled=True
- Update ProductionRun.recipe_snapshot_id
- Support --dry-run flag for validation

### Parallel Opportunities
- None (must complete before go-live)

### Dependencies
- Depends on WP03 (production integration complete)

### Risks & Mitigations
- Data corruption â†’ Backup before migration, dry-run mode
- Recipe deleted â†’ Handle gracefully with warning

---

## Work Package WP05: Scale Factor UI (Priority: P2)

**Goal**: Add scale_factor input to production dialog with calculated yield display.
**Independent Test**: User can enter scale_factor; expected yield updates correctly.
**Prompt**: `tasks/planned/WP05-scale-factor-ui.md`

### Included Subtasks
- [ ] T018 Add scale_factor entry to `src/ui/forms/record_production_dialog.py`
- [ ] T019 Update expected yield calculation display
- [ ] T020 Show ingredient requirements scaled by scale_factor Ã— num_batches
- [ ] T021 Validate scale_factor > 0

### Implementation Notes
- Default scale_factor = 1.0
- Display: "Expected: 72 cookies (36 Ã— 2.0 Ã— 1 batch)"
- Show ingredient requirements with scaling applied
- Validation: scale_factor must be > 0 (0.5 valid for half batches)

### Parallel Opportunities
- Can run parallel with WP04 after WP03 complete

### Dependencies
- Depends on WP03 (scale_factor in production flow)

### Risks & Mitigations
- UI confusion â†’ Clear labeling and calculated preview

---

## Work Package WP06: Variant Service & UI (Priority: P2)

**Goal**: Enable recipe variants with base_recipe relationship and grouped display.
**Independent Test**: Create variant, verify linked to base; recipe list shows indentation.
**Prompt**: `tasks/planned/WP06-variant-service-ui.md`

### Included Subtasks
- [ ] T022 [P] Add get_recipe_variants(base_recipe_id) to `src/services/recipe_service.py`
- [ ] T023 [P] Add create_recipe_variant() function
- [ ] T024 [P] Extend get_all_recipes() to support grouping by base
- [ ] T025 [P] Add base_recipe dropdown to `src/ui/forms/recipe_form.py`
- [ ] T026 [P] Add variant_name field to recipe form
- [ ] T027 Update recipe list in `src/ui/recipes_tab.py` with variant indentation
- [ ] T028 Sort: base recipes first, variants grouped below
- [ ] T029 Create unit tests for variant functions

### Implementation Notes
- Variant indentation: 2-3 spaces + "â””â”€" prefix consistent with ingredient hierarchy
- get_all_recipes() should return sorted with variants after their base
- ON DELETE SET NULL: when base deleted, variant becomes standalone
- Variant creation copies ingredients from base if desired

### Parallel Opportunities
- T022-T026 can run in parallel (different files)
- Can run parallel with WP02, WP07 after WP01

### Dependencies
- Depends on WP01 (Recipe model with base_recipe_id)

### Risks & Mitigations
- UI complexity â†’ Follow existing ingredient hierarchy patterns

---

## Work Package WP07: Production Readiness (Priority: P3)

**Goal**: Add is_production_ready flag with toggle and filter support.
**Independent Test**: Toggle readiness; filter shows only ready recipes.
**Prompt**: `tasks/planned/WP07-production-readiness.md`

### Included Subtasks
- [ ] T030 [P] Add is_production_ready checkbox to `src/ui/forms/recipe_form.py`
- [ ] T031 [P] Add readiness filter to `src/ui/recipes_tab.py` search bar
- [ ] T032 Update recipe creation to default is_production_ready=False
- [ ] T033 Filter production planning dropdowns to show ready recipes (optional)

### Implementation Notes
- Checkbox label: "Production Ready" (unchecked = experimental)
- Filter dropdown: "All" | "Production Ready" | "Experimental"
- New recipes default to experimental per FR-016

### Parallel Opportunities
- T030, T031 can run in parallel (different files)
- Can run parallel with WP02, WP06 after WP01

### Dependencies
- Depends on WP01 (Recipe model with is_production_ready)

### Risks & Mitigations
- User confusion â†’ Clear labeling, tooltip explaining purpose

---

## Work Package WP08: Recipe History View (Priority: P3)

**Goal**: Display snapshot history for a recipe with restore capability.
**Independent Test**: View history, see snapshots with dates; restore creates new recipe.
**Prompt**: `tasks/planned/WP08-recipe-history-view.md`

### Included Subtasks
- [ ] T034 Create `src/ui/views/recipe_history_view.py` dialog
- [ ] T035 Display snapshot list with dates and "(approximated)" badge for backfilled
- [ ] T036 Add "View Details" to show snapshot ingredient data
- [ ] T037 Add "Restore as New Recipe" functionality
- [ ] T038 Add create_recipe_from_snapshot() to snapshot service

### Implementation Notes
- Modal dialog accessible from recipe details or context menu
- List: Date | Scale Factor | Badge (if is_backfilled)
- View Details: Show JSON data in readable format
- Restore: Creates new Recipe template from snapshot JSON

### Parallel Opportunities
- Can run parallel with WP03 after WP02

### Dependencies
- Depends on WP02 (snapshot service)

### Risks & Mitigations
- Performance with many snapshots â†’ Paginate if needed (defer)

---

## Dependency & Execution Summary

- **Sequence**: WP01 â†’ (WP02 || WP06 || WP07) â†’ (WP03 || WP08) â†’ (WP04 || WP05)
- **Parallelization**:
  - After WP01: WP02, WP06, WP07 in parallel
  - After WP02: WP03, WP08 in parallel
  - After WP03: WP04, WP05 in parallel
- **MVP Scope**: WP01 + WP02 + WP03 + WP04 (Core snapshot system)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Create RecipeSnapshot model | WP01 | P1 | Yes |
| T002 | Add variant/ready fields to Recipe | WP01 | P1 | Yes |
| T003 | Add snapshot FK to ProductionRun | WP01 | P1 | Yes |
| T004 | Export RecipeSnapshot in __init__ | WP01 | P1 | No |
| T005 | Unit tests for RecipeSnapshot model | WP01 | P1 | Yes |
| T006 | Create snapshot service with create() | WP02 | P1 | No |
| T007 | Add get_recipe_snapshots() | WP02 | P1 | No |
| T008 | Add get_snapshot_by_production_run() | WP02 | P1 | No |
| T009 | Unit tests for snapshot service | WP02 | P1 | No |
| T010 | Modify record_batch_production() | WP03 | P1 | No |
| T011 | Update cost calculation for snapshot | WP03 | P1 | No |
| T012 | Add scale_factor to production flow | WP03 | P1 | No |
| T013 | Integration tests for production | WP03 | P1 | No |
| T014 | Create migration script | WP04 | P1 | No |
| T015 | Handle is_backfilled flag | WP04 | P1 | No |
| T016 | Add dry-run mode | WP04 | P1 | No |
| T017 | Test migration with sample data | WP04 | P1 | No |
| T018 | Add scale_factor entry to dialog | WP05 | P2 | No |
| T019 | Update expected yield display | WP05 | P2 | No |
| T020 | Show scaled ingredient requirements | WP05 | P2 | No |
| T021 | Validate scale_factor > 0 | WP05 | P2 | No |
| T022 | Add get_recipe_variants() | WP06 | P2 | Yes |
| T023 | Add create_recipe_variant() | WP06 | P2 | Yes |
| T024 | Extend get_all_recipes() | WP06 | P2 | Yes |
| T025 | Add base_recipe dropdown | WP06 | P2 | Yes |
| T026 | Add variant_name field | WP06 | P2 | Yes |
| T027 | Update recipe list indentation | WP06 | P2 | No |
| T028 | Sort variants under base | WP06 | P2 | No |
| T029 | Unit tests for variants | WP06 | P2 | No |
| T030 | Add is_production_ready checkbox | WP07 | P3 | Yes |
| T031 | Add readiness filter to search | WP07 | P3 | Yes |
| T032 | Default new recipes to experimental | WP07 | P3 | No |
| T033 | Filter production planning | WP07 | P3 | No |
| T034 | Create recipe_history_view.py | WP08 | P3 | No |
| T035 | Display snapshot list with badges | WP08 | P3 | No |
| T036 | Add View Details functionality | WP08 | P3 | No |
| T037 | Add Restore as New Recipe | WP08 | P3 | No |
| T038 | Add create_recipe_from_snapshot() | WP08 | P3 | No |
