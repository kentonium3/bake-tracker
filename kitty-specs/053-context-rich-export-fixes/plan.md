# Implementation Plan: Context-Rich Export Fixes

**Branch**: `053-context-rich-export-fixes` | **Date**: 2026-01-15 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/kitty-specs/053-context-rich-export-fixes/spec.md`

## Summary

Fix five usability issues in the context-rich export functionality:
1. Change file prefix from `view_` to `aug_`
2. Add missing entity types (Products, Material Products, Finished Units, Finished Goods)
3. Replace radio buttons with checkboxes for multi-select
4. Add "All" checkbox with select/deselect-all behavior
5. Change button text from "View" to "File"

Additionally, deprecate "view" terminology throughout the code in favor of "context-rich".

## Technical Context

**Language/Version**: Python 3.10+
**Primary Dependencies**: CustomTkinter, SQLAlchemy 2.x
**Storage**: SQLite with WAL mode
**Testing**: pytest
**Target Platform**: Desktop (Windows, macOS, Linux)
**Project Type**: Single desktop application
**Performance Goals**: N/A (sequential export acceptable per user)
**Constraints**: None specific
**Scale/Scope**: Single user desktop app

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. User-Centric Design | ✅ PASS | Multi-select and "All" option improve UX |
| II. Data Integrity | ✅ PASS | Export-only feature; no data modification |
| III. Future-Proof Schema | ✅ PASS | No schema changes |
| IV. Test-Driven Development | ✅ PASS | Service methods will have tests |
| V. Layered Architecture | ✅ PASS | UI changes in UI layer; service changes in service layer |
| VI. Schema Change Strategy | ✅ N/A | No schema changes |
| VII. Pragmatic Aspiration | ✅ PASS | Supports AI-assisted data entry workflow |

**No violations requiring justification.**

## Project Structure

### Documentation (this feature)

```
kitty-specs/053-context-rich-export-fixes/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Research findings
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks/               # Work packages (generated by /spec-kitty.tasks)
```

### Source Code (files to modify)

```
src/
├── services/
│   └── denormalized_export_service.py  # Rename methods, change prefix, add entities
└── ui/
    └── import_export_dialog.py         # Replace radio→checkbox, add "All", fix button text
```

**Structure Decision**: Existing single-project structure; no new directories needed.

## Implementation Approach

### Phase 1: Service Layer Changes

**File**: `src/services/denormalized_export_service.py`

1. **Rename all `*_view` methods to `*_context_rich`**:
   - `export_ingredients_view()` → `export_ingredients_context_rich()`
   - `export_materials_view()` → `export_materials_context_rich()`
   - `export_recipes_view()` → `export_recipes_context_rich()`
   - `export_products_view()` → `export_products_context_rich()`
   - `export_inventory_view()` → `export_inventory_context_rich()`
   - `export_purchases_view()` → `export_purchases_context_rich()`
   - `export_all_views()` → `export_all_context_rich()`

2. **Rename constants**:
   - `*_VIEW_EDITABLE` → `*_CONTEXT_RICH_EDITABLE`
   - `*_VIEW_READONLY` → `*_CONTEXT_RICH_READONLY`

3. **Change file prefix** in all export methods:
   - `view_` → `aug_`
   - Update `view_type` field in JSON output if present

4. **Add new export methods**:
   - `export_material_products_context_rich()` - follow `export_products_context_rich()` pattern
   - `export_finished_units_context_rich()` - include recipe context
   - `export_finished_goods_context_rich()` - include component/assembly context

### Phase 2: UI Layer Changes

**File**: `src/ui/import_export_dialog.py`

1. **Replace radio buttons with checkboxes** in `_setup_context_rich_tab()`:
   - Remove `ctk.CTkRadioButton` widgets
   - Create `ctk.CTkCheckBox` for each entity type
   - Store checkbox variables in dict: `self.context_rich_checkboxes = {}`

2. **Add "All" checkbox**:
   - Position at top of entity list
   - Add separator line below
   - Wire `command` callback to toggle all checkboxes

3. **Update entity list** (7 entities):
   - Ingredients (with products, inventory totals, costs)
   - Products (with ingredient context, supplier, inventory)
   - Recipes (with ingredients, computed costs)
   - Finished Units (with recipe, yield information)
   - Finished Goods (with components, assembly context)
   - Materials (with hierarchy paths, products)
   - Material Products (with material context, supplier)

4. **Implement "All" checkbox logic**:
   - When "All" checked → set all entity checkboxes to checked
   - When "All" unchecked → set all entity checkboxes to unchecked
   - When individual checkbox changes → update "All" state (checked if all selected, unchecked otherwise)

5. **Update export handler** `_export_context_rich()`:
   - Iterate over checked entities
   - Call corresponding service method for each
   - Handle validation (require at least one selection)

6. **Fix button text**:
   - Change from "Export Context-Rich View..." to "Export Context-Rich File..."

7. **Rename variables**:
   - `self.view_var` → remove (no longer single-select)
   - Add `self.context_rich_all_var` for "All" checkbox

### Testing Strategy

1. **Service Layer Tests** (`src/tests/test_denormalized_export_service.py`):
   - Test new method names work
   - Test file prefix is `aug_`
   - Test new entity exports produce valid JSON
   - Test `_meta` sections have correct fields

2. **UI Tests** (manual):
   - Verify checkboxes appear for all 7 entities
   - Verify "All" checkbox toggles all
   - Verify multi-select exports all selected entities
   - Verify validation prevents empty selection
   - Verify button text is correct

## Complexity Tracking

*No violations requiring justification.*

## Dependencies

- No new external dependencies
- Relies on existing CustomTkinter `CTkCheckBox` widget
- Relies on existing model relationships for new entity exports

## Risks

| Risk | Mitigation |
|------|------------|
| Breaking existing export workflows | Keep method signatures compatible; only rename |
| Missing context fields for new entities | Follow existing patterns exactly |
| "All" checkbox behavior confusing | Standard pattern; test with user |
