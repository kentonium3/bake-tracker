# Work Packages: Context-Rich Export Fixes

**Inputs**: Design documents from `/kitty-specs/053-context-rich-export-fixes/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md

**Tests**: Only include explicit testing work when stakeholders request it.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Service Layer Refactoring (Priority: P1) MVP

**Goal**: Rename methods and constants from "view" to "context_rich", change file prefix from `view_` to `aug_`.
**Independent Test**: Existing export functionality works with new method names and produces files with `aug_` prefix.
**Prompt**: `tasks/WP01-service-layer-refactoring.md`

### Included Subtasks
- [ ] T001 [P] Rename `*_VIEW_EDITABLE` constants to `*_CONTEXT_RICH_EDITABLE` in `src/services/denormalized_export_service.py`
- [ ] T002 [P] Rename `*_VIEW_READONLY` constants to `*_CONTEXT_RICH_READONLY` in `src/services/denormalized_export_service.py`
- [ ] T003 Rename all `export_*_view()` methods to `export_*_context_rich()` in `src/services/denormalized_export_service.py`
- [ ] T004 Change file prefix from `view_` to `aug_` in all export method file naming

### Implementation Notes
- Use find/replace for constant renaming (straightforward)
- Method renaming requires updating all internal references and callers
- File prefix change is in the filename construction within each export method
- Update any `view_type` JSON field values if present

### Parallel Opportunities
- T001 and T002 (constant renaming) can proceed in parallel
- T003 and T004 should be done together as they touch the same methods

### Dependencies
- None (starting package)

### Risks & Mitigations
- Breaking existing code that imports these methods: Search for all imports and update callers in UI layer
- Test that exports still work after renaming

---

## Work Package WP02: Service Layer New Exports (Priority: P1)

**Goal**: Add context-rich export methods for Products, Material Products, Finished Units, and Finished Goods.
**Independent Test**: Each new export method produces valid JSON with appropriate `_meta` section and context fields.
**Prompt**: `tasks/WP02-service-layer-new-exports.md`

### Included Subtasks
- [ ] T005 [P] Review and expose `export_products_context_rich()` with proper editable/readonly field definitions
- [ ] T006 [P] Create `export_material_products_context_rich()` following products pattern
- [ ] T007 [P] Create `export_finished_units_context_rich()` with recipe/yield context
- [ ] T008 [P] Create `export_finished_goods_context_rich()` with component/assembly context

### Implementation Notes
- Follow existing patterns from `export_ingredients_context_rich()`
- Each method needs:
  - `*_CONTEXT_RICH_EDITABLE` constant defining editable fields
  - `*_CONTEXT_RICH_READONLY` constant defining readonly context fields
  - Query with eager loading of relationships
  - JSON structure with `_meta`, `version`, `export_date`, `records`
- Reference `test_data/old_view_products.json` for Products structure

### Parallel Opportunities
- All four subtasks (T005-T008) can proceed in parallel as they create separate methods

### Dependencies
- Depends on WP01 (naming conventions established)

### Risks & Mitigations
- Missing relationship data: Ensure models have proper relationships defined
- Inconsistent JSON structure: Follow existing patterns exactly

---

## Work Package WP03: UI Layer Multi-Select (Priority: P1)

**Goal**: Replace radio buttons with checkboxes, add "All" option, fix button text, handle multi-select export.
**Independent Test**: Export dialog shows checkboxes for all 7 entities, "All" toggles correctly, multiple selections export separate files.
**Prompt**: `tasks/WP03-ui-layer-multi-select.md`

### Included Subtasks
- [ ] T009 Replace `ctk.CTkRadioButton` with `ctk.CTkCheckBox` widgets in `_setup_context_rich_tab()`
- [ ] T010 Add "All" checkbox at top of entity list with visual separator
- [ ] T011 Implement "All" checkbox toggle logic (check all / uncheck all)
- [ ] T012 Implement individual checkbox sync (update "All" state when individual changes)
- [ ] T013 Update entity list to include all 7 entity types with descriptions
- [ ] T014 Update `_export_context_rich()` to iterate over selected entities
- [ ] T015 Add validation requiring at least one entity selected
- [ ] T016 Change button text from "Export Context-Rich View..." to "Export Context-Rich File..."

### Implementation Notes
- Create dict `self.context_rich_checkboxes = {}` to store checkbox variables
- Create `self.context_rich_all_var` for "All" checkbox
- Entity list: Ingredients, Products, Recipes, Finished Units, Finished Goods, Materials, Material Products
- Sequential export: loop over checked entities, call corresponding service method for each
- Show message if no entities selected when export clicked

### Parallel Opportunities
- T009-T013 (UI setup) must be done together
- T014-T016 (handler/button changes) can follow once UI is set up

### Dependencies
- Depends on WP01 (method names) and WP02 (new export methods available)

### Risks & Mitigations
- "All" checkbox behavior confusing: Follow standard pattern, test with user
- Export handler errors: Handle each entity export independently, report any failures

---

## Dependency & Execution Summary

- **Sequence**: WP01 -> WP02 -> WP03
- **Parallelization**: WP01 and WP02 can proceed in parallel after initial WP01 naming is established. WP03 requires both WP01 and WP02 complete.
- **MVP Scope**: All three work packages are required for complete feature. WP01 alone provides prefix fix but not new entities or multi-select.

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Rename EDITABLE constants | WP01 | P1 | Yes |
| T002 | Rename READONLY constants | WP01 | P1 | Yes |
| T003 | Rename export methods | WP01 | P1 | No |
| T004 | Change file prefix to aug_ | WP01 | P1 | No |
| T005 | Expose products export | WP02 | P1 | Yes |
| T006 | Create material products export | WP02 | P1 | Yes |
| T007 | Create finished units export | WP02 | P1 | Yes |
| T008 | Create finished goods export | WP02 | P1 | Yes |
| T009 | Replace radio with checkboxes | WP03 | P1 | No |
| T010 | Add "All" checkbox | WP03 | P1 | No |
| T011 | Implement All toggle logic | WP03 | P1 | No |
| T012 | Implement individual sync | WP03 | P1 | No |
| T013 | Update entity list to 7 | WP03 | P1 | No |
| T014 | Update export handler | WP03 | P1 | No |
| T015 | Add validation | WP03 | P1 | No |
| T016 | Fix button text | WP03 | P1 | No |
