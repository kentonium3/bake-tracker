# Work Packages: Recipe Slug Support

**Inputs**: Design documents from `/kitty-specs/080-recipe-slug-support/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: Include tests as specified in FR (slug generation, collision handling, round-trip import/export).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

---

## Work Package WP01: Recipe Model Schema Changes (Priority: P0)

**Goal**: Add `slug` and `previous_slug` columns to Recipe model with proper indexing and auto-generation.
**Independent Test**: Recipe model has new columns; creating a recipe auto-generates a slug.
**Prompt**: `tasks/WP01-recipe-model-schema.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [x] T001: Add `slug` column to Recipe model (String(200), unique, indexed, non-nullable)
- [x] T002: Add `previous_slug` column to Recipe model (String(200), nullable, indexed)
- [x] T003: Add unique index for slug column
- [x] T004: Add event listener for slug auto-generation on insert
- [x] T005: Add model-level validation for slug format

### Implementation Notes
- Copy column pattern from `src/models/supplier.py:82-83`
- Copy event listener pattern from `src/models/supplier.py:183-189`
- Slug format: lowercase, hyphens, alphanumeric only, max 200 chars

### Parallel Opportunities
- T001, T002, T003 can be done together (single file edit)
- T004, T005 build on T001-T003

### Dependencies
- None (foundation work package)

### Risks & Mitigations
- Circular import with RecipeService for slug generation → use lazy import in event listener

---

## Work Package WP02: Recipe Service Slug Generation (Priority: P0)

**Goal**: Implement slug generation methods in RecipeService with collision handling and rename support.
**Independent Test**: `generate_slug()` creates valid slugs; collisions append `-2`, `-3`; rename preserves previous_slug.
**Prompt**: `tasks/WP02-recipe-service-slug.md`
**Estimated Size**: ~480 lines

### Included Subtasks
- [x] T006: Create `_generate_slug(name: str)` static method
- [x] T007: Create `_generate_unique_slug(name: str, session, exclude_id)` method
- [x] T008: Update `create_recipe()` to generate slug if not provided
- [x] T009: Update `update_recipe()` to handle rename (regenerate slug, preserve previous_slug)
- [x] T010: [P] Add unit tests for slug generation from various names
- [x] T011: [P] Add unit tests for collision handling (-2, -3 suffixes)
- [x] T012: [P] Add unit tests for rename behavior (previous_slug preservation)

### Implementation Notes
- Copy `_generate_slug()` from `src/services/finished_unit_service.py:629-652`
- Copy `_generate_unique_slug()` from `src/services/finished_unit_service.py:655-679`
- Use hyphen separator (not underscore like Supplier)
- Max 1000 collision attempts before raising ValidationError

### Parallel Opportunities
- T010, T011, T012 can run in parallel (independent test files)
- T006, T007 must complete before T008, T09

### Dependencies
- Depends on WP01 (Recipe model must have slug columns)

### Risks & Mitigations
- Performance with large recipe counts → indexed slug column enables fast lookups
- Unicode handling → use `unicodedata.normalize("NFKD", ...)` pattern from FinishedUnitService

---

## Work Package WP03: Export Service Updates (Priority: P1)

**Goal**: Add `recipe_slug` to all recipe and FK entity exports; maintain backward compatibility with `recipe_name`.
**Independent Test**: Export creates JSON with both `slug` and `recipe_slug` fields present.
**Prompt**: `tasks/WP03-export-service-updates.md`
**Estimated Size**: ~380 lines

### Included Subtasks
- [x] T013: Add `slug`, `previous_slug` to `_export_recipes()` in coordinated_export_service.py
- [x] T014: Add `component_recipe_slug` to recipe component export (nested in recipes.json)
- [ ] T015: [P] Add `recipe_slug` to `_export_finished_units()` (alongside recipe_name)
- [ ] T016: [P] Add `recipe_slug` to `_export_event_production_targets()` (in events.json)
- [ ] T017: [P] Add `recipe_slug` to `_export_production_runs()` (alongside recipe_name)
- [ ] T018: Add unit test verifying all exports include recipe_slug fields

### Implementation Notes
- File: `src/services/coordinated_export_service.py`
- Pattern: Add slug field alongside existing name field (dual-field export)
- Preserve all existing fields for backward compatibility

### Parallel Opportunities
- T015, T016, T17 can run in parallel (different export functions)
- T013, T014 depend on each other (same function, nested data)

### Dependencies
- Depends on WP02 (Recipe model must have slug populated)

### Risks & Mitigations
- Breaking existing imports → maintain all `recipe_name` fields unchanged

---

## Work Package WP04: Import Service Updates (Priority: P1)

**Goal**: Update all recipe FK imports to resolve via slug first with fallback to previous_slug, then name.
**Independent Test**: Import resolves recipes by slug; falls back to name for legacy exports; logs fallback events.
**Prompt**: `tasks/WP04-import-service-updates.md`
**Estimated Size**: ~480 lines

### Included Subtasks
- [ ] T019: Update `_import_recipes()` in catalog_import_service.py to use/generate slugs
- [ ] T020: Create `_resolve_recipe()` helper with slug → previous_slug → name fallback
- [ ] T021: [P] Update finished_units import to use `_resolve_recipe()` helper
- [ ] T022: [P] Update event_production_targets import to use slug resolution
- [ ] T023: [P] Update production_runs import to use slug resolution
- [ ] T024: Update recipe component import to use `component_recipe_slug` resolution
- [ ] T025: Add logging for fallback resolution (previous_slug and name fallbacks)

### Implementation Notes
- Files: `src/services/catalog_import_service.py`, `src/services/coordinated_export_service.py`
- Resolution order: slug → previous_slug → name (with logging on fallback)
- Generate slug from name if not provided in import file
- Pattern: Build lookup dicts for slug, previous_slug, and name

### Parallel Opportunities
- T021, T22, T023 can run in parallel (different import functions)
- T019, T020 must complete first (core logic)
- T024 depends on T020 (uses same resolution pattern)

### Dependencies
- Depends on WP02 (slug generation methods needed)
- Can run in parallel with WP03 after WP02 completes

### Risks & Mitigations
- Missing recipe on import → log error with clear message, skip record
- Name collision during slug generation → collision handling from WP02

---

## Work Package WP05: Integration Tests & Validation (Priority: P2)

**Goal**: Validate end-to-end export/import round-trip with slugs; verify legacy import compatibility.
**Independent Test**: Full export → fresh DB → import preserves all recipe associations.
**Prompt**: `tasks/WP05-integration-tests.md`
**Estimated Size**: ~320 lines

### Included Subtasks
- [ ] T026: Add round-trip export/import test with slug-enabled recipes
- [ ] T027: Add test for legacy import (no slugs, verify name fallback works)
- [ ] T028: Add test for previous_slug fallback (rename scenario)
- [ ] T029: Add test verifying all FK entities resolve correctly (FinishedUnit, ProductionRun, EventProductionTarget, RecipeComponent)

### Implementation Notes
- File: `src/tests/test_import_export.py` or new `src/tests/test_recipe_slug_integration.py`
- Use pytest fixtures to create test databases
- Test with real JSON export/import cycle

### Parallel Opportunities
- All tests can be written in parallel (independent test cases)

### Dependencies
- Depends on WP03 and WP04 (full export/import functionality needed)

### Risks & Mitigations
- Flaky tests → use deterministic test data, fixed slugs
- Slow tests → use in-memory SQLite for speed

---

## Dependency & Execution Summary

```
WP01: Schema (Foundation) ─────────────┐
                                       │
                                       v
WP02: Service Layer ───────────────────┤
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                      │
                    v                                      v
WP03: Export Updates                   WP04: Import Updates
(can run in parallel)                  (can run in parallel)
                    │                                      │
                    └──────────────────┬──────────────────┘
                                       │
                                       v
                            WP05: Integration Tests
```

- **Sequence**: WP01 → WP02 → (WP03 || WP04) → WP05
- **Parallelization**: WP03 and WP04 can run in parallel after WP02 completes
- **MVP Scope**: WP01 + WP02 + WP03 + WP04 (minimum for functional recipe slugs)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Add slug column to Recipe model | WP01 | P0 | No |
| T002 | Add previous_slug column to Recipe model | WP01 | P0 | No |
| T003 | Add unique index for slug | WP01 | P0 | No |
| T004 | Add event listener for slug auto-generation | WP01 | P0 | No |
| T005 | Add model-level validation | WP01 | P0 | No |
| T006 | Create _generate_slug() method | WP02 | P0 | No |
| T007 | Create _generate_unique_slug() method | WP02 | P0 | No |
| T008 | Update create_recipe() for slug | WP02 | P0 | No |
| T009 | Update update_recipe() for rename | WP02 | P0 | No |
| T010 | Unit tests for slug generation | WP02 | P0 | Yes |
| T011 | Unit tests for collision handling | WP02 | P0 | Yes |
| T012 | Unit tests for rename behavior | WP02 | P0 | Yes |
| T013 | Add slug to _export_recipes() | WP03 | P1 | No |
| T014 | Add component_recipe_slug to exports | WP03 | P1 | No |
| T015 | Add recipe_slug to finished_units export | WP03 | P1 | Yes |
| T016 | Add recipe_slug to event_production_targets | WP03 | P1 | Yes |
| T017 | Add recipe_slug to production_runs export | WP03 | P1 | Yes |
| T018 | Unit test for export changes | WP03 | P1 | No |
| T019 | Update _import_recipes() for slugs | WP04 | P1 | No |
| T020 | Create _resolve_recipe() helper | WP04 | P1 | No |
| T021 | Update finished_units import | WP04 | P1 | Yes |
| T022 | Update event_production_targets import | WP04 | P1 | Yes |
| T023 | Update production_runs import | WP04 | P1 | Yes |
| T024 | Update recipe component import | WP04 | P1 | No |
| T025 | Add logging for fallback resolution | WP04 | P1 | No |
| T026 | Round-trip export/import test | WP05 | P2 | Yes |
| T027 | Legacy import test (name fallback) | WP05 | P2 | Yes |
| T028 | Previous_slug fallback test | WP05 | P2 | Yes |
| T029 | FK entity resolution test | WP05 | P2 | Yes |
