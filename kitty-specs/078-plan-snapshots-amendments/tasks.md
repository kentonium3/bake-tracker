# Work Packages: Plan Snapshots & Amendments

**Inputs**: Design documents from `/kitty-specs/078-plan-snapshots-amendments/`
**Prerequisites**: plan.md (required), spec.md (user stories), data-model.md

**Tests**: Unit tests included for service layer per project constitution (TDD, >70% coverage).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: PlanSnapshot Model Foundation (Priority: P0)

**Goal**: Create the PlanSnapshot database model for storing plan state as JSON.
**Independent Test**: Model can be instantiated, persisted, and queried; Event relationship works.
**Prompt**: `/tasks/WP01-plan-snapshot-model.md`
**Estimated Size**: ~250 lines

### Included Subtasks
- [x] T001 Create PlanSnapshot model in `src/models/plan_snapshot.py`
- [x] T002 Add plan_snapshot relationship to Event model in `src/models/event.py`
- [x] T003 Update `src/models/__init__.py` to export PlanSnapshot
- [x] T004 Write model unit tests in `src/tests/test_plan_snapshot_model.py`

### Implementation Notes
- Follow existing model patterns (BaseModel inheritance, SQLAlchemy 2.x)
- Use JSON column type from `sqlalchemy.dialects.sqlite`
- One snapshot per event (unique constraint on event_id)
- Cascade delete when event is deleted

### Parallel Opportunities
- None - this is foundation work.

### Dependencies
- None (starting package).

### Risks & Mitigations
- JSON column compatibility: SQLite supports JSON natively; use `sqlalchemy.dialects.sqlite.JSON`

---

## Work Package WP02: Snapshot Service & Production Hook (Priority: P0)

**Goal**: Implement snapshot creation service and integrate with start_production() transition.
**Independent Test**: Starting production on a LOCKED event creates a snapshot with correct data.
**Prompt**: `/tasks/WP02-snapshot-service-hook.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [x] T005 Create `src/services/plan_snapshot_service.py` with create_plan_snapshot()
- [x] T006 Implement get_plan_snapshot() for retrieval
- [x] T007 Integrate snapshot creation into start_production() in `src/services/plan_state_service.py`
- [x] T008 Write unit tests for snapshot service in `src/tests/test_plan_snapshot_service.py`
- [x] T009 Write integration test for start_production with snapshot creation

### Implementation Notes
- Follow session=None pattern per CLAUDE.md
- Snapshot JSON schema: {snapshot_version, created_at, recipes, finished_goods, batch_decisions}
- Query EventRecipe, EventFinishedGood, BatchDecision to build snapshot data
- Snapshot creation must happen BEFORE state transition (atomic transaction)

### Parallel Opportunities
- T008 and T009 can be written in parallel after T005-T007.

### Dependencies
- Depends on WP01 (PlanSnapshot model must exist).

### Risks & Mitigations
- Session management: Pass session through to maintain transaction atomicity
- Data consistency: Create snapshot in same transaction as state change

---

## Work Package WP03: Amendment Service (Priority: P1) üéØ MVP

**Goal**: Implement amendment creation with validation and history retrieval.
**Independent Test**: Can create all 3 amendment types (DROP_FG, ADD_FG, MODIFY_BATCH) with validation; history retrieval works.
**Prompt**: `/tasks/WP03-amendment-service.md`
**Estimated Size**: ~450 lines

### Included Subtasks
- [x] T010 Create `src/services/plan_amendment_service.py` with base create_amendment()
- [x] T011 Implement drop_finished_good() with FG existence validation
- [x] T012 Implement add_finished_good() with duplicate detection validation
- [x] T013 Implement modify_batch_decision() with batch decision existence validation
- [x] T014 Implement get_amendments() for chronological history retrieval
- [x] T015 Write comprehensive unit tests in `src/tests/test_plan_amendment_service.py`

### Implementation Notes
- Validate plan_state == IN_PRODUCTION before any amendment
- Validate reason is non-empty
- DROP_FG: Delete EventFinishedGood record, store original quantity in amendment
- ADD_FG: Insert EventFinishedGood record, validate FG doesn't already exist
- MODIFY_BATCH: Update BatchDecision record, store old/new batch counts
- Use existing PlanAmendment model from F068 (no model changes needed)

### Parallel Opportunities
- T011, T012, T013 can be implemented in parallel (different amendment types)
- Can run in parallel with WP04 (Amendment UI) after WP02 completes

### Dependencies
- Depends on WP02 (snapshot must exist before amendments make sense).

### Risks & Mitigations
- Data integrity: Validate state and existence before each amendment
- Session management: Follow session=None pattern consistently

---

## Work Package WP04: Amendment UI Controls (Priority: P1)

**Goal**: Add amendment controls and history panel to Planning Tab UI.
**Independent Test**: Can create amendments via UI; history displays correctly.
**Prompt**: `/tasks/WP04-amendment-ui.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [x] T016 Add amendment controls panel frame to `src/ui/planning_tab.py`
- [ ] T017 Implement DROP_FG dialog with FG selection and reason entry
- [ ] T018 Implement ADD_FG dialog with available FG selection and quantity/reason entry
- [ ] T019 Implement MODIFY_BATCH dialog with recipe selection, batch adjustment, and reason
- [ ] T020 Add amendment history panel showing chronological amendment list

### Implementation Notes
- Amendment controls only visible/enabled when plan_state == IN_PRODUCTION
- Use CTkInputDialog or custom dialogs for reason entry
- History panel shows: type, summary, reason, timestamp
- Follow existing planning_tab.py patterns for frame structure
- Wire to plan_amendment_service functions

### Parallel Opportunities
- T017, T018, T19 dialog implementations can be done in parallel
- WP04 can run in parallel with WP03 (Amendment Service) after WP02 completes

### Dependencies
- Depends on WP02 (need snapshot to exist for amendments to make sense)
- Depends on WP03 for service layer (but can develop UI shell in parallel)

### Risks & Mitigations
- UI complexity: Keep dialogs simple; progressive disclosure for advanced options
- State synchronization: Refresh UI after each amendment

---

## Work Package WP05: Comparison View & Integration (Priority: P2)

**Goal**: Implement plan comparison view showing original vs current with highlighted differences.
**Independent Test**: Comparison view correctly shows dropped FGs, added FGs, and modified batches.
**Prompt**: `/tasks/WP05-comparison-view.md`
**Estimated Size**: ~450 lines

### Included Subtasks
- [ ] T021 Create comparison dataclasses in `src/services/plan_snapshot_service.py`
- [ ] T022 Implement get_plan_comparison() function returning structured diff
- [ ] T023 Add comparison view panel to `src/ui/planning_tab.py`
- [ ] T024 Implement visual diff highlighting for FG changes (added/dropped)
- [ ] T025 Implement visual diff highlighting for batch decision changes
- [ ] T026 Integration test of full workflow: lock ‚Üí start production ‚Üí amend ‚Üí compare

### Implementation Notes
- Comparison dataclasses: PlanComparison, FGComparisonItem, BatchComparisonItem
- Compare snapshot JSON against current EventFinishedGood/BatchDecision records
- Visual indicators: green for added, red for dropped, yellow for modified
- Comparison panel expandable/collapsible to avoid UI clutter

### Parallel Opportunities
- T24 and T25 highlighting implementations can be done in parallel

### Dependencies
- Depends on WP02 (snapshot service)
- Depends on WP03 (amendments modify live data)
- Depends on WP04 (amendments via UI)

### Risks & Mitigations
- JSON schema evolution: Include snapshot_version field for future compatibility
- Performance: Lazy load comparison view; don't compute on every refresh

---

## Dependency & Execution Summary

```
WP01 (Model) ‚Üí WP02 (Service+Hook)
                    ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚Üì           ‚Üì
        WP03 (Service) ‚à• WP04 (UI)  [PARALLEL]
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
             WP05 (Comparison)
```

- **Sequence**: WP01 ‚Üí WP02 ‚Üí [WP03 || WP04] ‚Üí WP05
- **Parallelization**: WP03 and WP04 can run in parallel after WP02 completes
- **MVP Scope**: WP01 + WP02 + WP03 (service layer complete; UI can follow)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Create PlanSnapshot model | WP01 | P0 | No |
| T002 | Add Event relationship | WP01 | P0 | No |
| T003 | Update model exports | WP01 | P0 | No |
| T004 | Model unit tests | WP01 | P0 | No |
| T005 | create_plan_snapshot() | WP02 | P0 | No |
| T006 | get_plan_snapshot() | WP02 | P0 | No |
| T007 | Hook into start_production() | WP02 | P0 | No |
| T008 | Snapshot service unit tests | WP02 | P0 | Yes |
| T009 | Integration test | WP02 | P0 | Yes |
| T010 | create_amendment() base | WP03 | P1 | No |
| T011 | drop_finished_good() | WP03 | P1 | Yes |
| T012 | add_finished_good() | WP03 | P1 | Yes |
| T013 | modify_batch_decision() | WP03 | P1 | Yes |
| T014 | get_amendments() | WP03 | P1 | No |
| T015 | Amendment service tests | WP03 | P1 | No |
| T016 | Amendment controls panel | WP04 | P1 | No |
| T017 | DROP_FG dialog | WP04 | P1 | Yes |
| T018 | ADD_FG dialog | WP04 | P1 | Yes |
| T019 | MODIFY_BATCH dialog | WP04 | P1 | Yes |
| T020 | Amendment history panel | WP04 | P1 | No |
| T021 | Comparison dataclasses | WP05 | P2 | No |
| T022 | get_plan_comparison() | WP05 | P2 | No |
| T023 | Comparison view panel | WP05 | P2 | No |
| T024 | FG diff highlighting | WP05 | P2 | Yes |
| T025 | Batch diff highlighting | WP05 | P2 | Yes |
| T026 | Full workflow integration test | WP05 | P2 | No |
