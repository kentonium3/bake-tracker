# Work Packages: Plan State Management

**Inputs**: Design documents from `/kitty-specs/077-plan-state-management/`
**Prerequisites**: plan.md (required), spec.md (user stories)

**Tests**: Unit tests for service layer, integration tests for guard behavior.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Plan State Service (Priority: P0) ðŸŽ¯ MVP

**Goal**: Create the plan state transition service with validation logic and exception handling.
**Independent Test**: Service methods correctly transition states and reject invalid transitions.
**Prompt**: `/tasks/WP01-plan-state-service.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [x] T001 Add PlanStateError exception to `src/services/exceptions.py`
- [x] T002 Create `src/services/plan_state_service.py` with get_plan_state() helper
- [x] T003 Implement lock_plan() transition function (DRAFT â†’ LOCKED)
- [x] T004 Implement start_production() and complete_production() transitions
- [x] T005 Write unit tests in `src/tests/test_plan_state_service.py`

### Implementation Notes
- Follow existing service patterns (session=None parameter, session_scope usage)
- Each transition function validates current state before proceeding
- Return updated Event object after successful transition

### Parallel Opportunities
- None - subtasks are sequential within this WP

### Dependencies
- None (foundation package)

### Risks & Mitigations
- State inconsistency â†’ Use atomic transactions via session_scope

---

## Work Package WP02: Modification Guards (Priority: P1)

**Goal**: Add state-based modification guards to existing service functions.
**Independent Test**: Recipe/FG changes blocked when not DRAFT; batch decisions allowed in DRAFT+LOCKED.
**Prompt**: `/tasks/WP02-modification-guards.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [x] T006 Add state check to `set_event_recipes()` in `src/services/event_service.py`
- [x] T007 Add state check to `set_event_fg_quantities()` in `src/services/event_service.py`
- [x] T008 Add state check to `save_batch_decisions()` in `src/services/batch_decision_service.py`
- [x] T009 Write integration tests in `src/tests/integration/test_plan_state_guards.py`
- [x] T010 [P] Update UI error handling in `src/ui/planning_tab.py` save handlers

### Implementation Notes
- Import PlanStateError from exceptions.py
- Recipe/FG functions: Only allow DRAFT state
- Batch decisions: Allow DRAFT or LOCKED states
- Catch and display PlanStateError in UI with user-friendly message

### Parallel Opportunities
- T010 can be done in parallel once T006-T008 are complete

### Dependencies
- Depends on WP01 (needs PlanStateError and plan_state_service)

### Risks & Mitigations
- Breaking existing tests â†’ Run full test suite after each change
- UI error handling â†’ Test with manual UI testing

---

## Work Package WP03: UI Integration (Priority: P2)

**Goal**: Add state display and transition controls to the Planning Tab.
**Independent Test**: State indicator visible, transition buttons work, invalid actions disabled.
**Prompt**: `/tasks/WP03-ui-integration.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [x] T011 Add state indicator frame to `src/ui/planning_tab.py`
- [x] T012 Add transition buttons (Lock Plan, Start Production, Complete)
- [x] T013 Wire button click handlers to plan_state_service calls
- [x] T014 Implement button enable/disable logic based on current state
- [x] T015 Show/hide state controls based on event selection

### Implementation Notes
- Add new row in grid layout for state controls
- Use CTkButton for transition buttons
- Update state display when event selection changes
- Refresh state after successful transitions

### Parallel Opportunities
- None - UI components must be built sequentially

### Dependencies
- Depends on WP01 (needs plan_state_service)
- Depends on WP02 (guards should be in place before UI exposes transitions)

### Risks & Mitigations
- Layout issues â†’ Test on different screen sizes
- State sync â†’ Always refresh from database after transitions

---

## Dependency & Execution Summary

- **Sequence**: WP01 â†’ WP02 â†’ WP03
- **Parallelization**: WP02 and WP03 can run in parallel after WP01 completes (WP02 is service layer, WP03 is UI layer - minimal overlap)
- **MVP Scope**: WP01 provides the core state machine; WP02 enforces rules; WP03 makes it user-accessible

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Add PlanStateError exception | WP01 | P0 | No |
| T002 | Create plan_state_service.py | WP01 | P0 | No |
| T003 | Implement lock_plan() | WP01 | P0 | No |
| T004 | Implement start/complete_production() | WP01 | P0 | No |
| T005 | Write unit tests | WP01 | P0 | No |
| T006 | Guard set_event_recipes() | WP02 | P1 | No |
| T007 | Guard set_event_fg_quantities() | WP02 | P1 | No |
| T008 | Guard save_batch_decisions() | WP02 | P1 | No |
| T009 | Write integration tests | WP02 | P1 | No |
| T010 | Update UI error handling | WP02 | P1 | Yes |
| T011 | Add state indicator frame | WP03 | P2 | No |
| T012 | Add transition buttons | WP03 | P2 | No |
| T013 | Wire button handlers | WP03 | P2 | No |
| T014 | Button enable/disable logic | WP03 | P2 | No |
| T015 | Show/hide on event selection | WP03 | P2 | No |
