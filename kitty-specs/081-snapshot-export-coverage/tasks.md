# Work Packages: Snapshot Export Coverage

**Inputs**: Design documents from `/kitty-specs/081-snapshot-export-coverage/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md
**Feature**: F081 - Add export/import support for RecipeSnapshot, FinishedGoodSnapshot, MaterialUnitSnapshot, and FinishedUnitSnapshot entities

**Tests**: Comprehensive test suite required per spec success criteria SC-007.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`.

---

## Work Package WP01: Recipe & FinishedGood Snapshot Export (Priority: P0)

**Goal**: Add export functions for RecipeSnapshot and FinishedGoodSnapshot entities to coordinated_export_service.py
**Independent Test**: Export produces recipe_snapshots.json and finished_good_snapshots.json with correct structure
**Prompt**: `/tasks/WP01-recipe-finishedgood-snapshot-export.md`
**Estimated Lines**: ~350

### Included Subtasks
- [x] T001 Add RecipeSnapshot model import and DEPENDENCY_ORDER entry
- [x] T002 Implement `_export_recipe_snapshots()` function
- [x] T003 Add FinishedGoodSnapshot model import and DEPENDENCY_ORDER entry
- [x] T004 Implement `_export_finished_good_snapshots()` function
- [x] T005 Update `_export_complete_impl()` to call both export functions

### Implementation Notes
- Follow existing `_export_finished_units()` pattern exactly
- Use joinedload for parent entity (Recipe, FinishedGood)
- Export FK as slug (recipe_slug, finished_good_slug)
- Order by snapshot_date (oldest first) per FR-015
- Preserve UUID and JSON data exactly per FR-010, FR-012

### Parallel Opportunities
- T001/T002 (RecipeSnapshot) and T003/T004 (FinishedGoodSnapshot) can be implemented in parallel

### Dependencies
- None (starting package)

### Risks & Mitigations
- Parent entity without slug: Use existing slug field (all parents have slugs per F080)

---

## Work Package WP02: MaterialUnit & FinishedUnit Snapshot Export (Priority: P0)

**Goal**: Add export functions for MaterialUnitSnapshot and FinishedUnitSnapshot entities
**Independent Test**: Export produces material_unit_snapshots.json and finished_unit_snapshots.json
**Prompt**: `/tasks/WP02-materialunit-finishedunit-snapshot-export.md`
**Estimated Lines**: ~350

### Included Subtasks
- [x] T006 Add MaterialUnitSnapshot model import and DEPENDENCY_ORDER entry
- [x] T007 Implement `_export_material_unit_snapshots()` function
- [x] T008 Add FinishedUnitSnapshot model import and DEPENDENCY_ORDER entry
- [x] T009 Implement `_export_finished_unit_snapshots()` function
- [x] T010 Complete export orchestration and verify manifest includes all 4 snapshot files

### Implementation Notes
- Follow same pattern as WP01
- MaterialUnit ‚Üí material_unit_slug FK resolution
- FinishedUnit ‚Üí finished_unit_slug FK resolution
- Manifest update happens automatically via _write_entity_file()

### Parallel Opportunities
- T006/T007 and T008/T009 can proceed in parallel
- WP02 can start immediately after WP01 begins (no hard dependency)

### Dependencies
- Soft dependency on WP01 (same file, coordinate edits)

### Risks & Mitigations
- File conflict with WP01: Coordinate or serialize implementation

---

## Work Package WP03: Recipe & FinishedGood Snapshot Import (Priority: P0)

**Goal**: Add import handlers for RecipeSnapshot and FinishedGoodSnapshot entities
**Independent Test**: Import recipe_snapshots.json and finished_good_snapshots.json with FK resolution
**Prompt**: `/tasks/WP03-recipe-finishedgood-snapshot-import.md`
**Estimated Lines**: ~400

### Included Subtasks
- [x] T011 Add snapshot model imports to import section and update delete order
- [x] T012 Implement `recipe_snapshots` import handler in `_import_entity_records()`
- [x] T013 Implement `finished_good_snapshots` import handler
- [x] T014 Add warning logging for missing parent entities (FR-013)

### Implementation Notes
- Delete snapshots BEFORE parent entities in `_import_complete_impl()`
- Resolve FK via slug lookup (recipe_slug ‚Üí recipe_id)
- Skip with warning if parent not found (don't fail entire import)
- Preserve exact UUID from export (no regeneration)
- Preserve exact timestamp (no modification)
- Preserve JSON data exactly (no transformation)

### Parallel Opportunities
- T012 and T013 can be implemented in parallel after T011

### Dependencies
- Depends on WP01 (export functions must exist for testing)

### Risks & Mitigations
- Missing parent: Skip with logger.warning(), continue import per FR-013

---

## Work Package WP04: MaterialUnit & FinishedUnit Snapshot Import (Priority: P0)

**Goal**: Complete import handlers for all 4 snapshot types
**Independent Test**: Full import of all 4 snapshot JSON files succeeds
**Prompt**: `/tasks/WP04-materialunit-finishedunit-snapshot-import.md`
**Estimated Lines**: ~350

### Included Subtasks
- [ ] T015 Implement `material_unit_snapshots` import handler
- [ ] T016 Implement `finished_unit_snapshots` import handler
- [ ] T017 Verify complete delete order includes all 4 snapshot types
- [ ] T018 Manual smoke test: export ‚Üí clear ‚Üí import cycle

### Implementation Notes
- Follow same pattern as WP03
- MaterialUnit slug lookup via material_unit_slug
- FinishedUnit slug lookup via finished_unit_slug
- Verify delete order: snapshots deleted before their parents

### Parallel Opportunities
- T015 and T016 can be implemented in parallel

### Dependencies
- Depends on WP02 (MaterialUnit/FinishedUnit exports)
- Depends on WP03 (import infrastructure in place)

### Risks & Mitigations
- Delete order wrong: Manually verify in code review

---

## Work Package WP05: Comprehensive Test Suite (Priority: P1) üéØ MVP Complete

**Goal**: Complete test coverage for all export/import functionality
**Independent Test**: All tests pass, round-trip integrity verified
**Prompt**: `/tasks/WP05-comprehensive-test-suite.md`
**Estimated Lines**: ~450

### Included Subtasks
- [ ] T019 Create test fixtures for all 4 snapshot types
- [ ] T020 Write export unit tests (verify JSON structure)
- [ ] T021 Write import unit tests (verify FK resolution)
- [ ] T022 Write round-trip integration test (export ‚Üí import ‚Üí export ‚Üí compare)
- [ ] T023 Write edge case tests (missing parent, empty export, duplicate UUID)

### Implementation Notes
- Place tests in `src/tests/test_snapshot_export_import.py`
- Use existing test patterns from `test_export_recipe_slug.py` (F080)
- Test fixtures should create realistic snapshot data with JSON blobs
- Round-trip test must verify UUID, timestamp, and JSON data match exactly

### Parallel Opportunities
- T020 (export tests) and T021 (import tests) can be written in parallel

### Dependencies
- Depends on WP04 (all implementation complete)

### Risks & Mitigations
- Test isolation: Use separate test database, clean up after each test

---

## Dependency & Execution Summary

```
WP01 (Recipe/FG Export) ‚îÄ‚îÄ‚îê
                          ‚îú‚îÄ‚îÄ‚ñ∫ WP03 (Recipe/FG Import) ‚îÄ‚îÄ‚îê
WP02 (MU/FU Export) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                              ‚îú‚îÄ‚îÄ‚ñ∫ WP05 (Tests)
                          ‚îî‚îÄ‚îÄ‚ñ∫ WP04 (MU/FU Import) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

- **Sequence**: WP01 ‚Üí WP03 ‚Üí WP05 (main path), WP02 can parallel with WP01
- **Parallelization**: WP01 and WP02 can run concurrently (different snapshot types)
- **MVP Scope**: All 5 WPs required for feature completion (data integrity is non-negotiable)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Add RecipeSnapshot import + DEPENDENCY_ORDER | WP01 | P0 | No |
| T002 | Implement `_export_recipe_snapshots()` | WP01 | P0 | Yes |
| T003 | Add FinishedGoodSnapshot import + DEPENDENCY_ORDER | WP01 | P0 | Yes |
| T004 | Implement `_export_finished_good_snapshots()` | WP01 | P0 | Yes |
| T005 | Update `_export_complete_impl()` | WP01 | P0 | No |
| T006 | Add MaterialUnitSnapshot import + DEPENDENCY_ORDER | WP02 | P0 | No |
| T007 | Implement `_export_material_unit_snapshots()` | WP02 | P0 | Yes |
| T008 | Add FinishedUnitSnapshot import + DEPENDENCY_ORDER | WP02 | P0 | Yes |
| T009 | Implement `_export_finished_unit_snapshots()` | WP02 | P0 | Yes |
| T010 | Complete export orchestration | WP02 | P0 | No |
| T011 | Add import section imports + delete order | WP03 | P0 | No |
| T012 | Implement recipe_snapshots import handler | WP03 | P0 | Yes |
| T013 | Implement finished_good_snapshots import handler | WP03 | P0 | Yes |
| T014 | Add missing parent warning logging | WP03 | P0 | No |
| T015 | Implement material_unit_snapshots import handler | WP04 | P0 | Yes |
| T016 | Implement finished_unit_snapshots import handler | WP04 | P0 | Yes |
| T017 | Verify complete delete order | WP04 | P0 | No |
| T018 | Manual smoke test | WP04 | P0 | No |
| T019 | Create test fixtures | WP05 | P1 | No |
| T020 | Write export unit tests | WP05 | P1 | Yes |
| T021 | Write import unit tests | WP05 | P1 | Yes |
| T022 | Write round-trip integration test | WP05 | P1 | No |
| T023 | Write edge case tests | WP05 | P1 | No |
