# Implementation Plan: Snapshot Export Coverage

**Branch**: `081-snapshot-export-coverage` | **Date**: 2026-01-28 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/kitty-specs/081-snapshot-export-coverage/spec.md`

## Summary

Add export/import support for 4 snapshot entity types (RecipeSnapshot, FinishedGoodSnapshot, MaterialUnitSnapshot, FinishedUnitSnapshot) to preserve cost history audit trail during data migrations. Implementation follows existing patterns in coordinated_export_service.py.

## Technical Context

**Language/Version**: Python 3.10+
**Primary Dependencies**: SQLAlchemy 2.x, pytest
**Storage**: SQLite with WAL mode
**Testing**: pytest with coverage
**Target Platform**: Desktop (Windows/macOS)
**Project Type**: Single project with layered architecture
**Performance Goals**: Export 1000 snapshots in <5s, Import 1000 snapshots in <10s
**Constraints**: Must preserve UUID, timestamps, and JSON data exactly

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. User-Centric Design | ✅ Pass | Feature ensures data integrity for migrations |
| II. Data Integrity & FIFO | ✅ Pass | Preserves cost history audit trail - core requirement |
| III. Future-Proof Schema | ✅ Pass | Uses existing slug-based FK pattern from F080 |
| IV. Test-Driven Development | ✅ Pass | Plan includes comprehensive tests |
| V. Layered Architecture | ✅ Pass | Extends service layer, no UI changes |
| VI. Schema Change Strategy | ✅ Pass | Export/import supports reset/reimport cycle |
| VII. Pragmatic Aspiration | ✅ Pass | Essential for web migration data portability |

**No violations. Proceed with implementation.**

## Project Structure

### Documentation (this feature)

```
kitty-specs/081-snapshot-export-coverage/
├── plan.md              # This file
├── research.md          # Snapshot model analysis and patterns
├── data-model.md        # Entity definitions and FK resolution
├── spec.md              # Feature specification
├── checklists/
│   └── requirements.md  # Quality validation checklist
└── tasks/               # Work package prompts (generated by /spec-kitty.tasks)
```

### Source Code (repository root)

```
src/
├── models/
│   ├── recipe_snapshot.py           # Existing (F037)
│   ├── finished_good_snapshot.py    # Existing (F064)
│   ├── material_unit_snapshot.py    # Existing (F064)
│   └── finished_unit_snapshot.py    # Existing (F064)
└── services/
    └── coordinated_export_service.py  # MODIFY: Add 4 export + 4 import functions

tests/
├── unit/
│   └── test_snapshot_export.py      # NEW: Export/import unit tests
└── integration/
    └── test_snapshot_roundtrip.py   # NEW: Round-trip integration tests
```

**Structure Decision**: Single project structure, extending existing services layer.

## Implementation Approach

### Phase 1: Export Functions (WP01-WP02)

Add 4 export functions to `coordinated_export_service.py`:

1. `_export_recipe_snapshots()` - Export with recipe_slug FK resolution
2. `_export_finished_good_snapshots()` - Export with finished_good_slug FK resolution
3. `_export_material_unit_snapshots()` - Export with material_unit_slug FK resolution
4. `_export_finished_unit_snapshots()` - Export with finished_unit_slug FK resolution

Each function:
- Queries all snapshots with joinedload for parent entity
- Builds records list with slug-based FK resolution
- Orders by snapshot_date (oldest first)
- Returns FileEntry via `_write_entity_file()`

### Phase 2: Import Functions (WP03-WP04)

Add 4 entity_type handlers in `_import_entity_records()`:

1. `recipe_snapshots` - Resolve recipe_slug → recipe_id
2. `finished_good_snapshots` - Resolve finished_good_slug → finished_good_id
3. `material_unit_snapshots` - Resolve material_unit_slug → material_unit_id
4. `finished_unit_snapshots` - Resolve finished_unit_slug → finished_unit_id

Each handler:
- Looks up parent entity by slug
- Skips with warning if parent not found
- Creates snapshot with exact UUID, timestamp, and JSON data
- Increments imported_count

### Phase 3: Orchestration Updates (WP02, WP04)

**Export orchestration** (`_export_complete_impl`):
- Add 4 export function calls after their parent entities
- Update DEPENDENCY_ORDER with new entity types

**Import orchestration** (delete order in `_import_complete_impl`):
- Add deletion of snapshot tables in correct order (before parents)

### Phase 4: Testing (WP05)

Unit tests:
- Export produces correct JSON structure
- Import resolves FK correctly
- Missing parent handling (skip + warning)
- UUID/timestamp preservation

Integration tests:
- Full round-trip: export → import → re-export → compare
- Manifest includes snapshot file counts
- Empty snapshot export (zero records)

## Key Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| FK Resolution | Slug-based | Follows F080 pattern, portable across databases |
| Missing Parent | Skip + warning | Partial imports continue, matches existing behavior |
| UUID Handling | Preserve exactly | Required for referential integrity |
| JSON Data | No transformation | Historical data must be exact replicas |
| Export Order | Chronological | Maintains audit trail progression |

## Dependency Order (DEPENDENCY_ORDER additions)

```python
# New entries in DEPENDENCY_ORDER
"recipe_snapshots": (19, ["recipes"]),
"finished_good_snapshots": (20, ["finished_goods"]),
"material_unit_snapshots": (21, ["material_units"]),
"finished_unit_snapshots": (22, ["finished_units"]),
```

## File Modifications Summary

| File | Changes |
|------|---------|
| `src/services/coordinated_export_service.py` | Add 4 export functions, 4 import handlers, update DEPENDENCY_ORDER, update orchestration |
| `src/tests/test_snapshot_export.py` | NEW: Unit tests for export functions |
| `src/tests/test_snapshot_import.py` | NEW: Unit tests for import handlers |
| `src/tests/test_snapshot_roundtrip.py` | NEW: Integration tests |

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Parent not found | Skip + warning log, continue import |
| Large snapshot count | Chronological ordering, no memory issues |
| JSON malformed | Preserve as-is, no validation |

## Success Criteria Mapping

| Success Criteria | Implementation |
|------------------|----------------|
| SC-001: All 4 types export | WP01-WP02 export functions |
| SC-002: All 4 types import | WP03-WP04 import handlers |
| SC-003: Round-trip integrity | WP05 integration test |
| SC-004: Export <5s/1000 | Simple query + write pattern |
| SC-005: Import <10s/1000 | Batch processing pattern |
| SC-006: Missing parent = warning | Skip + logger.warning() |
| SC-007: Zero failing tests | WP05 comprehensive tests |
| SC-008: Manifest counts | WP02 manifest update |

## Complexity Tracking

*No constitution violations. Table not applicable.*
