# Work Packages: Service Session Consistency Hardening

**Feature**: 062-service-session-consistency-hardening
**Inputs**: Design documents from `/kitty-specs/062-service-session-consistency-hardening/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md

**Tests**: Test updates are required to pass session parameters and verify transaction behavior.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

---

## Work Package WP01: UI Session Infrastructure (Priority: P0) ðŸŽ¯ Foundation

**Goal**: Create session context manager utilities in the UI layer to enable callers to manage session lifecycle before services require session parameters.

**Independent Test**: A UI component can wrap service calls in `with ui_session() as session:` and pass the session to services.

**Prompt**: `tasks/WP01-ui-session-infrastructure.md`

### Included Subtasks
- [x] T001 Create `src/ui/utils/__init__.py` if not exists
- [x] T002 Create `src/ui/utils/session_utils.py` with `ui_session()` context manager
- [x] T003 Add type hints and docstrings documenting usage pattern
- [x] T004 Create unit test for `ui_session()` in `src/tests/test_ui_session_utils.py`

### Implementation Notes
- Use `session_scope()` from `src/services/database.py` internally
- Pattern: `with ui_session() as session:` yields a session for passing to services
- Include example usage in docstring
- Re-export from `src/ui/utils/__init__.py` for convenient imports

### Parallel Opportunities
- This WP has no parallel tasks; it must complete before all service WPs.

### Dependencies
- None (starting package).

### Risks & Mitigations
- **Risk**: Import cycles between ui and services â†’ **Mitigation**: Only import from `src.services.database`, not service modules

---

## Work Package WP02: Event Service CRUD Operations (Priority: P1)

**Goal**: Add required session parameter to all event CRUD functions and update their callers.

**Independent Test**: Event CRUD operations work within a transaction and roll back correctly on error.

**Prompt**: `tasks/WP02-event-service-crud.md`

### Included Subtasks
- [x] T005 Add required `session` param to: `create_event`, `get_event_by_id`, `get_event_by_name`, `get_all_events`
- [x] T006 Add required `session` param to: `get_events_by_year`, `get_available_years`, `update_event`, `delete_event`
- [x] T007 Remove internal `session_scope()` from all CRUD functions
- [x] T008 Update UI callers in `src/ui/events_tab.py`, `src/ui/forms/event_form.py`
- [x] T009 Update UI callers in `src/ui/event_detail_window.py`, `src/ui/dashboards/plan_dashboard.py`
- [x] T010 Update tests in `src/tests/test_services.py` for event CRUD

### Implementation Notes
- Change `session=None` to required `session: Session` parameter
- Remove `with session_scope() as session:` wrapper, use provided session directly
- UI callers wrap operations in `with ui_session() as session:`
- Tests use `session_scope()` fixture to provide session

### Parallel Opportunities
- T005-T007 (service changes) can be done together
- T008-T009 (UI changes) can be done together after service changes

### Dependencies
- Depends on WP01 (ui_session utility must exist).

### Risks & Mitigations
- **Risk**: Many callers to update â†’ **Mitigation**: Search for function names, update systematically

---

## Work Package WP03: Event Service Assignment Operations (Priority: P1)

**Goal**: Add required session parameter to event assignment functions and update their callers.

**Independent Test**: Package-to-recipient assignments work within a transaction.

**Prompt**: `tasks/WP03-event-service-assignments.md`

### Included Subtasks
- [x] T011 Add required `session` param to: `assign_package_to_recipient`, `update_assignment`, `remove_assignment`
- [x] T012 Add required `session` param to: `get_event_assignments`, `get_recipient_assignments_for_event`
- [x] T013 Remove internal `session_scope()` from all assignment functions
- [x] T014 Update UI callers in `src/ui/forms/assignment_form.py`, `src/ui/packaging_assignment_dialog.py`
- [x] T015 Update tests for assignment functions

### Implementation Notes
- Same pattern as WP02: required session, remove internal scope
- Assignment form and packaging dialog are primary callers

### Parallel Opportunities
- T011-T013 (service changes) parallel with each other

### Dependencies
- Depends on WP01.

### Risks & Mitigations
- **Risk**: Assignment dialog may have complex flows â†’ **Mitigation**: Ensure single session wraps entire assignment operation

---

## Work Package WP04: Event Service Calculation Operations (Priority: P1)

**Goal**: Add required session parameter to event calculation and summary functions.

**Independent Test**: Cost and count calculations work within a transaction with consistent reads.

**Prompt**: `tasks/WP04-event-service-calculations.md`

### Included Subtasks
- [x] T016 Add required `session` param to: `get_event_total_cost`, `get_event_recipient_count`, `get_event_package_count`
- [x] T017 Add required `session` param to: `get_event_summary`, `get_recipe_needs`, `get_event_cost_analysis`
- [x] T018 Remove internal `session_scope()` from all calculation functions
- [x] T019 Update UI callers (event cards, dashboards, detail views)
- [x] T020 Update tests for calculation functions

### Implementation Notes
- `get_event_summary` and `get_event_cost_analysis` are complex aggregations
- Ensure session is threaded through to any sub-queries
- Dashboard and card components frequently call these

### Parallel Opportunities
- T016-T018 can proceed together

### Dependencies
- Depends on WP01.

### Risks & Mitigations
- **Risk**: Complex aggregation queries â†’ **Mitigation**: Verify all sub-queries use provided session

---

## Work Package WP05: Event Service Progress Operations (Priority: P1)

**Goal**: Add required session parameter to progress tracking functions with proper session threading.

**Independent Test**: Progress queries return consistent data when called within a transaction.

**Prompt**: `tasks/WP05-event-service-progress.md`

### Included Subtasks
- [x] T021 Add required `session` param to `get_event_overall_progress`
- [x] T022 Add required `session` param to `get_events_with_progress` and thread session to sub-calls
- [x] T023 Remove internal `session_scope()` and ensure session threading to `get_production_progress`, `get_assembly_progress`
- [x] T024 Update UI callers in dashboards and event views
- [x] T025 Update tests and add transaction consistency test

### Implementation Notes
- `get_events_with_progress` currently calls other functions outside session (line 2261-2267)
- Must thread session through ALL sub-calls for atomic reads
- `get_production_progress` and `get_assembly_progress` already accept session=None

### Parallel Opportunities
- Limited - session threading requires careful sequencing

### Dependencies
- Depends on WP01.

### Risks & Mitigations
- **Risk**: Complex session threading â†’ **Mitigation**: Trace call chain carefully, test with uncommitted data

---

## Work Package WP06: Event Service Target & Status Operations (Priority: P1)

**Goal**: Add required session parameter to production/assembly target and fulfillment status functions.

**Independent Test**: Target setting and status updates work within a transaction.

**Prompt**: `tasks/WP06-event-service-targets.md`

### Included Subtasks
- [x] T026 Add required `session` param to: `set_production_target`, `set_assembly_target`, `get_production_targets`, `get_assembly_targets`
- [x] T027 Add required `session` param to: `delete_production_target`, `delete_assembly_target`
- [x] T028 Add required `session` param to: `update_fulfillment_status`, `get_packages_by_status`
- [x] T029 Remove internal `session_scope()` from all target/status functions
- [x] T030 Update UI callers and tests

### Implementation Notes
- Target functions are used in planning views
- Status functions are used in event detail and delivery tracking

### Parallel Opportunities
- T026-T029 can proceed together

### Dependencies
- Depends on WP01.

### Risks & Mitigations
- **Risk**: Status updates may trigger cascading changes â†’ **Mitigation**: Ensure all cascades use same session

---

## Work Package WP07: Event Service Remaining Operations (Priority: P1)

**Goal**: Add required session parameter to remaining event service functions (clone, export, packaging).

**Independent Test**: Event cloning and packaging queries work within a transaction.

**Prompt**: `tasks/WP07-event-service-remaining.md`

### Included Subtasks
- [x] T031 Add required `session` param to: `clone_event`, `export_shopping_list_csv`
- [x] T032 Add required `session` param to: `get_event_packaging_needs`, `get_event_packaging_breakdown`
- [x] T033 Add required `session` param to: `get_recipient_history`
- [x] T034 Remove internal `session_scope()` from all remaining functions
- [x] T035 Update UI callers and tests

### Implementation Notes
- `clone_event` is complex - must use session for all cloned entities
- `export_shopping_list_csv` may need session for data reads before file write
- Private helper functions (`_aggregate_packaging`, `_get_packaging_on_hand`, etc.) should receive session

### Parallel Opportunities
- T031-T034 can proceed together

### Dependencies
- Depends on WP01.

### Risks & Mitigations
- **Risk**: Clone operation complexity â†’ **Mitigation**: Test clone with rollback to verify atomicity

---

## Work Package WP08: Batch & Assembly Service Bug Fixes (Priority: P1)

**Goal**: Fix the bug where history query functions accept but ignore their session parameter.

**Independent Test**: History queries see uncommitted data when passed a session with pending changes.

**Prompt**: `tasks/WP08-batch-assembly-bugfixes.md`

### Included Subtasks
- [x] T036 Fix `batch_production_service.get_production_history` to use provided session
- [x] T037 Fix `batch_production_service.get_production_run` to use provided session
- [x] T038 Fix `assembly_service.get_assembly_history` to use provided session
- [ ] T039 Fix `assembly_service.get_assembly_run` to use provided session
- [ ] T040 Add tests verifying uncommitted data visibility with session
- [ ] T041 Update existing tests to pass session parameter

### Implementation Notes
- Bug pattern: `session=None` parameter exists but `with session_scope() as session:` shadows it
- Fix: Use `cm = nullcontext(session) if session else session_scope(); with cm as session:`
- Since spec requires REQUIRED sessions, change to required and remove nullcontext pattern
- Reference correct pattern: `record_batch_production` in same file

### Parallel Opportunities
- T036-T039 can proceed in parallel (different files)

### Dependencies
- Depends on WP01.

### Risks & Mitigations
- **Risk**: Subtle bug may have other manifestations â†’ **Mitigation**: Search for similar pattern across codebase

---

## Work Package WP09: Production Service Session Hardening (Priority: P1)

**Goal**: Add required session parameter to all production_service functions.

**Independent Test**: Production queries and operations work within a transaction.

**Prompt**: `tasks/WP09-production-service.md`

### Included Subtasks
- [ ] T042 Add required `session` param to: `get_production_records`, `get_production_total`
- [ ] T043 Add required `session` param to: `can_assemble_package`, `update_package_status`
- [ ] T044 Add required `session` param to: `get_production_progress`, `get_dashboard_summary`
- [ ] T045 Add required `session` param to: `get_recipe_cost_breakdown`, `get_event_assignments`
- [ ] T046 Remove internal `session_scope()` from all functions
- [ ] T047 Update UI callers in production dashboard and planning views
- [ ] T048 Update tests

### Implementation Notes
- `production_service.py` is separate from `batch_production_service.py`
- These are query/status functions, not recording functions

### Parallel Opportunities
- T042-T046 can proceed together

### Dependencies
- Depends on WP01.

### Risks & Mitigations
- **Risk**: Confusion between production_service and batch_production_service â†’ **Mitigation**: Clear file paths in prompts

---

## Work Package WP10: DTO Cost Standardization (Priority: P2)

**Goal**: Standardize all DTO cost values to 2-decimal string format for JSON serialization safety.

**Independent Test**: All service responses with cost values serialize to JSON without errors.

**Prompt**: `tasks/WP10-dto-cost-standardization.md`

### Included Subtasks
- [ ] T049 Create `cost_to_string(decimal_value)` utility function
- [ ] T050 Audit `_to_dict` methods in `batch_production_service.py` for Decimal returns
- [ ] T051 Audit `_to_dict` methods in `assembly_service.py` for Decimal returns
- [ ] T052 Audit `_to_dict` methods in `event_service.py` for Decimal returns
- [ ] T053 Update all `_to_dict` methods to use `cost_to_string()` for cost fields
- [ ] T054 Update tests expecting Decimal to expect string format

### Implementation Notes
- Format: `f"{cost:.2f}"` â†’ `"12.34"` (standard currency formatting)
- Fields to convert: `total_cost`, `unit_cost`, `ingredient_cost`, etc.
- Create utility in `src/services/utils.py` or similar
- Document the convention for future DTO methods

### Parallel Opportunities
- T050-T052 (audits) can proceed in parallel

### Dependencies
- Depends on WP02-WP09 (services must be updated first).

### Risks & Mitigations
- **Risk**: UI code may expect Decimal â†’ **Mitigation**: Search for `.quantize()` or Decimal operations on service returns

---

## Work Package WP11: Structured Logging (Priority: P2)

**Goal**: Add structured logging to production and assembly operations for debugging multi-service transactions.

**Independent Test**: Running production/assembly operations produces log entries with operation context.

**Prompt**: `tasks/WP11-structured-logging.md`

### Included Subtasks
- [ ] T055 Define logging format and create logger setup in services
- [ ] T056 Add structured logging to `batch_production_service.record_batch_production`
- [ ] T057 Add structured logging to `assembly_service.record_assembly`
- [ ] T058 Add structured logging to check functions (check_can_produce, check_can_assemble)
- [ ] T059 Add test verifying log output contains expected context

### Implementation Notes
- Use Python stdlib `logging` module
- Log at INFO level: operation type, entity IDs, outcome (success/failure)
- Log at DEBUG level: parameter values, intermediate calculations
- Format: Structured dict for potential JSON logging
- Example: `logger.info("Production recorded", extra={"production_run_id": run.id, "recipe_id": recipe_id, "outcome": "success"})`

### Parallel Opportunities
- T056-T058 can proceed in parallel

### Dependencies
- Depends on WP08, WP09 (services should be session-hardened first).

### Risks & Mitigations
- **Risk**: Logging overhead â†’ **Mitigation**: Keep log statements minimal, use DEBUG for verbose info

---

## Dependency & Execution Summary

### Execution Sequence

```
WP01 (Foundation) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
         â”‚
         â”œâ”€â”€â–º WP02 (Event CRUD) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
         â”‚
         â”œâ”€â”€â–º WP03 (Event Assignment) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
         â”‚
         â”œâ”€â”€â–º WP04 (Event Calculation) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
         â”‚
         â”œâ”€â”€â–º WP05 (Event Progress) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
         â”‚
         â”œâ”€â”€â–º WP06 (Event Target/Status) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
         â”‚
         â”œâ”€â”€â–º WP07 (Event Remaining) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
         â”‚
         â”œâ”€â”€â–º WP08 (Batch/Assembly Bugfix) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
         â”‚
         â””â”€â”€â–º WP09 (Production Service) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
                                                                      â”‚
         After all services updated: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                                                      â”‚
                                         WP10 (DTO Standardization) â”€â”€â–º
                                                                      â”‚
                                         WP11 (Structured Logging) â”€â”€â”€â–º
```

### Parallelization Opportunities

After WP01 completes, these can run in parallel:
- **Stream A (Lead Agent)**: WP02 â†’ WP03 â†’ WP04 â†’ WP05 â†’ WP06 â†’ WP07 (event_service chunks)
- **Stream B (Parallel Agent)**: WP08 â†’ WP09 (other services)

After WP02-WP09 complete:
- WP10 and WP11 can run in parallel

### MVP Scope

**Minimum Viable Feature**: WP01 + WP02-WP09 (session hardening complete)
- WP10 (DTO standardization) and WP11 (logging) are polish items

### Agent Assignments (per plan.md)

**Lead Agent (Claude Code)**:
- WP01: Foundation
- WP02-WP07: Event service (largest, most critical)
- Integration verification

**Parallel Agent (Gemini)**:
- WP08: Batch/Assembly bug fixes
- WP09: Production service
- WP10-WP11: Polish items

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Parallel? |
|------------|---------|--------------|-----------|
| T001 | Create ui/utils/__init__.py | WP01 | No |
| T002 | Create session_utils.py with ui_session() | WP01 | No |
| T003 | Add type hints and docstrings | WP01 | No |
| T004 | Create unit test for ui_session() | WP01 | No |
| T005 | Add session to event CRUD (1/2) | WP02 | Yes |
| T006 | Add session to event CRUD (2/2) | WP02 | Yes |
| T007 | Remove session_scope from CRUD | WP02 | Yes |
| T008 | Update UI callers (events_tab, event_form) | WP02 | No |
| T009 | Update UI callers (event_detail, dashboards) | WP02 | No |
| T010 | Update CRUD tests | WP02 | No |
| T011 | Add session to assignment (1/2) | WP03 | Yes |
| T012 | Add session to assignment (2/2) | WP03 | Yes |
| T013 | Remove session_scope from assignments | WP03 | Yes |
| T014 | Update UI callers for assignments | WP03 | No |
| T015 | Update assignment tests | WP03 | No |
| T016 | Add session to calculations (1/2) | WP04 | Yes |
| T017 | Add session to calculations (2/2) | WP04 | Yes |
| T018 | Remove session_scope from calculations | WP04 | Yes |
| T019 | Update UI callers for calculations | WP04 | No |
| T020 | Update calculation tests | WP04 | No |
| T021 | Add session to get_event_overall_progress | WP05 | No |
| T022 | Add session to get_events_with_progress | WP05 | No |
| T023 | Thread session to progress sub-calls | WP05 | No |
| T024 | Update UI callers for progress | WP05 | No |
| T025 | Update progress tests | WP05 | No |
| T026 | Add session to targets (1/2) | WP06 | Yes |
| T027 | Add session to targets (2/2) | WP06 | Yes |
| T028 | Add session to status functions | WP06 | Yes |
| T029 | Remove session_scope from targets/status | WP06 | Yes |
| T030 | Update UI callers and tests for targets | WP06 | No |
| T031 | Add session to clone/export | WP07 | Yes |
| T032 | Add session to packaging queries | WP07 | Yes |
| T033 | Add session to get_recipient_history | WP07 | Yes |
| T034 | Remove session_scope from remaining | WP07 | Yes |
| T035 | Update UI callers and tests | WP07 | No |
| T036 | Fix batch get_production_history | WP08 | Yes |
| T037 | Fix batch get_production_run | WP08 | Yes |
| T038 | Fix assembly get_assembly_history | WP08 | Yes |
| T039 | Fix assembly get_assembly_run | WP08 | Yes |
| T040 | Add uncommitted data visibility tests | WP08 | No |
| T041 | Update existing history tests | WP08 | No |
| T042 | Add session to production queries (1/2) | WP09 | Yes |
| T043 | Add session to production queries (2/2) | WP09 | Yes |
| T044 | Add session to progress/dashboard | WP09 | Yes |
| T045 | Add session to cost breakdown | WP09 | Yes |
| T046 | Remove session_scope from production | WP09 | Yes |
| T047 | Update UI callers for production | WP09 | No |
| T048 | Update production tests | WP09 | No |
| T049 | Create cost_to_string utility | WP10 | No |
| T050 | Audit batch_production DTOs | WP10 | Yes |
| T051 | Audit assembly DTOs | WP10 | Yes |
| T052 | Audit event_service DTOs | WP10 | Yes |
| T053 | Update _to_dict methods | WP10 | No |
| T054 | Update tests for string costs | WP10 | No |
| T055 | Define logging format | WP11 | No |
| T056 | Add logging to record_batch_production | WP11 | Yes |
| T057 | Add logging to record_assembly | WP11 | Yes |
| T058 | Add logging to check functions | WP11 | Yes |
| T059 | Test log output | WP11 | No |
