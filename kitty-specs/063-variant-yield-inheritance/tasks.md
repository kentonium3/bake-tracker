# Work Packages: Variant Yield Inheritance

**Feature**: 063-variant-yield-inheritance
**Inputs**: Design documents from `/kitty-specs/063-variant-yield-inheritance/`
**Prerequisites**: plan.md (required), spec.md (user stories), data-model.md (contracts)

**Tests**: Unit tests are required for service primitives and variant creation validation.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

---

## Work Package WP01: Service Primitives (Priority: P1) ðŸŽ¯ Foundation

**Goal**: Implement `get_base_yield_structure()` and `get_finished_units()` primitives in `recipe_service.py` that provide transparent yield access for both base and variant recipes.

**Independent Test**: Both primitives return correct data for base recipes, variant recipes, and recipes with no FinishedUnits.

**Prompt**: `tasks/WP01-service-primitives.md`

**Estimated Size**: ~320 lines

### Included Subtasks
- [x] T001 Implement `get_base_yield_structure(recipe_id, session=None)` function
- [x] T002 Implement `get_finished_units(recipe_id, session=None)` function
- [x] T003 Add unit tests for `get_base_yield_structure` (base, variant, no FU cases)
- [x] T004 Add unit tests for `get_finished_units` (base, variant cases)
- [x] T005 Add comprehensive docstrings with usage examples

### Implementation Notes
- Follow existing session pattern: `session=None` with internal `session_scope()` fallback
- Return `List[Dict]` format per data-model.md contract
- Use existing `Recipe.base_recipe_id` relationship for variant resolution
- Handle edge case: recipe with no FinishedUnits returns empty list

### Parallel Opportunities
- T001 and T002 can be implemented in parallel [P]
- T003 and T004 can be implemented in parallel after T001/T002 [P]

### Dependencies
- None (starting package)

### Risks & Mitigations
- **Risk**: Session detachment when accessing relationships â†’ **Mitigation**: Eager load FinishedUnits in query

---

## Work Package WP02: Variant Creation Extension (Priority: P1)

**Goal**: Extend `create_recipe_variant()` to accept `finished_unit_names` parameter and create variant FinishedUnits with NULL yield fields.

**Independent Test**: Creating a variant with `finished_unit_names` creates FinishedUnit records with correct display_names and NULL yield fields.

**Prompt**: `tasks/WP02-variant-creation-extension.md`

**Estimated Size**: ~350 lines

### Included Subtasks
- [x] T006 Add `finished_unit_names` parameter to `create_recipe_variant()` and `_create_recipe_variant_impl()`
- [x] T007 Implement FinishedUnit creation logic in `_create_recipe_variant_impl()`
- [x] T008 Add validation: variant display_name must differ from base display_name
- [x] T009 Generate variant FinishedUnit slug from variant recipe name + display_name
- [x] T010 Add unit tests for variant creation with FinishedUnits
- [x] T011 Add unit tests for display_name validation (reject duplicates)

### Implementation Notes
- New parameter format: `finished_unit_names=[{"base_slug": "...", "display_name": "..."}]`
- Default to `None` - existing callers unchanged
- Use `finished_unit_service.create_finished_unit()` if available, or direct model creation
- Copy non-yield fields from base FinishedUnit (category, yield_mode, etc.)
- Set `items_per_batch=None`, `item_unit=None` explicitly

### Parallel Opportunities
- T006-T009 must be sequential
- T010 and T011 can be parallel after implementation [P]

### Dependencies
- Depends on WP01 (primitives used for validation logic)

### Risks & Mitigations
- **Risk**: Breaking existing callers â†’ **Mitigation**: New param has default value `None`
- **Risk**: Slug collision â†’ **Mitigation**: Include variant recipe ID in slug generation

---

## Work Package WP03: Variant Creation UI (Priority: P1)

**Goal**: Add UI for creating variants with FinishedUnit display_name input inline in the variant creation dialog.

**Independent Test**: User can create a variant from the recipe detail view and enter FinishedUnit display_names in the same dialog.

**Prompt**: `tasks/WP03-variant-creation-ui.md`

**Estimated Size**: ~400 lines

### Included Subtasks
- [x] T012 Create variant creation dialog/method in recipe forms (if not exists)
- [x] T013 Query and display base recipe's FinishedUnits as reference
- [x] T014 Add CTkEntry fields for variant FinishedUnit display_names (one per base FU)
- [ ] T015 Add inline validation feedback for duplicate display_name
- [ ] T016 Wire dialog save to call `create_recipe_variant()` with `finished_unit_names`
- [ ] T017 Handle case where base recipe has no FinishedUnits (skip FU section)

### Implementation Notes
- Integrate into existing recipe detail view or create "Create Variant" button
- Display base FU name as label, provide entry field for variant display_name
- Pre-populate variant display_name with suggested value (e.g., "{VariantName} {BaseFUName}")
- Use CTkEntry with validation callback
- Show error message if display_name matches base (per clarification)

### Parallel Opportunities
- T012-T13 must be sequential (dialog structure first)
- T14-T17 can be parallelized across different UI concerns [P]

### Dependencies
- Depends on WP02 (service function must accept `finished_unit_names`)

### Risks & Mitigations
- **Risk**: No existing variant UI â†’ **Mitigation**: Research existing recipe form patterns first
- **Risk**: Complex dialog state â†’ **Mitigation**: Keep state minimal, validate on save

---

## Work Package WP04: Production Display Integration (Priority: P2)

**Goal**: Update production dashboard and related displays to use `get_base_yield_structure()` for showing yield info, displaying variant's display_name with base's yield.

**Independent Test**: Production dashboard shows correct yield info ("24 cookies per batch") for both base and variant recipes.

**Prompt**: `tasks/WP04-production-display-integration.md`

**Estimated Size**: ~280 lines

### Included Subtasks
- [ ] T018 Identify production dashboard components that display yield info
- [ ] T019 Replace direct FinishedUnit yield access with `get_base_yield_structure()` calls
- [ ] T020 Ensure variant display_name is shown (from `get_finished_units()`) with base yield
- [ ] T021 Test production dashboard with base recipes, variant recipes, and recipes with multiple FUs

### Implementation Notes
- Production dashboard is in `src/ui/dashboards/` and `src/ui/production_dashboard_tab.py`
- May also affect finished goods displays in forms
- Pattern: call `get_base_yield_structure(recipe_id)` for yield, `get_finished_units(recipe_id)` for display_name
- Combine: show "{variant_display_name}: {base_items_per_batch} {base_item_unit} per batch"

### Parallel Opportunities
- T018 (research) must come first
- T019-T20 can be parallelized by component [P]

### Dependencies
- Depends on WP01 (primitives must exist)

### Risks & Mitigations
- **Risk**: Many display locations â†’ **Mitigation**: Focus on production dashboard first, expand if time permits

---

## Summary

| WP | Title | Subtasks | Est. Lines | Priority | Dependencies |
|----|-------|----------|------------|----------|--------------|
| WP01 | Service Primitives | T001-T005 (5) | ~320 | P1 | None |
| WP02 | Variant Creation Extension | T006-T011 (6) | ~350 | P1 | WP01 |
| WP03 | Variant Creation UI | T012-T017 (6) | ~400 | P1 | WP02 |
| WP04 | Production Display Integration | T018-T021 (4) | ~280 | P2 | WP01 |

**Total**: 4 work packages, 21 subtasks

**Parallelization**: WP01 is foundation. After WP01: WP02 and WP04 can run in parallel. WP03 depends on WP02.

**MVP Scope**: WP01 + WP02 delivers core service functionality. WP03 required for user workflow. WP04 is polish.
