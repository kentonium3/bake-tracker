# Implementation Plan: Variant Yield Inheritance

**Branch**: `063-variant-yield-inheritance` | **Date**: 2025-01-24 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/kitty-specs/063-variant-yield-inheritance/spec.md`

## Summary

Add service primitives (`get_base_yield_structure`, `get_finished_units`) to `recipe_service.py` that provide transparent yield access for both base and variant recipes. Extend the variant creation workflow to include FinishedUnit display_name input inline. Variant FinishedUnits store only display_name/slug/recipe_id with NULL yield fields - yield info is always retrieved from the base recipe via primitives.

## Technical Context

**Language/Version**: Python 3.10+
**Primary Dependencies**: SQLAlchemy 2.x, CustomTkinter
**Storage**: SQLite with WAL mode
**Testing**: pytest
**Target Platform**: Desktop (Windows/macOS)
**Project Type**: Single desktop application
**Performance Goals**: N/A (single user, local database)
**Constraints**: Follow existing session management pattern (`session=None` parameter)
**Scale/Scope**: Single user, ~100 recipes

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. User-Centric Design | ✅ PASS | Inline display_name input reduces friction |
| II. Data Integrity & FIFO | ✅ PASS | No impact on FIFO; yield inheritance is read-only |
| III. Future-Proof Schema | ✅ PASS | FinishedUnit already has nullable yield fields |
| IV. Test-Driven Development | ✅ PASS | Service primitives will have unit tests |
| V. Layered Architecture | ✅ PASS | Primitives in service layer; UI calls services |
| VI. Schema Change Strategy | ✅ PASS | No schema changes required |
| VII. Pragmatic Aspiration | ✅ PASS | Validates yield abstraction for future AI wrapping |

**No violations requiring justification.**

## Project Structure

### Documentation (this feature)

```
kitty-specs/063-variant-yield-inheritance/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0 research findings
├── data-model.md        # Service primitive contracts
└── tasks.md             # Task tracking (generated by /spec-kitty.tasks)
```

### Source Code (repository root)

```
src/
├── models/
│   └── finished_unit.py      # No changes needed (nullable fields exist)
├── services/
│   └── recipe_service.py     # Add get_base_yield_structure, get_finished_units
└── ui/
    └── forms/
        └── recipe_detail.py  # Extend variant creation with FinishedUnit inputs
```

**Structure Decision**: Single project layout (existing). New primitives added to existing `recipe_service.py`. UI changes extend existing recipe detail form.

## Implementation Approach

### Phase 1: Service Primitives (P1)

1. **Add `get_base_yield_structure(recipe_id, session=None)`**
   - If recipe is a variant (has base_recipe_id), return base recipe's FinishedUnits yield data
   - If recipe is a base, return its own FinishedUnits yield data
   - Return format: `List[Dict]` with `{items_per_batch, item_unit, display_name, slug}`

2. **Add `get_finished_units(recipe_id, session=None)`**
   - Return recipe's own FinishedUnits (for display_name access)
   - Works identically for base and variant recipes

3. **Unit tests for both primitives**
   - Test base recipe returns own yields
   - Test variant recipe returns base yields
   - Test session parameter works correctly

### Phase 2: Variant Creation Workflow (P1)

1. **Extend `_create_recipe_variant_impl` in recipe_service.py**
   - Accept `finished_unit_names: List[Dict]` parameter
   - Create variant FinishedUnits with provided display_names
   - Set items_per_batch and item_unit to NULL

2. **Add UI for FinishedUnit display_name input**
   - Extend variant creation dialog in recipe detail form
   - Show base FinishedUnit names as reference
   - Validate display_names differ from base

### Phase 3: Display Integration (P2)

1. **Update production dashboard to use primitives**
   - Replace direct FinishedUnit yield access with `get_base_yield_structure`
   - Display variant's display_name with base's yield info

## Key Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Primitive location | `recipe_service.py` | Recipe-focused, consistent with existing variant support |
| Session parameter | `session=None` | Follows established pattern per CLAUDE.md |
| Return format | `List[Dict]` | Decoupled from ORM, supports serialization |
| Variant FinishedUnit storage | NULL yield fields | Inheritance via primitives, not data duplication |
| UI integration | Inline in variant dialog | User clarification: single-step workflow |

## Dependencies

- Existing `create_recipe_variant` function (will be extended)
- Existing `FinishedUnit` model with nullable yield fields
- Existing variant relationship via `base_recipe_id`

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Breaking existing variant creation | Add new parameter with default; existing callers unchanged |
| Performance on deep variant chains | Variants-of-variants not supported; single lookup |
| Session detachment issues | Follow documented session pattern; pass session to inner calls |
