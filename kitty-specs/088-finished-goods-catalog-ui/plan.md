# Implementation Plan: Finished Goods Catalog UI

**Branch**: `088-finished-goods-catalog-ui` | **Date**: 2026-01-30 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification + F088 func-spec (docs/func-spec/F088_finished_goods_creation_ux.md)

## Summary

Add a Finished Goods tab to Catalog mode following the F087 standardized layout pattern. The tab provides full CRUD for FinishedGood records with a create/edit form containing three component sections: Foods (FinishedUnits), Materials (MaterialUnits), and nested Components (FinishedGoods). Component selection uses category filters + type-ahead search. Service layer handles atomic creation/update with circular reference validation.

## Technical Context

**Language/Version**: Python 3.10+
**Primary Dependencies**: CustomTkinter, SQLAlchemy 2.x, ttk (tkinter.ttk)
**Storage**: SQLite with WAL mode
**Testing**: pytest with fixtures
**Target Platform**: Desktop (Windows/macOS/Linux)
**Project Type**: Single desktop application
**Performance Goals**: UI operations complete in <500ms
**Constraints**: Must follow F087 layout pattern exactly
**Scale/Scope**: Single user, <100 FinishedGoods, <50 components per FinishedGood

## Constitution Check

*GATE: Passed - all principles satisfied*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. User-Centric Design | ✅ | Feature solves real user need (Marianne can define product catalog) |
| II. Data Integrity | ✅ | Atomic saves, circular reference validation |
| III. Future-Proof Schema | ✅ | No schema changes - uses existing FinishedGood/Composition models |
| IV. Test-Driven Development | ✅ | Service layer tests required |
| V. Layered Architecture | ✅ | UI → Services → Models separation maintained |
| VI. Schema Change Strategy | ✅ | N/A - no schema changes |
| VII. Pragmatic Aspiration | ✅ | Desktop-first, service layer API-ready |

## Project Structure

### Documentation (this feature)

```
kitty-specs/088-finished-goods-catalog-ui/
├── plan.md              # This file
├── research.md          # Codebase pattern research
├── data-model.md        # Entity relationships (existing models)
├── spec.md              # Feature specification
└── tasks/               # Work packages (generated by /spec-kitty.tasks)
```

### Source Code (new/modified files)

```
src/
├── ui/
│   ├── modes/
│   │   └── catalog_mode.py          # MODIFY: Add Finished Goods tab
│   ├── finished_goods_tab.py        # NEW: Main tab (F087 pattern)
│   └── forms/
│       └── finished_good_form.py    # NEW: Create/edit dialog with component sections
├── services/
│   └── finished_good_service.py     # MODIFY: Enhance create/update with components
└── tests/
    ├── test_finished_good_service.py  # NEW: Service layer tests
    └── test_finished_good_form.py     # NEW: UI tests (optional)
```

**Structure Decision**: Single project structure with standard src/tests layout. New UI files follow existing patterns (finished_units_tab.py, recipe_form.py).

## Implementation Approach

### Phase 1: Tab Shell (F087 Pattern)

Create `src/ui/finished_goods_tab.py` following F087 exactly:
- Row 0: SearchBar with assembly type filter
- Row 1: Action buttons (Create New, Edit, Delete)
- Row 2: ttk.Treeview with columns (Name, Assembly Type, Component Count, Notes)
- Row 3: Status bar

Add tab to `src/ui/modes/catalog_mode.py` as 4th tab after Recipes.

### Phase 2: Service Layer Enhancement

Enhance `src/services/finished_good_service.py`:
- `create_finished_good()` accepts `components` list parameter
- `update_finished_good()` with component replacement (delete old, create new)
- `validate_no_circular_references()` for nested FinishedGoods
- Atomic transaction with rollback on failure

### Phase 3: Create/Edit Form

Create `src/ui/forms/finished_good_form.py`:
- Basic info section (Name, Assembly Type, Packaging Instructions, Notes)
- Foods section (add FinishedUnits with category filter + search)
- Materials section (add MaterialUnits with category filter + search)
- Components section (add nested FinishedGoods with circular reference check)

### Phase 4: Integration & Polish

- Wire up CRUD operations in tab
- Implement delete with safety checks
- Add tests for service layer
- User testing with real data

## Key Patterns to Follow

### F087 Tab Layout (MANDATORY)

```python
# From src/ui/recipes_tab.py - copy this pattern exactly
self.grid_rowconfigure(0, weight=0)  # Search/filters (fixed)
self.grid_rowconfigure(1, weight=0)  # Action buttons (fixed)
self.grid_rowconfigure(2, weight=1)  # ttk.Treeview (expandable)
self.grid_rowconfigure(3, weight=0)  # Status bar (fixed)
```

### Composition Factory Methods

```python
# Use existing factory methods from src/models/composition.py
Composition.create_unit_composition(assembly_id, finished_unit_id, quantity)
Composition.create_assembly_composition(assembly_id, finished_good_id, quantity)
Composition.create_material_unit_composition(assembly_id, material_unit_id, quantity)
```

### Service Layer Session Pattern

```python
# From existing services - follow this pattern
def create_finished_good(display_name, assembly_type, components=None, session=None, **kwargs):
    if session is not None:
        return _create_impl(display_name, assembly_type, components, session, **kwargs)
    with session_scope() as session:
        return _create_impl(display_name, assembly_type, components, session, **kwargs)
```

## Complexity Tracking

*No constitution violations - standard complexity for this feature scope.*

| Aspect | Justification |
|--------|---------------|
| Modal form dialog | Follows established RecipeFormDialog pattern |
| Three component sections | Required by spec - foods, materials, components |
| Circular reference validation | Required for data integrity - prevents invalid nesting |

## Dependencies

- **F085 MaterialUnit**: Already implemented - provides material_unit_id for Composition
- **F087 Layout Pattern**: Already implemented - provides tab layout standard
- **Existing Models**: FinishedGood, Composition, FinishedUnit already exist
- **Existing Services**: finished_good_service.py provides foundation

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Component selection UI unwieldy with many items | Category filter + type-ahead search narrows options |
| Circular reference edge cases | Graph traversal validation; comprehensive tests |
| Form complexity | Collapsible sections; scrollable form |
