# Work Packages: Finished Goods Catalog UI

**Inputs**: Design documents from `/kitty-specs/088-finished-goods-catalog-ui/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: Service layer tests included per constitution (>80% coverage required).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`.

---

## Work Package WP01: Tab Shell with F087 Layout (Priority: P0)

**Goal**: Create the Finished Goods tab following F087 standardized layout exactly.
**Independent Test**: Tab appears in Catalog mode, displays empty ttk.Treeview grid with search bar and action buttons.
**Prompt**: `/tasks/WP01-tab-shell-f087-layout.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [x] T001 Create `src/ui/finished_goods_tab.py` with F087 3-row layout shell
- [x] T002 Add SearchBar with assembly type filter dropdown
- [x] T003 Create ttk.Treeview with columns (Name, Assembly Type, Component Count, Notes)
- [x] T004 Add action buttons frame (Create New, Edit, Delete) - disabled initially
- [x] T005 Add status bar with status messages
- [x] T006 Implement empty state message when no FinishedGoods exist
- [x] T007 Add tab to `src/ui/modes/catalog_mode.py` as 4th tab after Recipes

### Implementation Notes
- Copy F087 pattern from `src/ui/recipes_tab.py` (3-row layout with ttk.Treeview)
- Use `SearchBar` widget from `src/ui/widgets/search_bar.py`
- Assembly type filter options: All, Custom Order, Gift Box, Variety Pack, Seasonal Box, Event Package
- Columns match spec: Name, Assembly Type, Component Count, Notes (truncated)
- Follow `finished_units_tab.py` for selection state management pattern

### Parallel Opportunities
- T001-T006 can be developed together as single file
- T007 (catalog_mode.py modification) is quick integration step

### Dependencies
- None (starting package)

### Risks & Mitigations
- F087 deviation ‚Üí Copy directly from recipes_tab.py; verify trackpad scrolling works

---

## Work Package WP02: Service Layer - Create with Components (Priority: P0)

**Goal**: Enhance service layer to create FinishedGoods with atomic component creation.
**Independent Test**: Can programmatically create a FinishedGood with foods, materials, and nested components via service API.
**Prompt**: `/tasks/WP02-service-create-with-components.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [ ] T008 Enhance `create_finished_good()` in `src/services/finished_good_service.py` to accept `components` list parameter
- [ ] T009 [P] Implement atomic component creation using Composition factory methods
- [ ] T010 [P] Add input validation for component data structure
- [ ] T011 Add service layer tests for create with foods components
- [ ] T012 [P] Add service layer tests for create with materials components
- [ ] T013 [P] Add service layer tests for create with nested FinishedGood components

### Implementation Notes
- Component data structure: `[{"type": "finished_unit"|"material_unit"|"finished_good", "id": int, "quantity": int, "notes": str|None, "sort_order": int}]`
- Use existing factory methods: `Composition.create_unit_composition()`, `create_material_unit_composition()`, `create_assembly_composition()`
- Wrap in single transaction with `session_scope()` for atomic save
- Accept optional `session` parameter for caller-managed transactions
- Auto-generate slug from display_name (existing pattern)

### Parallel Opportunities
- T011-T013 (tests) can proceed in parallel once T008-T010 complete

### Dependencies
- None (service layer is independent)

### Risks & Mitigations
- Session detachment ‚Üí Follow session management pattern from CLAUDE.md

---

## Work Package WP03: Service Layer - Update and Validation (Priority: P0)

**Goal**: Implement update with component replacement and circular reference validation.
**Independent Test**: Can update existing FinishedGood, replacing all components; circular reference attempts are rejected.
**Prompt**: `/tasks/WP03-service-update-and-validation.md`
**Estimated Size**: ~450 lines

### Included Subtasks
- [ ] T014 Implement `update_finished_good()` with component replacement (delete old, create new)
- [ ] T015 Add `validate_no_circular_references()` using graph traversal
- [ ] T016 Add delete safety checks (check if referenced by other FinishedGoods)
- [ ] T017 Add delete safety checks (check if referenced by events/planning)
- [ ] T018 Add service tests for update with component changes
- [ ] T019 Add service tests for circular reference detection (self, direct, transitive)
- [ ] T020 Add service tests for delete safety checks

### Implementation Notes
- Update strategy: Delete all existing Compositions, create new ones (simpler than diff)
- Circular reference algorithm: BFS/DFS from target, check if current ID reachable
- Check `Composition.assembly_id` for other FinishedGoods referencing this one
- Check `EventFinishedGood` or similar for event planning references
- Return clear error messages explaining what blocks deletion

### Parallel Opportunities
- T16-T17 (delete checks) can proceed in parallel
- T18-T20 (tests) can proceed in parallel

### Dependencies
- Depends on WP02 (create pattern established)

### Risks & Mitigations
- Missed circular reference edge case ‚Üí Test A‚ÜíB‚ÜíC‚ÜíA cycle explicitly

---

## Work Package WP04: Form Dialog - Basic Structure (Priority: P1)

**Goal**: Create the create/edit form dialog with basic info section.
**Independent Test**: Dialog opens, displays basic info fields, Save/Cancel buttons work.
**Prompt**: `/tasks/WP04-form-dialog-basic-structure.md`
**Estimated Size**: ~380 lines

### Included Subtasks
- [x] T021 Create `src/ui/forms/finished_good_form.py` dialog shell (CTkToplevel modal)
- [x] T022 Add scrollable form container for sections
- [x] T023 Add Basic Info section (Name entry with validation, Assembly Type dropdown)
- [x] T024 Add Packaging Instructions textarea
- [x] T025 Add Notes textarea
- [x] T026 Add Save/Cancel buttons with basic validation (name required)
- [x] T027 Implement form population for edit mode (load existing FinishedGood data)

### Implementation Notes
- Follow `RecipeFormDialog` pattern from `src/ui/forms/recipe_form.py`
- Use `ctk.CTkScrollableFrame` for form body
- Assembly Type options from enum: CUSTOM_ORDER, GIFT_BOX, VARIETY_PACK, SEASONAL_BOX, EVENT_PACKAGE
- Result dict structure: `{"display_name": str, "assembly_type": str, "packaging_instructions": str, "notes": str, "components": list}`
- Modal behavior: `grab_set()`, `wait_window()`

### Parallel Opportunities
- T23-T25 (form fields) can proceed in parallel

### Dependencies
- None (form is independent of tab)

### Risks & Mitigations
- Form layout complexity ‚Üí Use grid layout with consistent padding

---

## Work Package WP05: Form Dialog - Foods Component Section (Priority: P1) üéØ MVP

**Goal**: Implement Foods section with category filter + search for adding FinishedUnits.
**Independent Test**: Can add foods to form, see them in list, remove them. Data preserved on save.
**Prompt**: `/tasks/WP05-form-foods-component-section.md`
**Estimated Size**: ~480 lines

### Included Subtasks
- [ ] T028 Create Foods section frame with section header and Add Food button
- [ ] T029 Create ComponentSelectionPopup for food selection (reusable base class)
- [ ] T030 Add category filter dropdown (populated from Recipe categories)
- [ ] T031 Add type-ahead search CTkComboBox for FinishedUnits
- [ ] T032 Add quantity input entry with integer validation
- [ ] T033 Implement added foods list display (CTkScrollableFrame with rows)
- [ ] T034 Add Remove button per row with callback

### Implementation Notes
- Load FinishedUnits via `finished_unit_service.get_all_finished_units()`
- Category filter narrows FinishedUnit list (filter by `category` field)
- Display: "Name (Recipe)" format for clarity
- Quantity validation: positive integer required
- Row display: Name | Quantity | Remove button
- Store as: `[{"type": "finished_unit", "id": fu.id, "quantity": qty, "display_name": fu.display_name}]`

### Parallel Opportunities
- T29-T32 (selection popup) can be developed together
- T33-T34 (list display) can proceed in parallel

### Dependencies
- Depends on WP04 (form shell exists)

### Risks & Mitigations
- Large FinishedUnit list ‚Üí Category filter + search reduces options

---

## Work Package WP06: Form Dialog - Materials and Components Sections (Priority: P2)

**Goal**: Add Materials section (MaterialUnits) and Components section (nested FinishedGoods).
**Independent Test**: Can add materials and nested components; all three component types work together.
**Prompt**: `/tasks/WP06-form-materials-and-components-sections.md`
**Estimated Size**: ~520 lines

### Included Subtasks
- [ ] T035 Create Materials section with Add Material button
- [ ] T036 Implement material selection with Material category/subcategory filter
- [ ] T037 Add type-ahead search for MaterialUnits (search by name and product name)
- [ ] T038 Add quantity input with decimal validation (materials support fractional)
- [ ] T039 Display added materials list with Product column
- [ ] T040 Create Components section with Add Component button
- [ ] T041 Implement component selection with Assembly Type filter
- [ ] T042 Add circular reference check on selection (filter out invalid choices)

### Implementation Notes
- Materials: Load via `material_unit_service.get_all_material_units()` or similar
- Material display: "Unit Name (Product Name)" format
- Quantity for materials: allow decimals (float)
- Components: Load via `finished_good_service.get_all_finished_goods()`
- Circular reference filter: Exclude self, exclude any FinishedGood that contains current
- Call `validate_no_circular_references()` from WP03 before allowing selection

### Parallel Opportunities
- T35-T39 (Materials) and T40-T42 (Components) can proceed in parallel

### Dependencies
- Depends on WP05 (reuse ComponentSelectionPopup pattern)
- Depends on WP03 (circular reference validation service)

### Risks & Mitigations
- Complex material hierarchy ‚Üí Use Material category + product structure
- Circular reference missed in UI ‚Üí Service layer validates again on save

---

## Work Package WP07: Tab Integration and CRUD Wiring (Priority: P1)

**Goal**: Wire up all CRUD operations in the tab, complete the user flow.
**Independent Test**: Full create/edit/delete workflow works end-to-end in the UI.
**Prompt**: `/tasks/WP07-tab-integration-and-crud-wiring.md`
**Estimated Size**: ~420 lines

### Included Subtasks
- [ ] T043 Wire Create New button to open form dialog (create mode)
- [ ] T044 Wire Edit button and double-click to open form dialog (edit mode)
- [ ] T045 Implement form result handling and service layer calls
- [ ] T046 Implement list refresh after create/edit operations
- [ ] T047 Wire Delete button with confirmation dialog
- [ ] T048 Implement delete with error handling (show blocked reason)
- [ ] T049 Implement search functionality (filter tree by name)
- [ ] T050 Implement assembly type filter functionality
- [ ] T051 Implement row selection state and button enable/disable

### Implementation Notes
- Create: Call `finished_good_service.create_finished_good()` with form result
- Edit: Load existing, populate form, call `update_finished_good()` on save
- Delete: Show confirmation, check result, show error if blocked
- Refresh: Re-query and re-populate treeview after changes
- Selection: Enable Edit/Delete buttons when row selected
- Filter: Filter `_current_finished_goods` list, refresh tree display

### Parallel Opportunities
- T49-T50 (search/filter) can proceed in parallel
- Most tasks are sequential (wiring flow)

### Dependencies
- Depends on WP01 (tab exists)
- Depends on WP02-WP03 (service layer complete)
- Depends on WP04-WP06 (form complete)

### Risks & Mitigations
- State sync issues ‚Üí Refresh list after every operation

---

## Dependency & Execution Summary

```
WP01 (Tab Shell) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                                              ‚îÇ
WP02 (Service Create) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                             ‚îÇ
                                 ‚îÇ                             ‚îÇ
WP03 (Service Update) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                             ‚îÇ
    (depends on WP02)           ‚îÇ                             ‚îÇ
                                 ‚îÇ                             ‚îÇ
WP04 (Form Basic) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                             ‚îÇ
                                 ‚îÇ                             ‚îÇ
WP05 (Form Foods) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                             ‚îÇ
    (depends on WP04)           ‚îÇ                             ‚îÇ
                                 ‚îú‚îÄ‚îÄ‚îÄ‚ñ∫ WP07 (Tab Integration) ‚îÄ‚î§
WP06 (Form Materials+Components)‚îÇ         (depends on all)    ‚îÇ
    (depends on WP05, WP03)     ‚îÇ                             ‚îÇ
                                 ‚îÇ                             ‚îÇ
```

**Parallelization**:
- WP01 + WP02 + WP04 can proceed in parallel (no dependencies)
- WP03 depends on WP02 (create pattern)
- WP05 depends on WP04 (form shell)
- WP06 depends on WP05 (component pattern) and WP03 (circular ref validation)
- WP07 depends on all (final integration)

**MVP Scope**: WP01 + WP02 + WP04 + WP05 + WP07 = Basic creation with foods only
**Full Scope**: All 7 work packages = Complete feature with materials and nested components

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Create finished_goods_tab.py shell | WP01 | P0 | No |
| T002 | Add SearchBar with assembly type filter | WP01 | P0 | No |
| T003 | Create ttk.Treeview with columns | WP01 | P0 | No |
| T004 | Add action buttons frame | WP01 | P0 | No |
| T005 | Add status bar | WP01 | P0 | No |
| T006 | Implement empty state message | WP01 | P0 | No |
| T007 | Add tab to catalog_mode.py | WP01 | P0 | No |
| T008 | Enhance create_finished_good() | WP02 | P0 | No |
| T009 | Implement atomic component creation | WP02 | P0 | Yes |
| T010 | Add component input validation | WP02 | P0 | Yes |
| T011 | Test create with foods | WP02 | P0 | Yes |
| T012 | Test create with materials | WP02 | P0 | Yes |
| T013 | Test create with nested components | WP02 | P0 | Yes |
| T014 | Implement update with component replacement | WP03 | P0 | No |
| T015 | Add circular reference validation | WP03 | P0 | No |
| T016 | Add delete check - other FinishedGoods | WP03 | P0 | Yes |
| T017 | Add delete check - events | WP03 | P0 | Yes |
| T018 | Test update with component changes | WP03 | P0 | Yes |
| T019 | Test circular reference detection | WP03 | P0 | Yes |
| T020 | Test delete safety checks | WP03 | P0 | Yes |
| T021 | Create form dialog shell | WP04 | P1 | No |
| T022 | Add scrollable form container | WP04 | P1 | No |
| T023 | Add Name and Assembly Type fields | WP04 | P1 | Yes |
| T024 | Add Packaging Instructions textarea | WP04 | P1 | Yes |
| T025 | Add Notes textarea | WP04 | P1 | Yes |
| T026 | Add Save/Cancel with validation | WP04 | P1 | No |
| T027 | Implement edit mode population | WP04 | P1 | No |
| T028 | Create Foods section frame | WP05 | P1 | No |
| T029 | Create ComponentSelectionPopup base | WP05 | P1 | No |
| T030 | Add category filter dropdown | WP05 | P1 | No |
| T031 | Add type-ahead search | WP05 | P1 | No |
| T032 | Add quantity input | WP05 | P1 | No |
| T033 | Implement foods list display | WP05 | P1 | Yes |
| T034 | Add Remove button per row | WP05 | P1 | Yes |
| T035 | Create Materials section | WP06 | P2 | Yes |
| T036 | Material category filter | WP06 | P2 | Yes |
| T037 | Material type-ahead search | WP06 | P2 | Yes |
| T038 | Material quantity (decimal) | WP06 | P2 | Yes |
| T039 | Materials list display | WP06 | P2 | Yes |
| T040 | Create Components section | WP06 | P2 | Yes |
| T041 | Component Assembly Type filter | WP06 | P2 | Yes |
| T042 | Circular reference filter in UI | WP06 | P2 | Yes |
| T043 | Wire Create New button | WP07 | P1 | No |
| T044 | Wire Edit button and double-click | WP07 | P1 | No |
| T045 | Implement form result handling | WP07 | P1 | No |
| T046 | Implement list refresh | WP07 | P1 | No |
| T047 | Wire Delete with confirmation | WP07 | P1 | No |
| T048 | Implement delete error handling | WP07 | P1 | No |
| T049 | Implement search functionality | WP07 | P1 | Yes |
| T050 | Implement assembly type filter | WP07 | P1 | Yes |
| T051 | Implement selection state | WP07 | P1 | No |
