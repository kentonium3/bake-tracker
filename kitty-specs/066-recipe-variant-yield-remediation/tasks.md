# Work Packages: Recipe Variant Yield Remediation

**Inputs**: Design documents from `/kitty-specs/066-recipe-variant-yield-remediation/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md

**Tests**: Integration tests included in WP06 to verify service decoupling.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Update Service Primitive Docstrings (Priority: P0)

**Goal**: Update docstrings for `get_finished_units()` and `get_base_yield_structure()` to reflect Phase 1 fix behavior.
**Independent Test**: Docstrings accurately describe that variants have copied (not NULL) yield values.
**Prompt**: `/tasks/WP01-update-primitive-docstrings.md`
**Dependencies**: None
**Estimated Size**: ~200 lines

### Included Subtasks
- [x] T001 Update `get_finished_units()` docstring - remove "NULL for variants" references
- [x] T002 Update `get_base_yield_structure()` docstring - clarify post-Phase-1 behavior

### Implementation Notes
- File: `src/services/recipe_service.py` lines 2019-2054 and 1941-1987
- Phase 1 fix changed variant FinishedUnits from NULL yields to copied yields
- Remove outdated references to NULL yield fields
- Clarify when to use each primitive

### Parallel Opportunities
- None (single file, sequential edits)

### Dependencies
- None (starting package)

### Risks & Mitigations
- Risk: Docstrings still mislead developers
- Mitigation: Review against actual behavior in tests

---

## Work Package WP02: Decouple Planning Service (Priority: P1)

**Goal**: Replace direct `recipe.finished_units` access with `get_finished_units()` primitive in planning_service.py.
**Independent Test**: Planning service imports and calls recipe_service.get_finished_units() instead of accessing model directly.
**Prompt**: `/tasks/WP02-decouple-planning-service.md`
**Dependencies**: WP01
**Estimated Size**: ~250 lines

### Included Subtasks
- [x] T003 [P] Replace direct access at `planning_service.py:505-506`
- [x] T004 [P] Replace direct access at `planning_service.py:686-687`
- [x] T005 Add import for recipe_service in planning_service.py

### Implementation Notes
- File: `src/services/planning/planning_service.py`
- Two locations use `recipe.finished_units` pattern
- Replace with `recipe_service.get_finished_units(recipe_id, session=session)`
- Note: primitive returns list of dicts, not ORM objects - access with `["key"]` not `.key`

### Parallel Opportunities
- T003 and T004 can be done in parallel (different functions in same file)

### Dependencies
- Depends on WP01 (docstrings clarify usage pattern)

### Risks & Mitigations
- Risk: Dict access pattern differs from ORM object access
- Mitigation: Careful review of attribute vs dict key access

---

## Work Package WP03: Decouple Batch Calculation (Priority: P1)

**Goal**: Replace direct `recipe.finished_units` access with `get_finished_units()` primitive in batch_calculation.py.
**Independent Test**: Batch calculation imports and calls recipe_service.get_finished_units() instead of accessing model directly.
**Prompt**: `/tasks/WP03-decouple-batch-calculation.md`
**Dependencies**: WP01
**Estimated Size**: ~200 lines

### Included Subtasks
- [x] T006 [P] Replace direct access at `batch_calculation.py:296-297`
- [x] T007 Add import for recipe_service in batch_calculation.py

### Implementation Notes
- File: `src/services/planning/batch_calculation.py`
- One location uses `recipe.finished_units` pattern
- Replace with `recipe_service.get_finished_units(recipe_id, session=session)`
- Same dict access pattern as WP02

### Parallel Opportunities
- Can run in parallel with WP02, WP04, WP05 (different files)

### Dependencies
- Depends on WP01 (docstrings clarify usage pattern)

### Risks & Mitigations
- Risk: Dict access pattern differs from ORM object access
- Mitigation: Test with existing test suite

---

## Work Package WP04: Update VariantCreationDialog (Priority: P1)

**Goal**: Update VariantCreationDialog with consistent terminology and base yield reference display.
**Independent Test**: Dialog shows "Variant Yields:" header, displays base recipe yields, and includes inheritance explanation.
**Prompt**: `/tasks/WP04-update-variant-creation-dialog.md`
**Dependencies**: WP01
**Estimated Size**: ~350 lines

### Included Subtasks
- [x] T008 [P] Update header from "Yield Type Names:" to "Variant Yields:"
- [x] T009 Add base yield reference display section showing items_per_batch and item_unit
- [x] T010 Add inheritance explanatory text ("Variant inherits yield structure from base recipe")

### Implementation Notes
- File: `src/ui/forms/variant_creation_dialog.py`
- Line 130: Change header text
- Add new section above editable fields showing base recipe yields as read-only reference
- Use `get_base_yield_structure()` to fetch base yields (passed as constructor arg or fetched via service)

### Parallel Opportunities
- Can run in parallel with WP02, WP03, WP05 (different files)

### Dependencies
- Depends on WP01 (primitives documented)

### Risks & Mitigations
- Risk: UI layout disrupted by new section
- Mitigation: Careful testing with various base recipe configurations

---

## Work Package WP05: Update RecipeFormDialog (Priority: P2)

**Goal**: Add variant detection and variant-specific behavior to RecipeFormDialog.
**Independent Test**: Editing a variant shows base recipe banner, read-only yield structure, but editable display_name.
**Prompt**: `/tasks/WP05-update-recipe-form-dialog.md`
**Dependencies**: WP01
**Estimated Size**: ~400 lines

### Included Subtasks
- [x] T011 Add variant detection in RecipeFormDialog.__init__ (check recipe.base_recipe_id)
- [ ] T012 Add "Base Recipe: [name]" banner at top for variants
- [ ] T013 Make yield structure fields (items_per_batch, item_unit, yield_mode) read-only for variants
- [ ] T014 Keep display_name field editable for variants
- [ ] T015 Add explanatory text about inheritance ("Yield structure inherited from base recipe")

### Implementation Notes
- File: `src/ui/forms/recipe_form.py`
- Add `is_variant` flag based on `recipe.base_recipe_id`
- Conditionally render banner and modify field states
- May need to fetch base recipe name for banner display

### Parallel Opportunities
- Can run in parallel with WP02, WP03, WP04 (different files)

### Dependencies
- Depends on WP01 (primitives documented)

### Risks & Mitigations
- Risk: Form layout complex with conditional sections
- Mitigation: Test both base and variant recipe editing thoroughly

---

## Work Package WP06: Integration Tests (Priority: P2)

**Goal**: Add integration tests verifying planning and batch_calculation services use primitives correctly.
**Independent Test**: Tests verify services call get_finished_units() instead of direct model access.
**Prompt**: `/tasks/WP06-integration-tests.md`
**Dependencies**: WP02, WP03
**Estimated Size**: ~300 lines

### Included Subtasks
- [ ] T016 [P] Create integration test for planning service primitive usage
- [ ] T017 [P] Create integration test for batch calculation primitive usage
- [ ] T018 Verify existing primitive tests pass with updated docstrings

### Implementation Notes
- New file: `src/tests/integration/test_service_decoupling.py` (or add to existing)
- Use mocking to verify `recipe_service.get_finished_units` is called
- Verify services don't access `recipe.finished_units` directly

### Parallel Opportunities
- T016 and T017 can be developed in parallel (different test cases)

### Dependencies
- Depends on WP02 and WP03 (services must be updated before testing)

### Risks & Mitigations
- Risk: Mocking complexity
- Mitigation: Use `unittest.mock.patch` for clear call verification

---

## Dependency & Execution Summary

```
WP01 ─────┬──────────────────────────────────────────────────┐
          │                                                  │
          ├─► WP02 (Planning Service) ──┐                   │
          │                              │                   │
          ├─► WP03 (Batch Calculation) ─┼─► WP06 (Tests) ──►│ DONE
          │                              │                   │
          ├─► WP04 (VariantCreationDlg) ─┘                   │
          │                                                  │
          └─► WP05 (RecipeFormDialog) ──────────────────────┘
```

- **Sequence**: WP01 → (WP02 || WP03 || WP04 || WP05) → WP06
- **Parallelization**: WP02, WP03, WP04, WP05 can all run in parallel after WP01 completes
- **MVP Scope**: WP01 + WP02 + WP03 (service layer complete)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Update get_finished_units() docstring | WP01 | P0 | No |
| T002 | Update get_base_yield_structure() docstring | WP01 | P0 | No |
| T003 | Replace direct access planning_service:505-506 | WP02 | P1 | Yes |
| T004 | Replace direct access planning_service:686-687 | WP02 | P1 | Yes |
| T005 | Add import in planning_service.py | WP02 | P1 | No |
| T006 | Replace direct access batch_calculation:296-297 | WP03 | P1 | Yes |
| T007 | Add import in batch_calculation.py | WP03 | P1 | No |
| T008 | Update VariantCreationDialog header | WP04 | P1 | Yes |
| T009 | Add base yield reference display | WP04 | P1 | No |
| T010 | Add inheritance explanatory text | WP04 | P1 | No |
| T011 | Add variant detection in RecipeFormDialog | WP05 | P2 | No |
| T012 | Add base recipe banner for variants | WP05 | P2 | No |
| T013 | Make yield fields read-only for variants | WP05 | P2 | No |
| T014 | Keep display_name editable | WP05 | P2 | No |
| T015 | Add explanatory text about inheritance | WP05 | P2 | No |
| T016 | Integration test for planning service | WP06 | P2 | Yes |
| T017 | Integration test for batch calculation | WP06 | P2 | Yes |
| T018 | Verify existing tests pass | WP06 | P2 | No |
