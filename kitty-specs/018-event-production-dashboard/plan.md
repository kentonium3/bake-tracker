# Implementation Plan: Event Production Dashboard

**Branch**: `018-event-production-dashboard` | **Date**: 2025-12-12 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `kitty-specs/018-event-production-dashboard/spec.md`

## Summary

Enhance the existing `ProductionDashboardTab` (Feature 017) from a single-event selector view to a multi-event "mission control" status board. Display all active/future events as expandable cards with aggregated progress, fulfillment status, and quick actions. Add event filtering by date/status.

**Key Insight**: This is an **enhancement** to existing code, not a new tab. Feature 017 already:
- Created `ProductionDashboardTab` as first tab (renamed from "Dashboard")
- Renamed old Dashboard to "Summary" tab
- Added single-event selector with progress bars

Feature 018 transforms this into a multi-event status board.

## Technical Context

**Language/Version**: Python 3.10+
**Primary Dependencies**: CustomTkinter, SQLAlchemy 2.x
**Storage**: SQLite with WAL mode (existing)
**Testing**: pytest (unit tests for any new service methods)
**Target Platform**: Desktop (Windows/macOS/Linux)
**Project Type**: Single desktop application
**Performance Goals**: Dashboard loads within 2 seconds for up to 50 events
**Constraints**: Must use existing EventService methods; no new database schema
**Scale/Scope**: Single user; typically 2-10 events visible at once

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. User-Centric Design | PASS | Dashboard solves real problem: "Where do I stand for Christmas?" |
| II. Data Integrity & FIFO | N/A | No changes to data layer |
| III. Future-Proof Schema | N/A | No schema changes |
| IV. Test-Driven Development | PASS | Will add UI integration tests |
| V. Layered Architecture | PASS | UI consumes services; no business logic in UI |
| VI. Migration Safety | N/A | No migrations |
| VII. Pragmatic Aspiration | PASS | Service layer stays UI-independent; web migration unaffected |

**Desktop Phase Questions:**
- Does this design block web deployment? → NO (service layer unchanged)
- Is the service layer UI-independent? → YES (existing EventService methods)
- Are business rules in services, not UI? → YES (progress calculations in EventService)
- What's the web migration cost? → LOW (only UI changes)

## Project Structure

### Documentation (this feature)

```
kitty-specs/018-event-production-dashboard/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output (minimal - no new entities)
├── quickstart.md        # Phase 1 output
└── tasks.md             # Phase 2 output (generated by /spec-kitty.tasks)
```

### Source Code (repository root)

```
src/
├── ui/
│   ├── production_dashboard_tab.py  # MODIFY - main enhancement target
│   ├── widgets/
│   │   └── event_card.py            # NEW - expandable event card widget
│   └── dialogs/
│       └── (existing dialogs - no changes)
├── services/
│   └── event_service.py             # MODIFY - add get_events_with_progress()
└── utils/
    └── constants.py                 # MODIFY - add color constants
tests/
└── unit/
    └── test_event_service.py        # MODIFY - add tests for new method
```

**Structure Decision**: Single project layout. Feature adds one new widget class and enhances existing tab.

## Complexity Tracking

*No constitution violations. Feature is straightforward UI enhancement.*

## Implementation Approach

### Phase 0 Research Findings

1. **Existing EventService Methods**: `get_production_progress()`, `get_assembly_progress()`, `get_event_overall_progress()` provide all needed data per-event
2. **Missing Capability**: Need batch method to get progress for multiple events efficiently
3. **UI Pattern**: Toggle visibility for expandable cards (confirmed in planning)
4. **Color Constants**: Need to define status colors in constants.py

### Phase 1 Design

#### New Service Method

```python
# event_service.py
def get_events_with_progress(
    filter_type: str = "active_future",  # "active_future", "past", "all"
    date_from: date = None,
    date_to: date = None
) -> List[Dict[str, Any]]:
    """
    Get all events matching filter with their progress summaries.

    Returns list of dicts with:
    - event: Event instance
    - event_id: int
    - event_name: str
    - event_date: date
    - production_progress: list (from get_production_progress)
    - assembly_progress: list (from get_assembly_progress)
    - overall_progress: dict (from get_event_overall_progress)
    """
```

#### New UI Widget: EventCard

```python
# src/ui/widgets/event_card.py
class EventCard(ctk.CTkFrame):
    """
    Expandable card showing event progress summary.

    Collapsed: Event name, date, overall progress bar, fulfillment counts
    Expanded: Individual target progress bars, quick action buttons
    """

    def __init__(self, parent, event_data: dict, callbacks: dict):
        # event_data: Output from get_events_with_progress()
        # callbacks: {on_record_production, on_record_assembly, on_shopping_list, on_event_detail}

    def _create_collapsed_view(self):
        # Header row: event name, date, overall progress
        # Fulfillment summary: X pending | Y ready | Z delivered

    def _create_expanded_view(self):
        # Production targets with progress bars
        # Assembly targets with progress bars
        # Quick action buttons

    def toggle_expanded(self):
        # Show/hide expanded detail frame
```

#### Color Scheme

```python
# src/utils/constants.py
STATUS_COLORS = {
    "not_started": "#808080",      # Gray
    "in_progress": "#FFA500",      # Orange/Amber
    "complete": "#28A745",         # Green
    "exceeded": "#20B2AA",         # Light green/teal
}
```

#### Modified ProductionDashboardTab

Replace current single-event selector with:
1. Filter controls (dropdown + date pickers)
2. Scrollable frame of EventCard widgets
3. Refresh logic to rebuild cards on filter change

### Key Implementation Notes

1. **Backward Compatibility**: Keep existing `_create_event_progress_section()` code as fallback; can be removed after Feature 018 is stable

2. **Performance**: Use single `get_events_with_progress()` call instead of N calls per event

3. **Auto-Refresh**: Dashboard already has `refresh()` method; enhance to rebuild event cards

4. **Quick Actions**: Leverage existing dialog infrastructure:
   - `RecordProductionDialog` and `RecordAssemblyDialog` already accept `event_id` parameter
   - Shopping list uses existing `event_service.get_shopping_list()`

5. **Event Detail Navigation**: Existing `_navigate_to_event_detail()` method can be reused

## Dependencies

- **EventService** (existing): get_production_progress, get_assembly_progress, get_event_overall_progress
- **ProductionDashboardTab** (existing): Base class to enhance
- **RecordProductionDialog, RecordAssemblyDialog** (existing): Quick action targets
- **Event model** (existing): event_date field for filtering

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Performance with many events | Medium | Batch query in get_events_with_progress(); pagination for 20+ events |
| CustomTkinter card styling | Low | Use standard CTkFrame with border; no complex custom widgets |
| Date picker availability | Low | Use tkcalendar or simple CTkEntry with date format validation |

## Next Steps

1. Run `/spec-kitty.tasks` to generate work packages
2. Implement in order: service method → widget → tab enhancement → tests
