# Work Packages: Phase 1 Ingredient Hierarchy Fixes

**Inputs**: Design documents from `/kitty-specs/033-phase-1-ingredient/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: Unit tests required for service layer functions per constitution (>70% coverage).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/planned/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Service Layer Functions (Priority: P0 - Foundational)

**Goal**: Add three validation/counting convenience functions to `ingredient_hierarchy_service.py` with full test coverage.
**Independent Test**: All new functions return expected results for L0/L1/L2 ingredients; tests pass.
**Prompt**: `tasks/planned/WP01-service-layer-functions.md`

### Included Subtasks
- [ ] T001 [P] Implement `get_child_count(ingredient_id, session=None) -> int` in `src/services/ingredient_hierarchy_service.py`
- [ ] T002 [P] Implement `get_product_count(ingredient_id, session=None) -> int` in `src/services/ingredient_hierarchy_service.py`
- [ ] T003 Implement `can_change_parent(ingredient_id, new_parent_id, session=None) -> dict` in `src/services/ingredient_hierarchy_service.py`
- [ ] T004 Add unit tests for all three functions in `src/tests/services/test_ingredient_hierarchy_service.py`

### Implementation Notes
- T001 and T002 are simple COUNT queries, can be implemented in parallel
- T003 wraps existing `validate_hierarchy()` with try/except, adds count gathering
- Return format for T003: `{allowed: bool, reason: str, warnings: list, child_count: int, product_count: int, new_level: int}`
- All functions must accept optional `session` parameter per session management pattern

### Parallel Opportunities
- T001 and T002 can be implemented simultaneously (different queries)
- T003 depends on T001 and T002 for count gathering
- T004 can start once any function is complete

### Dependencies
- None (foundational package)

### Risks & Mitigations
- Risk: Session management pattern violation → Follow existing function patterns in file
- Risk: Missing edge cases → Test with L0/L1/L2 and ingredients with/without children and products

---

## Work Package WP02: UI Form Fix - Remove Level Selector (Priority: P1) MVP

**Goal**: Fix the conceptual model issue by removing the explicit level dropdown and displaying computed level based on parent selection.
**Independent Test**: Open Add/Edit ingredient form, verify level displays correctly based on parent selection, no level dropdown exists.
**Prompt**: `tasks/planned/WP02-ui-form-fix.md`

### Included Subtasks
- [ ] T005 Remove `ingredient_level_dropdown` and `ingredient_level_var` from `src/ui/ingredients_tab.py` (lines ~866-879)
- [ ] T006 Add read-only `level_display` CTkLabel to show computed level
- [ ] T007 Implement `_compute_and_display_level()` helper method
- [ ] T008 Update `_on_l0_change()` and `_on_l1_change()` callbacks to compute level
- [ ] T009 Filter parent dropdowns to exclude L2 ingredients in `_build_l0_options()` and L1 refresh
- [ ] T010 Add inline warning display using `can_change_parent()` when editing existing ingredient

### Implementation Notes
- Remove lines 866-879 (level dropdown creation)
- Add level_display label that shows "Level: L0 (Root)" / "Level: L1 (Subcategory)" / "Level: L2 (Leaf)"
- Level is computed: no parent = L0, L0 parent = L1, L1 parent = L2
- Filter `_build_l0_options()` to only return `hierarchy_level in (0, 1)`
- Warning display is informational only (non-blocking per planning decision)

### Parallel Opportunities
- T005, T006, T007 can be done together as form restructuring
- T008, T009 relate to callback updates
- T010 is the final integration step

### Dependencies
- Depends on WP01 (needs `can_change_parent()` for T010)

### Risks & Mitigations
- Risk: Breaking existing form functionality → Test add/edit flows manually
- Risk: Missing callback updates → Trace all parent dropdown change handlers

---

## Work Package WP03: Hierarchy Path Display (Priority: P3)

**Goal**: Add hierarchy path column to ingredients tab list view showing full path like "Baking > Flour > All-Purpose Flour".
**Independent Test**: View ingredients list, verify each ingredient shows correct hierarchy path in new column.
**Prompt**: `tasks/planned/WP03-hierarchy-path-display.md`

### Included Subtasks
- [ ] T011 Add `hierarchy_path` column to treeview definition in `src/ui/ingredients_tab.py`
- [ ] T012 [P] Implement `_build_hierarchy_path_cache()` method using `get_ancestors()`
- [ ] T013 Update list population to display hierarchy paths from cache

### Implementation Notes
- Follow pattern from inventory_tab.py which already has hierarchy path display
- Use existing `get_ancestors()` from `ingredient_hierarchy_service.py`
- Build cache on data refresh to avoid N+1 queries
- Path format: "L0 > L1 > L2" or just "L0" for root ingredients

### Parallel Opportunities
- T012 can be implemented independently (new method)
- T011 and T013 are sequential (define column, then populate)

### Dependencies
- None (uses existing `get_ancestors()`)
- Can run in parallel with WP02 (different sections of same file)

### Risks & Mitigations
- Risk: N+1 query performance → Use caching pattern like inventory tab
- Risk: Cache stale after edits → Refresh cache on data changes

---

## Work Package WP04: Legacy Form Deprecation (Priority: P4 - Cleanup)

**Goal**: Mark `ingredient_form.py` legacy dialog as deprecated to prevent future use.
**Independent Test**: Open legacy form (if accessible), verify deprecation warning appears.
**Prompt**: `tasks/planned/WP04-legacy-form-deprecation.md`

### Included Subtasks
- [ ] T014 Add deprecation docstring and comment to `src/ui/forms/ingredient_form.py`
- [ ] T015 [P] Add runtime warning when dialog is opened (optional)

### Implementation Notes
- Add module-level docstring: "DEPRECATED: Use inline form in ingredients_tab.py instead"
- Add warning in `__init__`: `warnings.warn("IngredientFormDialog is deprecated", DeprecationWarning)`
- Search for usages of `IngredientFormDialog` to document call sites

### Parallel Opportunities
- T014 and T015 can be done in parallel
- Entire WP04 can run in parallel with WP02/WP03

### Dependencies
- None (independent cleanup)

### Risks & Mitigations
- Risk: Breaking existing functionality → Verify dialog not used in main flow
- Risk: Warning noise → Use stacklevel=2 for accurate call site reporting

---

## Dependency & Execution Summary

```
WP01 (Service Functions)
   ↓
WP02 (UI Form Fix) ←--- MVP SCOPE
   ↓
WP03 (Hierarchy Path Display)
   ↓
WP04 (Legacy Deprecation) ← Can run in parallel with WP02/WP03
```

- **Sequence**: WP01 → WP02 → WP03 → WP04
- **Parallelization**: WP04 can run in parallel once WP01 is complete
- **MVP Scope**: WP01 + WP02 constitute the minimal release (fixes the conceptual model issue)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Implement `get_child_count()` | WP01 | P0 | Yes |
| T002 | Implement `get_product_count()` | WP01 | P0 | Yes |
| T003 | Implement `can_change_parent()` | WP01 | P0 | No |
| T004 | Add unit tests for service functions | WP01 | P0 | No |
| T005 | Remove level dropdown | WP02 | P1 | No |
| T006 | Add level display label | WP02 | P1 | No |
| T007 | Implement level computation helper | WP02 | P1 | No |
| T008 | Update parent change callbacks | WP02 | P1 | No |
| T009 | Filter parent dropdowns (exclude L2) | WP02 | P1 | No |
| T010 | Add inline warning display | WP02 | P1 | No |
| T011 | Add hierarchy_path column | WP03 | P3 | No |
| T012 | Implement hierarchy path cache | WP03 | P3 | Yes |
| T013 | Display paths in list view | WP03 | P3 | No |
| T014 | Add deprecation docstring | WP04 | P4 | Yes |
| T015 | Add runtime deprecation warning | WP04 | P4 | Yes |
