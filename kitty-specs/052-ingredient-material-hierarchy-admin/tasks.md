# Work Packages: Ingredient & Material Hierarchy Admin

**Inputs**: Design documents from `/kitty-specs/052-ingredient-material-hierarchy-admin/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: Service layer tests required per constitution (>70% coverage).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Precise file paths provided for each subtask.

## Parallelization Strategy

```
WP01 (Ingredient Display) ‚îÄ‚îÄ‚îê
                            ‚îú‚îÄ‚îÄ‚ñ∫ WP03 (Services) ‚îÄ‚îÄ‚ñ∫ WP04 (Admin UI) ‚îÄ‚îÄ‚ñ∫ WP05-WP07 (Operations) ‚îÄ‚îÄ‚ñ∫ WP08 (Polish)
WP02 (Material Display) ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**WP01 and WP02 can run in parallel** (separate files, no dependencies).

---

## Work Package WP01: Ingredient Display Changes (Priority: P1) üéØ MVP

**Goal**: Display only L2 (leaf) ingredients in Ingredients tab with L0/L1 parent columns.
**Independent Test**: Open Ingredients tab, verify only leaf ingredients shown with three columns (L0, L1, Ingredient).
**Prompt**: `tasks/WP01-ingredient-display-changes.md`

### Included Subtasks
- [ ] T001 [P] Create `src/services/ingredient_hierarchy_service.py` with `get_leaf_ingredients()` method
- [ ] T002 [P] Add `get_ingredient_with_ancestors()` to return L0/L1/L2 names
- [ ] T003 Create `src/tests/services/test_ingredient_hierarchy_service.py` with unit tests
- [ ] T004 Modify `src/ui/ingredients_tab.py` to call hierarchy service instead of direct query
- [ ] T005 Add L0 and L1 columns to ingredients table display
- [ ] T006 Update filter functionality to work with L2-only display

### Implementation Notes
- Service returns list of L2 ingredients with eager-loaded parent chain
- UI changes affect `_create_table()` and `_load_data()` methods
- Preserve existing filter-by-category dropdown (filter by L0)

### Parallel Opportunities
- T001-T002 (service) can run parallel with WP02 (different files)
- T003 (tests) follows T001-T002

### Dependencies
- None (starting package).

### Risks & Mitigations
- Performance with many ingredients ‚Üí eager-load parent relationships in single query

---

## Work Package WP02: Material Display Changes (Priority: P1) üéØ MVP

**Goal**: Display only materials (not categories/subcategories) in Materials tab with parent columns.
**Independent Test**: Open Materials tab, verify only materials shown with Category and Subcategory columns.
**Prompt**: `tasks/WP02-material-display-changes.md`

### Included Subtasks
- [ ] T007 [P] Create `src/services/material_hierarchy_service.py` with `get_materials_with_parents()` method
- [ ] T008 Create `src/tests/services/test_material_hierarchy_service.py` with unit tests
- [ ] T009 Modify `src/ui/materials_tab.py` to call hierarchy service
- [ ] T010 Add Category and Subcategory columns to materials table display
- [ ] T011 Update filter functionality to work with materials-only display

### Implementation Notes
- Service joins Material ‚Üí MaterialSubcategory ‚Üí MaterialCategory
- Return dict with category_name, subcategory_name, material object

### Parallel Opportunities
- **Entire WP02 can run parallel with WP01** (different service/UI files)

### Dependencies
- None (can start immediately, parallel with WP01).

### Risks & Mitigations
- Similar to WP01 ‚Üí use same pattern for consistency

---

## Work Package WP03: Hierarchy Admin Services (Priority: P2)

**Goal**: Create shared service layer for hierarchy admin operations.
**Independent Test**: Unit tests pass for all service methods; services can build tree structures.
**Prompt**: `tasks/WP03-hierarchy-admin-services.md`

### Included Subtasks
- [ ] T012 Create `src/services/hierarchy_admin_service.py` with shared utilities
- [ ] T013 Add `validate_unique_sibling_name()` for name uniqueness validation
- [ ] T014 Add `generate_slug()` for URL-friendly slug generation
- [ ] T015 Add `validate_no_cycle()` for reparent cycle detection
- [ ] T016 Add `get_hierarchy_tree()` to `ingredient_hierarchy_service.py`
- [ ] T017 Add `get_usage_counts()` to `ingredient_hierarchy_service.py`
- [ ] T018 Add `get_hierarchy_tree()` to `material_hierarchy_service.py`
- [ ] T019 Add `get_usage_counts()` to `material_hierarchy_service.py`
- [ ] T020 Create `src/tests/services/test_hierarchy_admin_service.py`
- [ ] T021 Extend tests for tree and usage count methods

### Implementation Notes
- Tree structure returns nested dicts: `{name, level, children: [...], entity}`
- Usage counts query Product and RecipeIngredient tables
- Cycle detection uses `get_descendants()` from Ingredient model

### Parallel Opportunities
- T012-T15 (shared service) can parallel with T16-T17 (ingredient) and T18-T19 (material)

### Dependencies
- Depends on WP01, WP02 (uses services created there).

### Risks & Mitigations
- Recursive tree queries ‚Üí limit depth to 3 levels (known max)

---

## Work Package WP04: Hierarchy Admin UI Shell (Priority: P2)

**Goal**: Create reusable tree admin window configurable for Ingredients or Materials.
**Independent Test**: Open admin window, see tree view with expand/collapse, select item to see details.
**Prompt**: `tasks/WP04-hierarchy-admin-ui-shell.md`

### Included Subtasks
- [ ] T022 Create `src/ui/hierarchy_admin_window.py` as CTkToplevel window
- [ ] T023 Implement tree view using ttk.Treeview with CustomTkinter styling
- [ ] T024 Implement expand/collapse functionality
- [ ] T025 Implement item selection with detail panel
- [ ] T026 Display usage counts (products, recipes) for selected item
- [ ] T027 Add configuration parameter to switch between Ingredient/Material mode
- [ ] T028 Create action button placeholders (Add, Rename, Reparent)

### Implementation Notes
- Single window class with `entity_type` parameter ("ingredient" or "material")
- Calls appropriate hierarchy service based on mode
- Tree loads on open; detail panel updates on selection

### Parallel Opportunities
- Limited - UI must be built sequentially

### Dependencies
- Depends on WP03 (needs tree and usage count services).

### Risks & Mitigations
- ttk.Treeview styling ‚Üí test on both Windows and macOS

---

## Work Package WP05: Add Operations (Priority: P2)

**Goal**: Implement add functionality for new L2 ingredients and materials.
**Independent Test**: Add new ingredient via admin UI, verify it appears in Ingredients tab and dropdowns.
**Prompt**: `tasks/WP05-add-operations.md`

### Included Subtasks
- [ ] T029 Add `add_leaf_ingredient()` to `ingredient_hierarchy_service.py`
- [ ] T030 Add `add_material()` to `material_hierarchy_service.py`
- [ ] T031 Create add dialog in `hierarchy_admin_window.py`
- [ ] T032 Implement parent selection (L1 for ingredients, subcategory for materials)
- [ ] T033 Implement name validation (unique among siblings, non-empty)
- [ ] T034 Refresh tree after successful add
- [ ] T035 Add tests for add operations

### Implementation Notes
- Dialog shows parent dropdown, name input, confirm/cancel
- Auto-generate slug from name
- Set hierarchy_level=2 for new ingredients

### Parallel Opportunities
- T029 (ingredient) and T030 (material) can parallel

### Dependencies
- Depends on WP04 (needs admin UI shell).

### Risks & Mitigations
- Duplicate name error ‚Üí show user-friendly validation message

---

## Work Package WP06: Rename Operations (Priority: P2)

**Goal**: Implement rename functionality for any hierarchy item.
**Independent Test**: Rename ingredient, verify new name appears in Products and Recipes that use it.
**Prompt**: `tasks/WP06-rename-operations.md`

### Included Subtasks
- [ ] T036 Add `rename_ingredient()` to `ingredient_hierarchy_service.py`
- [ ] T037 Add `rename_item()` to `material_hierarchy_service.py` (category, subcategory, or material)
- [ ] T038 Create rename dialog in `hierarchy_admin_window.py`
- [ ] T039 Pre-populate current name in dialog
- [ ] T040 Implement name validation (unique among siblings)
- [ ] T041 Regenerate slug on rename
- [ ] T042 Refresh tree and detail panel after rename
- [ ] T043 Add tests for rename operations

### Implementation Notes
- Dialog shows current name (editable), confirm/cancel
- Validate new name doesn't conflict with siblings
- FK relationships ensure Products/Recipes show new name automatically

### Parallel Opportunities
- T036 (ingredient) and T037 (material) can parallel

### Dependencies
- Depends on WP04 (needs admin UI shell).
- Can parallel with WP05 (different operations).

### Risks & Mitigations
- None significant - FK design handles propagation

---

## Work Package WP07: Reparent Operations (Priority: P3)

**Goal**: Implement reparent functionality to move items between parents.
**Independent Test**: Move L2 ingredient to new L1, verify new hierarchy path displays correctly.
**Prompt**: `tasks/WP07-reparent-operations.md`

### Included Subtasks
- [ ] T044 Add `reparent_ingredient()` to `ingredient_hierarchy_service.py`
- [ ] T045 Add `reparent_material()` to `material_hierarchy_service.py`
- [ ] T046 Add `reparent_subcategory()` to `material_hierarchy_service.py`
- [ ] T047 Create reparent dialog in `hierarchy_admin_window.py`
- [ ] T048 Implement new parent dropdown (filtered to valid targets)
- [ ] T049 Implement cycle detection validation
- [ ] T050 Refresh tree after reparent (item moves in tree)
- [ ] T051 Add tests for reparent operations including cycle detection

### Implementation Notes
- Dialog shows new parent dropdown, excludes current parent and descendants
- For ingredients: L2 can move to L1, L1 can move to L0
- For materials: material to subcategory, subcategory to category

### Parallel Opportunities
- T044 (ingredient) and T045-T046 (material) can parallel

### Dependencies
- Depends on WP04 (needs admin UI shell).
- Can parallel with WP05, WP06.

### Risks & Mitigations
- Cycle creation ‚Üí validate before save using `validate_no_cycle()`

---

## Work Package WP08: Integration & Polish (Priority: P3)

**Goal**: Integrate admin UI into application menu and perform final validation.
**Independent Test**: Access Hierarchy Admin from Catalog menu, complete full workflow (add, rename, reparent).
**Prompt**: `tasks/WP08-integration-polish.md`

### Included Subtasks
- [ ] T052 Add "Hierarchy Admin" menu option in Catalog mode (main_window.py or menu)
- [ ] T053 Wire menu to open Hierarchy Admin window for Ingredients
- [ ] T054 Wire menu to open Hierarchy Admin window for Materials
- [ ] T055 Verify all acceptance criteria from spec (SC-001 through SC-008)
- [ ] T056 Verify historical recipe snapshots unchanged after operations
- [ ] T057 Final code cleanup and docstrings

### Implementation Notes
- Menu structure: Catalog ‚Üí Hierarchy Admin ‚Üí Ingredients / Materials
- Or: Catalog ‚Üí Ingredients Admin / Materials Admin (simpler)

### Parallel Opportunities
- T055-T056 (verification) can parallel with T057 (cleanup)

### Dependencies
- Depends on WP05, WP06, WP07 (all operations complete).

### Risks & Mitigations
- Menu location confusion ‚Üí match existing Catalog mode patterns

---

## Dependency & Execution Summary

```
Phase 1 (Parallel MVP):
‚îú‚îÄ‚îÄ WP01: Ingredient Display [P] ‚îÄ‚îÄ‚îê
‚îî‚îÄ‚îÄ WP02: Material Display [P] ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚ñ∫ Phase 2

Phase 2 (Services):
‚îî‚îÄ‚îÄ WP03: Hierarchy Admin Services ‚îÄ‚îÄ‚ñ∫ Phase 3

Phase 3 (UI Shell):
‚îî‚îÄ‚îÄ WP04: Hierarchy Admin UI Shell ‚îÄ‚îÄ‚ñ∫ Phase 4

Phase 4 (Operations - Can Parallel):
‚îú‚îÄ‚îÄ WP05: Add Operations [P] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îú‚îÄ‚îÄ WP06: Rename Operations [P] ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚ñ∫ Phase 5
‚îî‚îÄ‚îÄ WP07: Reparent Operations [P] ‚îÄ‚îò

Phase 5 (Polish):
‚îî‚îÄ‚îÄ WP08: Integration & Polish
```

**MVP Scope**: WP01 + WP02 deliver immediate user value (clearer listings). Full feature requires all packages.

---

## Subtask Index (Reference)

| ID | Summary | WP | Priority | Parallel? |
|----|---------|-----|----------|-----------|
| T001 | Create ingredient_hierarchy_service.py | WP01 | P1 | Yes |
| T002 | Add get_ingredient_with_ancestors() | WP01 | P1 | Yes |
| T003 | Tests for ingredient hierarchy service | WP01 | P1 | No |
| T004 | Modify ingredients_tab.py for service call | WP01 | P1 | No |
| T005 | Add L0/L1 columns to ingredients table | WP01 | P1 | No |
| T006 | Update ingredient filter functionality | WP01 | P1 | No |
| T007 | Create material_hierarchy_service.py | WP02 | P1 | Yes |
| T008 | Tests for material hierarchy service | WP02 | P1 | No |
| T009 | Modify materials_tab.py for service call | WP02 | P1 | No |
| T010 | Add Category/Subcategory columns | WP02 | P1 | No |
| T011 | Update material filter functionality | WP02 | P1 | No |
| T012 | Create hierarchy_admin_service.py | WP03 | P2 | Yes |
| T013 | Add validate_unique_sibling_name() | WP03 | P2 | No |
| T014 | Add generate_slug() | WP03 | P2 | No |
| T015 | Add validate_no_cycle() | WP03 | P2 | No |
| T016 | Add get_hierarchy_tree() for ingredients | WP03 | P2 | Yes |
| T017 | Add get_usage_counts() for ingredients | WP03 | P2 | Yes |
| T018 | Add get_hierarchy_tree() for materials | WP03 | P2 | Yes |
| T019 | Add get_usage_counts() for materials | WP03 | P2 | Yes |
| T020 | Tests for hierarchy_admin_service | WP03 | P2 | No |
| T021 | Tests for tree and usage count methods | WP03 | P2 | No |
| T022 | Create hierarchy_admin_window.py | WP04 | P2 | No |
| T023 | Implement ttk.Treeview with styling | WP04 | P2 | No |
| T024 | Implement expand/collapse | WP04 | P2 | No |
| T025 | Implement item selection with detail panel | WP04 | P2 | No |
| T026 | Display usage counts in detail panel | WP04 | P2 | No |
| T027 | Add entity_type configuration parameter | WP04 | P2 | No |
| T028 | Create action button placeholders | WP04 | P2 | No |
| T029 | Add add_leaf_ingredient() | WP05 | P2 | Yes |
| T030 | Add add_material() | WP05 | P2 | Yes |
| T031 | Create add dialog in admin window | WP05 | P2 | No |
| T032 | Implement parent selection in add dialog | WP05 | P2 | No |
| T033 | Implement name validation in add | WP05 | P2 | No |
| T034 | Refresh tree after add | WP05 | P2 | No |
| T035 | Tests for add operations | WP05 | P2 | No |
| T036 | Add rename_ingredient() | WP06 | P2 | Yes |
| T037 | Add rename_item() for materials | WP06 | P2 | Yes |
| T038 | Create rename dialog | WP06 | P2 | No |
| T039 | Pre-populate current name | WP06 | P2 | No |
| T040 | Name validation in rename | WP06 | P2 | No |
| T041 | Regenerate slug on rename | WP06 | P2 | No |
| T042 | Refresh tree after rename | WP06 | P2 | No |
| T043 | Tests for rename operations | WP06 | P2 | No |
| T044 | Add reparent_ingredient() | WP07 | P3 | Yes |
| T045 | Add reparent_material() | WP07 | P3 | Yes |
| T046 | Add reparent_subcategory() | WP07 | P3 | Yes |
| T047 | Create reparent dialog | WP07 | P3 | No |
| T048 | Implement parent dropdown in reparent | WP07 | P3 | No |
| T049 | Cycle detection in reparent | WP07 | P3 | No |
| T050 | Refresh tree after reparent | WP07 | P3 | No |
| T051 | Tests for reparent including cycles | WP07 | P3 | No |
| T052 | Add Hierarchy Admin menu option | WP08 | P3 | No |
| T053 | Wire menu to Ingredients admin | WP08 | P3 | No |
| T054 | Wire menu to Materials admin | WP08 | P3 | No |
| T055 | Verify acceptance criteria SC-001-008 | WP08 | P3 | Yes |
| T056 | Verify historical snapshots unchanged | WP08 | P3 | Yes |
| T057 | Final cleanup and docstrings | WP08 | P3 | Yes |
