# Work Packages: FinishedUnit Model Refactoring

**Inputs**: Design documents from `/kitty-specs/004-finishedunit-model-refactoring/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, contracts/, quickstart.md

**Tests**: Explicit testing included per constitution requirements (70% service layer coverage).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/planned/` generated by `/spec-kitty.tasks`. Treat this file as the high-level checklist; keep deep implementation detail inside the prompt files.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

## Path Conventions
- **Single project**: `src/`, `tests/`
- Paths match the desktop application structure per implementation plan.

---

## Work Package WP01: Database Foundation & Migration Infrastructure (Priority: P0)

**Goal**: Create database models and migration infrastructure for two-tier hierarchical system.
**Independent Test**: Models can be created and migrated with full data preservation validation.
**Prompt**: `/tasks/planned/WP01-database-foundation.md`

### Included Subtasks
- [ ] T001: Create database backup and validation utilities
- [ ] T002: Create FinishedUnit model (renamed from existing FinishedGood)
- [ ] T003: Create new FinishedGood model for assemblies
- [ ] T004: Create Composition junction model with polymorphic references
- [ ] T005: Create migration service with backup/restore functions
- [ ] T006: Create migration orchestrator for coordinated schema updates

### Implementation Notes
- Models use separate foreign keys pattern for polymorphic relationships
- Migration strategy: backup-and-restore for desktop application safety
- All existing FinishedGood data preserved and migrated to FinishedUnit

### Parallel Opportunities
- T002, T003, T004 can be developed concurrently (different model files)

### Dependencies
- None (foundation package)

### Risks
- Data migration complexity, referential integrity preservation

---

## Work Package WP02: Core Service Layer Implementation (Priority: P1)

**Goal**: Implement service layer for User Story 1 (Track Individual Consumable Items).
**Independent Test**: Complete CRUD operations for FinishedUnit with inventory management.
**Prompt**: `/tasks/planned/WP02-core-service-layer.md`

### Included Subtasks
- [ ] T007: Implement FinishedUnit service with CRUD operations and inventory management
- [ ] T008: Add database indexes for FinishedUnit performance optimization
- [ ] T009: Create unit tests for FinishedUnit service (70%+ coverage)
- [ ] T010: Validate migration workflow with existing data patterns

### Implementation Notes
- FinishedUnit service maintains API compatibility with existing FinishedGood usage
- FIFO cost calculation integration preserved
- Performance targets: <2s CRUD operations, <200ms inventory queries

### Parallel Opportunities
- T008 can proceed parallel with T007 development

### Dependencies
- WP01 (requires database models and migration infrastructure)

### Risks
- API compatibility during transition, performance regression

---

## Work Package WP03: Assembly Management Services (Priority: P2)

**Goal**: Implement service layer for User Story 2 (Create Simple Package Assemblies).
**Independent Test**: Create and manage FinishedGood assemblies with component tracking.
**Prompt**: `/tasks/planned/WP03-assembly-management.md`

### Included Subtasks
- [ ] T011: Implement FinishedGood service with assembly creation and management
- [ ] T012: Implement Composition service for relationship management
- [ ] T013: [P] Add assembly type enumeration and metadata handling
- [ ] T014: Create unit tests for assembly services (70%+ coverage)

### Implementation Notes
- Breadth-first hierarchy traversal using iterative application logic
- Component availability validation before assembly creation
- Cost calculation aggregation across component levels

### Parallel Opportunities
- T013 can proceed parallel with T011/T012 development

### Dependencies
- WP02 (requires FinishedUnit service for component management)

### Risks
- Hierarchy complexity, component availability validation

---

## Work Package WP04: Hierarchical Composition Features (Priority: P3)

**Goal**: Implement service layer for User Story 3 (Create Nested Package Hierarchies).
**Independent Test**: Create and manage complex nested assemblies with multi-level component tracking.
**Prompt**: `/tasks/planned/WP04-hierarchical-composition.md`

### Included Subtasks
- [ ] T015: Implement circular reference prevention with breadth-first validation
- [ ] T016: Add hierarchy traversal optimization for 5-level depth support
- [ ] T017: Create integration tests for complex hierarchy scenarios
- [ ] T018: Add performance benchmarks for hierarchy operations (<500ms queries)

### Implementation Notes
- Maximum 5-level hierarchy depth with visited node tracking
- Circular reference prevention using graph algorithms
- Performance optimization for complex assembly queries

### Parallel Opportunities
- T017 and T018 can proceed parallel with core implementation

### Dependencies
- WP03 (requires assembly management services)

### Risks
- Circular reference edge cases, performance at scale

---

## Work Package WP05: Integration & Testing Suite (Priority: P4)

**Goal**: Comprehensive testing and integration validation for all hierarchical features.
**Independent Test**: Full test suite passes with >70% service layer coverage and performance benchmarks met.
**Prompt**: `/tasks/planned/WP05-integration-testing.md`

### Included Subtasks
- [ ] T019: Create integration tests for cross-service operations
- [ ] T020: Create performance benchmarks for all service operations
- [ ] T021: Create migration integration tests with production data patterns
- [ ] T022: Validate constitution compliance and architecture alignment

### Implementation Notes
- Integration tests cover complete user workflows from all three user stories
- Performance validation against targets: <500ms queries, <2s operations, <30s assemblies
- Migration tests use realistic data volumes and patterns

### Parallel Opportunities
- All testing tasks can proceed in parallel once core services complete

### Dependencies
- WP04 (requires all core functionality complete)

### Risks
- Performance bottlenecks, edge case discovery

---

## Work Package WP06: UI Integration & Compatibility (Priority: P5)

**Goal**: Update UI layer to use new service interfaces and maintain feature compatibility.
**Independent Test**: All existing UI functionality works with new model structure, no user workflow disruption.
**Prompt**: `/tasks/planned/WP06-ui-integration.md`

### Included Subtasks
- [ ] T023: Update existing UI components to use FinishedUnit service
- [ ] T024: Add deprecation warnings for legacy API usage patterns
- [ ] T025: Create UI compatibility layer for transition period
- [ ] T026: Update UI service integration points

### Implementation Notes
- Gradual UI migration with backward compatibility preservation
- Clear deprecation path for legacy FinishedGood UI patterns
- No user-visible changes during transition period

### Parallel Opportunities
- T024 and T025 can proceed parallel with core UI updates

### Dependencies
- WP05 (requires validated service layer)

### Risks
- UI disruption, user experience regression

---

## Execution Strategy

### MVP Scope (Immediate Value)
- **WP01 + WP02**: Provides User Story 1 capability with individual item tracking
- Estimated effort: 8-12 hours
- Deliverable: Working FinishedUnit model with complete CRUD operations

### Full Feature Scope
- **All Work Packages**: Complete two-tier hierarchical system
- Estimated effort: 20-25 hours
- Deliverable: All three user stories implemented with full hierarchy support

### Parallelization Opportunities
- **Phase 1**: WP01 (sequential foundation)
- **Phase 2**: WP02 + early WP03 tasks (parallel development)
- **Phase 3**: WP04 + WP05 testing (parallel optimization)
- **Phase 4**: WP06 (UI integration)

### Critical Path
WP01 → WP02 → WP03 → WP04 (core functionality pipeline)
WP05 and WP06 can overlap with later stages of core development

---

## Performance Targets Summary

- **Individual operations**: <2s CRUD operations
- **Inventory queries**: <500ms for 10k items
- **Assembly creation**: <30s for 20-component assemblies
- **Hierarchy traversal**: <500ms for 5-level depth
- **Test coverage**: 70%+ service layer coverage
- **Migration**: Zero data loss with integrity validation