# Work Packages: Materials Management System

**Inputs**: Design documents from `/kitty-specs/047-materials-management-system/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, contracts/, quickstart.md

**Tests**: Service layer tests required per constitution (>70% coverage). UI tests optional.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`. Lane status is stored in YAML frontmatter (`lane: planned|doing|for_review|done`).

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

## Path Conventions
- **Single project**: `src/models/`, `src/services/`, `src/ui/`, `src/tests/`

---

## Work Package WP01: Foundation - Material Models (Priority: P0) ðŸŽ¯ MVP

**Goal**: Create all 7 SQLAlchemy models for materials management. This is the foundation everything else depends on.
**Independent Test**: Models can be imported without errors; database tables created successfully via `Base.metadata.create_all()`.
**Prompt**: `tasks/WP01-foundation-material-models.md`

### Included Subtasks
- [ ] T001 [P] Create MaterialCategory model in `src/models/material_category.py`
- [ ] T002 [P] Create MaterialSubcategory model in `src/models/material_subcategory.py`
- [ ] T003 [P] Create Material model in `src/models/material.py`
- [ ] T004 [P] Create MaterialProduct model in `src/models/material_product.py`
- [ ] T005 [P] Create MaterialUnit model in `src/models/material_unit.py`
- [ ] T006 [P] Create MaterialPurchase model in `src/models/material_purchase.py`
- [ ] T007 [P] Create MaterialConsumption model in `src/models/material_consumption.py`
- [ ] T008 Update `src/models/__init__.py` to export all new models

### Implementation Notes
- All models inherit from `BaseModel` in `src/models/base.py`
- Follow existing patterns from `ingredient.py`, `product.py`, `purchase.py`
- See `data-model.md` for complete field definitions and constraints
- Use `session_scope()` pattern for session management

### Parallel Opportunities
- **All 7 models (T001-T007) can be built in parallel** - no dependencies between them
- T008 must wait until all models exist

### Dependencies
- None (starting package)

### Risks & Mitigations
- Foreign key ordering in imports: Ensure `__init__.py` exports in dependency order
- Constraint naming conflicts: Use prefixes like `ck_material_category_*`

---

## Work Package WP02: Catalog Service - User Story 1 (Priority: P1) ðŸŽ¯ MVP

**Goal**: Implement CRUD operations for the material hierarchy (Category > Subcategory > Material > Product).
**Independent Test**: Can create complete hierarchy via service calls; validates FR-001 through FR-005.
**Prompt**: `tasks/WP02-catalog-service.md`

### Included Subtasks
- [ ] T009 Create `src/services/material_catalog_service.py` with category CRUD
- [ ] T010 Add subcategory CRUD to material_catalog_service
- [ ] T011 Add material CRUD to material_catalog_service
- [ ] T012 Add product CRUD to material_catalog_service
- [ ] T013 Implement slug auto-generation for all entities
- [ ] T014 Implement cascade delete validation rules
- [ ] T015 [P] Create `src/tests/test_material_catalog_service.py`
- [ ] T016 Update `src/services/__init__.py` to export new service

### Implementation Notes
- Follow `ingredient_crud_service.py` pattern
- All functions accept optional `session=None` parameter
- Slug generation: `slug = slug or slugify(name)`
- Delete validation: check for children before allowing delete

### Parallel Opportunities
- T015 (tests) can be written in parallel with service implementation

### Dependencies
- Depends on WP01 (models must exist)

### Risks & Mitigations
- Unique constraint violations: Return clear error messages for duplicate names/slugs

---

## Work Package WP03: Purchase Service - User Story 2 (Priority: P1) ðŸŽ¯ MVP

**Goal**: Implement purchase recording and inventory management with weighted average costing.
**Independent Test**: Record purchases, verify inventory updates, verify weighted average recalculation.
**Prompt**: `tasks/WP03-purchase-service.md`

### Included Subtasks
- [ ] T017 Create `src/services/material_purchase_service.py` with record_purchase()
- [ ] T018 Implement weighted_average_cost calculation
- [ ] T019 Implement inventory update logic (atomic with purchase)
- [ ] T020 Implement inventory adjustment (by count or percentage)
- [ ] T021 Add unit conversion for package_unit to base_units
- [ ] T022 [P] Create `src/tests/test_material_purchase_service.py`
- [ ] T023 Update `src/services/__init__.py`

### Implementation Notes
- Weighted average: `new_avg = (old_qty * old_avg + new_qty * new_cost) / (old_qty + new_qty)`
- First purchase sets initial cost (no division by zero)
- Unit conversion uses `src/services/unit_converter.py` patterns
- MaterialPurchase is immutable (no updated_at)

### Parallel Opportunities
- T022 (tests) can be written in parallel

### Dependencies
- Depends on WP01 (models) and WP02 (catalog service for product creation)

### Risks & Mitigations
- Floating point precision: Use Decimal for cost calculations
- Unit conversion edge cases: Validate package_unit is recognized

---

## Work Package WP04: Material Units Service - User Story 3 (Priority: P1) ðŸŽ¯ MVP

**Goal**: Implement MaterialUnit management with availability and cost calculations.
**Independent Test**: Create MaterialUnit, verify available inventory aggregates across products correctly.
**Prompt**: `tasks/WP04-material-units-service.md`

### Included Subtasks
- [ ] T024 Create `src/services/material_unit_service.py` with unit CRUD
- [ ] T025 Implement get_available_inventory() aggregation
- [ ] T026 Implement get_current_cost() weighted across products
- [ ] T027 Implement preview_consumption() for allocation planning
- [ ] T028 [P] Create `src/tests/test_material_unit_service.py`
- [ ] T029 Update `src/services/__init__.py`

### Implementation Notes
- Available inventory: `floor(sum(product.current_inventory) / quantity_per_unit)`
- Current cost: Weighted average across products * quantity_per_unit
- preview_consumption returns allocation plan without modifying inventory

### Parallel Opportunities
- T028 (tests) can be written in parallel

### Dependencies
- Depends on WP01 (models) and WP03 (inventory must exist to calculate availability)

### Risks & Mitigations
- Division by zero: Handle case where quantity_per_unit = 0 (validation prevents this)
- No products for material: Return 0 inventory, 0 cost

---

## Work Package WP05: Composition Integration - User Stories 4 & 5 (Priority: P2)

**Goal**: Extend Composition model to support materials; enable adding MaterialUnits and generic Material placeholders to FinishedGoods.
**Independent Test**: Add MaterialUnit and Material to FinishedGood composition; verify cost calculations separate food vs material.
**Prompt**: `tasks/WP05-composition-integration.md`

### Included Subtasks
- [ ] T030 Add `material_unit_id` column to `src/models/composition.py`
- [ ] T031 Add `material_id` column to `src/models/composition.py`
- [ ] T032 Update XOR constraint to 5-way (existing 3 + 2 new)
- [ ] T033 Add relationships: `material_unit_component`, `material_component`
- [ ] T034 Update composition factory methods for material types
- [ ] T035 Update `composition_service.py` for material cost calculations
- [ ] T036 Implement separate food vs material cost totals
- [ ] T037 [P] Update composition tests for new component types

### Implementation Notes
- XOR constraint ensures exactly ONE of 5 component types is set
- `is_generic` flag indicates deferred material (Material vs MaterialUnit)
- Cost calculation: sum material costs separately from food costs

### Parallel Opportunities
- T037 (tests) can be written in parallel with service changes

### Dependencies
- Depends on WP01 (Material models) and WP04 (MaterialUnit service for cost calculations)

### Risks & Mitigations
- Constraint migration: Since we're adding nullable columns, existing data remains valid
- XOR complexity: Test all 5 valid states and invalid combinations

---

## Work Package WP06: Assembly Consumption - User Story 6 (Priority: P2)

**Goal**: Implement material consumption during assembly with inventory decrements and historical snapshots.
**Independent Test**: Record assembly, verify material inventory decreases, verify MaterialConsumption snapshots created.
**Prompt**: `tasks/WP06-assembly-consumption.md`

### Included Subtasks
- [ ] T038 Create `src/services/material_consumption_service.py`
- [ ] T039 Implement get_pending_materials() for generic resolution
- [ ] T040 Implement validate_material_availability() checks
- [ ] T041 Implement record_material_consumption() with snapshots
- [ ] T042 Integrate with existing assembly_service.py
- [ ] T043 Implement inventory decrement logic (atomic with consumption)
- [ ] T044 Block assembly when inventory insufficient (FR-015)
- [ ] T045 [P] Create `src/tests/test_material_consumption_service.py`
- [ ] T046 Update `src/services/__init__.py`

### Implementation Notes
- Snapshot captures: product_name, material_name, subcategory_name, category_name, supplier_name, unit_cost
- Generic materials resolved via inline dropdown (UI) - service validates assignments match requirements
- Inventory must be sufficient - no bypass option per clarifications

### Parallel Opportunities
- T045 (tests) can be written in parallel

### Dependencies
- Depends on WP05 (Composition must support materials) and WP04 (MaterialUnit service)

### Risks & Mitigations
- Partial consumption failure: Use transaction to ensure atomic operation
- Snapshot data integrity: Capture all names at consumption time, not just IDs

---

## Work Package WP07: Materials Tab UI (Priority: P2)

**Goal**: Create CustomTkinter UI for materials management mirroring the Ingredients tab pattern.
**Independent Test**: User can navigate hierarchy, create/edit/delete entities, record purchases, view inventory.
**Prompt**: `tasks/WP07-materials-tab-ui.md`

### Included Subtasks
- [ ] T047 Create `src/ui/materials_tab.py` with tab structure
- [ ] T048 Implement hierarchy tree view (Category > Subcategory > Material)
- [ ] T049 Implement product list panel
- [ ] T050 Implement purchase recording form
- [ ] T051 Implement inventory adjustment controls
- [ ] T052 Implement MaterialUnit management UI
- [ ] T053 Add material to composition dialog integration
- [ ] T054 Wire up all service calls with error handling

### Implementation Notes
- Mirror `src/ui/ingredients_tab.py` structure
- Use existing UI component patterns (CTkFrame, CTkTreeview, etc.)
- Error messages displayed via CTkMessageBox

### Parallel Opportunities
- UI work can proceed in parallel with WP06 once services exist

### Dependencies
- Depends on WP02, WP03, WP04 (services must exist)

### Risks & Mitigations
- UI responsiveness: Use threading for long operations if needed
- Layout consistency: Follow existing tab patterns exactly

---

## Work Package WP08: Import/Export & Historical - User Stories 7 & 8 (Priority: P3)

**Goal**: Extend import/export for materials; implement historical query support.
**Independent Test**: Export materials, clear DB, import back; verify all data preserved. Query historical assembly, verify snapshot names returned.
**Prompt**: `tasks/WP08-import-export-historical.md`

### Included Subtasks
- [ ] T055 Extend `src/services/catalog_import_service.py` for materials
- [ ] T056 Extend `src/services/coordinated_export_service.py` for materials
- [ ] T057 Add material sections to import/export format (v4.x extension)
- [ ] T058 Implement get_consumption_history() query
- [ ] T059 Update assembly detail views to show material snapshots
- [ ] T060 [P] Add import/export tests for materials
- [ ] T061 [P] Add historical query tests

### Implementation Notes
- Import order: categories â†’ subcategories â†’ materials â†’ products â†’ units
- Export includes: all hierarchy levels + purchases + consumption history
- Historical queries use snapshot fields, not current catalog data

### Parallel Opportunities
- T060, T061 (tests) can be written in parallel
- Import and export can be developed in parallel

### Dependencies
- Depends on WP06 (MaterialConsumption must exist for history)

### Risks & Mitigations
- Import foreign key resolution: Validate suppliers exist before material import
- Large export files: Test with realistic data volumes

---

## Dependency & Execution Summary

```
WP01 (Models) â”€â”€â”€â”€â”€â”€â”¬â”€â”€> WP02 (Catalog) â”€â”€â”¬â”€â”€> WP03 (Purchases) â”€â”€> WP04 (Units) â”€â”€> WP05 (Composition)
                    â”‚                      â”‚                                              â”‚
                    â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€> WP06 (Assembly)
                    â”‚                                                                     â”‚         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€> WP07 (UI)
                                                                                          â”‚         â”‚
                                                                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€> WP08 (Import/Export)
```

- **Sequence**: WP01 â†’ WP02 â†’ WP03 â†’ WP04 â†’ WP05 â†’ WP06 â†’ WP07/WP08
- **Parallelization**:
  - WP01 subtasks T001-T007 can all run in parallel
  - Test subtasks can run parallel with their respective services
  - WP07 (UI) can run parallel with WP06 once services exist
  - WP08 import/export can be fully delegated to Gemini
- **MVP Scope**: WP01 + WP02 + WP03 + WP04 = Minimum viable materials management

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | MaterialCategory model | WP01 | P0 | Yes |
| T002 | MaterialSubcategory model | WP01 | P0 | Yes |
| T003 | Material model | WP01 | P0 | Yes |
| T004 | MaterialProduct model | WP01 | P0 | Yes |
| T005 | MaterialUnit model | WP01 | P0 | Yes |
| T006 | MaterialPurchase model | WP01 | P0 | Yes |
| T007 | MaterialConsumption model | WP01 | P0 | Yes |
| T008 | Update models/__init__.py | WP01 | P0 | No |
| T009 | Category CRUD | WP02 | P1 | No |
| T010 | Subcategory CRUD | WP02 | P1 | No |
| T011 | Material CRUD | WP02 | P1 | No |
| T012 | Product CRUD | WP02 | P1 | No |
| T013 | Slug auto-generation | WP02 | P1 | No |
| T014 | Cascade delete validation | WP02 | P1 | No |
| T015 | Catalog service tests | WP02 | P1 | Yes |
| T016 | Export catalog service | WP02 | P1 | No |
| T017 | record_purchase() | WP03 | P1 | No |
| T018 | Weighted average calculation | WP03 | P1 | No |
| T019 | Inventory update logic | WP03 | P1 | No |
| T020 | Inventory adjustment | WP03 | P1 | No |
| T021 | Unit conversion | WP03 | P1 | No |
| T022 | Purchase service tests | WP03 | P1 | Yes |
| T023 | Export purchase service | WP03 | P1 | No |
| T024 | MaterialUnit CRUD | WP04 | P1 | No |
| T025 | get_available_inventory() | WP04 | P1 | No |
| T026 | get_current_cost() | WP04 | P1 | No |
| T027 | preview_consumption() | WP04 | P1 | No |
| T028 | Material unit service tests | WP04 | P1 | Yes |
| T029 | Export unit service | WP04 | P1 | No |
| T030 | Add material_unit_id column | WP05 | P2 | No |
| T031 | Add material_id column | WP05 | P2 | No |
| T032 | Update XOR constraint | WP05 | P2 | No |
| T033 | Add material relationships | WP05 | P2 | No |
| T034 | Factory methods | WP05 | P2 | No |
| T035 | Update composition_service | WP05 | P2 | No |
| T036 | Food vs material cost totals | WP05 | P2 | No |
| T037 | Composition tests | WP05 | P2 | Yes |
| T038 | material_consumption_service | WP06 | P2 | No |
| T039 | get_pending_materials() | WP06 | P2 | No |
| T040 | validate_material_availability() | WP06 | P2 | No |
| T041 | record_material_consumption() | WP06 | P2 | No |
| T042 | Integrate with assembly_service | WP06 | P2 | No |
| T043 | Inventory decrement | WP06 | P2 | No |
| T044 | Block insufficient inventory | WP06 | P2 | No |
| T045 | Consumption service tests | WP06 | P2 | Yes |
| T046 | Export consumption service | WP06 | P2 | No |
| T047 | Materials tab structure | WP07 | P2 | No |
| T048 | Hierarchy tree view | WP07 | P2 | No |
| T049 | Product list panel | WP07 | P2 | No |
| T050 | Purchase recording form | WP07 | P2 | No |
| T051 | Inventory adjustment controls | WP07 | P2 | No |
| T052 | MaterialUnit management UI | WP07 | P2 | No |
| T053 | Composition dialog integration | WP07 | P2 | No |
| T054 | Service call wiring | WP07 | P2 | No |
| T055 | Extend catalog_import_service | WP08 | P3 | No |
| T056 | Extend coordinated_export_service | WP08 | P3 | No |
| T057 | Import/export format extension | WP08 | P3 | No |
| T058 | get_consumption_history() | WP08 | P3 | No |
| T059 | Assembly detail views | WP08 | P3 | No |
| T060 | Import/export tests | WP08 | P3 | Yes |
| T061 | Historical query tests | WP08 | P3 | Yes |

---

## Gemini Delegation Opportunities

The following work packages are **safe to delegate to Gemini CLI** via `gemini-parallel-dev` agent:

1. **WP01 (Models)** - All 7 models are independent; excellent parallel candidate
2. **WP08 (Import/Export)** - Independent from UI work; can be fully delegated
3. **Test subtasks** (T015, T022, T028, T037, T045, T060, T061) - Can run parallel with implementation

**Claude should lead:**
- WP05 (Composition Integration) - Complex constraint changes
- WP06 (Assembly Consumption) - Integration with existing assembly workflow
