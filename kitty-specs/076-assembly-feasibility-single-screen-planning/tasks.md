# Work Packages: Assembly Feasibility & Single-Screen Planning (F076)

**Inputs**: Design documents from `/kitty-specs/076-assembly-feasibility-single-screen-planning/`
**Prerequisites**: plan.md (required), spec.md (user stories)

**Tests**: Service layer tests included (constitution requirement: >70% coverage for services)

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Assembly Feasibility Service Foundation (Priority: P0)

**Goal**: Create the assembly_feasibility_service.py with core dataclasses and calculation logic.
**Independent Test**: Service calculates feasibility for an event with batch decisions.
**Prompt**: `/tasks/WP01-service-foundation.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [x] T001 Create dataclasses (ComponentStatus, FGFeasibilityStatus, AssemblyFeasibilityResult)
- [x] T002 Implement _get_production_availability() to calculate yields from BatchDecisions
- [x] T003 Implement _calculate_fg_feasibility() with bundle decomposition
- [x] T004 Implement calculate_assembly_feasibility() main public function
- [x] T005 Handle edge cases (empty event, missing decisions, zero quantities)

### Implementation Notes
- Follow session=None pattern per CLAUDE.md
- Reuse decompose_event_to_fu_requirements() from planning_service.py
- Use get_batch_decisions() from batch_decision_service.py
- Match yield calculation from BatchOption in planning_service.py

### Parallel Opportunities
- None (sequential implementation)

### Dependencies
- None (starting package)

### Risks & Mitigations
- Session management: Follow established pattern from inventory_gap_service.py
- Bundle complexity: Leverage proven F072 decomposition

---

## Work Package WP02: Service Unit Tests (Priority: P0)

**Goal**: Add comprehensive unit tests for assembly_feasibility_service.py.
**Independent Test**: pytest src/tests/test_assembly_feasibility_service.py passes.
**Prompt**: `/tasks/WP02-service-tests.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [ ] T006 [P] Test basic feasibility with single atomic FG (sufficient production)
- [ ] T007 [P] Test shortfall detection (production < needed)
- [ ] T008 [P] Test bundle component validation (nested FG)
- [ ] T009 [P] Test empty event and missing batch decisions
- [ ] T010 [P] Test decision coverage metrics (decided_count vs total_fu_count)

### Implementation Notes
- Use pytest fixtures following test_inventory_gap_service.py pattern
- Create test fixtures: Event, EventFinishedGood, FinishedGood, FinishedUnit, Recipe, BatchDecision
- Use Product fixture with product_name field (not name)

### Parallel Opportunities
- All test functions can be written in parallel

### Dependencies
- Depends on WP01 (service must exist)

### Risks & Mitigations
- Fixture complexity: Base on existing test_batch_decision_service.py fixtures

---

## Work Package WP03: Shopping Summary Frame (Priority: P1)

**Goal**: Create compact UI widget displaying shopping list summary (purchase vs sufficient counts).
**Independent Test**: Widget displays correct counts when given GapAnalysisResult.
**Prompt**: `/tasks/WP03-shopping-summary-frame.md`
**Estimated Size**: ~250 lines

### Included Subtasks
- [x] T011 Create ShoppingSummaryFrame class in src/ui/components/shopping_summary_frame.py
- [x] T012 Add update_summary(gap_result: GapAnalysisResult) method
- [x] T013 Add compact styling with item counts

### Implementation Notes
- Follow CustomTkinter patterns from existing components (FGSelectionFrame, RecipeSelectionFrame)
- Use CTkLabel for counts
- Keep minimal height (~60px)

### Parallel Opportunities
- Can be developed in parallel with WP04 (different files)

### Dependencies
- Depends on WP01 (for service integration understanding)

### Risks & Mitigations
- Layout sizing: Use pack() with fill="x" for horizontal stretching

---

## Work Package WP04: Assembly Status Frame (Priority: P1)

**Goal**: Create prominent UI widget displaying assembly feasibility status.
**Independent Test**: Widget displays correct status indicator and FG counts.
**Prompt**: `/tasks/WP04-assembly-status-frame.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [x] T014 Create AssemblyStatusFrame class in src/ui/components/assembly_status_frame.py
- [x] T015 Add status indicator with color coding (green/orange/red/gray)
- [x] T016 Add FG count display ("X of Y finished goods ready")
- [x] T017 Add per-FG detail list with shortfall amounts

### Implementation Notes
- Follow CustomTkinter patterns from BatchOptionsFrame
- Use fg_color for background color coding
- Status text: "Ready to Assemble", "Shortfalls Detected", "Cannot Assemble", "Awaiting Decisions"

### Parallel Opportunities
- T014-T16 can be done together, T17 (detail list) is additive

### Dependencies
- Depends on WP01 (consumes AssemblyFeasibilityResult)

### Risks & Mitigations
- Color accessibility: Use text labels in addition to colors

---

## Work Package WP05: Planning Tab Integration (Priority: P1) ðŸŽ¯ MVP

**Goal**: Integrate shopping summary and assembly status into planning_tab.py with real-time updates.
**Independent Test**: Selecting event shows shopping and assembly panels; saving batch decisions updates both.
**Prompt**: `/tasks/WP05-planning-tab-integration.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [x] T018 Add ShoppingSummaryFrame to planning_tab.py layout (row 5)
- [x] T019 Add AssemblyStatusFrame to planning_tab.py layout (row 6)
- [x] T020 Implement _update_shopping_summary() and _update_assembly_status() methods
- [x] T021 Wire callbacks: recipe save â†’ FG save â†’ batch save all trigger updates

### Implementation Notes
- Extend existing planning_tab.py grid layout
- Add new row indices (shift status bar down)
- Call updates after each relevant save operation
- Follow existing callback pattern (_on_recipe_selection_save, etc.)

### Parallel Opportunities
- None (integration requires sequential wiring)

### Dependencies
- Depends on WP01 (service), WP03 (shopping frame), WP04 (assembly frame)

### Risks & Mitigations
- Layout overflow: Use compact panels, verify on 1920x1080

---

## Dependency & Execution Summary

```
WP01 (Service) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€> WP02 (Tests)
                                       â”‚
                                       â”œâ”€â”€â”€â”€â”€> WP03 (Shopping UI) â”€â”€â”
                                       â”‚                            â”‚
                                       â””â”€â”€â”€â”€â”€> WP04 (Assembly UI) â”€â”€â”¼â”€â”€> WP05 (Integration)
                                                                    â”‚
                                                                    â”˜
```

- **Sequence**: WP01 â†’ (WP02 | WP03 | WP04 in parallel) â†’ WP05
- **Parallelization**: WP02, WP03, WP04 can run in parallel after WP01 completes
- **MVP Scope**: WP01 + WP05 deliver core functionality; WP02 adds test coverage; WP03/WP04 are UI components

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001       | Create service dataclasses | WP01 | P0 | No |
| T002       | Implement production availability calculation | WP01 | P0 | No |
| T003       | Implement FG feasibility calculation | WP01 | P0 | No |
| T004       | Implement main calculate_assembly_feasibility() | WP01 | P0 | No |
| T005       | Handle edge cases | WP01 | P0 | No |
| T006       | Test basic feasibility | WP02 | P0 | Yes |
| T007       | Test shortfall detection | WP02 | P0 | Yes |
| T008       | Test bundle validation | WP02 | P0 | Yes |
| T009       | Test empty event/missing decisions | WP02 | P0 | Yes |
| T010       | Test decision coverage metrics | WP02 | P0 | Yes |
| T011       | Create ShoppingSummaryFrame class | WP03 | P1 | No |
| T012       | Add update_summary method | WP03 | P1 | No |
| T013       | Add compact styling | WP03 | P1 | No |
| T014       | Create AssemblyStatusFrame class | WP04 | P1 | No |
| T015       | Add status indicator with colors | WP04 | P1 | No |
| T016       | Add FG count display | WP04 | P1 | No |
| T017       | Add per-FG detail list | WP04 | P1 | No |
| T018       | Add ShoppingSummaryFrame to planning_tab | WP05 | P1 | No |
| T019       | Add AssemblyStatusFrame to planning_tab | WP05 | P1 | No |
| T020       | Implement update callback methods | WP05 | P1 | No |
| T021       | Wire callbacks to save operations | WP05 | P1 | No |
