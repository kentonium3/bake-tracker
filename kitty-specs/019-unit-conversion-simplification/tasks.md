# Work Packages: Unit Conversion Simplification

**Inputs**: Design documents from `/kitty-specs/019-unit-conversion-simplification/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md

**Tests**: Unit tests verify conversion math accuracy (not regression comparison).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/planned/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Model & Schema Deletion (Priority: P0) ðŸŽ¯ MVP

**Goal**: Delete UnitConversion model and remove recipe_unit column from Ingredient.
**Independent Test**: Application starts without import errors; `from src.models import *` succeeds.
**Prompt**: `tasks/planned/WP01-model-schema-deletion.md`

### Included Subtasks
- [ ] T001 Delete `src/models/unit_conversion.py` entirely
- [ ] T002 Update `src/models/__init__.py` - remove UnitConversion import and `__all__` export
- [ ] T003 Update `src/models/ingredient.py` - remove `recipe_unit` column definition
- [ ] T004 Update `src/models/ingredient.py` - remove `conversions` relationship

### Implementation Notes
- Delete unit_conversion.py first
- Update __init__.py to remove the import line and __all__ entry
- In ingredient.py, remove the `recipe_unit = Column(...)` line (~line 64)
- Remove the `conversions = relationship(...)` line (~line 100-102)
- Do NOT delete the database yet - that happens during validation

### Parallel Opportunities
- None - must be done sequentially to avoid import errors

### Dependencies
- None (starting package)

### Risks & Mitigations
- Import errors cascade - verify imports work after each file change

---

## Work Package WP02: Import/Export v3.3 Update (Priority: P0)

**Goal**: Update import/export service to v3.3 format without unit_conversions.
**Independent Test**: Export produces JSON without `unit_conversions` array; import rejects v3.2 files.
**Prompt**: `tasks/planned/WP02-import-export-v33.md`

### Included Subtasks
- [ ] T005 Update `src/services/import_export_service.py` - remove `from src.models.unit_conversion import UnitConversion`
- [ ] T006 Remove unit_conversions export logic (~lines 1020, 1185, 1325, 1349)
- [ ] T007 Remove unit_conversions import logic (~lines 2300-2330)
- [ ] T008 Update version constant from "3.2" to "3.3" (~line 2245)
- [ ] T009 Remove `recipe_unit` from ingredient export fields
- [ ] T010 Remove `recipe_unit` from ingredient import handling

### Implementation Notes
- Start by removing the import statement for UnitConversion
- Search for all references to `unit_conversion` and remove related code blocks
- Update the version check to require "3.3"
- Test by attempting to parse existing v3.2 files - should fail with clear error

### Parallel Opportunities
- T006 and T007 can be done in parallel (export vs import)

### Dependencies
- Depends on WP01 (UnitConversion model must be deleted first)

### Risks & Mitigations
- Breaking change - clear error message for old format files

---

## Work Package WP03: Service Layer Cleanup (Priority: P1)

**Goal**: Remove all recipe_unit and UnitConversion references from service layer.
**Independent Test**: All services import cleanly; no undefined attribute errors.
**Prompt**: `tasks/planned/WP03-service-layer-cleanup.md`

### Included Subtasks
- [ ] T011 Update `src/services/unit_converter.py` - rename `recipe_unit` param to `target_unit` in `format_ingredient_conversion()`
- [ ] T012 Update `src/services/ingredient_service.py` - remove UnitConversion references
- [ ] T013 [P] Review/update `src/services/recipe_service.py` - remove recipe_unit references
- [ ] T014 [P] Review/update `src/services/product_service.py` - remove recipe_unit references
- [ ] T015 [P] Review/update `src/services/inventory_item_service.py` - remove recipe_unit references
- [ ] T016 [P] Review/update `src/services/ingredient_crud_service.py` - remove recipe_unit references
- [ ] T017 [P] Review/update `src/services/finished_unit_service.py` - remove recipe_unit references
- [ ] T018 [P] Review/update `src/services/assembly_service.py` - remove recipe_unit references

### Implementation Notes
- For each file, grep for `recipe_unit` and assess usage
- Most references are likely in docstrings or type hints - update or remove
- The `format_ingredient_conversion()` function parameter rename is the main code change
- Verify no logic depends on recipe_unit field

### Parallel Opportunities
- T013-T018 can all proceed in parallel (different files)

### Dependencies
- Depends on WP01 and WP02

### Risks & Mitigations
- Hidden dependencies - grep entire codebase for `recipe_unit` to ensure complete cleanup

---

## Work Package WP04: Test Updates & Validation (Priority: P2)

**Goal**: Update tests for model changes; add conversion accuracy tests.
**Independent Test**: `pytest src/tests -v` passes; coverage >70% on affected services.
**Prompt**: `tasks/planned/WP04-test-updates.md`

### Included Subtasks
- [ ] T019 Remove/update tests in `src/tests/test_models.py` for UnitConversion
- [ ] T020 [P] Update ingredient-related tests - remove recipe_unit expectations
- [ ] T021 [P] Add/verify unit tests for `convert_any_units()` accuracy in `src/tests/test_unit_converter.py`
- [ ] T022 [P] Update import/export tests for v3.3 format in `src/tests/services/test_import_export_service.py`
- [ ] T023 Add test for v3.2 import rejection

### Implementation Notes
- Grep test files for `UnitConversion` and `recipe_unit`
- Add tests verifying:
  - `convert_any_units(1, "cup", "oz", ingredient)` produces correct result for known densities
  - Same-type conversions (ozâ†’lb, cupâ†’tbsp) work correctly
- Update test fixtures that create ingredients with recipe_unit
- Add test that importing v3.2 JSON raises appropriate error

### Parallel Opportunities
- T020, T021, T022 can proceed in parallel (different test files)

### Dependencies
- Depends on WP01, WP02, WP03

### Risks & Mitigations
- Test fixtures may need updating - check conftest.py

---

## Work Package WP05: Data Files, Documentation & UI (Priority: P3) âœ…

**Goal**: Update test data to v3.3 format; update all documentation; clean up UI.
**Independent Test**: JSON files parse correctly; documentation is consistent; app runs without UI errors.
**Prompt**: `tasks/done/WP05-data-docs-ui.md`

### Included Subtasks
- [X] T024 Convert `test_data/baking_ingredients_v32.json` to v3.3 (N/A in worktree - will handle at merge)
- [X] T025 [P] Update `test_data/sample_data.json` if it contains unit_conversions
- [X] T026 [P] Update `docs/import_export_specification.md` to v3.3 schema
- [X] T027 [P] Update `docs/feature_proposal_catalog_import.md` - remove UnitConversion refs
- [X] T028 [P] Update `docs/catalog_import_status.md` - note format change to v3.3 (N/A in worktree)
- [X] T029 [P] Review/update `src/ui/inventory_tab.py` - remove recipe_unit references
- [X] T030 [P] Review/update `src/ui/forms/recipe_form.py` - remove recipe_unit references
- [X] T031 [P] Review/update `src/ui/event_detail_window.py` - remove recipe_unit references

### Implementation Notes
- For JSON files: remove `unit_conversions` array, remove `recipe_unit` from ingredients, update version to "3.3"
- Rename baking_ingredients_v32.json to baking_ingredients_v33.json (or update in place)
- For UI files: grep for recipe_unit and assess - likely minimal changes needed
- Update catalog_import_status.md to reflect new v3.3 format requirement

### Parallel Opportunities
- All subtasks except T024 can proceed in parallel

### Dependencies
- Depends on WP01-WP04 (all code changes complete)

### Risks & Mitigations
- Documentation drift - ensure all docs reference v3.3 consistently

---

## Dependency & Execution Summary

```
WP01 (Model Deletion) â”€â”¬â”€â–º WP02 (Import/Export v3.3)
                       â”‚
                       â””â”€â–º WP03 (Service Cleanup) â”€â–º WP04 (Tests) â”€â–º WP05 (Data/Docs/UI)
```

- **Sequence**: WP01 â†’ WP02 â†’ WP03 â†’ WP04 â†’ WP05
- **Parallelization**: WP02 and WP03 can start in parallel after WP01
- **MVP Scope**: WP01 + WP02 constitute minimal working change (model deletion + import/export)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Delete unit_conversion.py | WP01 | P0 | No |
| T002 | Update models/__init__.py | WP01 | P0 | No |
| T003 | Remove recipe_unit column | WP01 | P0 | No |
| T004 | Remove conversions relationship | WP01 | P0 | No |
| T005 | Remove UnitConversion import | WP02 | P0 | No |
| T006 | Remove export logic | WP02 | P0 | Yes |
| T007 | Remove import logic | WP02 | P0 | Yes |
| T008 | Update version to 3.3 | WP02 | P0 | No |
| T009 | Remove recipe_unit from export | WP02 | P0 | No |
| T010 | Remove recipe_unit from import | WP02 | P0 | No |
| T011 | Rename recipe_unit param | WP03 | P1 | No |
| T012 | Clean ingredient_service.py | WP03 | P1 | No |
| T013 | Clean recipe_service.py | WP03 | P1 | Yes |
| T014 | Clean product_service.py | WP03 | P1 | Yes |
| T015 | Clean inventory_item_service.py | WP03 | P1 | Yes |
| T016 | Clean ingredient_crud_service.py | WP03 | P1 | Yes |
| T017 | Clean finished_unit_service.py | WP03 | P1 | Yes |
| T018 | Clean assembly_service.py | WP03 | P1 | Yes |
| T019 | Update test_models.py | WP04 | P2 | No |
| T020 | Update ingredient tests | WP04 | P2 | Yes |
| T021 | Add convert_any_units tests | WP04 | P2 | Yes |
| T022 | Update import/export tests | WP04 | P2 | Yes |
| T023 | Add v3.2 rejection test | WP04 | P2 | No |
| T024 | Convert baking_ingredients JSON | WP05 | P3 | No |
| T025 | Update sample_data.json | WP05 | P3 | Yes |
| T026 | Update import_export_spec doc | WP05 | P3 | Yes |
| T027 | Update catalog_import proposal | WP05 | P3 | Yes |
| T028 | Update catalog_import_status | WP05 | P3 | Yes |
| T029 | Clean inventory_tab.py | WP05 | P3 | Yes |
| T030 | Clean recipe_form.py | WP05 | P3 | Yes |
| T031 | Clean event_detail_window.py | WP05 | P3 | Yes |
