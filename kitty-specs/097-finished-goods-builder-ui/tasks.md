# Work Packages: Finished Goods Builder UI

**Inputs**: Design documents from `kitty-specs/097-finished-goods-builder-ui/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: Tests included per TDD requirement (Constitution Principle IV).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

---

## Work Package WP01: AccordionStep Widget (Priority: P0)

**Goal**: Create a reusable `AccordionStep` widget for multi-step wizard UIs with locked/active/completed states.
**Independent Test**: Widget can be instantiated, expanded/collapsed, and transitioned between states with correct visual indicators.
**Prompt**: `tasks/WP01-accordion-step-widget.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [x] T001 Create AccordionStep widget class with header and content frames
- [x] T002 Implement state machine (locked, active, completed) with visual indicators
- [x] T003 Implement content show/hide via pack/pack_forget with "Change" button callback
- [x] T004 Write unit tests for AccordionStep state transitions and rendering

### Implementation Notes
- New file: `src/ui/widgets/accordion_step.py`
- Pattern based on `add_purchase_dialog.py` provisional form toggle (pack/pack_forget)
- Header: step number label, title, status icon (lock/checkmark/arrow), summary text, "Change" button
- Content frame: child widgets managed by caller, shown/hidden by AccordionStep
- States: `locked` (greyed header, no content), `active` (blue border, content visible), `completed` (checkmark, summary, Change button)

### Parallel Opportunities
- This WP is fully independent — no other WPs can start until this is done.

### Dependencies
- None (foundation work package).

### Risks & Mitigations
- CustomTkinter has no native accordion; must build from scratch using pack/pack_forget pattern.
- Risk: Theme compatibility for status icons. Mitigation: Use Unicode characters (checkmark, lock, arrow) instead of image assets.

---

## Work Package WP02: Builder Dialog Shell & Navigation (Priority: P0)

**Goal**: Create the FinishedGoodBuilderDialog modal with 3 AccordionStep instances and step navigation logic.
**Independent Test**: Dialog opens, shows 3 steps with Step 1 active, allows Cancel with confirmation, name entry works.
**Prompt**: `tasks/WP02-builder-dialog-shell.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [x] T005 Create FinishedGoodBuilderDialog class as CTkToplevel with modal behavior
- [x] T006 Wire up 3 AccordionStep instances (Food, Materials, Review) in scrollable container
- [x] T007 Implement step navigation controller (mutual exclusion, sequential progression, Change callbacks)
- [x] T008 Implement dialog-level controls (name entry, Cancel with confirmation, Start Over)
- [x] T009 Write unit tests for dialog shell navigation and state management

### Implementation Notes
- New file: `src/ui/builders/finished_good_builder.py` (new `builders/` directory)
- Follow CTkToplevel modal pattern: `transient(parent)`, `grab_set()`, `wait_window()`, `result` attribute
- Size: 700x750 (larger than existing forms for multi-select lists)
- Navigation rules: Only one step active; completed steps show summary; locked steps greyed out
- Start Over clears all state and re-expands Step 1
- Cancel checks for unsaved changes before closing

### Parallel Opportunities
- None within this WP; it's sequential.

### Dependencies
- Depends on WP01 (uses AccordionStep widget).

### Risks & Mitigations
- Risk: Dialog size may need adjustment based on content. Mitigation: Use `minsize()` and allow resize.
- Risk: pack_forget ordering issues. Mitigation: Use consistent pack ordering and test thoroughly.

---

## Work Package WP03: Food Selection Step (Priority: P1) MVP

**Goal**: Implement Step 1 of the builder — multi-select food item selection with category filtering, bare/assembly toggles, and quantity specification.
**Independent Test**: User can filter FinishedGoods by category and bare/assembly toggle, search by name, select multiple items with quantities, and pass validation to proceed.
**Prompt**: `tasks/WP03-food-selection-step.md`
**Estimated Size**: ~500 lines

### Included Subtasks
- [x] T010 Create food selection content panel with filter bar UI (category dropdown, bare/assembly toggles, search entry)
- [x] T011 Implement data query for available FinishedGoods with category, bare/assembly, and search filtering
- [x] T012 Implement scrollable checkbox list with per-item quantity entries
- [x] T013 Implement selection state management (global selections persisting across filter changes)
- [x] T014 Implement validation (minimum 1 item with quantity >= 1) and Continue button
- [x] T015 Write unit tests for food selection filtering, selection state, and validation

### Implementation Notes
- Category dropdown populated from distinct `FinishedUnit.category` values + "All Categories" option
- Bare toggle: `FinishedGood.assembly_type == AssemblyType.BARE`; Assembly toggle: `assembly_type != BARE`
- Each list row: CTkCheckBox + display_name label + CTkEntry for quantity (disabled until checked)
- Checking checkbox enables quantity field, sets default to 1
- Selections stored in `Dict[int, ComponentSelection]` keyed by component ID — survives filter changes
- When filters change, re-render list but restore check/quantity state from dict

### Parallel Opportunities
- T010 (UI layout) and T011 (data query) can be developed concurrently by different agents.

### Dependencies
- Depends on WP02 (needs dialog shell to embed content panel).

### Risks & Mitigations
- Risk: Large item lists may be slow to render. Mitigation: Use CTkScrollableFrame with lazy rendering for 200+ items.
- Risk: Category values may be inconsistent (mixed case, etc.). Mitigation: Normalize categories for display.

---

## Work Package WP04: Materials Selection Step (Priority: P1)

**Goal**: Implement Step 2 of the builder — multi-select MaterialUnit selection with MaterialCategory filtering and optional skip.
**Independent Test**: User can filter MaterialUnits by category, search by name, select materials with quantities, or skip the step entirely.
**Prompt**: `tasks/WP04-materials-selection-step.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [ ] T016 Create materials selection content panel with filter bar UI (MaterialCategory dropdown, search entry)
- [ ] T017 Implement data query for MaterialUnits with MaterialCategory filtering and search
- [ ] T018 Implement scrollable checkbox list with per-item quantity entries (reuse pattern from WP03)
- [ ] T019 Implement Skip button and optional step completion logic
- [ ] T020 Write unit tests for materials selection and skip functionality

### Implementation Notes
- MaterialUnits (not MaterialProducts) are the selectable items — Composition stores `material_unit_id`
- Category filter: Join MaterialUnit → MaterialProduct → MaterialSubcategory → MaterialCategory
- Display MaterialUnit.name in list rows (more specific than product name)
- Skip button collapses Step 2 with "No materials" summary and advances to Step 3
- Same checkbox + quantity pattern as Step 1

### Parallel Opportunities
- This WP could theoretically parallel with WP03 if content panels are separate classes, but sequential is safer to avoid builder file conflicts.

### Dependencies
- Depends on WP03 (builds on same dialog, follows same selection patterns established in WP03).

### Risks & Mitigations
- Risk: MaterialUnit query may require joins through 3 tables for category filtering. Mitigation: Use SQLAlchemy relationship joins; test query performance.
- Risk: Some MaterialProducts may have no MaterialUnits. Mitigation: Only show MaterialProducts that have at least one MaterialUnit.

---

## Work Package WP05: Review & Save (Create Mode) (Priority: P1) MVP

**Goal**: Implement Step 3 of the builder — component summary, name/notes editing, and atomic save via create_finished_good() service.
**Independent Test**: User sees complete component summary, can enter name and notes, and save creates a FinishedGood with all components persisted correctly.
**Prompt**: `tasks/WP05-review-and-save.md`
**Estimated Size**: ~450 lines

### Included Subtasks
- [ ] T021 Create review panel with component summary display (food items section + materials section)
- [ ] T022 Implement editable name field with slug-based uniqueness pre-validation
- [ ] T023 Implement notes text field and auto-suggested tags from component names
- [ ] T024 Implement Save button with create_finished_good() service call and component format conversion
- [ ] T025 Implement error handling (validation errors, duplicate name, service errors) with user feedback
- [ ] T026 Write unit tests for review display, save operation, and error handling

### Implementation Notes
- Summary display: Two sections — "Food Items" and "Materials" — each listing component name + quantity
- Name field: Pre-populate with auto-generated name if empty; validate slug uniqueness before save
- Save converts selections to service format: `[{"type": str, "id": int, "quantity": int, "sort_order": int}]`
- Service call: `FinishedGoodService.create_finished_good(display_name, assembly_type=CUSTOM_ORDER, components=[...])`
- On success: set `self.result`, `self.destroy()`
- On error: display error message inline, stay open for correction
- Assembly type: Default to CUSTOM_ORDER for builder-created items

### Parallel Opportunities
- None — this is the culmination of Steps 1+2.

### Dependencies
- Depends on WP04 (needs both selection steps complete to have data for review).

### Risks & Mitigations
- Risk: Slug uniqueness check may have race condition. Mitigation: Service handles IntegrityError as fallback.
- Risk: Large component lists may make summary unreadable. Mitigation: Use scrollable summary frame.

---

## Work Package WP06: Edit Mode (Priority: P1)

**Goal**: Enable the builder dialog to open in edit mode with pre-populated data from an existing FinishedGood, and save updates via update_finished_good() service.
**Independent Test**: Existing FinishedGood opens in builder with all components shown, user modifies a quantity, saves, and the update persists correctly.
**Prompt**: `tasks/WP06-edit-mode.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [ ] T027 Implement edit mode initialization (accept FinishedGood parameter, partition existing Composition records)
- [ ] T028 Pre-populate food and material selection states from existing component data
- [ ] T029 Open builder to Step 3 (Review) in edit mode with Steps 1-2 marked completed
- [ ] T030 Implement self-reference prevention (exclude current FinishedGood from Step 1 selectable items)
- [ ] T031 Implement Save in edit mode (update_finished_good() call with name uniqueness exclusion)

### Implementation Notes
- Constructor: `FinishedGoodBuilderDialog(parent, finished_good=None)` — if finished_good provided, enter edit mode
- Partition components by `Composition.component_type`: "finished_unit"/"finished_good" → food; "material_unit" → materials
- Pre-populate name, notes from existing FinishedGood fields
- Mark Steps 1 and 2 as completed with summary (e.g., "3 items selected", "2 materials selected")
- Self-reference: In Step 1, when "Include assemblies" is active, filter out the current `finished_good.id`
- Save: `update_finished_good(finished_good_id, display_name=..., components=[...])` — delete-and-replace pattern
- Name uniqueness: Exclude current item's slug from collision check

### Parallel Opportunities
- None — edit mode must build on working create mode.

### Dependencies
- Depends on WP05 (needs working create/save flow to extend for edit).

### Risks & Mitigations
- Risk: Detached ORM objects in edit mode. Mitigation: Reload FinishedGood via service before populating.
- Risk: Deleted components' source entities (e.g., a FinishedUnit was deleted). Mitigation: Show "(unavailable)" for missing components in review.

---

## Work Package WP07: Tab Integration & Polish (Priority: P1)

**Goal**: Wire the builder dialog into the FinishedGoodsTab for both create and edit flows, replacing the existing FinishedGoodFormDialog calls.
**Independent Test**: User can create a new FinishedGood via builder from the tab, edit an existing one via double-click or Edit button, and see the list refresh after save.
**Prompt**: `tasks/WP07-tab-integration.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [ ] T032 Update FinishedGoodsTab._add_finished_good() to launch FinishedGoodBuilderDialog
- [ ] T033 Update FinishedGoodsTab._edit_finished_good() to launch FinishedGoodBuilderDialog in edit mode
- [ ] T034 Rename "+ Add" button to "+ Create Finished Good" and wire to builder
- [ ] T035 Verify double-click and Edit button launch builder correctly, list refreshes after save
- [ ] T036 Write integration tests for end-to-end create and edit flows via tab

### Implementation Notes
- `finished_goods_tab.py`: Change import from `FinishedGoodFormDialog` to `FinishedGoodBuilderDialog`
- `_add_finished_good()`: Replace `FinishedGoodFormDialog(self, title="Add New Finished Good")` with `FinishedGoodBuilderDialog(self)`
- `_edit_finished_good()`: Replace `FinishedGoodFormDialog(self, finished_good=fg)` with `FinishedGoodBuilderDialog(self, finished_good=fg)`
- Same `wait_window()` + `dialog.result` pattern — builder returns component dict on save, None on cancel
- Existing `FinishedGoodFormDialog` NOT deleted — just no longer called from this tab
- Button text update: "Add" → "+ Create Finished Good" per spec FR-001

### Parallel Opportunities
- T034 (button rename) can be done independently of T032-T033.

### Dependencies
- Depends on WP06 (needs fully working builder with edit mode).

### Risks & Mitigations
- Risk: Existing tests may depend on FinishedGoodFormDialog integration. Mitigation: Update existing tab tests to use builder.
- Risk: Result format mismatch between builder and tab handler. Mitigation: Builder uses same result dict structure as existing form.

---

## Dependency & Execution Summary

- **Sequence**: WP01 → WP02 → WP03 → WP04 → WP05 → WP06 → WP07
- **Parallelization**: Limited — each WP builds on the previous. However, within WPs, some subtasks are parallelizable (noted with [P]).
- **MVP Scope**: WP01 through WP05 constitute a working create flow. WP06 adds edit mode. WP07 completes integration.
- **Critical Path**: WP01 (foundation) and WP03 (food selection) are the largest risk items — if the accordion widget or multi-select pattern doesn't work well, all downstream WPs are affected.

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Create AccordionStep widget class | WP01 | P0 | No |
| T002 | Implement state machine with visual indicators | WP01 | P0 | No |
| T003 | Implement content show/hide and Change button | WP01 | P0 | No |
| T004 | Unit tests for AccordionStep | WP01 | P0 | No |
| T005 | Create FinishedGoodBuilderDialog CTkToplevel | WP02 | P0 | No |
| T006 | Wire up 3 AccordionStep instances | WP02 | P0 | No |
| T007 | Implement step navigation controller | WP02 | P0 | No |
| T008 | Implement dialog-level controls | WP02 | P0 | No |
| T009 | Unit tests for dialog navigation | WP02 | P0 | No |
| T010 | Create food selection content panel UI | WP03 | P1 | Yes |
| T011 | Implement food query with filtering | WP03 | P1 | Yes |
| T012 | Implement scrollable checkbox list + quantities | WP03 | P1 | No |
| T013 | Implement selection state management | WP03 | P1 | No |
| T014 | Implement validation and Continue button | WP03 | P1 | No |
| T015 | Unit tests for food selection | WP03 | P1 | No |
| T016 | Create materials selection content panel UI | WP04 | P1 | Yes |
| T017 | Implement MaterialUnit query with filtering | WP04 | P1 | Yes |
| T018 | Implement scrollable checkbox list + quantities | WP04 | P1 | No |
| T019 | Implement Skip button and optional step logic | WP04 | P1 | No |
| T020 | Unit tests for materials selection | WP04 | P1 | No |
| T021 | Create review panel with component summary | WP05 | P1 | No |
| T022 | Implement name field with uniqueness validation | WP05 | P1 | No |
| T023 | Implement notes and auto-suggested tags | WP05 | P1 | No |
| T024 | Implement Save with create_finished_good() | WP05 | P1 | No |
| T025 | Implement error handling and user feedback | WP05 | P1 | No |
| T026 | Unit tests for review and save | WP05 | P1 | No |
| T027 | Implement edit mode initialization | WP06 | P1 | No |
| T028 | Pre-populate selection states from components | WP06 | P1 | No |
| T029 | Open to Step 3 in edit mode | WP06 | P1 | No |
| T030 | Self-reference prevention in Step 1 | WP06 | P1 | No |
| T031 | Save in edit mode with update service | WP06 | P1 | No |
| T032 | Update _add_finished_good() for builder | WP07 | P1 | No |
| T033 | Update _edit_finished_good() for builder | WP07 | P1 | No |
| T034 | Rename Add button to "+ Create Finished Good" | WP07 | P1 | Yes |
| T035 | Verify double-click, Edit button, list refresh | WP07 | P1 | No |
| T036 | Integration tests for tab flows | WP07 | P1 | No |

---

> All subtasks assigned to exactly one work package. 36 subtasks across 7 WPs. Average 5.1 subtasks per WP (within ideal 3-7 range).
