# Work Packages: Planning Workspace (F039)

**Inputs**: Design documents from `kitty-specs/039-planning-workspace/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, contracts/, quickstart.md

**Tests**: Testing included for service layer (>70% coverage per constitution).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/planned/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

## Path Conventions
- **Single project**: `src/`, `tests/`

---

## Work Package WP01: Model Foundation (Priority: P0)

**Goal**: Add OutputMode enum to Event and create ProductionPlanSnapshot model.
**Independent Test**: Models import correctly; new tables created; Event.output_mode field accessible.
**Prompt**: `tasks/planned/WP01-model-foundation.md`

### Included Subtasks
- [ ] T001 Add OutputMode enum to `src/models/event.py`
- [ ] T002 Add output_mode field to Event model in `src/models/event.py`
- [ ] T003 Create ProductionPlanSnapshot model in `src/models/production_plan_snapshot.py`
- [ ] T004 Add ProductionPlanSnapshot relationship to Event model
- [ ] T005 Export ProductionPlanSnapshot from `src/models/__init__.py`
- [ ] T006 Write unit tests for new model in `src/tests/models/test_production_plan_snapshot.py`

### Implementation Notes
- Event already uses `date_added`/`last_modified` instead of `created_at`/`updated_at`
- ProductionPlanSnapshot stores calculation_results as JSON blob
- Staleness detection uses timestamp comparison (FR-037 through FR-041)

### Parallel Opportunities
- None (foundation work - must complete before services)

### Dependencies
- None (starting package).

### Risks & Mitigations
- Schema change requires migration → use export/reset/import cycle per constitution

---

## Work Package WP02: Batch Calculation Service (Priority: P1) [P]

**Goal**: Implement batch count calculation logic that always rounds up (never short).
**Independent Test**: Unit tests pass for calculate_batches, waste calculation, and multi-recipe aggregation.
**Prompt**: `tasks/planned/WP02-batch-calculation-service.md`

### Included Subtasks
- [ ] T007 [P] Create `src/services/planning/__init__.py` with module exports
- [ ] T008 [P] Create `src/services/planning/batch_calculation.py` with calculate_batches function
- [ ] T009 [P] Implement waste percentage calculation (FR-014)
- [ ] T010 [P] Implement bundle explosion logic (FR-009) for BUNDLED mode
- [ ] T011 [P] Implement recipe aggregation (FR-010) - group FinishedUnits by recipe
- [ ] T012 [P] Write unit tests in `src/tests/services/planning/test_batch_calculation.py`

### Implementation Notes
- Always use `math.ceil(needed / yield)` to prevent shortfall (SC-003)
- Waste = (batches * yield_per_batch) - units_needed
- Bundle explosion: recursively expand FinishedGood -> Composition -> FinishedUnit

### Parallel Opportunities
- Can run in parallel with WP03, WP04, WP05 (all service modules)

### Dependencies
- Depends on WP01 (models must exist).

### Risks & Mitigations
- Rounding errors → test edge cases (exact fit, 1 over, large quantities)

---

## Work Package WP03: Shopping List Service (Priority: P1) [P]

**Goal**: Generate aggregated shopping list with inventory gap analysis.
**Independent Test**: Unit tests pass for ingredient aggregation and gap calculation.
**Prompt**: `tasks/planned/WP03-shopping-list-service.md`

### Included Subtasks
- [ ] T013 [P] Create `src/services/planning/shopping_list.py`
- [ ] T014 [P] Implement get_shopping_list wrapping event_service (FR-015)
- [ ] T015 [P] Implement ingredient aggregation across recipes (FR-016)
- [ ] T016 [P] Implement inventory gap calculation (FR-018): max(0, needed - available)
- [ ] T017 [P] Implement mark_shopping_complete (FR-020)
- [ ] T018 [P] Write unit tests in `src/tests/services/planning/test_shopping_list.py`

### Implementation Notes
- Existing `event_service.get_shopping_list()` provides base functionality
- Extend with ShoppingListItem DTO formatting for wizard UI
- Session management: accept optional session parameter

### Parallel Opportunities
- Can run in parallel with WP02, WP04, WP05

### Dependencies
- Depends on WP01 (models must exist).

### Risks & Mitigations
- Session detachment → pass session to all nested calls

---

## Work Package WP04: Feasibility Service (Priority: P1) [P]

**Goal**: Check production and assembly feasibility.
**Independent Test**: Unit tests pass for feasibility checks with various inventory states.
**Prompt**: `tasks/planned/WP04-feasibility-service.md`

### Included Subtasks
- [ ] T019 [P] Create `src/services/planning/feasibility.py`
- [ ] T020 [P] Implement check_assembly_feasibility using assembly_service (FR-022-026)
- [ ] T021 [P] Implement check_production_feasibility using batch_production_service
- [ ] T022 [P] Implement FeasibilityResult and FeasibilityStatus DTOs
- [ ] T023 [P] Handle partial assembly feasibility (FR-028, FR-036)
- [ ] T024 [P] Write unit tests in `src/tests/services/planning/test_feasibility.py`

### Implementation Notes
- Wrap existing `assembly_service.check_can_assemble()`
- Wrap existing `batch_production_service.check_can_produce()`
- Return structured results with missing component details

### Parallel Opportunities
- Can run in parallel with WP02, WP03, WP05

### Dependencies
- Depends on WP01 (models must exist).

### Risks & Mitigations
- Complex nested queries → use eager loading

---

## Work Package WP05: Progress Service (Priority: P1) [P]

**Goal**: Track production and assembly progress.
**Independent Test**: Unit tests pass for progress calculation and status updates.
**Prompt**: `tasks/planned/WP05-progress-service.md`

### Included Subtasks
- [ ] T025 [P] Create `src/services/planning/progress.py`
- [ ] T026 [P] Implement get_production_progress wrapping event_service (FR-030-031)
- [ ] T027 [P] Implement get_assembly_progress wrapping event_service
- [ ] T028 [P] Implement get_overall_progress (FR-033)
- [ ] T029 [P] Implement ProductionProgress and AssemblyProgress DTOs
- [ ] T030 [P] Write unit tests in `src/tests/services/planning/test_progress.py`

### Implementation Notes
- Existing `event_service.get_production_progress()` and `get_assembly_progress()` provide base
- Extend with DTO formatting and phase status calculation
- Progress = (completed_batches / target_batches) * 100

### Parallel Opportunities
- Can run in parallel with WP02, WP03, WP04

### Dependencies
- Depends on WP01 (models must exist).

### Risks & Mitigations
- Division by zero → handle zero targets gracefully

---

## Work Package WP06: Planning Service Facade (Priority: P2)

**Goal**: Create PlanningService facade that orchestrates all modules.
**Independent Test**: Integration tests pass for calculate_plan, check_staleness, get_plan_summary.
**Prompt**: `tasks/planned/WP06-planning-service-facade.md`

### Included Subtasks
- [ ] T031 Create `src/services/planning/planning_service.py` facade
- [ ] T032 Implement calculate_plan orchestrating all modules (contract method)
- [ ] T033 Implement get_plan_summary with phase status calculation
- [ ] T034 Implement check_staleness using timestamp comparison (FR-039-040)
- [ ] T035 Implement get_recipe_batches, get_shopping_list facade methods
- [ ] T036 Implement check_assembly_feasibility, check_production_feasibility facade methods
- [ ] T037 Implement get_production_progress, get_assembly_progress, get_overall_progress
- [ ] T038 Implement get_assembly_checklist, record_assembly_confirmation (FR-027-029)
- [ ] T039 Implement mark_shopping_complete facade method
- [ ] T040 Define PlanningError, StalePlanError, IncompleteRequirementsError exceptions
- [ ] T041 Write integration tests in `src/tests/services/planning/test_planning_service.py`

### Implementation Notes
- Follow contract defined in `contracts/planning_service.py`
- All methods accept optional `session` parameter
- Facade delegates to focused modules (batch_calculation, shopping_list, feasibility, progress)

### Parallel Opportunities
- None (depends on all service modules)

### Dependencies
- Depends on WP02, WP03, WP04, WP05 (all service modules).

### Risks & Mitigations
- Transaction scope → ensure facade methods maintain session context

---

## Work Package WP07: Planning Workspace Container (Priority: P3)

**Goal**: Create main wizard container with phase navigation sidebar.
**Independent Test**: UI renders with sidebar; phase navigation works; status indicators display.
**Prompt**: `tasks/planned/WP07-planning-workspace-container.md`

### Included Subtasks
- [ ] T042 Create `src/ui/planning/__init__.py` with module exports
- [ ] T043 Create `src/ui/planning/planning_workspace.py` main container
- [ ] T044 Create `src/ui/planning/phase_sidebar.py` navigation sidebar
- [ ] T045 Implement phase status indicators (not_started, in_progress, complete, blocked)
- [ ] T046 Implement phase navigation with warning dialogs (FR-034-035)
- [ ] T047 Implement stale plan banner with recalculate option (FR-040)
- [ ] T048 Wire planning_workspace into PLAN mode navigation (from F038)

### Implementation Notes
- Wizard layout: sidebar (20%) + main content (80%)
- Use CustomTkinter CTkFrame, CTkButton, CTkLabel
- Follow existing UI patterns from other modes

### Parallel Opportunities
- None (container must exist before views)

### Dependencies
- Depends on WP06 (PlanningService facade).

### Risks & Mitigations
- UI framework compatibility → test on all target platforms

---

## Work Package WP08: Phase View Components (Priority: P3) [P]

**Goal**: Create the four phase view components (Calculate, Shop, Produce, Assemble).
**Independent Test**: Each view renders correctly and interacts with PlanningService.
**Prompt**: `tasks/planned/WP08-phase-view-components.md`

### Included Subtasks
- [ ] T049 [P] Create `src/ui/planning/calculate_view.py` - batch calculation display (US1)
- [ ] T050 [P] Create `src/ui/planning/shop_view.py` - shopping list with Need/Have/Buy (US2)
- [ ] T051 [P] Create `src/ui/planning/produce_view.py` - production progress bars (US4)
- [ ] T052 [P] Create `src/ui/planning/assemble_view.py` - assembly checklist (US5)
- [ ] T053 [P] Implement calculate button and results table in calculate_view
- [ ] T054 [P] Implement shopping list table with sufficient/needs-purchase styling
- [ ] T055 [P] Implement progress bars per recipe in produce_view
- [ ] T056 [P] Implement assembly checklist with partial assembly support (FR-036)
- [ ] T057 [P] Implement feasibility indicators in assemble_view (FR-024-026)

### Implementation Notes
- Each view is a CTkFrame that can be swapped by container
- Views call PlanningService methods for data
- Follow existing UI patterns (tables, progress bars, buttons)

### Parallel Opportunities
- All four views can be developed in parallel (different files)

### Dependencies
- Depends on WP07 (container must exist).

### Risks & Mitigations
- Consistent styling → use shared color constants

---

## Work Package WP09: Polish & Integration (Priority: P4)

**Goal**: Final integration, edge case handling, and validation.
**Independent Test**: Full workflow test; all acceptance scenarios pass; >70% service coverage.
**Prompt**: `tasks/planned/WP09-polish-and-integration.md`

### Included Subtasks
- [ ] T058 Validate full workflow: Event -> Calculate -> Shop -> Produce -> Assemble
- [ ] T059 Test edge cases from spec (zero requirements, missing components, etc.)
- [ ] T060 Verify staleness detection works correctly
- [ ] T061 Verify batch calculation never produces shortfall (SC-003)
- [ ] T062 Verify shopping list gap calculation (SC-008)
- [ ] T063 Verify <500ms calculation performance for 10+ recipes (SC-002)
- [ ] T064 Run pytest coverage and ensure >70% on services/planning
- [ ] T065 Update quickstart.md verification checklist with results

### Implementation Notes
- Use integration tests with realistic event data
- Test all edge cases documented in spec.md
- Performance test with timer assertions

### Parallel Opportunities
- None (final validation phase)

### Dependencies
- Depends on WP08 (all components complete).

### Risks & Mitigations
- Performance issues → optimize queries, add indexes if needed

---

## Dependency & Execution Summary

```
WP01 (Models)
    |
    +-- WP02 (Batch Calc) --+
    |                       |
    +-- WP03 (Shopping)  ---+
    |                       |---> WP06 (Facade) --> WP07 (Container) --> WP08 (Views) --> WP09 (Polish)
    +-- WP04 (Feasibility)--+
    |                       |
    +-- WP05 (Progress) ----+
```

- **Sequence**: WP01 -> [WP02, WP03, WP04, WP05 parallel] -> WP06 -> WP07 -> WP08 -> WP09
- **Parallelization**: WP02-05 are safe to parallelize (different modules, no shared state). WP08 views are parallelizable.
- **MVP Scope**: WP01-WP08 constitute minimum viable feature. WP09 is hardening.

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Add OutputMode enum | WP01 | P0 | No |
| T002 | Add output_mode field to Event | WP01 | P0 | No |
| T003 | Create ProductionPlanSnapshot model | WP01 | P0 | No |
| T004 | Add ProductionPlanSnapshot relationship | WP01 | P0 | No |
| T005 | Export new model | WP01 | P0 | No |
| T006 | Unit tests for new model | WP01 | P0 | No |
| T007 | Create planning/__init__.py | WP02 | P1 | Yes |
| T008 | Create batch_calculation.py | WP02 | P1 | Yes |
| T009 | Waste percentage calculation | WP02 | P1 | Yes |
| T010 | Bundle explosion logic | WP02 | P1 | Yes |
| T011 | Recipe aggregation | WP02 | P1 | Yes |
| T012 | Batch calculation tests | WP02 | P1 | Yes |
| T013 | Create shopping_list.py | WP03 | P1 | Yes |
| T014 | Wrap event_service shopping | WP03 | P1 | Yes |
| T015 | Ingredient aggregation | WP03 | P1 | Yes |
| T016 | Gap calculation | WP03 | P1 | Yes |
| T017 | Mark shopping complete | WP03 | P1 | Yes |
| T018 | Shopping list tests | WP03 | P1 | Yes |
| T019 | Create feasibility.py | WP04 | P1 | Yes |
| T020 | Check assembly feasibility | WP04 | P1 | Yes |
| T021 | Check production feasibility | WP04 | P1 | Yes |
| T022 | Feasibility DTOs | WP04 | P1 | Yes |
| T023 | Partial assembly feasibility | WP04 | P1 | Yes |
| T024 | Feasibility tests | WP04 | P1 | Yes |
| T025 | Create progress.py | WP05 | P1 | Yes |
| T026 | Get production progress | WP05 | P1 | Yes |
| T027 | Get assembly progress | WP05 | P1 | Yes |
| T028 | Get overall progress | WP05 | P1 | Yes |
| T029 | Progress DTOs | WP05 | P1 | Yes |
| T030 | Progress tests | WP05 | P1 | Yes |
| T031 | Create planning_service.py | WP06 | P2 | No |
| T032 | Implement calculate_plan | WP06 | P2 | No |
| T033 | Implement get_plan_summary | WP06 | P2 | No |
| T034 | Implement check_staleness | WP06 | P2 | No |
| T035 | Recipe batches facade | WP06 | P2 | No |
| T036 | Feasibility facade methods | WP06 | P2 | No |
| T037 | Progress facade methods | WP06 | P2 | No |
| T038 | Assembly checklist methods | WP06 | P2 | No |
| T039 | Mark shopping complete facade | WP06 | P2 | No |
| T040 | Define exceptions | WP06 | P2 | No |
| T041 | Facade integration tests | WP06 | P2 | No |
| T042 | Create planning/__init__.py (UI) | WP07 | P3 | No |
| T043 | Create planning_workspace.py | WP07 | P3 | No |
| T044 | Create phase_sidebar.py | WP07 | P3 | No |
| T045 | Phase status indicators | WP07 | P3 | No |
| T046 | Phase navigation warnings | WP07 | P3 | No |
| T047 | Stale plan banner | WP07 | P3 | No |
| T048 | Wire into PLAN mode | WP07 | P3 | No |
| T049 | Create calculate_view.py | WP08 | P3 | Yes |
| T050 | Create shop_view.py | WP08 | P3 | Yes |
| T051 | Create produce_view.py | WP08 | P3 | Yes |
| T052 | Create assemble_view.py | WP08 | P3 | Yes |
| T053 | Calculate button and results | WP08 | P3 | Yes |
| T054 | Shopping list table styling | WP08 | P3 | Yes |
| T055 | Progress bars per recipe | WP08 | P3 | Yes |
| T056 | Assembly checklist UI | WP08 | P3 | Yes |
| T057 | Feasibility indicators UI | WP08 | P3 | Yes |
| T058 | Full workflow test | WP09 | P4 | No |
| T059 | Edge case tests | WP09 | P4 | No |
| T060 | Staleness verification | WP09 | P4 | No |
| T061 | Shortfall prevention verification | WP09 | P4 | No |
| T062 | Gap calculation verification | WP09 | P4 | No |
| T063 | Performance verification | WP09 | P4 | No |
| T064 | Coverage verification | WP09 | P4 | No |
| T065 | Update quickstart checklist | WP09 | P4 | No |
