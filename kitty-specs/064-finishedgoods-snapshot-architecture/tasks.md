# Work Packages: FinishedGoods Snapshot Architecture

**Feature**: 064-finishedgoods-snapshot-architecture
**Inputs**: Design documents from `kitty-specs/064-finishedgoods-snapshot-architecture/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: Unit tests included for all service layer primitives per constitution (>70% coverage target).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

---

## Work Package WP01: FinishedUnitSnapshot Model + Service (Priority: P0)

**Goal**: Create FinishedUnitSnapshot model and service primitive following RecipeSnapshot pattern exactly.
**Independent Test**: FinishedUnitSnapshot can be created, queried by ID, and queried by planning_snapshot_id.
**Prompt**: `tasks/WP01-finished-unit-snapshot.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [x] T001 Create FinishedUnitSnapshot model in `src/models/finished_unit_snapshot.py`
- [x] T002 [P] Add FinishedUnitSnapshot to models `__init__.py` exports
- [x] T003 Add `create_finished_unit_snapshot()` function to `src/services/finished_unit_service.py`
- [x] T004 Add `get_finished_unit_snapshot()` and `get_snapshots_by_planning_id()` query functions
- [x] T005 Create unit tests in `src/tests/test_finished_unit_snapshot.py`

### Implementation Notes
- Model follows RecipeSnapshot pattern: JSON Text column, dual context FKs, wrapper/impl session pattern
- Service function returns dict (not ORM object) - matches recipe_snapshot_service pattern
- definition_data JSON captures all FinishedUnit fields plus denormalized recipe name/category

### Parallel Opportunities
- T002 can run in parallel with T001 (add import after model file exists)
- WP01 and WP02 can run in parallel (no dependencies between them)

### Dependencies
- None (foundation package)

### Risks & Mitigations
- Schema mismatch: Cross-reference data-model.md for exact column specs
- Session management: Copy wrapper/impl pattern exactly from recipe_snapshot_service.py

---

## Work Package WP02: MaterialUnitSnapshot Model + Service (Priority: P0)

**Goal**: Create MaterialUnitSnapshot model and service primitive following same pattern as WP01.
**Independent Test**: MaterialUnitSnapshot can be created, queried by ID, includes denormalized material name.
**Prompt**: `tasks/WP02-material-unit-snapshot.md`
**Estimated Size**: ~320 lines

### Included Subtasks
- [x] T006 Create MaterialUnitSnapshot model in `src/models/material_unit_snapshot.py`
- [x] T007 [P] Add MaterialUnitSnapshot to models `__init__.py` exports
- [x] T008 Add `create_material_unit_snapshot()` function to `src/services/material_unit_service.py`
- [x] T009 Add `get_material_unit_snapshot()` and `get_snapshots_by_planning_id()` query functions
- [x] T010 Create unit tests in `src/tests/test_material_unit_snapshot.py`

### Implementation Notes
- Identical pattern to WP01 - different source entity (MaterialUnit vs FinishedUnit)
- definition_data captures: slug, name, description, material_id, material_name, material_category, quantity_per_unit

### Parallel Opportunities
- T007 can run in parallel with T006
- WP02 can run in parallel with WP01

### Dependencies
- None (foundation package)

### Risks & Mitigations
- MaterialUnit model structure: Verify field names by reading src/models/material_unit.py

---

## Work Package WP03: FinishedGoodSnapshot Model + Service (Priority: P0) ðŸŽ¯ MVP

**Goal**: Create FinishedGoodSnapshot model and recursive snapshot service with circular reference detection.
**Independent Test**: FinishedGoodSnapshot captures component hierarchy, circular references raise descriptive error.
**Prompt**: `tasks/WP03-finished-good-snapshot.md`
**Estimated Size**: ~550 lines

### Included Subtasks
- [x] T011 Create FinishedGoodSnapshot model in `src/models/finished_good_snapshot.py`
- [x] T012 [P] Add FinishedGoodSnapshot to models `__init__.py` exports
- [x] T013 Create custom exception classes (CircularReferenceError, MaxDepthExceededError)
- [x] T014 Add `create_finished_good_snapshot()` with recursive component snapshot logic
- [x] T015 Implement circular reference detection with visited_ids set tracking
- [x] T016 Implement max depth enforcement (10 levels)
- [x] T017 Add `get_finished_good_snapshot()` and `get_snapshots_by_planning_id()` query functions
- [x] T018 Create comprehensive unit tests including edge cases

### Implementation Notes
- Most complex WP - recursive snapshot creation orchestrates WP01 and WP02 primitives
- Component snapshot strategy:
  - `finished_unit_id` â†’ call `create_finished_unit_snapshot()`, store snapshot_id
  - `material_unit_id` â†’ call `create_material_unit_snapshot()`, store snapshot_id
  - `finished_good_id` â†’ recurse `create_finished_good_snapshot()`, store snapshot_id
  - `material_id` (is_generic=True) â†’ store placeholder data, snapshot_id=null
  - `packaging_product_id` â†’ skip (out of scope)
- All component snapshots created in same session for transaction atomicity

### Parallel Opportunities
- T012 and T013 can run in parallel with T011
- T017 can start once model exists

### Dependencies
- Depends on WP01 (FinishedUnitSnapshot service) and WP02 (MaterialUnitSnapshot service)

### Risks & Mitigations
- Circular reference detection: Test with deliberately circular fixtures
- Transaction atomicity: Use single session throughout recursive calls
- Performance: Test with 50+ component FinishedGood to validate <5s requirement

---

## Work Package WP04: PlanningSnapshot Container (Priority: P0)

**Goal**: Create PlanningSnapshot container model and service for grouping snapshots by planning session.
**Independent Test**: PlanningSnapshot can be created, linked to event, and queried with all associated snapshots.
**Prompt**: `tasks/WP04-planning-snapshot-container.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [x] T019 Create PlanningSnapshot model in `src/models/planning_snapshot.py`
- [x] T020 [P] Add PlanningSnapshot to models `__init__.py` exports
- [x] T021 [P] Add Event.planning_snapshots relationship to `src/models/event.py`
- [x] T022 Create `src/services/planning_snapshot_service.py` with CRUD functions
- [x] T023 Add `get_planning_snapshot()` with all linked snapshots aggregation
- [x] T024 Add `delete_planning_snapshot()` (relies on CASCADE for cleanup)
- [x] T025 Create unit tests in `src/tests/test_planning_snapshot.py`

### Implementation Notes
- PlanningSnapshot is the container that groups all snapshots for an event planning session
- Relationships: PlanningSnapshot has one-to-many to all three snapshot types
- Event.planning_snapshots enables navigation from Event to its planning snapshots
- Deletion cascades to all associated snapshots (no orphans)

### Parallel Opportunities
- T020 and T021 can run in parallel
- T024 can run in parallel with T023

### Dependencies
- Depends on WP01, WP02, WP03 (all snapshot models must exist for relationships)

### Risks & Mitigations
- Cascade deletion: Test that deleting PlanningSnapshot removes all child snapshots
- Orphan prevention: Ensure snapshots always have valid container reference

---

## Dependency & Execution Summary

- **Sequence**: WP01 + WP02 (parallel) â†’ WP03 â†’ WP04
- **Parallelization**: WP01 and WP02 can run simultaneously by different agents
- **MVP Scope**: All 4 WPs constitute MVP (primitives-first approach). Assembly/Planning orchestration (WP05, WP06) deferred to future feature.

```
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  WP01  â”‚     â”‚  WP02  â”‚  â† Can run in parallel
      â”‚ (FU)   â”‚     â”‚ (MU)   â”‚
      â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚              â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
           â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
           â”‚   WP03    â”‚  â† Depends on WP01, WP02
           â”‚   (FG)    â”‚
           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                 â”‚
           â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
           â”‚   WP04    â”‚  â† Depends on WP01, WP02, WP03
           â”‚(Planning) â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | FinishedUnitSnapshot model | WP01 | P0 | No |
| T002 | Add to models __init__.py | WP01 | P0 | Yes |
| T003 | create_finished_unit_snapshot() | WP01 | P0 | No |
| T004 | Query functions | WP01 | P0 | No |
| T005 | Unit tests | WP01 | P0 | No |
| T006 | MaterialUnitSnapshot model | WP02 | P0 | No |
| T007 | Add to models __init__.py | WP02 | P0 | Yes |
| T008 | create_material_unit_snapshot() | WP02 | P0 | No |
| T009 | Query functions | WP02 | P0 | No |
| T010 | Unit tests | WP02 | P0 | No |
| T011 | FinishedGoodSnapshot model | WP03 | P0 | No |
| T012 | Add to models __init__.py | WP03 | P0 | Yes |
| T013 | Exception classes | WP03 | P0 | Yes |
| T014 | create_finished_good_snapshot() | WP03 | P0 | No |
| T015 | Circular reference detection | WP03 | P0 | No |
| T016 | Max depth enforcement | WP03 | P0 | No |
| T017 | Query functions | WP03 | P0 | No |
| T018 | Unit tests | WP03 | P0 | No |
| T019 | PlanningSnapshot model | WP04 | P0 | No |
| T020 | Add to models __init__.py | WP04 | P0 | Yes |
| T021 | Event.planning_snapshots relationship | WP04 | P0 | Yes |
| T022 | planning_snapshot_service CRUD | WP04 | P0 | No |
| T023 | get_planning_snapshot() aggregation | WP04 | P0 | No |
| T024 | delete_planning_snapshot() | WP04 | P0 | Yes |
| T025 | Unit tests | WP04 | P0 | No |
