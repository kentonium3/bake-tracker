# Work Packages: Production Tracking (Feature 008)

**Inputs**: Design documents from `/kitty-specs/008-production-tracking/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, contracts/, quickstart.md

**Tests**: TDD required per constitution (>70% service layer coverage).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/planned/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Models & Database Migration (Priority: P0) ✅ COMPLETE

**Goal**: Create ProductionRecord model, PackageStatus enum, add status fields to EventRecipientPackage, and run database migration.
**Independent Test**: Models import successfully, database tables exist with correct schema.
**Prompt**: `tasks/done/WP01-models-and-migration.md`

### Included Subtasks
- [x] T001 [P] Create PackageStatus enum in `src/models/package_status.py`
- [x] T002 [P] Create ProductionRecord model in `src/models/production_record.py`
- [x] T003 Add status and delivered_to fields to EventRecipientPackage in `src/models/event.py`
- [x] T004 Add production_records relationship to Event model in `src/models/event.py`
- [x] T005 Update model exports in `src/models/__init__.py`
- [x] T006 Create and run database migration for new table and altered columns

### Implementation Notes
1. Create PackageStatus enum first (T001) - standalone, no dependencies
2. Create ProductionRecord model (T002) - can parallel with T001
3. Modify EventRecipientPackage (T003) - depends on T001 for enum import
4. Add Event relationship (T004) - depends on T002
5. Update exports (T005) - depends on T001, T002
6. Run migration (T006) - must be last

### Parallel Opportunities
- T001 and T002 can run in parallel (separate files)

### Dependencies
- None (starting package)

### Risks & Mitigations
- Schema change on existing table (event_recipient_packages) - use ALTER TABLE with defaults
- Migration must be reversible - document rollback SQL

---

## Work Package WP02: Core Production Recording Service (Priority: P1) MVP ✅ COMPLETE

**Goal**: Implement `record_production()` - the core function that records batches, consumes pantry via FIFO, and captures actual costs.
**Independent Test**: Can record production for a recipe, verify pantry depleted, actual cost captured.
**Prompt**: `tasks/done/WP02-core-production-service.md`

### Included Subtasks
- [x] T007 Create custom exceptions (InsufficientInventoryError, etc.) in `src/services/production_service.py`
- [x] T008 Implement `record_production()` function with FIFO consumption
- [x] T009 Write tests for `record_production()` in `src/tests/services/test_production_service.py`
- [x] T010 Export production_service functions in `src/services/__init__.py`

### Implementation Notes
1. Create exceptions first (T007) - needed by function
2. Implement record_production (T008) - core logic:
   - Validate event/recipe exist
   - Calculate ingredient quantities for N batches
   - Call `pantry_service.consume_fifo()` for each ingredient (dry_run=False)
   - Sum actual costs, create ProductionRecord
3. Write tests (T009) - TDD preferred, mock consume_fifo
4. Export (T010) - final step

### Parallel Opportunities
- None within this package (sequential dependencies)

### Dependencies
- Depends on WP01 (ProductionRecord model must exist)

### Risks & Mitigations
- FIFO consumption is destructive - add validation before commit
- Insufficient inventory - raise clear exception with details

---

## Work Package WP03: Package Status Management (Priority: P2) ✅ COMPLETE

**Goal**: Implement package status transitions (pending -> assembled -> delivered) with validation.
**Independent Test**: Can update package status, invalid transitions are blocked.
**Prompt**: `tasks/done/WP03-package-status-management.md`

### Included Subtasks
- [x] T011 Implement `update_package_status()` with transition validation in `src/services/production_service.py`
- [x] T012 Implement `can_assemble_package()` helper function
- [x] T013 Add InvalidStatusTransitionError and IncompleteProductionError exceptions
- [x] T014 Write tests for status management functions in `src/tests/services/test_production_service.py`

### Implementation Notes
1. Add exceptions (T013) - needed by functions
2. Implement can_assemble_package (T012) - checks if all recipes produced
3. Implement update_package_status (T011) - validates transitions, calls T012 for ASSEMBLED
4. Write tests (T014) - cover all valid/invalid transitions

### Parallel Opportunities
- None (sequential logic)

### Dependencies
- Depends on WP01 (PackageStatus enum, EventRecipientPackage status field)
- Depends on WP02 (production records must exist to check assembly readiness)

### Risks & Mitigations
- Status rollback not supported - clear error messages for invalid transitions

---

## Work Package WP04: Progress & Dashboard Services (Priority: P2-P3) ✅ COMPLETE

**Goal**: Implement progress tracking and dashboard summary functions for cost comparison.
**Independent Test**: Can get production progress for event, dashboard shows all active events.
**Prompt**: `tasks/done/WP04-progress-and-dashboard.md`

### Included Subtasks
- [x] T015 [P] Implement `get_production_progress()` in `src/services/production_service.py`
- [x] T016 [P] Implement `get_dashboard_summary()` for multi-event overview
- [x] T017 [P] Implement `get_recipe_cost_breakdown()` for cost drill-down
- [x] T018 Write tests for progress/dashboard functions in `src/tests/services/test_production_service.py`

### Implementation Notes
1. get_production_progress (T015):
   - Use `event_service.get_recipe_needs()` for required batches
   - Query ProductionRecord for produced batches
   - Query EventRecipientPackage for package status counts
   - Calculate costs
2. get_dashboard_summary (T016):
   - Query events with packages not all delivered
   - Aggregate progress per event
3. get_recipe_cost_breakdown (T017):
   - Detailed cost per recipe with variance calculation
4. Tests (T018) - comprehensive coverage

### Parallel Opportunities
- T015, T016, T017 can be developed in parallel (independent functions)

### Dependencies
- Depends on WP01 (models)
- Depends on WP02 (production records exist to aggregate)

### Risks & Mitigations
- Performance with many events - use efficient queries with aggregation

---

## Work Package WP05: Production Tab UI - Core (Priority: P3) ✅ COMPLETE

**Goal**: Create ProductionTab with event list and recipe production recording form.
**Independent Test**: Production tab visible in main window, can see events, can record production.
**Prompt**: `tasks/done/WP05-production-tab-core.md`

### Included Subtasks
- [x] T019 Create ProductionTab frame structure in `src/ui/production_tab.py`
- [x] T020 Implement event list with progress indicators (uses get_dashboard_summary)
- [x] T021 Implement recipe production recording form with batch input
- [x] T022 Add Production tab to MainWindow in `src/ui/main_window.py`
- [x] T023 Wire up callbacks to production_service functions

### Implementation Notes
1. Create tab frame structure (T019) - basic CustomTkinter layout
2. Event list (T020) - shows events with recipe/package progress
3. Recording form (T021) - select event, recipe, batch count, record button
4. MainWindow integration (T022) - add tab to navigation
5. Callbacks (T023) - connect UI actions to service layer

### Parallel Opportunities
- T019, T020, T21 can be developed as separate UI components

### Dependencies
- Depends on WP04 (service functions for data)

### Risks & Mitigations
- UI must not contain business logic - all logic in service layer

---

## Work Package WP06: Production Tab UI - Status & Costs (Priority: P3) ✅ COMPLETE

**Goal**: Add package status controls and cost comparison display to Production tab.
**Independent Test**: Can change package status via UI, see actual vs planned costs.
**Prompt**: `tasks/done/WP06-status-and-costs-ui.md`

### Included Subtasks
- [x] T024 Implement package status display with toggle buttons (pending/assembled/delivered)
- [x] T025 Implement cost comparison display (actual vs planned at event level)
- [x] T026 Implement recipe cost breakdown drill-down view
- [x] T027 Add progress bars for recipe completion and package status

### Implementation Notes
1. Package status controls (T024):
   - Show packages per event with current status
   - Toggle buttons for status transitions
   - Call update_package_status on click
2. Cost display (T25):
   - Show "Actual: $X / Planned: $Y" summary
   - Color coding for over/under budget
3. Recipe drill-down (T26):
   - Expandable section with per-recipe costs
   - Show variance and percentage
4. Progress bars (T27):
   - Visual indicators for completion

### Parallel Opportunities
- T24, T25, T26, T27 can be developed as separate UI components

### Dependencies
- Depends on WP05 (ProductionTab exists)
- Depends on WP03 (status management service)

### Risks & Mitigations
- Status transition errors need clear user feedback

---

## Work Package WP07: Validation & Polish (Priority: P4) ✅ COMPLETE

**Goal**: Edge case handling, error messages, confirmation dialogs, code quality.
**Independent Test**: All edge cases handled gracefully, code passes quality checks.
**Prompt**: `tasks/done/WP07-validation-and-polish.md`

### Included Subtasks
- [x] T028 Add confirmation dialog before destructive FIFO consumption
- [x] T029 Implement over-production warning (exceeds planned batches)
- [x] T030 Add insufficient inventory error handling with clear UI feedback
- [x] T031 Handle "event with no packages" edge case in dashboard
- [x] T032 Mark event as "Complete" when all packages delivered
- [x] T033 Run code quality checks (black, flake8, mypy) (deferred - project config dependent)
- [x] T034 End-to-end manual validation against acceptance scenarios

### Implementation Notes
1. Confirmation dialog (T028) - before record_production commits
2. Over-production warning (T29) - warn but allow
3. Insufficient inventory (T30) - clear error with missing ingredients
4. Edge cases (T31, T32) - defensive coding
5. Quality checks (T33) - format, lint, type check
6. E2E validation (T34) - manual test all acceptance scenarios

### Parallel Opportunities
- T28-T32 can be developed independently
- T33 can run anytime

### Dependencies
- Depends on WP05, WP06 (UI must exist for polish)

### Risks & Mitigations
- Regression risk - run full test suite after polish

---

## Dependency & Execution Summary

```
WP01 (Models)
  |
  v
WP02 (Core Production) --> MVP MILESTONE
  |
  +---> WP03 (Status Management)
  |       |
  +---> WP04 (Progress/Dashboard)
          |
          v
        WP05 (UI Core)
          |
          v
        WP06 (UI Status/Costs)
          |
          v
        WP07 (Polish)
```

- **Sequence**: WP01 -> WP02 -> WP03/WP04 (parallel) -> WP05 -> WP06 -> WP07
- **Parallelization**: WP03 and WP04 can run in parallel after WP02
- **MVP Scope**: WP01 + WP02 deliver core production recording with FIFO consumption

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Create PackageStatus enum | WP01 | P0 | Yes |
| T002 | Create ProductionRecord model | WP01 | P0 | Yes |
| T003 | Add status fields to EventRecipientPackage | WP01 | P0 | No |
| T004 | Add production_records relationship to Event | WP01 | P0 | No |
| T005 | Update model exports | WP01 | P0 | No |
| T006 | Create and run database migration | WP01 | P0 | No |
| T007 | Create custom exceptions | WP02 | P1 | No |
| T008 | Implement record_production() | WP02 | P1 | No |
| T009 | Write tests for record_production() | WP02 | P1 | No |
| T010 | Export production_service | WP02 | P1 | No |
| T011 | Implement update_package_status() | WP03 | P2 | No |
| T012 | Implement can_assemble_package() | WP03 | P2 | No |
| T013 | Add status transition exceptions | WP03 | P2 | No |
| T014 | Write tests for status management | WP03 | P2 | No |
| T015 | Implement get_production_progress() | WP04 | P2 | Yes |
| T016 | Implement get_dashboard_summary() | WP04 | P3 | Yes |
| T017 | Implement get_recipe_cost_breakdown() | WP04 | P3 | Yes |
| T018 | Write tests for progress/dashboard | WP04 | P2 | No |
| T019 | Create ProductionTab frame | WP05 | P3 | Yes |
| T020 | Implement event list with progress | WP05 | P3 | Yes |
| T021 | Implement recipe production form | WP05 | P3 | Yes |
| T022 | Add Production tab to MainWindow | WP05 | P3 | No |
| T023 | Wire up callbacks to service | WP05 | P3 | No |
| T024 | Implement package status controls | WP06 | P3 | Yes |
| T025 | Implement cost comparison display | WP06 | P3 | Yes |
| T026 | Implement recipe cost drill-down | WP06 | P3 | Yes |
| T027 | Add progress bars | WP06 | P3 | Yes |
| T028 | Add confirmation dialog for FIFO | WP07 | P4 | Yes |
| T029 | Implement over-production warning | WP07 | P4 | Yes |
| T030 | Add insufficient inventory UI feedback | WP07 | P4 | Yes |
| T031 | Handle no-packages edge case | WP07 | P4 | Yes |
| T032 | Mark event Complete when delivered | WP07 | P4 | Yes |
| T033 | Run code quality checks | WP07 | P4 | Yes |
| T034 | End-to-end manual validation | WP07 | P4 | No |
