# Work Packages: Production & Inventory Tracking

**Inputs**: Design documents from `/kitty-specs/013-production-inventory-tracking/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, contracts/, quickstart.md

**Tests**: Include testing work per SC-008 requirement (>70% service layer coverage).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `kitty-specs/013-production-inventory-tracking/tasks/planned/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Production Run Models (Priority: P0)

**Goal**: Create the ProductionRun and ProductionConsumption models that form the foundation of batch production tracking.
**Independent Test**: Models can be instantiated, saved to DB, and queried with proper constraints enforced.
**Prompt**: `tasks/planned/WP01-production-run-models.md`

### Included Subtasks
- [ ] T001 [P] Create ProductionRun model in `src/models/production_run.py`
- [ ] T002 [P] Create ProductionConsumption model in `src/models/production_consumption.py`
- [ ] T003 Update `src/models/__init__.py` to export new models
- [ ] T004 Add `production_runs` relationship to Recipe model

### Implementation Notes
- Follow BaseModel pattern from `src/models/base.py`
- Include all columns, constraints, and indexes per data-model.md
- ProductionRun has FK to Recipe and FinishedUnit
- ProductionConsumption has FK to ProductionRun only (stores ingredient_slug, not FK)

### Parallel Opportunities
- T001 and T002 can be developed in parallel (different files)

### Dependencies
- None (foundational models)

### Risks & Mitigations
- Schema drift from data-model.md: Validate column definitions against data-model.md exactly

---

## Work Package WP02: Assembly Run Models (Priority: P0)

**Goal**: Create the AssemblyRun and its two consumption ledger models.
**Independent Test**: Models can be instantiated, saved to DB, and queried with proper constraints enforced.
**Prompt**: `tasks/planned/WP02-assembly-run-models.md`

### Included Subtasks
- [ ] T005 [P] Create AssemblyRun model in `src/models/assembly_run.py`
- [ ] T006 [P] Create AssemblyFinishedUnitConsumption model in `src/models/assembly_finished_unit_consumption.py`
- [ ] T007 [P] Create AssemblyPackagingConsumption model in `src/models/assembly_packaging_consumption.py`
- [ ] T008 Update `src/models/__init__.py` to export new assembly models

### Implementation Notes
- Follow BaseModel pattern
- AssemblyRun has FK to FinishedGood
- AssemblyFinishedUnitConsumption has FK to AssemblyRun and FinishedUnit
- AssemblyPackagingConsumption has FK to AssemblyRun and Product

### Parallel Opportunities
- T005, T006, T007 can all be developed in parallel (different files)

### Dependencies
- None (foundational models, can run parallel with WP01)

### Risks & Mitigations
- Missing relationship definitions: Ensure back_populates is correctly configured

---

## Work Package WP03: Batch Production Service - Core (Priority: P1)

**Goal**: Implement `check_can_produce()` and `record_batch_production()` functions in BatchProductionService.
**Independent Test**: Can verify ingredient availability and record batch production with FIFO consumption.
**Prompt**: `tasks/planned/WP03-batch-production-service-core.md`

### Included Subtasks
- [ ] T009 Create `src/services/batch_production_service.py` with module structure
- [ ] T010 Implement `check_can_produce(recipe_id, num_batches)` using dry_run FIFO
- [ ] T011 Implement `record_batch_production()` with full transaction logic
- [ ] T012 Add custom exceptions (InsufficientInventoryError, RecipeNotFoundError, etc.)
- [ ] T013 Update `src/services/__init__.py` to export new service

### Implementation Notes
- Use `recipe_service.get_aggregated_ingredients()` for nested recipe support
- Use `inventory_item_service.consume_fifo(dry_run=True)` for availability checks
- Use `inventory_item_service.consume_fifo(dry_run=False)` for actual consumption
- All operations within single `session_scope()` transaction
- Calculate per_unit_cost = total_ingredient_cost / actual_yield (handle div by 0)

### Parallel Opportunities
- T009, T012 are prerequisites; T010 and T011 can be partially parallel after setup

### Dependencies
- Depends on WP01 (ProductionRun, ProductionConsumption models)

### Risks & Mitigations
- Transaction rollback on partial failure: Use single session_scope for atomicity
- FIFO cost calculation errors: Validate consume_fifo returns expected structure

---

## Work Package WP04: Batch Production Service - Tests (Priority: P1)

**Goal**: Achieve >70% test coverage for BatchProductionService with comprehensive test scenarios.
**Independent Test**: All tests pass, coverage meets threshold.
**Prompt**: `tasks/planned/WP04-batch-production-service-tests.md`

### Included Subtasks
- [ ] T014 Create test file `src/tests/test_batch_production_service.py`
- [ ] T015 [P] Test `check_can_produce()` - sufficient inventory scenario
- [ ] T016 [P] Test `check_can_produce()` - insufficient inventory scenario
- [ ] T017 [P] Test `check_can_produce()` - nested recipe scenario
- [ ] T018 [P] Test `record_batch_production()` - happy path
- [ ] T019 [P] Test `record_batch_production()` - actual_yield = 0 (failed batch)
- [ ] T020 [P] Test `record_batch_production()` - yield exceeds expected
- [ ] T021 [P] Test `record_batch_production()` - insufficient inventory rollback
- [ ] T022 [P] Test `record_batch_production()` - FinishedUnit-Recipe mismatch

### Implementation Notes
- Create fixtures for Recipe, FinishedUnit, Ingredient, Product, InventoryItem
- Verify FIFO consumption was called with correct parameters
- Verify FinishedUnit.inventory_count incremented by actual_yield
- Verify ProductionRun and ProductionConsumption records created correctly
- Verify transaction rollback on failure (no partial state)

### Parallel Opportunities
- All test subtasks (T015-T022) can be developed in parallel after T014 setup

### Dependencies
- Depends on WP03 (BatchProductionService implementation)

### Risks & Mitigations
- Flaky tests from shared state: Use fresh DB session per test with proper teardown

---

## Work Package WP05: Assembly Service - Core (Priority: P2)

**Goal**: Implement `check_can_assemble()` and `record_assembly()` functions in AssemblyService.
**Independent Test**: Can verify component availability and record assembly with inventory updates.
**Prompt**: `tasks/planned/WP05-assembly-service-core.md`

### Included Subtasks
- [ ] T023 Create `src/services/assembly_service.py` with module structure
- [ ] T024 Implement `check_can_assemble(finished_good_id, quantity)`
- [ ] T025 Implement `record_assembly()` with full transaction logic
- [ ] T026 Add custom exceptions (InsufficientFinishedUnitError, InsufficientPackagingError, etc.)
- [ ] T027 Update `src/services/__init__.py` to export assembly service

### Implementation Notes
- Query Composition model for FinishedGood's components (finished_units and packaging)
- Check FinishedUnit.inventory_count for availability
- Use `consume_fifo()` for packaging consumption (packaging products have ingredient associations)
- Decrement FinishedUnit.inventory_count, increment FinishedGood.inventory_count
- Create AssemblyRun + consumption ledger records atomically

### Parallel Opportunities
- T023, T026 are prerequisites; T024 and T025 can be partially parallel after setup

### Dependencies
- Depends on WP02 (AssemblyRun models)
- Depends on WP03 (pattern established for service structure)

### Risks & Mitigations
- Composition BOM query complexity: Understand existing Composition model structure first
- Packaging consumption via wrong mechanism: Must use consume_fifo for packaging products

---

## Work Package WP06: Assembly Service - Tests (Priority: P2)

**Goal**: Achieve >70% test coverage for AssemblyService with comprehensive test scenarios.
**Independent Test**: All tests pass, coverage meets threshold.
**Prompt**: `tasks/planned/WP06-assembly-service-tests.md`

### Included Subtasks
- [ ] T028 Create test file `src/tests/test_assembly_service.py`
- [ ] T029 [P] Test `check_can_assemble()` - sufficient components
- [ ] T030 [P] Test `check_can_assemble()` - insufficient FinishedUnit
- [ ] T031 [P] Test `check_can_assemble()` - insufficient packaging
- [ ] T032 [P] Test `record_assembly()` - happy path
- [ ] T033 [P] Test `record_assembly()` - nested FinishedGood components
- [ ] T034 [P] Test `record_assembly()` - insufficient inventory rollback
- [ ] T035 [P] Test `record_assembly()` - FinishedGood not found

### Implementation Notes
- Create fixtures for FinishedGood, FinishedUnit, Composition, packaging Products
- Verify FinishedUnit.inventory_count decremented correctly
- Verify packaging consumed via FIFO
- Verify FinishedGood.inventory_count incremented
- Verify all consumption ledger records created

### Parallel Opportunities
- All test subtasks (T029-T035) can be developed in parallel after T028 setup

### Dependencies
- Depends on WP05 (AssemblyService implementation)

### Risks & Mitigations
- Complex fixture setup for Composition: Reference existing composition test patterns

---

## Work Package WP07: History & Query Functions (Priority: P3)

**Goal**: Implement production and assembly history query functions.
**Independent Test**: Can query production/assembly history with filters and get full consumption details.
**Prompt**: `tasks/planned/WP07-history-query-functions.md`

### Included Subtasks
- [ ] T036 [P] Implement `get_production_history()` in batch_production_service.py
- [ ] T037 [P] Implement `get_production_run()` in batch_production_service.py
- [ ] T038 [P] Implement `get_assembly_history()` in assembly_service.py
- [ ] T039 [P] Implement `get_assembly_run()` in assembly_service.py
- [ ] T040 Add tests for history query functions

### Implementation Notes
- Support filtering by recipe_id, finished_unit_id, date range
- Support pagination with limit/offset
- Include consumption ledger details when requested
- Use eager loading to avoid N+1 queries

### Parallel Opportunities
- T036-T039 can all be developed in parallel (different functions/files)

### Dependencies
- Depends on WP03 (BatchProductionService) and WP05 (AssemblyService)

### Risks & Mitigations
- Performance on large history: Add appropriate indexes, use pagination

---

## Work Package WP08: Import/Export (Priority: P3)

**Goal**: Implement import/export functionality for production and assembly history.
**Independent Test**: Can export production/assembly data, reimport, and verify data integrity.
**Prompt**: `tasks/planned/WP08-import-export.md`

### Included Subtasks
- [ ] T041 [P] Implement `export_production_history()` serialization
- [ ] T042 [P] Implement `import_production_history()` deserialization
- [ ] T043 [P] Implement `export_assembly_history()` serialization
- [ ] T044 [P] Implement `import_assembly_history()` deserialization
- [ ] T045 Add tests for import/export round-trip integrity

### Implementation Notes
- Export format: JSON with all consumption ledger details
- Include UUID fields for cross-system compatibility
- Validate referential integrity on import (recipe, finished_unit must exist)
- Handle duplicate detection via UUID

### Parallel Opportunities
- Export functions (T041, T043) can be parallel; Import functions (T042, T044) can be parallel

### Dependencies
- Depends on WP07 (history query functions)

### Risks & Mitigations
- Foreign key resolution on import: Validate all references exist before insert
- Data corruption on partial import: Use transaction with rollback

---

## Dependency & Execution Summary

**Sequence**:
```
WP01 (Production Models) ─┬─► WP03 (Batch Production Service) ─► WP04 (Batch Tests)
                          │                                              │
WP02 (Assembly Models) ───┼─► WP05 (Assembly Service) ─► WP06 (Assembly Tests)
                          │                                              │
                          └───────────────────────────► WP07 (History) ──► WP08 (Import/Export)
```

**Parallelization**:
- WP01 and WP02 can run in parallel (no dependencies)
- WP03 and WP05 can partially overlap after their model dependencies complete
- WP04 and WP06 can run in parallel after their service dependencies complete

**MVP Scope**: WP01 + WP02 + WP03 + WP04 (batch production with tests) constitutes minimal usable feature. Assembly (WP05, WP06) and history/export (WP07, WP08) can follow.

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Create ProductionRun model | WP01 | P0 | Yes |
| T002 | Create ProductionConsumption model | WP01 | P0 | Yes |
| T003 | Update models __init__.py | WP01 | P0 | No |
| T004 | Add Recipe.production_runs relationship | WP01 | P0 | No |
| T005 | Create AssemblyRun model | WP02 | P0 | Yes |
| T006 | Create AssemblyFinishedUnitConsumption model | WP02 | P0 | Yes |
| T007 | Create AssemblyPackagingConsumption model | WP02 | P0 | Yes |
| T008 | Update models __init__.py for assembly | WP02 | P0 | No |
| T009 | Create batch_production_service.py structure | WP03 | P1 | No |
| T010 | Implement check_can_produce() | WP03 | P1 | No |
| T011 | Implement record_batch_production() | WP03 | P1 | No |
| T012 | Add batch production exceptions | WP03 | P1 | Yes |
| T013 | Update services __init__.py | WP03 | P1 | No |
| T014 | Create test_batch_production_service.py | WP04 | P1 | No |
| T015 | Test check_can_produce - sufficient | WP04 | P1 | Yes |
| T016 | Test check_can_produce - insufficient | WP04 | P1 | Yes |
| T017 | Test check_can_produce - nested | WP04 | P1 | Yes |
| T018 | Test record_batch_production - happy path | WP04 | P1 | Yes |
| T019 | Test record_batch_production - yield=0 | WP04 | P1 | Yes |
| T020 | Test record_batch_production - yield exceeds | WP04 | P1 | Yes |
| T021 | Test record_batch_production - rollback | WP04 | P1 | Yes |
| T022 | Test record_batch_production - mismatch | WP04 | P1 | Yes |
| T023 | Create assembly_service.py structure | WP05 | P2 | No |
| T024 | Implement check_can_assemble() | WP05 | P2 | No |
| T025 | Implement record_assembly() | WP05 | P2 | No |
| T026 | Add assembly exceptions | WP05 | P2 | Yes |
| T027 | Update services __init__.py | WP05 | P2 | No |
| T028 | Create test_assembly_service.py | WP06 | P2 | No |
| T029 | Test check_can_assemble - sufficient | WP06 | P2 | Yes |
| T030 | Test check_can_assemble - insufficient FU | WP06 | P2 | Yes |
| T031 | Test check_can_assemble - insufficient pkg | WP06 | P2 | Yes |
| T032 | Test record_assembly - happy path | WP06 | P2 | Yes |
| T033 | Test record_assembly - nested FG | WP06 | P2 | Yes |
| T034 | Test record_assembly - rollback | WP06 | P2 | Yes |
| T035 | Test record_assembly - FG not found | WP06 | P2 | Yes |
| T036 | Implement get_production_history() | WP07 | P3 | Yes |
| T037 | Implement get_production_run() | WP07 | P3 | Yes |
| T038 | Implement get_assembly_history() | WP07 | P3 | Yes |
| T039 | Implement get_assembly_run() | WP07 | P3 | Yes |
| T040 | Add history query tests | WP07 | P3 | No |
| T041 | Implement export_production_history() | WP08 | P3 | Yes |
| T042 | Implement import_production_history() | WP08 | P3 | Yes |
| T043 | Implement export_assembly_history() | WP08 | P3 | Yes |
| T044 | Implement import_assembly_history() | WP08 | P3 | Yes |
| T045 | Add import/export tests | WP08 | P3 | No |
