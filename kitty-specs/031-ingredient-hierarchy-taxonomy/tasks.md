# Work Packages: Ingredient Hierarchy Taxonomy

**Inputs**: Design documents from `kitty-specs/031-ingredient-hierarchy-taxonomy/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, contracts/, quickstart.md

**Tests**: Unit tests for service layer included per constitution (TDD, >70% coverage).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/planned/` generated by `/spec-kitty.tasks`.

---

## Work Package WP01: Schema & Model Foundation (Priority: P0)

**Goal**: Add hierarchy fields to Ingredient model (parent_ingredient_id, hierarchy_level, self-referential relationship).
**Independent Test**: Ingredient model accepts hierarchy fields; database creates with new columns and indexes.
**Prompt**: `tasks/planned/WP01-schema-model-foundation.md`
**Assignee**: Claude (foundation layer)

### Included Subtasks
- [ ] T001 Add `parent_ingredient_id` FK column to Ingredient model (`src/models/ingredient.py`)
- [ ] T002 Add `hierarchy_level` column with CHECK constraint (0, 1, 2)
- [ ] T003 Add self-referential relationship (children/parent backref)
- [ ] T004 Add database indexes for parent_ingredient_id and hierarchy_level
- [ ] T005 Update Ingredient.to_dict() to include hierarchy fields
- [ ] T006 Export database, delete, recreate with new schema (constitution VI)

### Implementation Notes
- Follow SQLAlchemy self-referential pattern: `relationship("Ingredient", backref=backref('parent', remote_side=[id]))`
- Default hierarchy_level=2 for existing ingredients (all become leaves initially)
- Retain `category` field as deprecated (rollback safety)

### Parallel Opportunities
- None - this is the foundation layer.

### Dependencies
- None (starting package).

### Risks & Mitigations
- Data loss during schema recreation → Export all data first; validate import after

---

## Work Package WP02: Hierarchy Service - Core Functions (Priority: P0)

**Goal**: Implement tree traversal service methods for navigation.
**Independent Test**: Service methods return correct tree data from test database.
**Prompt**: `tasks/planned/WP02-hierarchy-service-core.md`
**Assignee**: Claude or Gemini

### Included Subtasks
- [ ] T007 Create `src/services/ingredient_hierarchy_service.py` with session pattern
- [ ] T008 Implement `get_root_ingredients()` - returns all level 0 ingredients
- [ ] T009 Implement `get_children(parent_id)` - returns direct children
- [ ] T010 Implement `get_ancestors(ingredient_id)` - returns path to root (breadcrumb)
- [ ] T011 Implement `get_all_descendants(ancestor_id)` - recursive descendants
- [ ] T012 Implement `get_leaf_ingredients(parent_id=None)` - all/filtered leaf nodes
- [ ] T013 Implement `is_leaf(ingredient_id)` - helper for validation
- [ ] T014 [P] Write unit tests for all core functions (`src/tests/services/test_ingredient_hierarchy_service.py`)

### Implementation Notes
- Follow existing service patterns (session_scope, optional session parameter)
- Return dicts from service methods (not ORM objects) per project convention
- Use SQLAlchemy recursive queries or Python recursion (3-level depth is small)

### Parallel Opportunities
- T014 (tests) can parallel with implementation once function signatures defined

### Dependencies
- Depends on WP01.

### Risks & Mitigations
- Query performance on 500+ ingredients → Fixed 3-level depth limits recursion

---

## Work Package WP03: Hierarchy Service - Validation & Management (Priority: P0)

**Goal**: Implement validation and hierarchy management operations.
**Independent Test**: Validation prevents invalid operations; move_ingredient correctly updates hierarchy.
**Prompt**: `tasks/planned/WP03-hierarchy-service-validation.md`
**Assignee**: Claude

### Included Subtasks
- [ ] T015 Implement `validate_hierarchy_level(ingredient_id, allowed_levels)`
- [ ] T016 Implement `would_create_cycle(ingredient_id, new_parent_id)` - cycle detection
- [ ] T017 Implement `move_ingredient(ingredient_id, new_parent_id)` - with validation
- [ ] T018 Implement `search_ingredients(query)` - returns matches with ancestors
- [ ] T019 Add hierarchy exceptions to `src/services/exceptions.py` (CircularReferenceError, etc.)
- [ ] T020 [P] Write unit tests for validation and management functions

### Implementation Notes
- Cycle detection: walk from new_parent to root, check if ingredient_id is encountered
- Move operation: validate depth, validate no cycle, update parent_id and recalculate level
- Search returns list with `ancestors` field populated for each match

### Parallel Opportunities
- T020 (tests) can parallel once function signatures defined

### Dependencies
- Depends on WP02 (uses core functions).

### Risks & Mitigations
- Circular reference bugs → Comprehensive test cases for edge cases

---

## Work Package WP04: Service Layer Validation Updates (Priority: P1)

**Goal**: Enforce leaf-only constraints in existing services.
**Independent Test**: Recipe and product services reject non-leaf ingredients with helpful errors.
**Prompt**: `tasks/planned/WP04-service-validation-updates.md`
**Assignee**: Claude

### Included Subtasks
- [ ] T021 Update `src/services/ingredient_service.py` - validate hierarchy on create/update
- [ ] T022 Update `src/services/recipe_service.py` - enforce leaf-only in add_ingredient_to_recipe
- [ ] T023 Update `src/services/product_service.py` - enforce leaf-only on product creation
- [ ] T024 Update `src/services/product_catalog_service.py` - leaf-only validation
- [ ] T025 [P] Update existing service tests to cover hierarchy validation

### Implementation Notes
- Validation error messages should suggest leaf alternatives (get top 3 leaf descendants)
- Pattern: `if not is_leaf(ingredient_id): raise ValidationError(...)`
- Import hierarchy service functions where needed

### Parallel Opportunities
- Each service update can proceed in parallel (different files)

### Dependencies
- Depends on WP02, WP03 (uses hierarchy service).

### Risks & Mitigations
- Breaking existing functionality → Run full test suite after each service update

---

## Work Package WP05: Tree Widget Component (Priority: P1) [P]

**Goal**: Create reusable tree selection widget for ingredient hierarchy.
**Independent Test**: Widget displays tree, supports expand/collapse, search works with auto-expand.
**Prompt**: `tasks/planned/WP05-tree-widget-component.md`
**Assignee**: Gemini (parallel safe)

### Included Subtasks
- [ ] T026 [P] Create `src/ui/widgets/ingredient_tree_widget.py` with ttk.Treeview
- [ ] T027 [P] Implement expand/collapse functionality with lazy loading
- [ ] T028 [P] Implement search box with auto-expand matching branches
- [ ] T029 [P] Implement breadcrumb display for selected item
- [ ] T030 [P] Add context-aware selection mode (leaf-only for recipes)
- [ ] T031 [P] Add visual distinction between category nodes and leaf nodes

### Implementation Notes
- Use ttk.Treeview inside CTkFrame for CustomTkinter compatibility
- Lazy-load children on expand (call get_children service)
- Search: filter tree, auto-expand branches containing matches
- Pass `leaf_only=True` parameter for recipe context

### Parallel Opportunities
- **FULLY PARALLEL with WP04** - Different file set, can stub service calls
- All subtasks within this WP can proceed in parallel

### Dependencies
- Depends on WP01 (schema). Can stub services for initial development.

### Risks & Mitigations
- ttk.Treeview styling conflicts with CustomTkinter → Test early; fallback to minimal styling

---

## Work Package WP06: UI Integration (Priority: P1)

**Goal**: Integrate tree widget into existing UI components.
**Independent Test**: Users can select ingredients via tree in Ingredients tab and recipe dialogs.
**Prompt**: `tasks/planned/WP06-ui-integration.md`
**Assignee**: Claude

### Included Subtasks
- [ ] T032 Integrate tree widget into `src/ui/ingredients_tab.py`
- [ ] T033 Update `src/ui/forms/recipe_ingredient_dialog.py` to use tree selector
- [ ] T034 Add ingredient detail panel showing hierarchy (breadcrumb path)
- [ ] T035 Wire up search and filter controls to tree widget
- [ ] T036 Update ingredient creation/edit forms for hierarchy fields

### Implementation Notes
- Replace flat dropdown/list with tree widget
- In recipe context, configure widget with `leaf_only=True`
- Show breadcrumb path in detail view: "Chocolate → Dark Chocolate → Semi-Sweet Chips"

### Parallel Opportunities
- T032 and T033 can proceed in parallel (different dialogs)

### Dependencies
- Depends on WP04, WP05 (services and widget ready).

### Risks & Mitigations
- User confusion with new navigation → Design follows mockups from design doc; test with real user

---

## Work Package WP07: Migration Tooling (Priority: P2) [P]

**Goal**: Create scripts to migrate existing 487 ingredients to hierarchical structure.
**Independent Test**: Export → Transform → Validate → Import cycle works with sample data.
**Prompt**: `tasks/planned/WP07-migration-tooling.md`
**Assignee**: Gemini (parallel safe)

### Included Subtasks
- [ ] T037 [P] Create `scripts/migrate_hierarchy/export_ingredients.py` - export current data
- [ ] T038 [P] Create `scripts/migrate_hierarchy/transform_hierarchy.py` - merge AI suggestions
- [ ] T039 [P] Create `scripts/migrate_hierarchy/validate_hierarchy.py` - pre-import validation
- [ ] T040 [P] Create `scripts/prompts/hierarchy_categorization_prompt.md` - AI prompt template
- [ ] T041 [P] Document migration process in README or separate doc

### Implementation Notes
- Transform script accepts AI-generated JSON with suggested parent relationships
- Validate script checks: no orphans, valid levels, no cycles, all leaves exist
- AI prompt template should instruct external AI on expected output format

### Parallel Opportunities
- **FULLY PARALLEL with WP05, WP06** - Different file set (scripts/)
- All subtasks within this WP can proceed in parallel

### Dependencies
- Depends on WP01 (schema), WP02 (service for validation logic).

### Risks & Mitigations
- AI categorization quality → Human review step; manual editing capability

---

## Work Package WP08: Integration & Polish (Priority: P2)

**Goal**: End-to-end testing, production migration, and final polish.
**Independent Test**: All 487 ingredients migrated; user acceptance test passes.
**Prompt**: `tasks/planned/WP08-integration-polish.md`
**Assignee**: Claude

### Included Subtasks
- [ ] T042 Create sample hierarchy data for testing (20-30 ingredients, 5 root categories)
- [ ] T043 Update export/import services to handle new hierarchy fields
- [ ] T044 Execute full migration of production ingredient data
- [ ] T045 End-to-end testing of all user stories
- [ ] T046 User acceptance testing with Marianne
- [ ] T047 Bug fixes from testing
- [ ] T048 Update CHANGELOG and documentation

### Implementation Notes
- Sample data: Create JSON with Chocolate, Flour, Sugar hierarchies for testing
- Migration: Export prod data → Run AI categorization externally → Transform → Import
- UAT: Validate SC-001 through SC-007 with real user

### Parallel Opportunities
- T042 (sample data) can proceed early as parallel prep work

### Dependencies
- Depends on WP01-WP07 (all components complete).

### Risks & Mitigations
- Migration data loss → Keep backup; validate record counts before/after

---

## Dependency & Execution Summary

```
WP01 (Schema) ─────────────────────────────────────────────────────┐
     │                                                             │
     ├─► WP02 (Core Services) ─► WP03 (Validation Services) ─┐    │
     │                                                        │    │
     │   [PARALLEL BRANCH - Gemini]                          │    │
     ├─► WP05 (Tree Widget) ──────────────────────────────►  │    │
     │                                                        │    │
     └─► WP07 (Migration Tools) ─────────────────────────►   │    │
                                                              │    │
                                                              ▼    │
                         WP04 (Service Updates) ◄─────────────┘    │
                                    │                              │
                                    ▼                              │
                         WP06 (UI Integration)                     │
                                    │                              │
                                    ▼                              │
                         WP08 (Integration & Polish) ◄─────────────┘
```

**Sequence**: WP01 → {WP02 → WP03 → WP04} + {WP05 || WP07} → WP06 → WP08

**Parallelization Opportunities**:
- After WP01: **Gemini can start WP05 (Tree Widget) and WP07 (Migration) in parallel with Claude doing WP02-WP04**
- WP05 and WP07 have no file conflicts with service work
- Estimated time savings: ~40% by parallelizing widget and migration work

**MVP Scope**: WP01 + WP02 + WP03 + WP04 + WP05 + WP06 (core hierarchy + UI)
- WP07 (Migration) and WP08 (Polish) can follow as second phase if time-constrained

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Add parent_ingredient_id FK column | WP01 | P0 | No |
| T002 | Add hierarchy_level column | WP01 | P0 | No |
| T003 | Add self-referential relationship | WP01 | P0 | No |
| T004 | Add database indexes | WP01 | P0 | No |
| T005 | Update to_dict() for hierarchy | WP01 | P0 | No |
| T006 | Export/recreate database | WP01 | P0 | No |
| T007 | Create hierarchy service file | WP02 | P0 | No |
| T008 | Implement get_root_ingredients | WP02 | P0 | No |
| T009 | Implement get_children | WP02 | P0 | No |
| T010 | Implement get_ancestors | WP02 | P0 | No |
| T011 | Implement get_all_descendants | WP02 | P0 | No |
| T012 | Implement get_leaf_ingredients | WP02 | P0 | No |
| T013 | Implement is_leaf helper | WP02 | P0 | No |
| T014 | Unit tests for core functions | WP02 | P0 | Yes |
| T015 | Implement validate_hierarchy_level | WP03 | P0 | No |
| T016 | Implement cycle detection | WP03 | P0 | No |
| T017 | Implement move_ingredient | WP03 | P0 | No |
| T018 | Implement search_ingredients | WP03 | P0 | No |
| T019 | Add hierarchy exceptions | WP03 | P0 | No |
| T020 | Unit tests for validation | WP03 | P0 | Yes |
| T021 | Update ingredient_service.py | WP04 | P1 | No |
| T022 | Update recipe_service.py | WP04 | P1 | No |
| T023 | Update product_service.py | WP04 | P1 | No |
| T024 | Update product_catalog_service.py | WP04 | P1 | No |
| T025 | Update service tests | WP04 | P1 | Yes |
| T026 | Create tree widget file | WP05 | P1 | Yes |
| T027 | Implement expand/collapse | WP05 | P1 | Yes |
| T028 | Implement search auto-expand | WP05 | P1 | Yes |
| T029 | Implement breadcrumb display | WP05 | P1 | Yes |
| T030 | Add leaf-only selection mode | WP05 | P1 | Yes |
| T031 | Visual node distinction | WP05 | P1 | Yes |
| T032 | Integrate into ingredients_tab | WP06 | P1 | No |
| T033 | Update recipe_ingredient_dialog | WP06 | P1 | Yes |
| T034 | Add hierarchy detail panel | WP06 | P1 | Yes |
| T035 | Wire search/filter controls | WP06 | P1 | No |
| T036 | Update create/edit forms | WP06 | P1 | No |
| T037 | Create export script | WP07 | P2 | Yes |
| T038 | Create transform script | WP07 | P2 | Yes |
| T039 | Create validate script | WP07 | P2 | Yes |
| T040 | Create AI prompt template | WP07 | P2 | Yes |
| T041 | Document migration process | WP07 | P2 | Yes |
| T042 | Create sample hierarchy data | WP08 | P2 | Yes |
| T043 | Update export/import services | WP08 | P2 | No |
| T044 | Execute production migration | WP08 | P2 | No |
| T045 | End-to-end testing | WP08 | P2 | No |
| T046 | User acceptance testing | WP08 | P2 | No |
| T047 | Bug fixes from testing | WP08 | P2 | No |
| T048 | Update CHANGELOG and docs | WP08 | P2 | Yes |
