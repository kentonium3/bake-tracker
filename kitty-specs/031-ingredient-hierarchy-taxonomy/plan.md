# Implementation Plan: Ingredient Hierarchy Taxonomy

**Branch**: `031-ingredient-hierarchy-taxonomy` | **Date**: 2025-12-30 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `kitty-specs/031-ingredient-hierarchy-taxonomy/spec.md`

---

## Summary

Replace the flat ingredient catalog (487+ items with category string) with a three-tier self-referential hierarchy. The hierarchy uses `parent_ingredient_id` FK and `hierarchy_level` field on the existing Ingredient table. Only leaf ingredients (level 2) can have Products or be used in Recipes.

**Key Components**:
1. Schema changes (2 new columns, indexes)
2. Tree traversal service (`ingredient_hierarchy_service.py`)
3. UI tree widget (ttk.Treeview in CustomTkinter)
4. Migration tooling (hybrid: accepts pre-generated AI suggestions)

---

## Technical Context

**Language/Version**: Python 3.10+
**Primary Dependencies**: SQLAlchemy 2.x, CustomTkinter, tkinter.ttk
**Storage**: SQLite with WAL mode
**Testing**: pytest with >70% service coverage
**Target Platform**: Desktop (Windows, macOS, Linux)
**Project Type**: Single desktop application
**Performance Goals**: Tree navigation <1s, search <1s for 500+ ingredients
**Constraints**: Single-user, offline-capable, no API dependencies for core features
**Scale/Scope**: 487 existing ingredients, 3-level max depth

---

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Pre-Design Check

| Principle | Status | Notes |
|-----------|--------|-------|
| I. User-Centric Design | PASS | Tree navigation reduces 487-item scroll to 3 clicks; validated in design doc |
| II. Data Integrity & FIFO | PASS | Hierarchy is structural metadata; doesn't affect FIFO calculations |
| III. Future-Proof Schema | PASS | Self-referential FK supports arbitrary depth; nullable parent allows incremental adoption |
| IV. Test-Driven Development | PASS | Plan includes service layer tests; >70% coverage target maintained |
| V. Layered Architecture | PASS | Hierarchy logic in service layer; UI only renders tree widget |
| VI. Schema Change Strategy | PASS | Using export → reset → import cycle per constitution |
| VII. Pragmatic Aspiration | PASS | Desktop-focused; structure supports future web migration |

### Post-Design Check

| Principle | Status | Notes |
|-----------|--------|-------|
| V. Layered Architecture | VERIFIED | `ingredient_hierarchy_service.py` contains all tree logic; UI only calls service methods |
| IV. TDD | VERIFIED | Test strategy defined for all service methods |

**Gate Status**: PASSED - No violations

---

## Project Structure

### Documentation (this feature)

```
kitty-specs/031-ingredient-hierarchy-taxonomy/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 research decisions
├── data-model.md        # Entity changes and validation rules
├── quickstart.md        # Developer onboarding guide
├── research/
│   ├── evidence-log.csv
│   └── source-register.csv
├── contracts/           # Service contracts
│   └── ingredient_hierarchy_service.md
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Generated by /spec-kitty.tasks
```

### Source Code (repository root)

```
src/
├── models/
│   └── ingredient.py          # MODIFY: Add parent_ingredient_id, hierarchy_level
├── services/
│   ├── ingredient_service.py  # MODIFY: Add hierarchy validation
│   ├── ingredient_hierarchy_service.py  # NEW: Tree traversal methods
│   ├── recipe_service.py      # MODIFY: Validate leaf-only ingredients
│   └── product_service.py     # MODIFY: Validate leaf-only assignment
├── ui/
│   ├── widgets/
│   │   └── ingredient_tree_widget.py  # NEW: Tree selection widget
│   ├── ingredients_tab.py     # MODIFY: Use tree widget
│   └── forms/
│       └── recipe_ingredient_dialog.py  # MODIFY: Use tree widget
└── tests/
    └── services/
        └── test_ingredient_hierarchy_service.py  # NEW

scripts/
├── migrate_hierarchy/
│   ├── export_ingredients.py      # Export current data
│   ├── transform_hierarchy.py     # Merge AI suggestions with export
│   └── validate_hierarchy.py      # Pre-import validation
└── prompts/
    └── hierarchy_categorization_prompt.md  # AI prompt template
```

**Structure Decision**: Single project structure (existing). New files added to existing directories following established patterns.

---

## Complexity Tracking

*No constitution violations - table empty*

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| (none) | - | - |

---

## Implementation Phases

### Phase 1: Schema & Model (Foundation)

**Goal**: Add hierarchy fields to Ingredient model

**Deliverables**:
- Modified `src/models/ingredient.py` with new columns and relationships
- Database recreation with new schema
- Basic model tests

**Dependencies**: None (foundation layer)

---

### Phase 2: Service Layer

**Goal**: Implement tree traversal and validation services

**Deliverables**:
- New `src/services/ingredient_hierarchy_service.py`
- Modified `src/services/ingredient_service.py` (hierarchy validation)
- Modified `src/services/recipe_service.py` (leaf-only validation)
- Modified `src/services/product_service.py` (leaf-only validation)
- Unit tests with >70% coverage

**Dependencies**: Phase 1

---

### Phase 3: UI Tree Widget

**Goal**: Create reusable tree selection widget

**Deliverables**:
- New `src/ui/widgets/ingredient_tree_widget.py`
- Integration with Ingredients tab
- Integration with recipe ingredient selection
- Search functionality with auto-expand

**Dependencies**: Phase 2

---

### Phase 4: Migration Tooling

**Goal**: Tools to transform existing data to hierarchy

**Deliverables**:
- Export script for current ingredients
- Transform script accepting AI-generated suggestions
- Validation script for pre-import checks
- AI prompt template for categorization
- Documentation for migration process

**Dependencies**: Phases 1-2 (can parallel with Phase 3)

---

### Phase 5: Integration & Testing

**Goal**: End-to-end validation and user testing

**Deliverables**:
- Integration tests
- Full migration of production data
- User acceptance testing with Marianne
- Bug fixes from testing

**Dependencies**: Phases 1-4

---

## Parallelization Strategy

| Work Package | Assignable To | Dependencies | Files Modified |
|--------------|---------------|--------------|----------------|
| Schema/Model changes | Claude | None | `src/models/ingredient.py` |
| Hierarchy service | Claude or Gemini | Schema | `src/services/ingredient_hierarchy_service.py` |
| Service validation updates | Claude | Schema | `ingredient_service.py`, `recipe_service.py`, `product_service.py` |
| Tree widget | Gemini | Schema (can stub services) | `src/ui/widgets/ingredient_tree_widget.py` |
| Migration tooling | Gemini | Export services | `scripts/migrate_hierarchy/*.py` |
| Service unit tests | Gemini | Services complete | `src/tests/services/test_*.py` |
| UI integration | Claude | Widget + Services | `ingredients_tab.py`, dialogs |

**Safe Parallel Assignments**:
- **After Phase 1**: Gemini can work on tree widget while Claude works on services
- **After Phase 2**: Gemini can work on migration tooling while Claude integrates UI
- **File boundaries enforced**: No overlapping file modifications

---

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| ttk.Treeview styling conflicts | Test early; fallback to minimal styling |
| AI suggestions poor quality | Human review step; manual editing capability |
| Performance on 500+ ingredients | Fixed 3-level depth limits recursion; cache if needed |
| User confusion with tree | Early prototype testing; keep flat dropdown as fallback |

---

## Success Metrics

From spec.md:
- SC-001: Navigate root → leaf in ≤3 clicks
- SC-002: Search with auto-expand <1 second
- SC-003: All 487 ingredients migrated, zero data loss
- SC-004: Recipe creation same or fewer clicks
- SC-005: 90%+ AI suggestions accepted
- SC-006: 100% invalid operations prevented
- SC-007: Marianne succeeds on first attempt

---

## Next Steps

1. Run `/spec-kitty.tasks` to generate work packages
2. Assign parallel work to Gemini (tree widget, migration tooling)
3. Begin with Phase 1 (schema changes) as foundation
