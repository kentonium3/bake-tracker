# Work Packages: Production-Aware Planning Calculations

**Feature**: F079 | **Created**: 2026-01-28
**Inputs**: Design documents from `/kitty-specs/079-production-aware-planning-calculations/`
**Prerequisites**: plan.md (required), spec.md (user stories), data-model.md

**Tests**: Included per constitution requirement (>70% service coverage).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Includes precise file paths.

---

## Work Package WP01: Remaining Needs Calculation (Priority: P1) üéØ Foundation

**Goal**: Extend ProductionProgress DTO with remaining_batches and overage_batches fields, add helper function for downstream consumers.
**Independent Test**: Tests verify remaining calculation: partial completion shows correct remaining, overage shows 0 remaining with overage count.
**Prompt**: `tasks/WP01-remaining-needs-calculation.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [x] T001 Extend ProductionProgress dataclass with remaining_batches and overage_batches fields in `src/services/planning/progress.py`
- [x] T002 Update _get_production_progress_impl() to calculate remaining_batches and overage_batches
- [x] T003 Add get_remaining_production_needs() helper function returning Dict[recipe_id, remaining_batches]
- [x] T004 Write tests for remaining calculation in `src/tests/planning/test_progress.py`

### Implementation Notes
1. Modify the ProductionProgress dataclass (add 2 fields)
2. Update the implementation to calculate: `remaining = max(0, target - completed)`, `overage = max(0, completed - target)`
3. Add new function that wraps get_production_progress() and returns dict
4. Tests cover: partial completion, exact completion, overage, zero target

### Parallel Opportunities
- None - this is foundation work that must complete first

### Dependencies
- None (starting package)

### Risks & Mitigations
- Risk: Breaking existing callers of ProductionProgress
- Mitigation: New fields are additive; existing code continues to work

---

## Work Package WP02: Production-Aware Feasibility (Priority: P2)

**Goal**: Modify check_production_feasibility() to check remaining batches instead of total when production_aware=True.
**Independent Test**: With 10 target batches, 7 completed, and inventory for 3 but not 10, feasibility shows CAN_PRODUCE.
**Prompt**: `tasks/WP02-production-aware-feasibility.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [x] T005 Add production_aware parameter (default True) to check_production_feasibility() signature
- [ ] T006 Import get_remaining_production_needs() from progress module
- [ ] T007 Modify _check_production_feasibility_impl() to use remaining batches when production_aware=True
- [ ] T008 [P] Write tests for production-aware feasibility in `src/tests/planning/test_feasibility.py`

### Implementation Notes
1. Add `production_aware: bool = True` parameter to both public and impl functions
2. When production_aware=True, call get_remaining_production_needs() to get remaining counts
3. Use remaining_batches instead of target.target_batches for check_can_produce()
4. Handle edge case: if remaining is 0, skip the check (already complete)
5. Tests cover: sufficient for remaining, insufficient for remaining, all complete, legacy mode (production_aware=False)

### Parallel Opportunities
- T008 (tests) can be written in parallel with T005-T007 implementation

### Dependencies
- Depends on WP01 (needs get_remaining_production_needs())

### Risks & Mitigations
- Risk: Breaking existing callers
- Mitigation: Default production_aware=True gives new behavior; callers can opt-out with False

---

## Work Package WP03: Production-Aware Shopping List (Priority: P3)

**Goal**: Modify shopping list to calculate ingredient needs for remaining production only.
**Independent Test**: With 10 batches target, 7 completed (needing 300g flour for remaining 3), and 200g in stock, shopping list shows 100g to buy.
**Prompt**: `tasks/WP03-production-aware-shopping-list.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [x] T009 Add production_aware parameter (default True) to get_shopping_list() and related functions
- [x] T010 Create _calculate_remaining_ingredient_needs() helper to compute needs for remaining batches
- [x] T011 Integrate remaining needs calculation into shopping list flow
- [x] T012 [P] Write tests for production-aware shopping list in `src/tests/planning/test_shopping_list.py`

### Implementation Notes
1. Add `production_aware: bool = True` parameter to get_shopping_list(), get_items_to_buy(), get_shopping_summary()
2. When production_aware=True:
   - Get remaining batches per recipe via get_remaining_production_needs()
   - Calculate ingredient needs based on remaining batches only
   - Compare against current inventory for gap calculation
3. When all production complete (all remaining=0), return empty list
4. Tests cover: partial production, complete production, legacy mode

### Parallel Opportunities
- T012 (tests) can be written in parallel with T009-T011 implementation

### Dependencies
- Depends on WP01 (needs get_remaining_production_needs())

### Risks & Mitigations
- Risk: Complex integration with event_service.get_shopping_list()
- Mitigation: May need to bypass event_service and calculate directly from remaining needs

---

## Work Package WP04: Amendment Production Validation (Priority: P3)

**Goal**: Add validation to block MODIFY_BATCH and DROP_FG amendments when recipes have completed production.
**Independent Test**: Attempting to modify batch decision for recipe with production raises ValidationError with clear message.
**Prompt**: `tasks/WP04-amendment-production-validation.md`
**Estimated Size**: ~450 lines

### Included Subtasks
- [x] T013 Add _has_production_for_recipe() helper function to check if recipe has production records
- [x] T014 Add validation call in _modify_batch_decision_impl() before making changes
- [x] T015 Add _get_recipes_for_finished_good() helper to find recipes contributing to an FG
- [x] T016 Add validation call in _drop_finished_good_impl() checking all contributing recipes
- [x] T017 [P] Write tests for amendment validation in `src/tests/test_plan_amendment_service.py`

### Implementation Notes
1. `_has_production_for_recipe(event_id, recipe_id, session)` - query ProductionRun for count > 0
2. In modify_batch_decision: call validation before batch_decision update
3. `_get_recipes_for_finished_good(fg_id, session)` - trace Composition ‚Üí FinishedUnit ‚Üí Recipe
4. In drop_finished_good: check all contributing recipes have no production
5. ValidationError messages must include recipe/FG name for clarity
6. Tests cover: amendment allowed (no production), amendment blocked (has production), clear error messages

### Parallel Opportunities
- T017 (tests) can be written in parallel with T013-T016 implementation

### Dependencies
- None (uses existing models; doesn't depend on WP01)
- Can run in parallel with WP02 and WP03

### Risks & Mitigations
- Risk: Complex FG ‚Üí Recipe tracing for drop_finished_good
- Mitigation: Reuse existing Composition queries from assembly_service

---

## Work Package WP05: UI Progress Display (Priority: P4)

**Goal**: Update planning_tab to display remaining batches, overage indicators, and lock icons for recipes with production.
**Independent Test**: Planning dashboard shows "3 of 5 (2 remaining)" for partial production, "+2 overage" for over-production, lock icon blocks amendment UI.
**Prompt**: `tasks/WP05-ui-progress-display.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [ ] T018 Update progress display to show "X of Y (Z remaining)" format
- [ ] T019 Add overage indicator when completed > target showing "+N overage"
- [ ] T020 Add lock icon next to recipes with completed production
- [ ] T021 Disable/hide amendment controls for locked recipes

### Implementation Notes
1. Modify production progress rendering to include remaining_batches
2. Add conditional overage display when overage_batches > 0
3. Query for production existence to determine lock state
4. Use CTk styling for lock indicator (icon or badge)
5. Disable batch modification buttons when recipe is locked

### Parallel Opportunities
- T018 and T019 can proceed in parallel (different UI elements)

### Dependencies
- Depends on WP01 (needs remaining_batches in ProductionProgress)
- Depends on WP04 (needs production check logic for lock icon)

### Risks & Mitigations
- Risk: UI code changes may have unexpected layout impacts
- Mitigation: Test with various data scenarios (0, partial, complete, overage)

---

## Dependency & Execution Summary

```
WP01 (foundation) ‚îÄ‚î¨‚îÄ‚Üí WP02 (feasibility)
                   ‚îú‚îÄ‚Üí WP03 (shopping)
                   ‚îî‚îÄ‚Üí WP05 (UI) ‚Üê‚îÄ‚îÄ WP04 (amendment validation)

WP04 can run parallel with WP02/WP03 (no dependency on WP01)
```

**Sequence**:
1. WP01 (must complete first - foundation)
2. WP02, WP03, WP04 (can parallelize)
3. WP05 (depends on WP01 and WP04)

**MVP Scope**: WP01 + WP02 constitute minimum viable production-aware planning. WP03-WP05 enhance the experience.

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Extend ProductionProgress with remaining/overage fields | WP01 | P1 | No |
| T002 | Update impl to calculate remaining/overage | WP01 | P1 | No |
| T003 | Add get_remaining_production_needs() helper | WP01 | P1 | No |
| T004 | Write remaining calculation tests | WP01 | P1 | No |
| T005 | Add production_aware param to feasibility | WP02 | P2 | No |
| T006 | Import get_remaining_production_needs | WP02 | P2 | No |
| T007 | Modify feasibility impl for remaining batches | WP02 | P2 | No |
| T008 | Write production-aware feasibility tests | WP02 | P2 | Yes |
| T009 | Add production_aware param to shopping list | WP03 | P3 | No |
| T010 | Create remaining ingredient needs helper | WP03 | P3 | No |
| T011 | Integrate remaining needs into shopping flow | WP03 | P3 | No |
| T012 | Write production-aware shopping list tests | WP03 | P3 | Yes |
| T013 | Add _has_production_for_recipe() helper | WP04 | P3 | No |
| T014 | Add validation to modify_batch_decision() | WP04 | P3 | No |
| T015 | Add _get_recipes_for_finished_good() helper | WP04 | P3 | No |
| T016 | Add validation to drop_finished_good() | WP04 | P3 | No |
| T017 | Write amendment validation tests | WP04 | P3 | Yes |
| T018 | Update progress display format | WP05 | P4 | Yes |
| T019 | Add overage indicator | WP05 | P4 | Yes |
| T020 | Add lock icon for recipes with production | WP05 | P4 | No |
| T021 | Disable amendment controls for locked recipes | WP05 | P4 | No |
