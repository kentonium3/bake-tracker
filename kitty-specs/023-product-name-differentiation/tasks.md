# Work Packages: Product Name Differentiation

**Feature Branch**: `023-product-name-differentiation`
**Inputs**: Design documents from `kitty-specs/023-product-name-differentiation/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: Only include explicit testing work when stakeholders request it.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/planned/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Model Layer - Add product_name Column (Priority: P1) MVP

**Goal**: Add `product_name` column to Product model with unique constraint and display_name update.
**Independent Test**: Create Product with product_name, verify it saves and displays correctly in display_name property.
**Prompt**: `tasks/planned/WP01-model-product-name-column.md`

### Included Subtasks
- [ ] T001 Add `product_name` column (VARCHAR 200, nullable) to `src/models/product.py` after `brand`
- [ ] T002 Add UniqueConstraint for `(ingredient_id, brand, product_name, package_size, package_unit)` in `__table_args__`
- [ ] T003 Update `display_name` property to include `product_name` after brand (format: "Brand ProductName Size")
- [ ] T004 Add empty string to NULL normalization in model `__init__` or validator

### Implementation Notes
1. Column position: after `brand`, before `package_size`
2. UniqueConstraint pattern from `src/models/recipe.py:375`
3. SQLite NULL behavior: multiple NULLs are distinct (acceptable)
4. Empty string normalization ensures consistency with NULL handling

### Parallel Opportunities
- None within this package (sequential column then constraint then property)

### Dependencies
- None (foundational package)

### Risks & Mitigations
- Risk: Constraint conflicts with existing data
- Mitigation: All existing products will have NULL product_name; SQLite treats NULLs as distinct

---

## Work Package WP02: Service Layer - product_service Updates (Priority: P1)

**Goal**: Update product_service create/update methods to accept and handle product_name parameter.
**Independent Test**: Call `create_product()` with product_name, verify it persists correctly.
**Prompt**: `tasks/planned/WP02-service-product-updates.md`

### Included Subtasks
- [ ] T005 Update `create_product()` in `src/services/product_service.py` to accept `product_name` parameter
- [ ] T006 Update `update_product()` in `src/services/product_service.py` to accept `product_name` parameter

### Implementation Notes
1. Both methods need optional `product_name: Optional[str] = None` parameter
2. Normalize empty strings to None before saving
3. Follow existing parameter patterns in the service

### Parallel Opportunities
- T005 and T006 can be implemented in parallel [P]

### Dependencies
- Depends on WP01 (model must have column first)

### Risks & Mitigations
- Risk: Session management issues per CLAUDE.md guidelines
- Mitigation: Follow existing service patterns, ensure session parameter propagation

---

## Work Package WP03: Service Layer - Import/Export Updates (Priority: P2)

**Goal**: Add product_name to export output and import handling with backward compatibility.
**Independent Test**: Export products with product_name, verify JSON includes field; import old JSON without product_name, verify NULL default.
**Prompt**: `tasks/planned/WP03-service-import-export.md`

### Included Subtasks
- [ ] T007 Add `product_name` to product export in `src/services/import_export_service.py` (around line 1148)
- [ ] T008 Update import duplicate check to include `product_name` in lookup (around line 2357)
- [ ] T009 Handle backward compatibility: default missing `product_name` to NULL on import

### Implementation Notes
1. Export: Add optional field pattern like other nullable fields (lines 1147-1176)
2. Import lookup: Extend filter_by to include `product_name=prod_data.get("product_name")`
3. Backward compatibility: `.get("product_name")` returns None if missing

### Parallel Opportunities
- T007 (export) can proceed independently from T008-T009 (import) [P]

### Dependencies
- Depends on WP01 (model must have column)

### Risks & Mitigations
- Risk: Old exports without product_name fail on import
- Mitigation: Use .get() with None default for backward compatibility

---

## Work Package WP04: UI Layer - ProductFormDialog Updates (Priority: P1)

**Goal**: Add Product Name field to the Add/Edit Product form in the UI.
**Independent Test**: Open Add Product dialog, verify Product Name field appears after Brand, can be filled or left blank.
**Prompt**: `tasks/planned/WP04-ui-product-form.md`

### Included Subtasks
- [ ] T010 Add "Product Name" entry field after Brand field in `ProductFormDialog._create_form()` at `src/ui/ingredients_tab.py`
- [ ] T011 Update `_populate_form()` to load existing product_name value
- [ ] T012 Update `_save()` to include product_name in result dict
- [ ] T013 Add 200-character limit validation and update help text

### Implementation Notes
1. Field placement: After Brand (row after line 1525), before Purchase Quantity
2. Use CTkEntry with placeholder "e.g., 70% Cacao"
3. Label: "Product Name:" (no asterisk - optional field)
4. Update help text at bottom to explain when to use product_name

### Parallel Opportunities
- None within this package (form components are interdependent)

### Dependencies
- Depends on WP02 (service must accept product_name parameter)

### Risks & Mitigations
- Risk: Form layout shift affects usability
- Mitigation: Window geometry already accommodates additional fields (550x550)

---

## Work Package WP05: Migration - Export/Reset/Import Cycle (Priority: P1)

**Goal**: Execute Constitution VI migration cycle to apply schema changes to existing database.
**Independent Test**: Count products before migration, run cycle, verify same count after with all product_name=NULL.
**Prompt**: `tasks/planned/WP05-migration-cycle.md`

### Included Subtasks
- [ ] T014 Export current database to JSON using File > Export Data menu
- [ ] T015 Delete database file (`bake_tracker.db`) and restart app to recreate with new schema
- [ ] T016 Import data from exported JSON file using File > Import Data menu
- [ ] T017 Verify all products preserved with `product_name=NULL` and counts match

### Implementation Notes
1. This is a manual/operational work package, not code changes
2. Export path: typically `data/` directory
3. Database path: check app settings or `data/bake_tracker.db`
4. Verification: Compare product counts before/after, spot-check display names

### Parallel Opportunities
- None (sequential process)

### Dependencies
- Depends on WP01-WP04 (all code changes must be complete)

### Risks & Mitigations
- Risk: Data loss during migration
- Mitigation: Keep backup of export JSON; verify counts match exactly

---

## Dependency & Execution Summary

```
WP01 (Model) ─────┬──> WP02 (Service CRUD) ──> WP04 (UI) ──┐
                  │                                         │
                  └──> WP03 (Import/Export) ────────────────┴──> WP05 (Migration)
```

**Sequence**:
1. WP01 - Model changes (foundational)
2. WP02, WP03 - Service changes (can run in parallel after WP01)
3. WP04 - UI changes (after WP02)
4. WP05 - Migration (after all code complete)

**Parallelization**:
- WP02 and WP03 can proceed in parallel once WP01 is complete
- Within WP02: T005 and T006 are parallel-safe
- Within WP03: T007 is parallel-safe with T008-T009

**MVP Scope**: WP01 + WP02 + WP04 deliver User Story 1 (core add/edit functionality)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Add product_name column to model | WP01 | P1 | No |
| T002 | Add UniqueConstraint | WP01 | P1 | No |
| T003 | Update display_name property | WP01 | P1 | No |
| T004 | Add empty string normalization | WP01 | P1 | No |
| T005 | Update create_product() | WP02 | P1 | Yes |
| T006 | Update update_product() | WP02 | P1 | Yes |
| T007 | Add product_name to export | WP03 | P2 | Yes |
| T008 | Update import lookup | WP03 | P2 | No |
| T009 | Handle backward compatibility | WP03 | P2 | No |
| T010 | Add UI field | WP04 | P1 | No |
| T011 | Update _populate_form() | WP04 | P1 | No |
| T012 | Update _save() | WP04 | P1 | No |
| T013 | Add validation and help text | WP04 | P1 | No |
| T014 | Export current data | WP05 | P1 | No |
| T015 | Delete and recreate database | WP05 | P1 | No |
| T016 | Import data | WP05 | P1 | No |
| T017 | Verify migration success | WP05 | P1 | No |
