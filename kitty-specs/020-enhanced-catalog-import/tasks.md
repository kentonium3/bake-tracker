# Work Packages: Enhanced Catalog Import

**Inputs**: Design documents from `kitty-specs/020-enhanced-catalog-import/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, quickstart.md

**Tests**: Service layer tests required per Constitution Principle IV (>70% coverage).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/planned/` generated by `/spec-kitty.tasks`.

---

## Work Package WP01: Service Foundation - Result Class & Ingredient Import (Priority: P1)

**Goal**: Create `CatalogImportResult` class and implement `import_ingredients()` with ADD_ONLY mode. This is the foundation all other work packages build upon.
**Independent Test**: Run ingredient import via direct function call; verify ingredients created, existing skipped, result counts accurate.
**Prompt**: `tasks/planned/WP01-service-foundation-ingredient-import.md`

### Included Subtasks
- [X] T001 Create `src/services/catalog_import_service.py` with module docstring and imports
- [X] T002 Implement `CatalogImportResult` class with per-entity tracking
- [X] T003 Implement `import_ingredients()` function with ADD_ONLY mode
- [X] T004 Implement inline FK/unique validation for ingredients
- [X] T005 Create `src/tests/test_catalog_import_service.py` with ingredient tests
- [X] T006 [P] Test: `test_import_ingredients_add_mode` - new ingredients created
- [X] T007 [P] Test: `test_import_ingredients_skip_existing` - existing slugs skipped

### Implementation Notes
1. Follow `ImportResult` pattern from `import_export_service.py`
2. Use `session=None` optional parameter pattern per CLAUDE.md
3. Unique key for ingredients: `slug`
4. Process in order: query existing, skip or create, track counts

### Parallel Opportunities
- T006 and T007 test implementations can proceed in parallel once T005 establishes test file

### Dependencies
- None (starting package)

### Risks & Mitigations
- Session detachment: Follow `session=None` pattern exactly as documented in CLAUDE.md

---

## Work Package WP02: Product Import (Priority: P1)

**Goal**: Implement `import_products()` with FK validation for ingredient references.
**Independent Test**: Import products with valid/invalid ingredient_slug; verify FK errors reported, valid products created.
**Prompt**: `tasks/planned/WP02-product-import.md`

### Included Subtasks
- [X] T008 Implement `import_products()` function with ADD_ONLY mode
- [X] T009 Implement ingredient_slug FK validation (lookup by slug)
- [X] T010 Handle composite unique key: (ingredient_id, brand)
- [X] T011 [P] Test: `test_import_products_add_mode` - new products created
- [X] T012 [P] Test: `test_import_products_fk_validation` - missing ingredient fails

### Implementation Notes
1. Lookup ingredient by slug before creating product
2. Composite unique key means checking both ingredient_id AND brand
3. Add actionable error messages: "Product 'X' references missing ingredient: 'Y'"

### Parallel Opportunities
- T011 and T012 can proceed in parallel

### Dependencies
- Depends on WP01 (CatalogImportResult class, service file structure)

### Risks & Mitigations
- Brand can be null - handle None brand in uniqueness check

---

## Work Package WP03: Recipe Import with FK Validation (Priority: P1)

**Goal**: Implement `import_recipes()` with FK validation for ingredients and component recipes, plus circular reference detection.
**Independent Test**: Import recipes with valid/invalid refs; verify FK errors and collision errors reported with full detail.
**Prompt**: `tasks/planned/WP03-recipe-import.md`

### Included Subtasks
- [X] T013 Implement `import_recipes()` function with ADD_ONLY mode
- [X] T014 Implement ingredient_slug FK validation for RecipeIngredient
- [X] T015 Implement recipe_name FK validation for RecipeComponent
- [X] T016 Implement circular reference detection for nested recipes
- [X] T017 Implement name collision detection with detailed error message
- [X] T018 [P] Test: `test_import_recipes_add_mode` - new recipes created
- [X] T019 [P] Test: `test_import_recipes_fk_validation` - missing ingredient fails
- [X] T020 [P] Test: `test_import_recipes_collision` - existing name rejected with detail
- [X] T021 Test: `test_import_recipes_circular_detection` - circular refs detected

### Implementation Notes
1. Unique key for recipes: `name` (not slug - matches model)
2. Create Recipe, then RecipeIngredients, then RecipeComponents
3. Collision error must include: existing recipe name, yield info vs import recipe info
4. Circular detection: build graph of recipe->component relationships, detect cycles

### Parallel Opportunities
- T018, T019, T020 can proceed in parallel

### Dependencies
- Depends on WP01 (CatalogImportResult, service structure)

### Risks & Mitigations
- Recipe model uses `name` not `slug` - spec references slug but model uses name. Use `name` consistently.

---

## Work Package WP04: AUGMENT Mode (Priority: P2)

**Goal**: Add AUGMENT mode to ingredient and product import; reject AUGMENT for recipes.
**Independent Test**: Augment existing ingredient with null density; verify only null fields updated, non-null preserved.
**Prompt**: `tasks/planned/WP04-augment-mode.md`

### Included Subtasks
- [X] T022 Add mode parameter to `import_ingredients()` with AUGMENT logic
- [X] T023 Implement protected vs augmentable field handling for ingredients
- [X] T024 Add mode parameter to `import_products()` with AUGMENT logic
- [X] T025 Implement protected vs augmentable field handling for products
- [X] T026 Add AUGMENT rejection to `import_recipes()` with clear error
- [X] T027 [P] Test: `test_import_ingredients_augment_mode` - null fields updated
- [X] T028 [P] Test: `test_import_ingredients_augment_preserves_existing` - non-null unchanged
- [X] T029 [P] Test: `test_import_products_augment_mode`
- [X] T030 Test: `test_import_recipes_augment_rejected` - AUGMENT mode returns error

### Implementation Notes
1. Protected ingredient fields: `slug`, `display_name`
2. Augmentable ingredient fields: density_*, foodon_id, fdc_ids, allergens, description (if null)
3. Protected product fields: `ingredient_slug`, `brand`
4. Augmentable product fields: upc_code, package_size, is_preferred (if null)
5. Use conditional UPDATE: `WHERE field IS NULL`

### Parallel Opportunities
- T027, T028, T029 can proceed in parallel

### Dependencies
- Depends on WP01, WP02, WP03 (entity import functions exist)

### Risks & Mitigations
- Must not overwrite user data - verify with explicit test that non-null values preserved

---

## Work Package WP05: Coordinator and Dry-Run (Priority: P2)

**Goal**: Implement `import_catalog()` coordinator, `validate_catalog_file()`, and dry-run mode.
**Independent Test**: Run dry-run on catalog file; verify no database changes but accurate preview returned.
**Prompt**: `tasks/planned/WP05-coordinator-and-dry-run.md`

### Included Subtasks
- [X] T031 Implement `validate_catalog_file()` with format detection
- [X] T032 Implement `import_catalog()` coordinator function
- [X] T033 Process entities in dependency order: ingredients -> products -> recipes
- [X] T034 Implement entity filter parameter (process only specified types)
- [X] T035 Implement dry-run mode: validate all, rollback changes
- [X] T036 [P] Test: `test_validate_catalog_file_format_detection`
- [X] T037 [P] Test: `test_import_catalog_dependency_order`
- [X] T038 Test: `test_dry_run_no_commit` - database unchanged after dry-run
- [X] T039 Test: `test_partial_success` - valid records committed, failures reported

### Implementation Notes
1. Format detection: `catalog_version` -> catalog import, `version: "3.x"` -> error with guidance
2. Dependency order ensures FK refs exist when needed
3. Dry-run: use session.rollback() before return
4. Merge results from entity-specific functions

### Parallel Opportunities
- T036 and T037 can proceed in parallel

### Dependencies
- Depends on WP01-WP04 (all entity import functions)

### Risks & Mitigations
- Dry-run must perfectly match actual run - verify counts equal

---

## Work Package WP06: CLI Implementation (Priority: P2)

**Goal**: Create CLI entry point with all required flags: --mode, --entity, --dry-run, --verbose.
**Independent Test**: Run `python -m src.utils.import_catalog --help`; verify all options documented. Import test file via CLI.
**Prompt**: `tasks/planned/WP06-cli-implementation.md`

### Included Subtasks
- [X] T040 Create `src/utils/import_catalog.py` with argparse setup
- [X] T041 Implement --mode flag (add/augment)
- [X] T042 Implement --entity flag (ingredients/products/recipes, repeatable)
- [X] T043 Implement --dry-run flag
- [X] T044 Implement --verbose flag for detailed output
- [X] T045 Implement exit codes: 0=success, 1=partial, 2=failure, 3=invalid args
- [X] T046 Format and print CatalogImportResult summary
- [X] T047 [P] Test: `test_cli_add_mode` - full CLI flow
- [X] T048 [P] Test: `test_cli_dry_run` - preview output
- [X] T049 Test: `test_cli_verbose` - detailed output

### Implementation Notes
1. Follow pattern from `import_export_cli.py`
2. Entry point: `if __name__ == "__main__": main()`
3. Use sys.exit() with appropriate exit codes
4. Verbose mode: print each record decision

### Parallel Opportunities
- T047, T048 can proceed in parallel

### Dependencies
- Depends on WP05 (coordinator function exists)

### Risks & Mitigations
- Exit code consistency - document in help text

---

## Work Package WP07: UI Dialog (Priority: P3)

**Goal**: Create CatalogImportDialog and wire to File menu with all UI behaviors.
**Independent Test**: Open app, File > Import Catalog..., complete import workflow via UI.
**Prompt**: `tasks/planned/WP07-ui-dialog.md`

### Included Subtasks
- [X] T050 Create `src/ui/catalog_import_dialog.py` based on ImportDialog pattern
- [X] T051 Implement file picker filtered to .json
- [X] T052 Implement mode radio buttons (Add Only / Augment)
- [X] T053 Implement entity checkboxes (Ingredients / Products / Recipes)
- [X] T054 Disable Augment radio when Recipes checkbox selected
- [X] T055 Implement dry-run checkbox with "Preview..." button label
- [X] T056 Implement import execution and progress indication
- [X] T057 Create results summary dialog with counts per entity
- [X] T058 Add expandable Details section for errors
- [X] T059 Modify `src/ui/main_window.py` to add "Import Catalog..." menu item
- [X] T060 Wire menu item to open CatalogImportDialog
- [X] T061 Refresh affected tabs after successful import

### Implementation Notes
1. Follow `ImportDialog` class structure from `import_export_dialog.py`
2. Modal behavior: `transient()`, `grab_set()`
3. Menu item placement: after separator, before existing Import/Export
4. Refresh: call refresh methods on Ingredients and Recipes tabs if they exist

### Parallel Opportunities
- T050-T058 (dialog creation) independent of T059-T061 (menu wiring)

### Dependencies
- Depends on WP05 (coordinator and dry-run)

### Risks & Mitigations
- UI testing is manual - document test steps in prompt

---

## Work Package WP08: Integration and Polish (Priority: P3)

**Goal**: End-to-end validation, error message refinement, documentation updates.
**Independent Test**: Import the 160-ingredient catalog file successfully; verify all success criteria met.
**Prompt**: `tasks/planned/WP08-integration-and-polish.md`

### Included Subtasks
- [X] T062 End-to-end test: Import 160-ingredient catalog via CLI
- [X] T063 End-to-end test: Import via UI
- [X] T064 Verify SC-010: Import completes in under 30 seconds
- [X] T065 Review and refine error message wording
- [X] T066 Verify existing unified import/export unchanged (SC-006)
- [X] T067 Update quickstart.md with final verified commands
- [X] T068 Run test coverage report, ensure >70% on service layer

### Implementation Notes
1. Use `test_data/baking_ingredients_v33.json` for 160-ingredient test
2. Time the import, log result
3. Regression test: run existing import_export tests to verify no breakage

### Parallel Opportunities
- T062 and T063 can proceed in parallel
- T065 and T067 can proceed in parallel

### Dependencies
- Depends on all previous work packages (WP01-WP07)

### Risks & Mitigations
- Performance: if >30s, add batch processing (unlikely for 160 records)

---

## Dependency & Execution Summary

```
WP01 (Service Foundation) ──┬──> WP02 (Product Import)
                            │
                            ├──> WP03 (Recipe Import)
                            │
                            └──> WP04 (AUGMENT Mode) ──┐
                                                       │
WP02 + WP03 + WP04 ────────────────────────────────────┴──> WP05 (Coordinator)
                                                               │
                                                               ├──> WP06 (CLI)
                                                               │
                                                               └──> WP07 (UI)
                                                                      │
WP06 + WP07 ─────────────────────────────────────────────────────────┴──> WP08 (Polish)
```

**Sequence**: WP01 → WP02 + WP03 (parallel) → WP04 → WP05 → WP06 + WP07 (parallel) → WP08

**MVP Scope**: WP01 + WP05 + WP06 delivers User Story 1 (CLI import of ingredients).

---

## Subtask Index (Reference)

| Subtask | Summary | WP | Priority | Parallel? |
|---------|---------|-----|----------|-----------|
| T001 | Create catalog_import_service.py | WP01 | P1 | No |
| T002 | Implement CatalogImportResult | WP01 | P1 | No |
| T003 | Implement import_ingredients() ADD_ONLY | WP01 | P1 | No |
| T004 | Implement ingredient validation | WP01 | P1 | No |
| T005 | Create test file | WP01 | P1 | No |
| T006 | Test: add mode | WP01 | P1 | Yes |
| T007 | Test: skip existing | WP01 | P1 | Yes |
| T008 | Implement import_products() | WP02 | P1 | No |
| T009 | Implement ingredient_slug FK validation | WP02 | P1 | No |
| T010 | Handle composite unique key | WP02 | P1 | No |
| T011 | Test: product add mode | WP02 | P1 | Yes |
| T012 | Test: product FK validation | WP02 | P1 | Yes |
| T013 | Implement import_recipes() | WP03 | P1 | No |
| T014 | Validate RecipeIngredient FKs | WP03 | P1 | No |
| T015 | Validate RecipeComponent FKs | WP03 | P1 | No |
| T016 | Circular reference detection | WP03 | P1 | No |
| T017 | Name collision detection | WP03 | P1 | No |
| T018 | Test: recipe add mode | WP03 | P1 | Yes |
| T019 | Test: recipe FK validation | WP03 | P1 | Yes |
| T020 | Test: recipe collision | WP03 | P1 | Yes |
| T021 | Test: circular detection | WP03 | P1 | No |
| T022 | Add AUGMENT to ingredients | WP04 | P2 | No |
| T023 | Protected vs augmentable (ingredients) | WP04 | P2 | No |
| T024 | Add AUGMENT to products | WP04 | P2 | No |
| T025 | Protected vs augmentable (products) | WP04 | P2 | No |
| T026 | Reject AUGMENT for recipes | WP04 | P2 | No |
| T027 | Test: ingredient augment | WP04 | P2 | Yes |
| T028 | Test: augment preserves | WP04 | P2 | Yes |
| T029 | Test: product augment | WP04 | P2 | Yes |
| T030 | Test: recipe augment rejected | WP04 | P2 | No |
| T031 | Implement validate_catalog_file() | WP05 | P2 | No |
| T032 | Implement import_catalog() | WP05 | P2 | No |
| T033 | Dependency order processing | WP05 | P2 | No |
| T034 | Entity filter parameter | WP05 | P2 | No |
| T035 | Implement dry-run mode | WP05 | P2 | No |
| T036 | Test: format detection | WP05 | P2 | Yes |
| T037 | Test: dependency order | WP05 | P2 | Yes |
| T038 | Test: dry-run no commit | WP05 | P2 | No |
| T039 | Test: partial success | WP05 | P2 | No |
| T040 | Create import_catalog.py CLI | WP06 | P2 | No |
| T041 | Implement --mode flag | WP06 | P2 | No |
| T042 | Implement --entity flag | WP06 | P2 | No |
| T043 | Implement --dry-run flag | WP06 | P2 | No |
| T044 | Implement --verbose flag | WP06 | P2 | No |
| T045 | Implement exit codes | WP06 | P2 | No |
| T046 | Format result summary | WP06 | P2 | No |
| T047 | Test: CLI add mode | WP06 | P2 | Yes |
| T048 | Test: CLI dry-run | WP06 | P2 | Yes |
| T049 | Test: CLI verbose | WP06 | P2 | No |
| T050 | Create CatalogImportDialog | WP07 | P3 | No |
| T051 | File picker | WP07 | P3 | No |
| T052 | Mode radio buttons | WP07 | P3 | No |
| T053 | Entity checkboxes | WP07 | P3 | No |
| T054 | Disable Augment when Recipes selected | WP07 | P3 | No |
| T055 | Dry-run checkbox | WP07 | P3 | No |
| T056 | Import execution | WP07 | P3 | No |
| T057 | Results summary dialog | WP07 | P3 | No |
| T058 | Expandable Details section | WP07 | P3 | No |
| T059 | Modify main_window.py | WP07 | P3 | No |
| T060 | Wire menu item | WP07 | P3 | No |
| T061 | Refresh tabs after import | WP07 | P3 | No |
| T062 | E2E: 160-ingredient CLI | WP08 | P3 | Yes |
| T063 | E2E: UI import | WP08 | P3 | Yes |
| T064 | Verify performance | WP08 | P3 | No |
| T065 | Refine error messages | WP08 | P3 | Yes |
| T066 | Verify unified import unchanged | WP08 | P3 | No |
| T067 | Update quickstart.md | WP08 | P3 | Yes |
| T068 | Coverage report | WP08 | P3 | No |
