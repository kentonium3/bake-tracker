# Work Packages: Materials Purchase Integration & Workflows

**Feature**: 059-materials-purchase-integration
**Inputs**: Design documents from `/kitty-specs/059-materials-purchase-integration/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: Only include explicit testing work when stakeholders request it.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Service Layer - Provisional Product Support (Priority: P0)

**Goal**: Add provisional product lifecycle support to MaterialCatalogService.
**Independent Test**: Provisional products can be created, checked for completeness, and auto-promoted on enrichment.
**Prompt**: `tasks/WP01-provisional-product-support.md`

### Included Subtasks
- [x] T001 Verify is_provisional column exists in MaterialProduct model (add if missing)
- [x] T002 Update create_product() to accept is_provisional parameter
- [x] T003 Add check_provisional_completeness() method to MaterialCatalogService
- [x] T004 Update update_product() to auto-clear is_provisional when completeness criteria met
- [x] T005 Write unit tests for provisional product lifecycle

### Implementation Notes
- Completeness requires: name, brand, slug, package_quantity, package_unit, material_id (per clarification)
- Follow existing session pattern (session=None parameter)
- Reference: `src/services/material_catalog_service.py`

### Parallel Opportunities
- T001 can be verified independently
- T005 (tests) can be written in parallel with implementation

### Dependencies
- None (foundation work package)

### Risks & Mitigations
- Schema change risk: Verify is_provisional exists before assuming; add migration if needed

---

## Work Package WP02: Service Layer - Inventory Adjustment (Priority: P0)

**Goal**: Add manual inventory adjustment method to MaterialInventoryService.
**Independent Test**: Inventory items can be adjusted (both "each" and "variable" materials) with validation and notes.
**Prompt**: `tasks/WP02-inventory-adjustment-service.md`

### Included Subtasks
- [x] T006 Add adjust_inventory() method signature with session pattern
- [x] T007 Implement "each" materials adjustment (direct quantity update via Add/Subtract/Set)
- [x] T008 Implement "variable" materials adjustment (percentage-based calculation)
- [x] T009 Add notes field support for adjustment reason tracking
- [x] T010 Write unit tests for adjustment scenarios (happy path, edge cases, validation)

### Implementation Notes
- Per clarification: Update existing lot's quantity_remaining directly (no new lot creation)
- Validation: new_quantity >= 0 (prevent negative)
- Reference: `src/services/material_inventory_service.py`

### Parallel Opportunities
- T007 and T008 can be implemented in parallel (different code paths)
- T010 (tests) can be written in parallel with implementation

### Dependencies
- None (foundation work package, parallel to WP01)

### Risks & Mitigations
- FIFO ordering: Ensure adjustment doesn't break FIFO consumption logic (it shouldn't - only updates quantity)

---

## Work Package WP03: Purchase Form - Product Type Selector (Priority: P1) MVP

**Goal**: Extend AddPurchaseDialog with product type selector and material-specific fields.
**Independent Test**: User can switch between Food/Material and see appropriate fields; material purchases create correct records.
**Prompt**: `tasks/WP03-purchase-form-product-type.md`

### Included Subtasks
- [x] T011 Add product type radio buttons (Food/Material) at top of form
- [x] T012 Implement field group show/hide logic (_on_product_type_change handler)
- [x] T013 Create material-specific field widgets (MaterialProduct dropdown, package qty fields)
- [x] T014 Implement real-time calculation for total units and unit cost (trace handlers)
- [x] T015 Wire up validation for material fields (product selected, qty > 0, cost >= 0)
- [x] T016 Connect to MaterialPurchaseService.record_purchase() on save
- [x] T017 Add clearing of type-specific fields when switching product type

### Implementation Notes
- Follow existing form patterns from research.md
- Use CTkRadioButton for product type, CTkComboBox for MaterialProduct dropdown
- Real-time calculations via StringVar.trace_add()
- Reference: `src/ui/dialogs/add_purchase_dialog.py`

### Parallel Opportunities
- T013 (widgets) and T014 (calculations) can be developed in parallel

### Dependencies
- Depends on WP01 (provisional support needed for future inline creation)

### Risks & Mitigations
- Form complexity: Clear visual grouping, complete hide of irrelevant fields
- User confusion on switch: Clear fields when changing type

---

## Work Package WP04: Material Inventory Display (Priority: P1) MVP

**Goal**: Add Materials section/tab to purchases_tab.py showing MaterialInventoryItem lots.
**Independent Test**: User can view material inventory with sorting, filtering, and proper empty state.
**Prompt**: `tasks/WP04-material-inventory-display.md`

### Included Subtasks
- [x] T018 Add Materials tab/section structure to purchases_tab.py
- [x] T019 Create ttk.Treeview with required columns (Product, Brand, Date, Qty Purchased, Qty Remaining, Cost/Unit, Value, Actions)
- [x] T020 Implement column sorting (click header to sort, toggle direction)
- [x] T021 [P] Add cascading filters (MaterialProduct dropdown, date range, show depleted checkbox)
- [x] T022 [P] Implement item count display (status label)
- [x] T023 Add empty state message ("No material inventory items...")
- [x] T024 Wire up data loading from MaterialInventoryService.list_inventory_items()

### Implementation Notes
- Follow inventory_tab.py patterns from research.md
- Sort by purchased_at DESC by default (newest first for visibility)
- Use re-entry guard pattern for filter cascading
- Reference: `src/ui/tabs/purchases_tab.py`, `src/ui/inventory_tab.py`

### Parallel Opportunities
- T021 (filters) and T022 (count display) can proceed in parallel
- Entire WP can parallelize with WP03 and WP05

### Dependencies
- Depends on WP02 (needs list_inventory_items service method)

### Risks & Mitigations
- Performance with large datasets: ttk.Treeview handles this well
- FIFO confusion: Label clearly "Sorted by date (newest first)"

---

## Work Package WP05: Manual Adjustment Dialog (Priority: P1)

**Goal**: Create MaterialAdjustmentDialog for manual inventory adjustments.
**Independent Test**: User can adjust "each" and "variable" materials with live preview and validation.
**Prompt**: `tasks/WP05-adjustment-dialog.md`

### Included Subtasks
- [x] T025 Create MaterialAdjustmentDialog class (CTkToplevel with modal setup)
- [x] T026 Implement "each" materials UI (Add/Subtract/Set radio buttons + integer input)
- [x] T027 Implement "variable" materials UI (percentage input 0-100)
- [x] T028 Add live preview calculation (color-coded: gray/green/red)
- [x] T029 Add notes field (optional, records adjustment reason)
- [x] T030 Wire to MaterialInventoryService.adjust_inventory() on save
- [x] T031 Handle validation (non-negative result, valid percentage)

### Implementation Notes
- Follow CTkToplevel dialog patterns from research.md
- Modal setup order: transient → grab_set → wait_visibility → focus_force
- Center on parent window
- Reference: `src/ui/dialogs/` (new file: material_adjustment_dialog.py)

### Parallel Opportunities
- T026 ("each" UI) and T027 ("variable" UI) can be implemented in parallel
- Entire WP can parallelize with WP03 and WP04

### Dependencies
- Depends on WP02 (needs adjust_inventory service method)

### Risks & Mitigations
- Wrong adjustment type: Detect material base_unit_type and show appropriate UI

---

## Work Package WP06: CLI Material Purchase Extension (Priority: P2)

**Goal**: Add material purchase command to CLI with provisional product creation.
**Independent Test**: CLI can record material purchases, creating provisional products when needed.
**Prompt**: `tasks/WP06-cli-material-purchase.md`

### Included Subtasks
- [x] T032 Add "purchase-material" subcommand to argparse in import_export_cli.py
- [x] T033 Implement product lookup (find existing MaterialProduct by name/slug)
- [x] T034 Implement provisional product creation prompt (material type selection, minimal fields)
- [x] T035 Wire to MaterialPurchaseService.record_purchase() for purchase recording
- [x] T036 Format success/error output (with inventory confirmation)

### Implementation Notes
- Follow existing CLI patterns from research.md
- Use CLIFKResolver-style interactive prompts
- Accept: --product (existing), --name (new provisional), --qty, --cost, --material-type
- Reference: `src/utils/import_export_cli.py`

### Parallel Opportunities
- Can parallelize with WP07 after Wave 1 completes

### Dependencies
- Depends on WP01 (provisional product support)

### Risks & Mitigations
- User error on material type: Show clear numbered list with unit types

---

## Work Package WP07: Provisional Product UI Indicators (Priority: P2)

**Goal**: Add provisional product indicators to MaterialProductsTab and enrichment workflow.
**Independent Test**: Provisional products display indicator; editing clears flag when complete.
**Prompt**: `tasks/WP07-provisional-indicators.md`

### Included Subtasks
- [ ] T037 Add provisional indicator to MaterialProductsTab table (icon or badge column)
- [ ] T038 Show "Needs enrichment" visual indicator for is_provisional=True products
- [ ] T039 Update product edit dialog to track completeness during editing
- [ ] T040 Auto-clear is_provisional flag on save when completeness criteria met

### Implementation Notes
- Follow existing indicator patterns (e.g., hidden products styling)
- Completeness check uses check_provisional_completeness() from WP01
- Reference: `src/ui/materials_tab.py` (MaterialProductsTab section)

### Parallel Opportunities
- Can parallelize with WP06 after Wave 1 completes

### Dependencies
- Depends on WP01 (check_provisional_completeness method)

### Risks & Mitigations
- Indicator visibility: Make prominent with color or icon, not subtle

---

## Work Package WP08: MaterialUnit UI Enhancement (Priority: P3)

**Goal**: Enhance MaterialUnitFormDialog to display inherited unit type and preview.
**Independent Test**: Unit type displays when Material selected; "each" materials lock quantity to 1.
**Prompt**: `tasks/WP08-material-unit-enhancement.md`

### Included Subtasks
- [ ] T041 Add unit type display label (shows base_unit_type inherited from Material)
- [ ] T042 Make quantity field label dynamic (e.g., "Quantity per unit (in linear_cm):")
- [ ] T043 Add preview text for consumption (e.g., "This unit will consume 15 cm of Red Ribbon")
- [ ] T044 Lock quantity to 1 for "each" materials (disable entry, set value)
- [ ] T045 Update _on_material_selected() handler to trigger all above changes

### Implementation Notes
- Gap identified in research.md: base_unit_type loaded but not displayed
- Material data already available in self._materials dict
- Reference: `src/ui/materials_tab.py` (MaterialUnitFormDialog, lines 1304-1562)

### Parallel Opportunities
- All subtasks depend on T045 handler changes (mostly sequential)

### Dependencies
- None (UI-only changes to existing dialog)

### Risks & Mitigations
- Layout space: Unit type and preview may need dialog resize

---

## Work Package WP09: Integration & Polish (Priority: P3)

**Goal**: End-to-end validation and final polish across all components.
**Independent Test**: Full workflow scenarios pass; edge cases handled; UI consistent.
**Prompt**: `tasks/WP09-integration-polish.md`

### Included Subtasks
- [ ] T046 End-to-end test: Purchase → View → Adjust (manual walkthrough)
- [ ] T047 End-to-end test: CLI provisional → UI enrichment
- [ ] T048 Verify FIFO display order consistency (newest first in UI)
- [ ] T049 Edge case testing (empty states, validation errors, large quantities)
- [ ] T050 Code review and cleanup (remove debug code, consistent formatting)

### Implementation Notes
- Manual testing scenarios from spec.md acceptance criteria
- Verify all FR-001 through FR-022 are satisfied

### Parallel Opportunities
- T046 and T047 can run in parallel

### Dependencies
- Depends on all previous work packages (WP01-WP08)

### Risks & Mitigations
- Integration issues: Run after each wave merge, not just at end

---

## Dependency & Execution Summary

**Sequence**:
```
Foundation (parallel):
  WP01 (Provisional Support) ─┬─→ Wave 1
  WP02 (Adjustment Service)  ─┘

Wave 1 (parallel after Foundation):
  WP03 (Purchase Form)      ─┬─→ Wave 2
  WP04 (Inventory Display)  ─┤
  WP05 (Adjustment Dialog)  ─┘

Wave 2 (parallel after Wave 1):
  WP06 (CLI Extension)      ─┬─→ WP09
  WP07 (Provisional UI)     ─┤
  WP08 (MaterialUnit UI)    ─┘

Final:
  WP09 (Integration & Polish)
```

**Parallelization**:
- Foundation: WP01 and WP02 can run in parallel
- Wave 1: WP03, WP04, WP05 can all run in parallel (different files)
- Wave 2: WP06, WP07, WP08 can all run in parallel (different files)

**MVP Scope**: WP01 + WP02 + WP03 + WP04 + WP05 (User Stories 1, 2, 3)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Verify is_provisional column exists | WP01 | P0 | No |
| T002 | Update create_product() for is_provisional | WP01 | P0 | No |
| T003 | Add check_provisional_completeness() | WP01 | P0 | No |
| T004 | Auto-clear is_provisional on enrichment | WP01 | P0 | No |
| T005 | Tests for provisional lifecycle | WP01 | P0 | Yes |
| T006 | Add adjust_inventory() method signature | WP02 | P0 | No |
| T007 | Implement "each" materials adjustment | WP02 | P0 | Yes |
| T008 | Implement "variable" materials adjustment | WP02 | P0 | Yes |
| T009 | Add notes field support | WP02 | P0 | No |
| T010 | Tests for adjustment scenarios | WP02 | P0 | Yes |
| T011 | Add product type radio buttons | WP03 | P1 | No |
| T012 | Implement show/hide field logic | WP03 | P1 | No |
| T013 | Create material-specific widgets | WP03 | P1 | Yes |
| T014 | Implement real-time calculations | WP03 | P1 | Yes |
| T015 | Wire up validation | WP03 | P1 | No |
| T016 | Connect to MaterialPurchaseService | WP03 | P1 | No |
| T017 | Clear fields on type switch | WP03 | P1 | No |
| T018 | Add Materials tab structure | WP04 | P1 | No |
| T019 | Create ttk.Treeview with columns | WP04 | P1 | No |
| T020 | Implement column sorting | WP04 | P1 | No |
| T021 | Add cascading filters | WP04 | P1 | Yes |
| T022 | Implement item count display | WP04 | P1 | Yes |
| T023 | Add empty state message | WP04 | P1 | No |
| T024 | Wire up data loading | WP04 | P1 | No |
| T025 | Create MaterialAdjustmentDialog class | WP05 | P1 | No |
| T026 | Implement "each" materials UI | WP05 | P1 | Yes |
| T027 | Implement "variable" materials UI | WP05 | P1 | Yes |
| T028 | Add live preview calculation | WP05 | P1 | No |
| T029 | Add notes field | WP05 | P1 | No |
| T030 | Wire to adjust_inventory service | WP05 | P1 | No |
| T031 | Handle validation | WP05 | P1 | No |
| T032 | Add purchase-material subcommand | WP06 | P2 | No |
| T033 | Implement product lookup | WP06 | P2 | No |
| T034 | Implement provisional creation prompt | WP06 | P2 | No |
| T035 | Wire to MaterialPurchaseService | WP06 | P2 | No |
| T036 | Format success/error output | WP06 | P2 | No |
| T037 | Add provisional indicator to table | WP07 | P2 | No |
| T038 | Show "Needs enrichment" badge | WP07 | P2 | No |
| T039 | Update edit dialog for completeness | WP07 | P2 | No |
| T040 | Auto-clear is_provisional on save | WP07 | P2 | No |
| T041 | Add unit type display label | WP08 | P3 | No |
| T042 | Make quantity label dynamic | WP08 | P3 | No |
| T043 | Add preview text for consumption | WP08 | P3 | No |
| T044 | Lock quantity to 1 for "each" materials | WP08 | P3 | No |
| T045 | Update _on_material_selected handler | WP08 | P3 | No |
| T046 | E2E test: Purchase → View → Adjust | WP09 | P3 | Yes |
| T047 | E2E test: CLI provisional → UI enrichment | WP09 | P3 | Yes |
| T048 | Verify FIFO display order | WP09 | P3 | No |
| T049 | Edge case testing | WP09 | P3 | No |
| T050 | Code review and cleanup | WP09 | P3 | No |
