# Work Packages: Variant-Aware Shopping List Recommendations

**Inputs**: Design documents from `kitty-specs/007-variant-aware-shopping/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, quickstart.md

**Tests**: Unit and integration tests are included per constitution requirement (>70% service coverage).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/planned/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: VariantService Recommendation Engine (Priority: P0) ✅ COMPLETE

**Goal**: Implement the core variant recommendation logic in VariantService that calculates cost-per-unit, minimum packages, and total cost for ingredient shortfalls.
**Independent Test**: Unit tests pass for `get_variant_recommendation()` with preferred, multiple, and no-variant scenarios.
**Prompt**: `tasks/done/WP01-variant-service-recommendations.md`

### Included Subtasks
- [x] T001 Implement `_calculate_variant_cost()` helper in `src/services/variant_service.py`
- [x] T002 Implement `get_variant_recommendation()` method in `src/services/variant_service.py`
- [x] T003 Handle edge cases: no variants, no purchase history (FR-003, FR-010)
- [x] T004 [P] Unit tests in `src/tests/services/test_variant_service.py` (15 tests pass)

### Implementation Notes
1. `_calculate_variant_cost(variant, shortfall, recipe_unit)`:
   - Get `cost_per_purchase_unit` from `variant.get_current_cost_per_unit()`
   - Convert shortfall from recipe_unit to purchase_unit using `unit_converter.convert_any_units()`
   - Calculate `min_packages = ceil(shortfall_in_purchase_units / variant.purchase_quantity)`
   - Calculate `total_cost = min_packages * variant.purchase_quantity * cost_per_purchase_unit`
   - Calculate `cost_per_recipe_unit` using unit conversion
   - Handle "Cost unknown" when no purchase history exists

2. `get_variant_recommendation(ingredient_slug, shortfall, recipe_unit)`:
   - Use existing `get_preferred_variant()` and `get_variants_for_ingredient()`
   - Return `variant_status`: 'preferred' | 'multiple' | 'none'
   - Return `variant_recommendation` (single) and `all_variants` (list)

### Parallel Opportunities
- T004 (tests) can be written in parallel with T001-T003 using TDD approach.

### Dependencies
- None (foundational work package).

### Risks & Mitigations
- Unit conversion failures: Return "Unit conversion unavailable" message per spec edge case.
- Division by zero: Guard against zero package_quantity.

---

## Work Package WP02: EventService Shopping List Integration (Priority: P1) MVP ✅ COMPLETE

**Goal**: Extend `get_shopping_list()` to include variant recommendations and calculate total estimated cost.
**Independent Test**: Integration test verifies shopping list returns variant data and correct total cost.
**Prompt**: `tasks/done/WP02-event-service-integration.md`

### Included Subtasks
- [x] T005 Modify `get_shopping_list()` in `src/services/event_service.py` to call VariantService
- [x] T006 Calculate and return `total_estimated_cost` across all items (FR-007)
- [x] T007 [P] Integration tests in `src/tests/services/test_event_service_variants.py` (5 tests)

### Implementation Notes
1. For each item in shopping list with shortfall > 0:
   - Call `VariantService.get_variant_recommendation(ingredient_slug, shortfall, unit)`
   - Add `variant_status`, `variant_recommendation`, `all_variants` to item dict
2. Calculate `total_estimated_cost`:
   - Sum `variant_recommendation.total_cost` for items where status='preferred'
   - For status='multiple', exclude from total (user hasn't chosen)
3. Return structure matches data-model.md ShoppingListItem extension.

### Parallel Opportunities
- T007 (tests) can proceed alongside T005-T006.

### Dependencies
- Depends on WP01 (VariantService methods must exist).

### Risks & Mitigations
- Performance: Shopping list may now make N variant queries. If slow, consider batch query optimization (future enhancement).
- Existing tests: FR-009 requires existing shopping list tests continue to pass.

---

## Work Package WP03: Shopping List UI Enhancement (Priority: P2) ✅ COMPLETE

**Goal**: Add variant recommendation columns to the shopping list table and handle multiple variant display.
**Independent Test**: Visual verification shows variant columns, preferred indicators, and stacked rows for multiple variants.
**Prompt**: `tasks/done/WP03-shopping-list-ui.md`

### Included Subtasks
- [x] T008 Add columns to shopping list table: Variant, Package Size, Cost/Unit, Est. Cost
- [x] T009 Handle vertically stacked rows for `variant_status='multiple'` (FR-002)
- [x] T010 Display "[preferred]" indicator for preferred variants (FR-001)
- [x] T011 Display "No variant configured" for `variant_status='none'` (FR-003)
- [x] T012 Display total estimated cost at bottom of shopping list (FR-007)

### Implementation Notes
1. Extend existing table in `src/ui/event_planning_tab.py`:
   - New columns: Variant, Package Size, Cost/Unit, Est. Cost
   - Column widths need tuning for readability
2. Row rendering logic:
   - Single row for 'preferred' status with all fields populated
   - Multiple rows for 'multiple' status, one per variant, under same ingredient
   - Single row for 'none' status with "No variant configured" text
3. Total cost display:
   - Add summary row or label at bottom showing total estimated cost
   - Format as currency with 2 decimal places

### Parallel Opportunities
- T008-T012 must be sequential (building on same UI component).

### Dependencies
- Depends on WP02 (shopping list data must include variant fields).

### Risks & Mitigations
- Table width: Adding columns may cause horizontal scrolling. Consider abbreviations or tooltips.
- Performance (SC-005): Shopping list must still load in <2 seconds with new columns.

---

## Work Package WP04: Validation and Polish (Priority: P3)

**Goal**: End-to-end validation against all acceptance criteria and polish.
**Independent Test**: All acceptance scenarios from spec.md pass manual testing.
**Prompt**: `tasks/planned/WP04-validation-polish.md`

### Included Subtasks
- [ ] T013 Validate all acceptance scenarios from User Stories 1-4
- [ ] T014 [P] Verify edge cases: zero shortfall, significant overbuy, unit conversion failure
- [ ] T015 [P] Run full test suite and verify >70% service coverage
- [ ] T016 Code formatting (black) and linting (flake8, mypy)

### Implementation Notes
1. Manual validation checklist:
   - US1: Preferred variant shown with package context
   - US2: Multiple variants listed when no preferred
   - US3: Total estimated cost calculates correctly
   - US4: "No variant configured" displays gracefully
2. Edge case verification:
   - Zero shortfall: "Sufficient stock" message
   - Overbuy scenario: 1 package shown even if wasteful
   - Unit conversion failure: Warning message displayed

### Parallel Opportunities
- T014, T015, T016 can run in parallel.

### Dependencies
- Depends on WP01, WP02, WP03 (all implementation complete).

### Risks & Mitigations
- Regression: Ensure Feature 006 shopping list functionality preserved.

---

## Dependency & Execution Summary

```
WP01 (VariantService) ─────► WP02 (EventService) ─────► WP03 (UI) ─────► WP04 (Polish)
     [Foundational]              [MVP Core]           [Display]        [Validation]
```

- **Sequence**: WP01 → WP02 → WP03 → WP04
- **Parallelization**: Within each WP, test subtasks can run alongside implementation.
- **MVP Scope**: WP01 + WP02 deliver functional backend; WP03 makes it user-visible.

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Implement `_calculate_variant_cost()` helper | WP01 | P0 | No |
| T002 | Implement `get_variant_recommendation()` method | WP01 | P0 | No |
| T003 | Handle no-variant and no-purchase-history cases | WP01 | P0 | No |
| T004 | Unit tests for VariantService recommendations | WP01 | P0 | Yes |
| T005 | Modify `get_shopping_list()` for variant data | WP02 | P1 | No |
| T006 | Calculate total_estimated_cost | WP02 | P1 | No |
| T007 | Integration tests for shopping list | WP02 | P1 | Yes |
| T008 | Add variant columns to UI table | WP03 | P2 | No |
| T009 | Handle stacked rows for multiple variants | WP03 | P2 | No |
| T010 | Display "[preferred]" indicator | WP03 | P2 | No |
| T011 | Display "No variant configured" fallback | WP03 | P2 | No |
| T012 | Display total estimated cost in UI | WP03 | P2 | No |
| T013 | Validate acceptance scenarios | WP04 | P3 | No |
| T014 | Verify edge cases | WP04 | P3 | Yes |
| T015 | Run full test suite, verify coverage | WP04 | P3 | Yes |
| T016 | Code formatting and linting | WP04 | P3 | Yes |
