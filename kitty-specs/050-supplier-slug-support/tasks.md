# Work Packages: Supplier Slug Support

**Inputs**: Design documents from `/kitty-specs/050-supplier-slug-support/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: Testing tasks included per TDD principle in constitution (>70% service layer coverage).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Model & Slug Generation Foundation (Priority: P0)

**Goal**: Add slug field to Supplier model and create slug generation function.
**Independent Test**: Unit tests pass for slug generation with various inputs (Unicode, conflicts, physical vs online).
**Prompt**: `tasks/WP01-model-slug-generation.md`

### Included Subtasks
- [x] T001 Add `slug` field to Supplier model in `src/models/supplier.py` (String(100), unique, indexed, non-nullable)
- [x] T002 Add unique index `idx_supplier_slug` to `__table_args__`
- [x] T003 Create `generate_supplier_slug()` function in `src/services/supplier_service.py`
- [x] T004 [P] Generalize `create_slug()` in `src/utils/slug_utils.py` to accept model class parameter
- [x] T005 [P] Write unit tests for supplier slug generation in `src/tests/test_supplier_service.py`
- [x] T006 Update `to_dict()` method in Supplier model to include slug field

### Implementation Notes
- Physical suppliers: input = `{name} {city} {state}`
- Online suppliers: input = `{name}` only
- Use existing `create_slug()` algorithm from slug_utils.py
- Conflict resolution: `_1`, `_2`, `_3` suffixes (matching existing pattern)

### Parallel Opportunities
- T004 (utility generalization) and T005 (tests) can proceed in parallel
- T001/T002 (model) must complete before T003 (service function)

### Dependencies
- None (starting package)

### Risks & Mitigations
- Risk: Circular import when generalizing create_slug → Use late binding/function parameter
- Risk: Conflict resolution differs from spec (_1 vs _2) → Clarified: use existing _1 pattern

---

## Work Package WP02: Supplier Service Slug Integration (Priority: P0)

**Goal**: Integrate slug generation into supplier CRUD operations and migrate existing data.
**Independent Test**: Create supplier via service, verify slug is generated. Run migration, verify all existing suppliers have slugs.
**Prompt**: `tasks/WP02-supplier-service-integration.md`

### Included Subtasks
- [x] T007 Update `create_supplier()` in `src/services/supplier_service.py` to generate slug on creation
- [x] T008 Create `migrate_supplier_slugs()` function for existing suppliers
- [x] T009 Add validation to reject suppliers without slugs
- [x] T010 [P] Write tests for supplier creation with auto-slug generation
- [x] T011 [P] Write tests for migration function (idempotent, conflict resolution)
- [x] T012 Handle malformed slug regeneration per clarification (enforce consistency)

### Implementation Notes
- Migration must be idempotent (re-running preserves existing valid slugs - NO, per clarification: regenerate all to enforce consistency)
- Clarification update: ALL slugs regenerated to match standard pattern, not preserved
- Session management: pass session to slug generation for uniqueness checking

### Parallel Opportunities
- T010 and T011 (tests) can proceed in parallel after T007/T008 complete

### Dependencies
- Depends on WP01 (model and slug generation function)

### Risks & Mitigations
- Risk: Session detachment during migration → Use single session for entire migration batch
- Risk: Duplicate slug during migration → Use conflict resolution with incrementing suffix

---

## Work Package WP03: Export Service Updates (Priority: P1)

**Goal**: Update export to include supplier slugs and product supplier references.
**Independent Test**: Export suppliers, verify JSON contains slug field. Export products, verify preferred_supplier_slug included.
**Prompt**: `tasks/WP03-export-service-updates.md`

### Included Subtasks
- [x] T013 Update supplier export in `src/services/import_export_service.py` to include slug field
- [x] T014 Update product export to include `preferred_supplier_slug` field
- [x] T015 Update product export to include `preferred_supplier_name` field (human-readable)
- [x] T016 [P] Write tests for supplier export with slug
- [x] T017 [P] Write tests for product export with supplier slug reference

### Implementation Notes
- Supplier export: Add slug to serialization
- Product export: Look up supplier by preferred_supplier_id, include both slug and name
- Handle products with no preferred supplier (null fields)

### Parallel Opportunities
- T016 and T017 (tests) can proceed in parallel
- T013 (supplier export) and T014/T015 (product export) can proceed in parallel

### Dependencies
- Depends on WP01 (slug field exists in model)

### Risks & Mitigations
- Risk: Products reference deleted/inactive suppliers → Include slug from relationship even if inactive

---

## Work Package WP04: Import Service Updates (Priority: P1)

**Goal**: Update import to match suppliers by slug and resolve product supplier references.
**Independent Test**: Import suppliers with slugs, verify matched/created correctly. Import products with supplier_slug, verify FK resolved.
**Prompt**: `tasks/WP04-import-service-updates.md`

### Included Subtasks
- [x] T018 Update `_find_existing_by_slug()` in `src/services/enhanced_import_service.py` to handle suppliers
- [x] T019 Update `_resolve_fk_by_slug()` to resolve supplier references by slug
- [x] T020 Update `fk_resolver_service.py` to collect supplier slugs (not names)
- [x] T021 Implement merge mode (update explicit fields only) for existing suppliers
- [x] T022 Implement skip mode (add new only) for supplier import
- [x] T023 Add backward compatibility for legacy files (preferred_supplier_id fallback)
- [x] T024 Add warning logging for unresolved supplier slugs
- [x] T025 [P] Write tests for slug-based supplier import (new, existing, merge, skip)
- [x] T026 [P] Write tests for product import with supplier slug resolution
- [x] T027 [P] Write tests for legacy backward compatibility

### Implementation Notes
- Import resolution order: slug (primary) → id (fallback for legacy)
- Merge mode: only update fields explicitly present in import record
- Log warning but don't fail import when supplier slug not found
- Session management critical: pass session through all FK resolution

### Parallel Opportunities
- T025, T026, T027 (tests) can proceed in parallel
- T018/T019/T020 (FK resolution) vs T021/T022 (import modes) can proceed in parallel

### Dependencies
- Depends on WP01 (model), WP03 (export format finalized)

### Risks & Mitigations
- Risk: Legacy files have ID that doesn't exist in new DB → Log warning, leave FK null
- Risk: Session detachment in nested FK resolution → Pass session explicitly

---

## Work Package WP05: Slug Immutability & Validation (Priority: P2)

**Goal**: Prevent slug modification after creation to preserve data integrity.
**Independent Test**: Attempt to modify supplier slug via service, verify rejected. Update supplier name, verify slug unchanged.
**Prompt**: `tasks/WP05-slug-immutability.md`

### Included Subtasks
- [x] T028 Update `update_supplier()` in supplier_service.py to reject slug changes
- [x] T029 Ensure slug is preserved when supplier name/location changes
- [x] T030 Add appropriate error message for slug modification attempts
- [x] T031 [P] Write tests for slug immutability enforcement

### Implementation Notes
- Check if incoming data contains 'slug' key and it differs from existing
- Raise ValueError or custom exception for slug modification attempts
- Slug should not appear in update forms (UI consideration, not in scope)

### Parallel Opportunities
- T031 (tests) can proceed after T028-T030 complete

### Dependencies
- Depends on WP02 (supplier service integration)

### Risks & Mitigations
- Risk: Admin override needed for slug correction → Out of scope for this feature; document in future enhancements

---

## Work Package WP06: Dry-Run, Test Data & Polish (Priority: P3)

**Goal**: Add dry-run import preview and update test data files.
**Independent Test**: Run import with dry_run=True, verify preview returned and no DB changes. Load test_data/suppliers.json, verify all have slugs.
**Prompt**: `tasks/WP06-dry-run-polish.md`

### Included Subtasks
- [x] T032 Add `dry_run` parameter to supplier import function
- [x] T033 Return preview stats (new count, existing count, error count) in dry-run mode
- [x] T034 Ensure no database changes occur in dry-run mode
- [x] T035 Update `test_data/suppliers.json` with slug field for all suppliers
- [x] T036 Update `test_data/sample_data_all.json` if it contains suppliers
- [x] T037 [P] Write tests for dry-run import mode
- [x] T038 [P] Verify round-trip test: export → fresh DB → import → verify associations

### Implementation Notes
- Dry-run: use transaction rollback or separate preview logic
- Test data: generate slugs using same algorithm as production
- Round-trip test validates entire feature integration

### Parallel Opportunities
- T035/T036 (test data) can proceed in parallel with T032-T034 (dry-run)
- T037 and T038 (tests) can proceed in parallel

### Dependencies
- Depends on WP01-WP04 (core functionality complete)

### Risks & Mitigations
- Risk: Dry-run implementation complexity → Consider simpler preview-only approach without full transaction simulation

---

## Dependency & Execution Summary

```
WP01 (Model/Slug) ─────┬──> WP02 (Service Integration) ──> WP05 (Immutability)
                       │
                       └──> WP03 (Export) ──┬──> WP04 (Import)
                                            │
                                            └──> WP06 (Dry-Run/Polish)
```

- **Sequence**: WP01 → WP02/WP03 (parallel) → WP04 → WP05 → WP06
- **Parallelization**:
  - WP02 and WP03 can proceed in parallel after WP01
  - Within packages, tests can run parallel to implementation
  - Gemini agent can handle WP03 while Claude handles WP01/WP02
- **MVP Scope**: WP01 + WP02 + WP03 + WP04 = Core slug functionality for import/export

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Add slug field to Supplier model | WP01 | P0 | No |
| T002 | Add unique index for slug | WP01 | P0 | No |
| T003 | Create generate_supplier_slug() | WP01 | P0 | No |
| T004 | Generalize create_slug() utility | WP01 | P0 | Yes |
| T005 | Unit tests for slug generation | WP01 | P0 | Yes |
| T006 | Update to_dict() for slug | WP01 | P0 | No |
| T007 | Integrate slug in create_supplier() | WP02 | P0 | No |
| T008 | Create migrate_supplier_slugs() | WP02 | P0 | No |
| T009 | Add validation for slug required | WP02 | P0 | No |
| T010 | Tests for auto-slug creation | WP02 | P0 | Yes |
| T011 | Tests for migration function | WP02 | P0 | Yes |
| T012 | Handle malformed slug regeneration | WP02 | P0 | No |
| T013 | Update supplier export with slug | WP03 | P1 | No |
| T014 | Add preferred_supplier_slug to product export | WP03 | P1 | No |
| T015 | Add preferred_supplier_name to product export | WP03 | P1 | No |
| T016 | Tests for supplier export | WP03 | P1 | Yes |
| T017 | Tests for product export | WP03 | P1 | Yes |
| T018 | Update _find_existing_by_slug() | WP04 | P1 | No |
| T019 | Update _resolve_fk_by_slug() | WP04 | P1 | No |
| T020 | Update fk_resolver_service.py | WP04 | P1 | No |
| T021 | Implement merge mode | WP04 | P1 | No |
| T022 | Implement skip mode | WP04 | P1 | No |
| T023 | Backward compatibility (ID fallback) | WP04 | P1 | No |
| T024 | Warning logging for unresolved slugs | WP04 | P1 | No |
| T025 | Tests for slug-based supplier import | WP04 | P1 | Yes |
| T026 | Tests for product import | WP04 | P1 | Yes |
| T027 | Tests for legacy backward compatibility | WP04 | P1 | Yes |
| T028 | Reject slug changes in update | WP05 | P2 | No |
| T029 | Preserve slug on name/location change | WP05 | P2 | No |
| T030 | Error message for slug modification | WP05 | P2 | No |
| T031 | Tests for immutability | WP05 | P2 | Yes |
| T032 | Add dry_run parameter | WP06 | P3 | No |
| T033 | Return preview stats | WP06 | P3 | No |
| T034 | Ensure no DB changes in dry-run | WP06 | P3 | No |
| T035 | Update test_data/suppliers.json | WP06 | P3 | Yes |
| T036 | Update sample_data_all.json | WP06 | P3 | Yes |
| T037 | Tests for dry-run mode | WP06 | P3 | Yes |
| T038 | Round-trip integration test | WP06 | P3 | Yes |
