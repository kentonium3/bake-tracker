# Work Packages: Batch Calculation & User Decisions

**Inputs**: Design documents from `/kitty-specs/073-batch-calculation-user-decisions/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, quickstart.md

**Tests**: Included per constitution requirement (TDD for service layer, >70% coverage).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Foundation Fixes (Priority: P0)

**Goal**: Fix F072 API to return FU-level data and update BatchDecision schema constraint.
**Independent Test**: F072 tests pass with new return type; BatchDecision accepts multiple FUs from same recipe per event.
**Prompt**: `tasks/WP01-foundation-fixes.md`
**Estimated Size**: ~450 lines

### Included Subtasks
- [x] T001 Add `FURequirement` dataclass to `src/services/planning_service.py`
- [x] T002 Rename `calculate_recipe_requirements()` → `decompose_event_to_fu_requirements()`
- [x] T003 Modify `_decompose_fg_to_recipes()` → `_decompose_fg_to_fus()` to return FU-level data
- [x] T004 Remove recipe-level aggregation from decomposition logic
- [x] T005 Update all 22 F072 tests in `src/tests/test_planning_service.py` for new return type
- [x] T006 Modify `BatchDecision` model - change `finished_unit_id` to NOT NULL
- [x] T007 Update UniqueConstraint from `(event_id, recipe_id)` to `(event_id, finished_unit_id)`
- [x] T008 Verify constraint changes with fresh database creation

### Implementation Notes
- F072 API change is breaking but no production code uses it yet (only tests)
- Schema change follows Constitution VI (export/reset/import) - but batch_decisions table is likely empty
- Run `pytest src/tests/test_planning_service.py -v` to verify all 22 tests pass

### Parallel Opportunities
- T001-T004 (API changes) must be sequential
- T005 (test updates) can proceed after T004
- T006-T008 (schema changes) can run in parallel with T001-T005

### Dependencies
- None (starting package)

### Risks & Mitigations
- Risk: Existing batch_decisions data → Check table is empty before schema change
- Risk: Test assertion changes miss edge cases → Carefully review each test's intent

---

## Work Package WP02: Batch Calculation Service (Priority: P1)

**Goal**: Implement batch calculation logic that uses F072 output to generate floor/ceil options.
**Independent Test**: `calculate_batch_options(event_id)` returns correct options with shortfall flags and exact match detection.
**Prompt**: `tasks/WP02-batch-calculation-service.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [x] T009 Add `BatchOption` dataclass to `src/services/planning_service.py`
- [x] T010 Add `BatchOptionsResult` dataclass for per-FU results
- [x] T011 Implement `calculate_batch_options_for_fu()` - floor/ceil calculation
- [x] T012 Implement `calculate_batch_options()` - event-level using F072 output
- [x] T013 Handle edge cases: zero yield, zero quantity, floor=0
- [x] T014 Write tests in `src/tests/test_batch_calculation.py`

### Implementation Notes
- Use `math.floor()` and `math.ceil()` on `FinishedUnit.calculate_batches_needed()` result
- Handle both YieldMode.DISCRETE_COUNT and YieldMode.BATCH_PORTION
- Return empty list for FUs with invalid yield configuration

### Parallel Opportunities
- T009, T010 (dataclasses) can be done together
- T011, T012 must be sequential
- T014 (tests) can be written alongside T011-T012

### Dependencies
- Depends on WP01 (F072 API must return FU-level data)

### Risks & Mitigations
- Risk: BATCH_PORTION mode calculation differs from DISCRETE_COUNT → Test both modes explicitly
- Risk: Rounding edge cases (e.g., quantity exactly divisible) → Include exact match tests

---

## Work Package WP03: Batch Decision CRUD Service (Priority: P1)

**Goal**: Implement persistence layer for batch decisions with validation.
**Independent Test**: CRUD operations work correctly; shortfall validation enforced.
**Prompt**: `tasks/WP03-batch-decision-crud-service.md`
**Estimated Size**: ~380 lines

### Included Subtasks
- [x] T015 Create `src/services/batch_decision_service.py` module with imports
- [x] T016 Implement `save_batch_decision()` with validation
- [x] T017 Implement `get_batch_decisions(event_id)` - returns all for event
- [x] T018 Implement `get_batch_decision(event_id, finished_unit_id)` - single lookup
- [x] T019 Implement `delete_batch_decisions(event_id)` - clear all for event
- [x] T020 Add shortfall confirmation validation in save logic
- [x] T021 Write tests in `src/tests/test_batch_decision_service.py`

### Implementation Notes
- Follow patterns from `event_service.py` (validate parent entity, accept session parameter)
- Shortfall validation: if `is_shortfall=True`, require `confirmed_shortfall=True`
- Use replace pattern: delete existing + insert new for save_all operations

### Parallel Opportunities
- T015 must be first
- T016-T020 can proceed in parallel after T015
- T021 (tests) should be written alongside each function

### Dependencies
- Depends on WP01 (BatchDecision schema change)

### Risks & Mitigations
- Risk: Session management issues → Follow CLAUDE.md session patterns
- Risk: Orphaned decisions after FG removal → CASCADE delete handles this

---

## Work Package WP04: UI Widget - BatchOptionsFrame (Priority: P2)

**Goal**: Create the UI widget for displaying and selecting batch options.
**Independent Test**: Widget displays options correctly with shortfall warnings and exact match highlights.
**Prompt**: `tasks/WP04-ui-widget-batch-options-frame.md`
**Estimated Size**: ~420 lines

### Included Subtasks
- [x] T022 Create `src/ui/widgets/batch_options_frame.py` module
- [x] T023 Implement `BatchOptionsFrame` class structure with constructor
- [x] T024 Implement `populate(options_results)` to display all FUs
- [x] T025 Implement `_create_fu_section(result)` for individual FU display
- [x] T026 Implement radio button selection with shortfall visual indicator
- [x] T027 Implement exact match highlighting
- [x] T028 Implement `_format_option_text(option, unit)` for display formatting
- [x] T029 Add selection change callback and `get_selections()` method

### Implementation Notes
- Follow CTkRadioButton pattern from `finished_good_form.py:182-209`
- Use StringVar per FU for radio button grouping
- Shortfall indicator: red text or warning icon
- Exact match indicator: green text or checkmark

### Parallel Opportunities
- T022-T023 must be first
- T024-T028 can proceed somewhat in parallel (different methods)
- T029 integrates the others

### Dependencies
- Depends on WP02 (BatchOptionsResult dataclass)

### Risks & Mitigations
- Risk: UI styling inconsistent → Use existing CTk patterns from codebase
- Risk: Performance with many FUs → Lazy loading if >50 FUs (unlikely)

---

## Work Package WP05: Integration with Planning Tab (Priority: P2)

**Goal**: Wire up the complete flow: load options → user selection → shortfall confirmation → save.
**Independent Test**: End-to-end flow works: select event → see batch options → make selections → save → reload shows selections.
**Prompt**: `tasks/WP05-integration-planning-tab.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [ ] T030 Add BatchOptionsFrame instance to `src/ui/planning_tab.py` layout
- [ ] T031 Implement `_load_batch_options()` when event is selected
- [ ] T032 Implement shortfall confirmation dialog flow using `show_confirmation()`
- [ ] T033 Implement `_save_batch_decisions()` on user action
- [ ] T034 Implement load existing decisions on event open (pre-select radio buttons)
- [ ] T035 Wire up modification flow (change existing decision triggers re-save)
- [ ] T036 End-to-end manual testing and validation

### Implementation Notes
- BatchOptionsFrame should appear after FG quantities section
- Use existing `show_confirmation()` from `src/ui/widgets/dialogs.py`
- Save button or auto-save on selection change (follow existing patterns)
- Load decisions via `get_batch_decisions()` and pre-select matching options

### Parallel Opportunities
- T030 must be first
- T031-T035 have some dependencies but can overlap
- T036 is final validation

### Dependencies
- Depends on WP03 (CRUD service)
- Depends on WP04 (UI widget)

### Risks & Mitigations
- Risk: State synchronization issues → Clear state on event change
- Risk: Save on every selection change could be slow → Debounce or explicit save button

---

## Dependency & Execution Summary

```
WP01 (Foundation) ──┬──→ WP02 (Batch Calc) ──┐
                    │                         │
                    └──→ WP03 (CRUD Service) ─┼──→ WP05 (Integration)
                                              │
                         WP04 (UI Widget) ────┘
```

- **Sequence**: WP01 → (WP02, WP03 parallel possible) → WP04 → WP05
- **Parallelization**: WP02 and WP03 could run in parallel after WP01 (different files)
- **MVP Scope**: WP01-WP03 deliver core backend functionality; WP04-WP05 complete UI

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Add FURequirement dataclass | WP01 | P0 | No |
| T002 | Rename calculate_recipe_requirements | WP01 | P0 | No |
| T003 | Modify decomposition to return FU-level | WP01 | P0 | No |
| T004 | Remove recipe-level aggregation | WP01 | P0 | No |
| T005 | Update 22 F072 tests | WP01 | P0 | Yes (after T004) |
| T006 | BatchDecision finished_unit_id NOT NULL | WP01 | P0 | Yes |
| T007 | Update UniqueConstraint | WP01 | P0 | Yes |
| T008 | Verify constraint with fresh DB | WP01 | P0 | No |
| T009 | Add BatchOption dataclass | WP02 | P1 | Yes |
| T010 | Add BatchOptionsResult dataclass | WP02 | P1 | Yes |
| T011 | Implement calculate_batch_options_for_fu | WP02 | P1 | No |
| T012 | Implement calculate_batch_options | WP02 | P1 | No |
| T013 | Handle edge cases | WP02 | P1 | No |
| T014 | Write batch calculation tests | WP02 | P1 | Yes |
| T015 | Create batch_decision_service.py | WP03 | P1 | No |
| T016 | Implement save_batch_decision | WP03 | P1 | Yes |
| T017 | Implement get_batch_decisions | WP03 | P1 | Yes |
| T018 | Implement get_batch_decision single | WP03 | P1 | Yes |
| T019 | Implement delete_batch_decisions | WP03 | P1 | Yes |
| T020 | Add shortfall confirmation validation | WP03 | P1 | No |
| T021 | Write CRUD tests | WP03 | P1 | Yes |
| T022 | Create batch_options_frame.py | WP04 | P2 | No |
| T023 | Implement BatchOptionsFrame class | WP04 | P2 | No |
| T024 | Implement populate() | WP04 | P2 | No |
| T025 | Implement _create_fu_section | WP04 | P2 | Yes |
| T026 | Implement radio button selection | WP04 | P2 | Yes |
| T027 | Implement exact match highlighting | WP04 | P2 | Yes |
| T028 | Implement _format_option_text | WP04 | P2 | Yes |
| T029 | Add selection callback and get_selections | WP04 | P2 | No |
| T030 | Add BatchOptionsFrame to planning_tab | WP05 | P2 | No |
| T031 | Implement _load_batch_options | WP05 | P2 | No |
| T032 | Implement shortfall confirmation dialog | WP05 | P2 | No |
| T033 | Implement _save_batch_decisions | WP05 | P2 | No |
| T034 | Implement load existing decisions | WP05 | P2 | No |
| T035 | Wire up modification flow | WP05 | P2 | No |
| T036 | End-to-end testing | WP05 | P2 | No |
