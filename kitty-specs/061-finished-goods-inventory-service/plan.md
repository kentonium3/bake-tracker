# Implementation Plan: Finished Goods Inventory Service

**Branch**: `061-finished-goods-inventory-service` | **Date**: 2026-01-21 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/kitty-specs/061-finished-goods-inventory-service/spec.md`

## Summary

Add a session-aware service layer for finished goods inventory management. The service provides primitives for inventory queries, availability validation, and tracked adjustments. Production and assembly services will be updated to use these primitives. Model business logic methods will be removed and replaced with service calls. A new `FinishedGoodsAdjustment` table provides an audit trail for all inventory changes.

## Technical Context

**Language/Version**: Python 3.10+
**Primary Dependencies**: SQLAlchemy 2.x, CustomTkinter (UI deferred)
**Storage**: SQLite with WAL mode
**Testing**: pytest with >70% service coverage target
**Target Platform**: Desktop (Windows/macOS/Linux)
**Project Type**: Single desktop application
**Performance Goals**: N/A (single-user desktop app)
**Constraints**: Session ownership per F060; non-negative inventory enforced at DB level
**Scale/Scope**: Single user; dozens of finished units/goods

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. User-Centric Design | ✅ PASS | Service layer prepares for Phase 3 UI; no user impact yet |
| II. Data Integrity & FIFO | ✅ PASS | Non-negative constraints; FIFO not required for finished goods (costs at production time) |
| III. Future-Proof Schema | ✅ PASS | New adjustment table prepares for audit trail; no breaking changes |
| IV. Test-Driven Development | ✅ PASS | Service methods require tests before completion |
| V. Layered Architecture | ✅ PASS | Business logic moves FROM models TO service layer |
| VI. Schema Change Strategy | ✅ PASS | Export/reset/import cycle; new table starts empty |
| VII. Pragmatic Aspiration | ✅ PASS | Clean service layer supports future web migration |

**Web Migration Cost**: LOW - Service layer is UI-independent; future API wrapper straightforward.

## Project Structure

### Documentation (this feature)

```
kitty-specs/061-finished-goods-inventory-service/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 research findings
├── data-model.md        # New model definition
├── quickstart.md        # Developer quick reference
├── checklists/
│   └── requirements.md  # Quality checklist
└── tasks/               # Work packages (generated by /spec-kitty.tasks)
```

### Source Code (repository root)

```
src/
├── models/
│   ├── finished_unit.py           # UPDATE: Add relationship, remove business methods
│   ├── finished_good.py           # UPDATE: Add relationship, remove business methods
│   └── finished_goods_adjustment.py  # NEW: Audit trail model
├── services/
│   ├── finished_goods_inventory_service.py  # NEW: Core service
│   ├── assembly_service.py        # UPDATE: Use inventory service
│   └── batch_production_service.py  # UPDATE: Use inventory service
├── utils/
│   └── constants.py               # UPDATE: Add threshold constant
└── tests/
    └── services/
        └── test_finished_goods_inventory_service.py  # NEW: Service tests
```

**Structure Decision**: Single project layout (existing). New service follows established patterns in `src/services/`.

## Complexity Tracking

*No constitution violations requiring justification.*

## Planning Decisions (Confirmed)

| Question | Decision | Rationale |
|----------|----------|-----------|
| Integration scope | Inventory service AND production/assembly updates in same feature | Complete integration; avoid partial state |
| Model deprecation | Remove methods entirely; update all callers | Cleaner codebase; no confusion |
| Adjustment tracking | New `FinishedGoodsAdjustment` table | Supports future audit UI; queryable history |
| Low stock threshold | `constants.py` (`DEFAULT_LOW_STOCK_THRESHOLD = 5`) | Simple; no runtime config UI needed yet |

## Service Interface Design

### Module: `src/services/finished_goods_inventory_service.py`

```python
# Query Functions
def get_inventory_status(
    item_type: str | None = None,  # "finished_unit" or "finished_good"
    item_id: int | None = None,
    exclude_zero: bool = False,
    session=None
) -> list[dict]:
    """Get inventory status for finished goods."""

def get_low_stock_items(
    threshold: int | None = None,  # Defaults to DEFAULT_LOW_STOCK_THRESHOLD
    item_type: str | None = None,
    session=None
) -> list[dict]:
    """Get items below threshold."""

def get_total_inventory_value(
    session=None
) -> dict:
    """Calculate total value of finished goods inventory."""

# Validation Functions
def check_availability(
    item_type: str,
    item_id: int,
    quantity: int,
    session=None
) -> dict:
    """Check if quantity is available. Returns availability status and shortage if any."""

def validate_consumption(
    item_type: str,
    item_id: int,
    quantity: int,
    session=None
) -> dict:
    """Validate consumption request without modifying. Returns validation result."""

# Mutation Function
def adjust_inventory(
    item_type: str,
    item_id: int,
    quantity: int,  # Positive or negative
    reason: str,
    notes: str | None = None,
    session=None
) -> dict:
    """Adjust inventory and create audit record. Returns adjustment details."""
```

### Return Value Patterns

```python
# get_inventory_status
[
    {
        "item_type": "finished_unit",
        "id": 1,
        "slug": "sugar-cookie",
        "display_name": "Sugar Cookie",
        "inventory_count": 24,
        "current_cost": Decimal("1.50"),
        "total_value": Decimal("36.00")
    },
    ...
]

# check_availability
{
    "available": True,
    "item_type": "finished_unit",
    "item_id": 1,
    "requested": 5,
    "current_count": 24
}
# OR
{
    "available": False,
    "item_type": "finished_unit",
    "item_id": 1,
    "requested": 30,
    "current_count": 24,
    "shortage": 6
}

# adjust_inventory
{
    "success": True,
    "item_type": "finished_unit",
    "item_id": 1,
    "previous_count": 24,
    "new_count": 34,
    "quantity_change": 10,
    "reason": "production",
    "adjustment_id": 42
}
```

## Integration Points

### Assembly Service Updates

**File**: `src/services/assembly_service.py`

Replace direct inventory modifications with service calls:

```python
# BEFORE (direct model modification)
fu.inventory_count -= needed
session.flush()

# AFTER (service call)
finished_goods_inventory_service.adjust_inventory(
    item_type="finished_unit",
    item_id=fu.id,
    quantity=-needed,
    reason="assembly",
    notes=f"Assembly run for {finished_good.display_name}",
    session=session
)
```

### Production Service Updates

**File**: `src/services/batch_production_service.py`

Add inventory update after production completion:

```python
# After production run recorded
finished_goods_inventory_service.adjust_inventory(
    item_type="finished_unit",
    item_id=finished_unit_id,
    quantity=actual_yield,
    reason="production",
    notes=f"Production run #{production_run.id}",
    session=session
)
```

## Implementation Phases

### Phase 1: Foundation
1. Create `FinishedGoodsAdjustment` model
2. Add relationships to `FinishedUnit` and `FinishedGood`
3. Add constants to `constants.py`
4. Create service module skeleton with session pattern

### Phase 2: Core Service
1. Implement `get_inventory_status()`
2. Implement `check_availability()` and `validate_consumption()`
3. Implement `adjust_inventory()` with audit trail
4. Implement `get_low_stock_items()`
5. Implement `get_total_inventory_value()`

### Phase 3: Integration
1. Update assembly service to use inventory primitives
2. Update production service to use inventory primitives
3. Find and update all callers of deprecated model methods

### Phase 4: Cleanup
1. Remove business logic methods from models
2. Update model `__init__.py` exports
3. Verify all tests pass

### Phase 5: Testing & Documentation
1. Unit tests for all service methods
2. Integration tests for assembly flow
3. Integration tests for production flow
4. Export/import round-trip test

## Callers to Find and Update

**Search patterns** (use grep to find all callers):

```bash
# Direct inventory_count modifications
grep -rn "inventory_count\s*[-+]=" src/
grep -rn "\.inventory_count\s*=" src/

# Model method calls
grep -rn "\.is_available(" src/
grep -rn "\.update_inventory(" src/
grep -rn "\.can_assemble(" src/  # May stay on model or move to assembly_service
```

## Test Plan

### Unit Tests (Service Layer)

- `test_get_inventory_status_all_items`
- `test_get_inventory_status_by_type`
- `test_get_inventory_status_by_id`
- `test_get_inventory_status_exclude_zero`
- `test_check_availability_sufficient`
- `test_check_availability_insufficient`
- `test_validate_consumption_valid`
- `test_validate_consumption_invalid`
- `test_adjust_inventory_positive`
- `test_adjust_inventory_negative`
- `test_adjust_inventory_creates_audit_record`
- `test_adjust_inventory_prevents_negative`
- `test_adjust_inventory_with_session`
- `test_adjust_inventory_without_session`
- `test_get_low_stock_items_default_threshold`
- `test_get_low_stock_items_custom_threshold`
- `test_get_low_stock_items_by_type`
- `test_get_total_inventory_value`

### Integration Tests

- `test_assembly_uses_inventory_service`
- `test_assembly_rollback_restores_inventory`
- `test_production_updates_inventory`
- `test_multi_item_assembly_atomic`
- `test_export_includes_inventory_counts`
- `test_import_restores_inventory_counts`

## Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| Unknown callers of deprecated methods | Comprehensive grep search; test coverage |
| Session pattern mistakes | Follow established patterns; atomicity tests |
| Export/import breaks | Inventory already exported; no format changes |
| Production service doesn't update inventory currently | Verify current behavior; add if missing |

## References

- [spec.md](spec.md) - Feature specification
- [research.md](research.md) - Codebase research findings
- [data-model.md](data-model.md) - New model definition
- [quickstart.md](quickstart.md) - Developer quick reference
- `docs/func-spec/F061_finished_goods_inventory.md` - Original functional spec
- `docs/func-spec/F060_architecture_hardening_service_boundaries.md` - Session pattern reference

---

**STOP POINT**: Plan complete. Run `/spec-kitty.tasks` to generate work packages.
