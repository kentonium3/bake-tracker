# Implementation Plan: Purchase Tracking & Enhanced Costing

**Branch**: `028-purchase-tracking-enhanced` | **Date**: 2025-12-22 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/kitty-specs/028-purchase-tracking-enhanced/spec.md`

## Summary

Integrate Purchase entity (created by F027) into the inventory workflow to enable:
1. Supplier selection during inventory addition
2. Price suggestions based on purchase history
3. Accurate FIFO cost calculations using purchase prices
4. Migration of existing InventoryItems to have linked Purchase records

**Key Finding**: F027 has already created the Purchase, Supplier, and InventoryItem.purchase_id infrastructure. F028 focuses on service integration, UI updates, and migration.

## Technical Context

**Language/Version**: Python 3.10+ (minimum for type hints)
**Primary Dependencies**: SQLAlchemy 2.x, CustomTkinter
**Storage**: SQLite with WAL mode
**Testing**: pytest (>70% service layer coverage required)
**Target Platform**: Desktop (macOS/Windows)
**Project Type**: Single desktop application
**Performance Goals**: Price suggestion < 1 second (local SQLite)
**Constraints**: Single user, offline-capable
**Scale/Scope**: ~100-500 products, ~1000 purchases/year

## Planning Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Technical Approach | Re-evaluate fresh | Design doc is reference, not prescription |
| Service Layer | Hybrid | purchase_service.py for queries; inventory_item_service owns Purchase creation |
| UI Integration | Modify in-place | Update existing InventoryItemFormDialog |
| Migration Validation | Post-migration script | Simpler than dry-run for single-user app |

## Constitution Check

*GATE: Verified against `.kittify/memory/constitution.md`*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. User-Centric | PASS | Feature enables price tracking requested by user |
| II. Data Integrity | PASS | Purchase linkage ensures FIFO accuracy |
| III. Future-Proof | PASS | Building on F027's schema investments |
| IV. Layered Architecture | PASS | UI → Services → Models flow maintained |
| V. TDD | PENDING | Tests required during implementation |
| VI. Schema Changes | PASS | Export/reset/import migration pattern |

## Project Structure

### Documentation (this feature)

```
kitty-specs/028-purchase-tracking-enhanced/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 research findings
├── data-model.md        # Entity documentation
├── research/
│   ├── evidence-log.csv # Research audit trail
│   └── source-register.csv
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Generated by /spec-kitty.tasks
```

### Source Code (repository root)

```
src/
├── models/
│   ├── purchase.py          # EXISTS - no changes needed
│   ├── supplier.py          # EXISTS - no changes needed
│   ├── inventory_item.py    # EXISTS - has purchase_id FK
│   └── product.py           # EXISTS - has preferred_supplier_id
├── services/
│   ├── purchase_service.py  # UPDATE - add price suggestion functions
│   ├── supplier_service.py  # EXISTS - no changes needed
│   └── inventory_item_service.py  # UPDATE - integrate Purchase creation
├── ui/
│   └── inventory_tab.py     # UPDATE - add supplier dropdown, price hints
└── tests/
    └── services/
        ├── test_purchase_service.py    # NEW tests
        └── test_inventory_item_service.py  # UPDATE tests
```

**Structure Decision**: Single project desktop app. Existing structure maintained.

## Implementation Approach

### Phase 1: Service Layer Updates

**1.1 purchase_service.py - Add Price Suggestion Functions**

```python
# NEW FUNCTIONS

def get_last_price_at_supplier(
    product_id: int,
    supplier_id: int,
    session: Optional[Session] = None
) -> Optional[Dict[str, Any]]:
    """
    Get last purchase price for product at specific supplier.

    Returns: {unit_price, purchase_date, supplier_id} or None
    """

def get_last_price_any_supplier(
    product_id: int,
    session: Optional[Session] = None
) -> Optional[Dict[str, Any]]:
    """
    Get last purchase price for product at any supplier.
    Fallback when no history at selected supplier.

    Returns: {unit_price, purchase_date, supplier_id, supplier_name} or None
    """
```

**1.2 inventory_item_service.py - Integrate Purchase Creation**

Update `add_to_inventory()` signature:
```python
def add_to_inventory(
    product_id: int,
    quantity: float,
    supplier_id: int,          # NEW - required
    unit_price: Decimal,       # NEW - required
    added_date: Optional[date] = None,
    expiration_date: Optional[date] = None,
    notes: Optional[str] = None,
    session: Optional[Session] = None,
) -> Dict[str, Any]:
    """
    ATOMIC OPERATION:
    1. Create Purchase record
    2. Create InventoryItem with purchase_id
    3. Set InventoryItem.unit_cost from unit_price
    """
```

### Phase 2: UI Updates

**2.1 InventoryItemFormDialog Modifications**

Location: `src/ui/inventory_tab.py`

Changes:
1. Add Supplier dropdown (populated from `get_active_suppliers()`)
2. Add Price entry field with validation
3. Add price hint label (updates on supplier selection)
4. Wire `on_supplier_change` callback to fetch price suggestion

UI Flow:
```
Product:   [Select Product ▼]
Supplier:  [Select Supplier ▼]  ← NEW
Price:     [$______]            ← NEW
           (last paid: $8.99 at Costco on 2025-12-15)  ← Hint
Quantity:  [_______]
Notes:     [_______________________]
[Cancel]                    [Add]
```

### Phase 3: Migration

**3.1 Migration Script** (`src/services/migration/f028_migration.py`)

1. Find "Unknown" supplier (created by F027) or create if missing
2. Query InventoryItems where purchase_id IS NULL
3. For each:
   - Create Purchase record with Unknown supplier
   - Set purchase_date = added_date
   - Set unit_price = unit_cost or 0.00
   - Link InventoryItem.purchase_id
4. Commit transaction

**3.2 Validation Script** (`src/services/migration/f028_validation.py`)

Checks:
- No InventoryItem has NULL purchase_id
- All Purchase.product_id matches linked InventoryItem.product_id
- Record counts match

### Phase 4: Testing

Required test coverage:
- `test_get_last_price_at_supplier()` - with/without history
- `test_get_last_price_any_supplier()` - fallback behavior
- `test_add_to_inventory_creates_purchase()` - atomic creation
- `test_add_to_inventory_sets_unit_cost()` - FIFO field population
- `test_migration_creates_purchases()` - migration script
- `test_migration_validation()` - validation script

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Migration data loss | Export before migration, validation script after |
| Price NULL on existing items | Use 0.00 as fallback, log warnings |
| Unknown supplier missing | Create if not found during migration |

## Dependencies

- **F027 Complete**: Supplier table, Purchase model, InventoryItem.purchase_id FK exist
- **Session Pattern**: All new functions follow `session=None` pattern per CLAUDE.md

## Next Steps

1. Run `/spec-kitty.tasks` to generate work packages
2. Implementation order:
   - Task 1: purchase_service price suggestion functions
   - Task 2: inventory_item_service Purchase integration
   - Task 3: UI dialog modifications
   - Task 4: Migration and validation scripts
   - Task 5: Testing and documentation
