# Work Packages: Purchase Tracking & Enhanced Costing

**Inputs**: Design documents from `/kitty-specs/028-purchase-tracking-enhanced/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: Testing tasks included as project requires >70% service layer coverage.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/planned/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

## Path Conventions
- **Single project**: `src/`, `src/tests/`
- Services: `src/services/`
- Models: `src/models/`
- UI: `src/ui/`

---

## Work Package WP01: Price Suggestion Service Functions (Priority: P0)

**Goal**: Add price suggestion query functions to purchase_service.py enabling price hints in UI.
**Independent Test**: Unit tests pass for both functions with various scenarios (history exists, no history, supplier-specific vs any supplier).
**Prompt**: `tasks/planned/WP01-price-suggestion-functions.md`
**User Stories**: US2 (Price Suggestion) - Foundation

### Included Subtasks
- [x] T001 [P] Implement `get_last_price_at_supplier()` in `src/services/purchase_service.py`
- [x] T002 [P] Implement `get_last_price_any_supplier()` in `src/services/purchase_service.py`
- [x] T003 [P] Write unit tests for price suggestion functions in `src/tests/services/test_purchase_service.py`

### Implementation Notes
- Both functions follow session=None pattern per CLAUDE.md
- Query Purchase table ordered by purchase_date DESC, limit 1
- Return dict with unit_price, purchase_date, supplier_id (and supplier_name for fallback)
- Return None if no purchase history exists

### Parallel Opportunities
- All three subtasks can proceed in parallel (different functions/test file)

### Dependencies
- None (starting package). Relies on existing Purchase model from F027.

### Risks & Mitigations
- Purchase model may have different field names than expected. Mitigation: Verify model structure before implementation.

---

## Work Package WP02: Inventory-Purchase Service Integration (Priority: P0)

**Goal**: Update inventory_item_service.add_to_inventory() to create Purchase records atomically.
**Independent Test**: Adding inventory creates both InventoryItem and Purchase records with correct linkage.
**Prompt**: `tasks/planned/WP02-inventory-purchase-integration.md`
**User Stories**: US1 (Add Inventory with Supplier Selection) - Foundation

### Included Subtasks
- [x] T004 Update `add_to_inventory()` signature with `supplier_id` and `unit_price` params in `src/services/inventory_item_service.py`
- [x] T005 Implement atomic Purchase record creation within `add_to_inventory()`
- [x] T006 Set `InventoryItem.unit_cost` from `Purchase.unit_price` for FIFO
- [x] T007 [P] Write/update tests for `add_to_inventory()` in `src/tests/services/test_inventory_item_service.py`

### Implementation Notes
- Single session transaction: create Purchase, then InventoryItem with purchase_id
- purchase_date defaults to today if not provided
- unit_cost on InventoryItem enables existing FIFO to work without changes
- Must handle both new signature and maintain backward compatibility during migration

### Parallel Opportunities
- T007 (tests) can proceed in parallel with implementation once interface is defined

### Dependencies
- Depends on WP01 for price suggestion functions (UI will use them, but service integration is independent)

### Risks & Mitigations
- Existing callers of add_to_inventory() will break. Mitigation: Update all call sites (UI dialog) in WP03.

---

## Work Package WP03: UI Supplier Dropdown and Price Entry (Priority: P1) MVP

**Goal**: Modify InventoryItemFormDialog with supplier dropdown, price field, and price hints.
**Independent Test**: User can select supplier, see price suggestion, enter price, and successfully add inventory.
**Prompt**: `tasks/planned/WP03-ui-supplier-price-entry.md`
**User Stories**: US1 (Add Inventory with Supplier Selection), US2 (Price Suggestion from Purchase History)

### Included Subtasks
- [x] T008 Add Supplier dropdown populated from `get_active_suppliers()` in `src/ui/inventory_tab.py`
- [x] T009 Add Price entry field with decimal validation in `src/ui/inventory_tab.py`
- [x] T010 Add price hint label (dynamic update) in `src/ui/inventory_tab.py`
- [x] T011 Wire `on_supplier_change` callback to fetch/display price suggestions
- [x] T012 Implement zero-price confirmation warning dialog (FR-007)
- [x] T013 Implement negative price validation error (FR-008)
- [x] T014 Update dialog submission to call updated `add_to_inventory()` with new params

### Implementation Notes
- Supplier dropdown: sorted alphabetically by display_name
- Price hint format: "(last paid: $X.XX on YYYY-MM-DD)" or "(last paid: $X.XX at Supplier on YYYY-MM-DD)" for fallback
- Zero-price: show CTkMessagebox confirmation before proceeding
- Negative price: prevent submission, show inline validation error
- Submission must include supplier_id and unit_price

### Parallel Opportunities
- T012 and T013 (validation dialogs) can be implemented in parallel with main form work

### Dependencies
- Depends on WP01 (price suggestion functions)
- Depends on WP02 (updated add_to_inventory signature)

### Risks & Mitigations
- UI complexity increase. Mitigation: Follow existing CustomTkinter patterns; price hints provide immediate value.

---

## Work Package WP04: Migration and Validation Scripts (Priority: P1)

**Goal**: Create migration script to link existing InventoryItems to Purchase records.
**Independent Test**: Migration runs successfully on test database; validation confirms all items linked.
**Prompt**: `tasks/planned/WP04-migration-validation.md`
**User Stories**: US5 (Data Migration from Existing Inventory)

### Included Subtasks
- [x] T015 Create `src/services/migration/f028_migration.py` script
- [x] T016 Implement find/create "Unknown" supplier logic in migration
- [x] T017 Implement InventoryItem to Purchase linking logic
- [x] T018 Create `src/services/migration/f028_validation.py` script
- [x] T019 [P] Write tests for migration scripts in `src/tests/services/test_f028_migration.py`

### Implementation Notes
- Migration steps:
  1. Find "Unknown" supplier (name='Unknown') or create with defaults
  2. Query InventoryItems where purchase_id IS NULL
  3. For each: create Purchase with Unknown supplier, link via purchase_id
  4. Set unit_cost if NULL (use 0.00 fallback with warning log)
- Validation checks:
  1. No InventoryItem has NULL purchase_id
  2. Purchase.product_id matches InventoryItem.product_id
  3. Record counts match expectations
- Use export/reset/import pattern per Constitution VI

### Parallel Opportunities
- T019 (tests) can proceed in parallel once migration interface is defined

### Dependencies
- Depends on WP02 (Purchase creation logic can inform migration approach)

### Risks & Mitigations
- Data loss during migration. Mitigation: Export before migration, validation after, documented rollback.

---

## Work Package WP05: FIFO Verification and Final Testing (Priority: P2)

**Goal**: Verify FIFO calculations use Purchase.unit_price and run full test suite.
**Independent Test**: FIFO cost calculation produces correct results using purchase prices; all tests pass.
**Prompt**: `tasks/planned/WP05-fifo-verification-testing.md`
**User Stories**: US3 (Accurate FIFO Cost Calculation), US4 (Purchase History Query)

### Included Subtasks
- [x] T020 Verify FIFO in `consume_fifo()` uses `InventoryItem.unit_cost` (populated from Purchase)
- [x] T021 Add integration test for FIFO with purchase-linked inventory
- [x] T022 Verify purchase history query functions work correctly
- [x] T023 Run full test suite and verify all existing tests pass
- [x] T024 Update any broken tests due to signature changes

### Implementation Notes
- FIFO should already work via InventoryItem.unit_cost (set in WP02)
- Verify no code path bypasses Purchase linkage
- Purchase history queries: sorted by date DESC, filterable by supplier
- Run: `pytest src/tests -v --cov=src`

### Parallel Opportunities
- T021 and T022 can proceed in parallel (different test scenarios)

### Dependencies
- Depends on WP02, WP03, WP04 (full system integration required)

### Risks & Mitigations
- Regression from signature changes. Mitigation: Fix any broken tests in T024.

---

## Dependency & Execution Summary

```
WP01 (Price Functions) ──┐
                         ├──> WP03 (UI) ──┐
WP02 (Service Integration)──┘             │
         │                                ├──> WP05 (FIFO & Testing)
         └──> WP04 (Migration) ───────────┘
```

- **Sequence**: WP01 + WP02 (parallel) → WP03 + WP04 (parallel) → WP05
- **Parallelization**: WP01 and WP02 can run concurrently. WP03 and WP04 can run concurrently after prerequisites.
- **MVP Scope**: WP01 + WP02 + WP03 = Minimum viable feature (supplier selection + price suggestions)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | get_last_price_at_supplier() | WP01 | P0 | Yes |
| T002 | get_last_price_any_supplier() | WP01 | P0 | Yes |
| T003 | Tests for price suggestion functions | WP01 | P0 | Yes |
| T004 | Update add_to_inventory() signature | WP02 | P0 | No |
| T005 | Implement atomic Purchase creation | WP02 | P0 | No |
| T006 | Set InventoryItem.unit_cost | WP02 | P0 | No |
| T007 | Tests for add_to_inventory() | WP02 | P0 | Yes |
| T008 | Add Supplier dropdown | WP03 | P1 | No |
| T009 | Add Price entry field | WP03 | P1 | No |
| T010 | Add price hint label | WP03 | P1 | No |
| T011 | Wire on_supplier_change callback | WP03 | P1 | No |
| T012 | Zero-price confirmation dialog | WP03 | P1 | Yes |
| T013 | Negative price validation | WP03 | P1 | Yes |
| T014 | Update dialog submission | WP03 | P1 | No |
| T015 | Create migration script | WP04 | P1 | No |
| T016 | Find/create Unknown supplier | WP04 | P1 | No |
| T017 | Implement linking logic | WP04 | P1 | No |
| T018 | Create validation script | WP04 | P1 | No |
| T019 | Tests for migration | WP04 | P1 | Yes |
| T020 | Verify FIFO uses unit_cost | WP05 | P2 | No |
| T021 | Integration test for FIFO | WP05 | P2 | Yes |
| T022 | Verify purchase history queries | WP05 | P2 | Yes |
| T023 | Run full test suite | WP05 | P2 | No |
| T024 | Fix broken tests | WP05 | P2 | No |
