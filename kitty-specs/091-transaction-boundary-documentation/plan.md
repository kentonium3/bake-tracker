# Implementation Plan: Transaction Boundary Documentation

**Branch**: `091-transaction-boundary-documentation` | **Date**: 2026-02-02 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/kitty-specs/091-transaction-boundary-documentation/spec.md`

## Summary

Add comprehensive transaction boundary documentation to all service functions (~50-60 functions), audit multi-step operations for atomicity, and create a transaction patterns guide. This is primarily a **documentation feature** with potential minor code fixes for session parameter passing.

The feature implements Constitutional Principle VI.C.2 (Transaction Boundaries): "Service methods define transaction scope" and "No silent auto-commits; failures roll back cleanly."

## Technical Context

**Language/Version**: Python 3.10+
**Primary Dependencies**: SQLAlchemy 2.x (ORM), existing session_scope() pattern
**Storage**: SQLite with WAL mode
**Testing**: pytest (docstring verification tests optional)
**Target Platform**: Desktop (Linux/Windows/macOS)
**Project Type**: Single desktop application
**Performance Goals**: N/A (documentation feature)
**Constraints**: Must follow existing session parameter pattern exactly
**Scale/Scope**: ~50-60 service functions to document, ~20 multi-step operations to audit

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| VI.C.1 Session Parameter Pattern | ✅ ALIGNED | Feature documents this pattern, does not change it |
| VI.C.2 Transaction Boundaries | ✅ IMPLEMENTS | Primary deliverable - adds docstring documentation |
| VI.D.1 Method Signatures | ✅ ALIGNED | Adds docstrings per this requirement |
| VI.E.1 Logging Strategy | ✅ SUPPORTS | Transaction boundaries are operation context |
| IV Test-Driven Development | ⚠️ N/A | Documentation feature; no code logic changes |

**Constitution Compliance**: This feature directly implements VI.C.2 requirements. No violations.

## Project Structure

### Documentation (this feature)

```
kitty-specs/091-transaction-boundary-documentation/
├── plan.md              # This file
├── spec.md              # Feature specification
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks/               # Work package prompts (generated by /spec-kitty.tasks)
```

### Source Code (repository root)

```
src/
├── services/                    # Primary target - 65+ service files
│   ├── ingredient_service.py    # Example: CRUD operations
│   ├── recipe_service.py        # Example: Recipe management
│   ├── batch_production_service.py  # Example: Multi-step atomic
│   ├── assembly_service.py      # Example: Multi-step atomic
│   ├── planning/
│   │   └── planning_service.py  # Example: Multi-step atomic
│   └── ...                      # All other service files
└── ...

docs/
├── design/
│   └── transaction_patterns_guide.md  # NEW - Transaction patterns guide
└── ...
```

**Structure Decision**: No changes to source structure. Documentation added inline (docstrings) and as new guide file.

## Implementation Approach

### Three Docstring Templates

Based on func-spec FR-1, use these exact templates consistently:

**Pattern A: Read-Only Operation**
```python
"""
[Function description]

Transaction boundary: Read-only, no transaction needed.
Safe to call without session - uses temporary session for query.

Args:
    ...
    session: Optional session (for composition with other operations)

Returns:
    ...

Raises:
    ...
"""
```

**Pattern B: Single-Step Write**
```python
"""
[Function description]

Transaction boundary: Single operation, automatically atomic.
If session provided, caller controls transaction commit/rollback.
If session not provided, uses session_scope() (auto-commit on success).

Args:
    ...
    session: Optional session for transactional composition

Returns:
    ...

Raises:
    ...
"""
```

**Pattern C: Multi-Step Atomic Operation**
```python
"""
[Function description]

Transaction boundary: ALL operations in single session (atomic).
Atomicity guarantee: Either ALL steps succeed OR entire operation rolls back.
Steps executed atomically:
1. [Step 1 description]
2. [Step 2 description]
3. [Step 3 description]

CRITICAL: All nested service calls receive session parameter to ensure
atomicity. Never create new session_scope() within this function.

Args:
    ...
    session: Optional session for transactional composition

Returns:
    ...

Raises:
    ...
"""
```

### Service File Inventory

From the glob results, there are 65 service-related Python files. Filtering for actual service modules with transaction-relevant functions:

**Core Services (~40 functions estimated)**:
- `ingredient_service.py`, `ingredient_crud_service.py`
- `recipe_service.py`
- `product_service.py`, `product_catalog_service.py`
- `inventory_item_service.py`
- `purchase_service.py`
- `supplier_service.py`
- `event_service.py`
- `recipient_service.py`
- `preferences_service.py`

**Multi-Step Operations (~20 functions estimated)**:
- `batch_production_service.py` - `record_batch_production()` (key example)
- `assembly_service.py` - `record_assembly()` (key example)
- `planning/planning_service.py` - Multi-step planning operations
- `material_consumption_service.py`
- `material_purchase_service.py`
- `finished_good_service.py`
- `import_export_service.py`, `enhanced_import_service.py`
- `transaction_import_service.py`

**Support/Utility (lower priority)**:
- `unit_converter.py`, `unit_service.py`
- `dto_utils.py`, `logging_utils.py`
- `fk_resolver_service.py`
- `schema_validation_service.py`

### Audit Strategy

For multi-step operations:
1. Identify functions calling 2+ other service functions
2. Verify all nested calls pass `session=session`
3. Document transaction scope in docstring
4. Fix any missing session parameter passing

## Work Package Strategy

Given this is primarily documentation:

**WP01: Service Inventory & Classification** (Foundation)
- List all service functions with session parameter
- Classify each as read-only, single-step, or multi-step
- Create tracking spreadsheet for documentation progress

**WP02-WP04: Documentation by Service Group** (Parallel)
- WP02: Core CRUD services (ingredient, recipe, product)
- WP03: Inventory & purchasing services
- WP04: Planning & production services

**WP05: Multi-Step Operation Audit** (Sequential - requires WP02-04)
- Deep dive into multi-step operations
- Verify session passing
- Fix any broken atomicity patterns

**WP06: Transaction Patterns Guide** (Sequential - requires WP05)
- Create docs/design/transaction_patterns_guide.md
- Document three patterns with code examples
- Document common pitfalls

**WP07: Finalization & Code Review Checklist** (Sequential - requires WP06)
- Verify all documentation consistency
- Update code review checklist
- Final review pass

## Complexity Tracking

*Fill ONLY if Constitution Check has violations that must be justified*

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| None | N/A | N/A |

No complexity violations. This is a documentation feature aligned with Constitution VI.C.2.

## Risks

| Risk | Mitigation |
|------|------------|
| Missing some service functions | Systematic grep for `def .*session` and `with session_scope` |
| Inconsistent documentation format | Use exact templates from func-spec FR-1 |
| Documentation becomes stale | Add to code review checklist (FR-009) |
| Broken atomicity patterns found | Fix during WP05 audit (minor code changes) |

## Dependencies

- Existing session parameter pattern (documented in CLAUDE.md)
- Constitution VI.C.2 (Transaction Boundaries)
- func-spec F091 provides detailed implementation guidance

## Success Criteria Reference

From spec.md:
- SC-001: 100% of service functions have "Transaction boundary:" documentation
- SC-002: 100% of multi-step operations pass atomicity audit
- SC-003: Transaction patterns guide exists with all three patterns
- SC-004: Common pitfalls section documents at least 3 anti-patterns
- SC-005: Code review checklist updated
- SC-006: Documentation uses consistent phrasing

---

**Planning Complete**: Ready for `/spec-kitty.tasks` to generate work packages.
