# Work Packages: Materials FIFO Foundation

**Inputs**: Design documents from `/kitty-specs/058-materials-fifo-foundation/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: Unit tests required for service layer (>70% coverage per constitution).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`. Treat this file as the high-level checklist; keep deep implementation detail inside the prompt files.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

## Path Conventions

This is a single desktop application:
- Source: `src/models/`, `src/services/`, `src/ui/`
- Tests: `src/tests/`

---

## Work Package WP01: Schema Changes - MaterialInventoryItem Model (Priority: P0)

**Goal**: Create the MaterialInventoryItem model that parallels InventoryItem for FIFO tracking.
**Independent Test**: Model can be imported and passes basic validation tests.
**Prompt**: `tasks/WP01-material-inventory-item-model.md`
**Agent Assignment**: Claude (core foundation)

### Included Subtasks
- [ ] T001 [P] Create MaterialInventoryItem model in `src/models/material_inventory_item.py`
- [ ] T002 Add MaterialInventoryItem to `src/models/__init__.py` exports
- [ ] T003 Add inventory_items relationship to MaterialProduct model
- [ ] T004 Add inventory_item relationship to MaterialPurchase model (1:1)

### Implementation Notes
- Follow InventoryItem pattern exactly per research.md
- Fields: material_product_id, material_purchase_id, quantity_purchased (immutable), quantity_remaining (mutable), cost_per_unit (immutable), purchase_date, location, notes
- All quantities stored in base units (cm)
- Indexes on material_product_id, purchase_date, material_purchase_id, location

### Parallel Opportunities
- T001 is the foundation; T002-T004 follow sequentially

### Dependencies
- None (starting package)

### Risks & Mitigations
- Relationship naming consistency: follow existing patterns exactly

---

## Work Package WP02: Schema Changes - MaterialProduct Cleanup (Priority: P0)

**Goal**: Remove deprecated cost/inventory fields from MaterialProduct to enforce definition/instantiation separation.
**Independent Test**: MaterialProduct model no longer has current_inventory or weighted_avg_cost fields.
**Prompt**: `tasks/WP02-material-product-cleanup.md`
**Agent Assignment**: Claude (core schema)

### Included Subtasks
- [ ] T005 Remove current_inventory field from MaterialProduct model
- [ ] T006 Remove weighted_avg_cost field from MaterialProduct model
- [ ] T007 Remove inventory_value property from MaterialProduct model
- [ ] T008 Remove related CheckConstraints (ck_material_product_inventory_non_negative, ck_material_product_cost_non_negative)

### Implementation Notes
- This is a BREAKING CHANGE - users must export data before migration
- Constitution requires definition/instantiation separation
- Update to_dict() to remove inventory_value

### Parallel Opportunities
- All subtasks affect same file - must be sequential

### Dependencies
- Depends on WP01 (relationship to inventory_items must exist first)

### Risks & Mitigations
- Data loss: Document that users must export before migration

---

## Work Package WP03: Schema Changes - MaterialConsumption & Material Updates (Priority: P0)

**Goal**: Add FIFO traceability to MaterialConsumption and update Material base_unit_type to metric.
**Independent Test**: MaterialConsumption has inventory_item_id FK; Material uses metric base_unit_type values.
**Prompt**: `tasks/WP03-consumption-material-updates.md`
**Agent Assignment**: Claude (core schema)

### Included Subtasks
- [ ] T009 Add inventory_item_id FK to MaterialConsumption model
- [ ] T010 Add inventory_item relationship to MaterialConsumption
- [ ] T011 Update Material.base_unit_type CHECK constraint to use metric values ('linear_cm', 'square_cm', 'each')

### Implementation Notes
- inventory_item_id is nullable for backward compatibility with existing records
- base_unit_type migration: linear_inchesâ†’linear_cm, square_inchesâ†’square_cm
- Existing data will need migration during reset/re-import

### Parallel Opportunities
- T009-T010 (MaterialConsumption) can proceed in parallel with T011 (Material)

### Dependencies
- Depends on WP01 (MaterialInventoryItem must exist for FK reference)

### Risks & Mitigations
- Migration complexity: Schema change strategy is reset/re-import per constitution

---

## Work Package WP04: Material Unit Converter (Priority: P1)

**Goal**: Create unit converter for materials with metric base units (cm for linear/area).
**Independent Test**: All conversion factors pass unit tests; validation rejects incompatible conversions.
**Prompt**: `tasks/WP04-material-unit-converter.md`
**Agent Assignment**: Gemini (independent module)

### Included Subtasks
- [ ] T012 [P] Create `src/services/material_unit_converter.py` with conversion factor dictionaries
- [ ] T013 [P] Implement `convert_to_base_units()` function
- [ ] T014 [P] Implement `convert_from_base_units()` function
- [ ] T015 [P] Implement `validate_unit_compatibility()` function
- [ ] T016 [P] Create `src/tests/test_material_unit_converter.py` with comprehensive tests

### Implementation Notes
- Linear conversions to cm: feet (Ã—30.48), inches (Ã—2.54), yards (Ã—91.44), meters (Ã—100), mm (Ã—0.1)
- Area conversions to square_cm: square_feet (Ã—929.0304), square_inches (Ã—6.4516), square_meters (Ã—10000)
- Validation must reject cross-type conversions (e.g., feet â†’ square_cm)

### Parallel Opportunities
- T12-T16 can all proceed in parallel (different functions)
- This entire WP is independent of schema work

### Dependencies
- None (independent module)

### Risks & Mitigations
- Precision: Use Decimal for financial calculations, Float for storage per existing patterns

---

## Work Package WP05: MaterialInventoryService Core (Priority: P1) ðŸŽ¯ MVP

**Goal**: Create the service layer for material inventory FIFO operations.
**Independent Test**: Service functions pass unit tests; FIFO algorithm correctly consumes oldest lots first.
**Prompt**: `tasks/WP05-material-inventory-service.md`
**Agent Assignment**: Claude (core FIFO logic)

### Included Subtasks
- [ ] T017 Create `src/services/material_inventory_service.py` structure
- [ ] T018 Implement `get_fifo_inventory(material_product_id)` - returns lots ordered by purchase_date ASC
- [ ] T019 Implement `calculate_available_inventory(material_product_id)` - sum of quantity_remaining
- [ ] T020 Implement `consume_material_fifo()` algorithm with session pattern
- [ ] T021 Implement `validate_inventory_availability(requirements)` function

### Implementation Notes
- Copy consume_fifo pattern from inventory_item_service.py exactly
- Session management: accept optional session parameter per CLAUDE.md
- Return structure: {consumed, breakdown, shortfall, satisfied, total_cost}
- Filter: quantity_remaining > 0.001 (avoid floating-point dust)

### Parallel Opportunities
- T17 foundation first, then T18-T21 can proceed in parallel

### Dependencies
- Depends on WP01 (MaterialInventoryItem model)
- Depends on WP04 (unit converter for consumption)

### Risks & Mitigations
- FIFO algorithm correctness: comprehensive unit tests required

---

## Work Package WP06: MaterialInventoryService Tests (Priority: P1)

**Goal**: Achieve >70% test coverage for MaterialInventoryService.
**Independent Test**: pytest passes with coverage report showing >70%.
**Prompt**: `tasks/WP06-inventory-service-tests.md`
**Agent Assignment**: Claude (test quality)

### Included Subtasks
- [ ] T022 Create `src/tests/test_material_inventory_service.py` test file
- [ ] T023 Test get_fifo_inventory() ordering behavior
- [ ] T024 Test calculate_available_inventory() aggregation
- [ ] T025 Test consume_material_fifo() single-lot scenario
- [ ] T026 Test consume_material_fifo() multi-lot FIFO scenario
- [ ] T027 Test consume_material_fifo() with shortfall
- [ ] T028 Test validate_inventory_availability() success and failure cases
- [ ] T044 Test quantity_purchased immutability enforcement (FR-015)
- [ ] T045 Test cost_per_unit immutability enforcement (FR-016)

### Implementation Notes
- Use pytest fixtures for test data setup
- Test multi-lot scenarios: Lot A (older) consumed before Lot B (newer)
- Test edge cases: zero inventory, insufficient inventory, donated materials ($0 cost)

### Parallel Opportunities
- T23-T28 can proceed in parallel once T22 (file setup) is complete

### Dependencies
- Depends on WP05 (service must exist to test)

### Risks & Mitigations
- Test isolation: use session rollback pattern for database tests

---

## Work Package WP07: Purchase Integration (Priority: P1)

**Goal**: Update material purchase service to create MaterialInventoryItem on purchase.
**Independent Test**: Recording a purchase creates an inventory item with correct quantities and cost.
**Prompt**: `tasks/WP07-purchase-integration.md`
**Agent Assignment**: Claude (integration)

### Included Subtasks
- [ ] T029 Update `material_purchase_service.py` to create MaterialInventoryItem on purchase
- [ ] T030 Remove `_update_inventory_on_purchase()` weighted average logic
- [ ] T031 Add unit conversion on purchase (imperial input â†’ metric base units)
- [ ] T032 Add purchaseâ†’inventory integration tests

### Implementation Notes
- Convert: 100 feet â†’ 3048 cm; $15/100ft â†’ $0.00492/cm
- Create inventory item atomically in same transaction as purchase
- quantity_purchased and cost_per_unit are immutable snapshots

### Parallel Opportunities
- T29-T31 are sequential (same function); T32 (tests) can follow

### Dependencies
- Depends on WP01 (MaterialInventoryItem model)
- Depends on WP04 (unit converter)

### Risks & Mitigations
- Atomicity: ensure purchase and inventory item creation in same transaction

---

## Work Package WP08: Import/Export Schema Handling (Priority: P2)

**Goal**: Update import/export service to handle deprecated fields gracefully.
**Independent Test**: Export excludes deprecated fields; import ignores them without error.
**Prompt**: `tasks/WP08-import-export-updates.md`
**Agent Assignment**: Gemini (independent)

### Included Subtasks
- [ ] T033 Update MaterialProduct export to exclude current_inventory and weighted_avg_cost
- [ ] T034 Update MaterialProduct import to gracefully ignore current_inventory and weighted_avg_cost
- [ ] T035 Add import/export roundtrip tests for new schema

### Implementation Notes
- EXCLUDED_FIELDS = {"current_inventory", "weighted_avg_cost"}
- Import: gracefully ignore deprecated fields without error
- Maintain backward compatibility with old export files

### Parallel Opportunities
- T33-T34 can proceed in parallel; T35 follows

### Dependencies
- Depends on WP02 (fields must be removed from model first)

### Risks & Mitigations
- Backward compatibility: test with old export file format

---

## Work Package WP09: Catalog UI Cleanup (Priority: P2)

**Goal**: Remove cost and inventory columns from Materials Catalog view.
**Independent Test**: Catalog shows only definition fields (name, brand, SKU, package, supplier).
**Prompt**: `tasks/WP09-catalog-ui-cleanup.md`
**Agent Assignment**: Claude (UI)

### Included Subtasks
- [ ] T036 Remove cost/inventory columns from materials_tab.py product list
- [ ] T037 Update any column width/layout calculations
- [ ] T038 Remove inventory_value from denormalized export service (if present)

### Implementation Notes
- Catalog should show: Name, Brand, SKU, Package (qty + unit), Supplier
- NO columns for: current_inventory, weighted_avg_cost, inventory_value
- Keep UI simple - inventory view will be in F059

### Parallel Opportunities
- T36-T38 can proceed in parallel (different files)

### Dependencies
- Depends on WP02 (fields must be removed from model)

### Risks & Mitigations
- UI testing: manual verification of column layout

---

## Work Package WP10: Integration Tests & Validation (Priority: P2)

**Goal**: Comprehensive integration tests validating end-to-end FIFO behavior.
**Independent Test**: All integration tests pass; FIFO cost calculations are accurate.
**Prompt**: `tasks/WP10-integration-tests.md`
**Agent Assignment**: Claude (final validation)

### Included Subtasks
- [ ] T039 Create `src/tests/test_material_fifo_integration.py`
- [ ] T040 Test purchaseâ†’inventory item creation flow
- [ ] T041 Test multi-lot FIFO consumption scenario (per spec acceptance criteria)
- [ ] T042 Test cost calculation accuracy across multiple lots
- [ ] T043 Test pattern consistency with ingredient FIFO system

### Implementation Notes
- Acceptance scenario from spec: Lot A (100cm @ $0.10) + Lot B (100cm @ $0.15), consume 50cm â†’ $5.00 from Lot A only
- Second scenario: Lot A (30cm remaining), consume 50cm â†’ 30cm from A + 20cm from B = $6.00
- Verify MaterialInventoryItem structure matches InventoryItem pattern

### Parallel Opportunities
- T40-T43 can proceed in parallel once T39 (file setup) complete

### Dependencies
- Depends on all previous WPs (full system integration)

### Risks & Mitigations
- Test isolation: use fresh database for each integration test

---

## Dependency & Execution Summary

**Sequence**:
```
WP01 (Schema: Model) â”€â”€â”¬â”€â”€â–º WP02 (Schema: Cleanup) â”€â”€â–º WP08 (Import/Export)
                       â”‚                              â””â”€â”€â–º WP09 (UI Cleanup)
                       â”œâ”€â”€â–º WP03 (Schema: Updates)
                       â”‚
WP04 (Unit Converter) â”€â”´â”€â”€â–º WP05 (Inventory Service) â”€â”€â–º WP06 (Service Tests)
                       â”‚                              â””â”€â”€â–º WP07 (Purchase Integration)
                       â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º WP10 (Integration Tests)
```

**Parallelization Opportunities**:
- **Window 1**: WP01 (Claude) + WP04 (Gemini) - run simultaneously
- **Window 2**: WP02+WP03 (Claude) + WP08 (Gemini) after WP01 - run simultaneously
- **Window 3**: WP05 (Claude) after WP01+WP04
- **Window 4**: WP06+WP07 (Claude) + WP09 (Claude) after dependencies
- **Window 5**: WP10 (Claude) after all others

**MVP Scope**: WP01 + WP04 + WP05 + WP07 constitute the minimal FIFO foundation. WP02, WP03, WP06, WP08, WP09, WP10 are required for full constitutional compliance.

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Create MaterialInventoryItem model | WP01 | P0 | Yes |
| T002 | Add model to __init__.py exports | WP01 | P0 | No |
| T003 | Add inventory_items relationship to MaterialProduct | WP01 | P0 | No |
| T004 | Add inventory_item relationship to MaterialPurchase | WP01 | P0 | No |
| T005 | Remove current_inventory from MaterialProduct | WP02 | P0 | No |
| T006 | Remove weighted_avg_cost from MaterialProduct | WP02 | P0 | No |
| T007 | Remove inventory_value property | WP02 | P0 | No |
| T008 | Remove cost/inventory constraints | WP02 | P0 | No |
| T009 | Add inventory_item_id FK to MaterialConsumption | WP03 | P0 | Yes |
| T010 | Add inventory_item relationship to MaterialConsumption | WP03 | P0 | Yes |
| T011 | Update Material.base_unit_type to metric | WP03 | P0 | Yes |
| T012 | Create material_unit_converter.py | WP04 | P1 | Yes |
| T013 | Implement convert_to_base_units() | WP04 | P1 | Yes |
| T014 | Implement convert_from_base_units() | WP04 | P1 | Yes |
| T015 | Implement validate_unit_compatibility() | WP04 | P1 | Yes |
| T016 | Create unit converter tests | WP04 | P1 | Yes |
| T017 | Create material_inventory_service.py | WP05 | P1 | No |
| T018 | Implement get_fifo_inventory() | WP05 | P1 | Yes |
| T019 | Implement calculate_available_inventory() | WP05 | P1 | Yes |
| T020 | Implement consume_material_fifo() | WP05 | P1 | Yes |
| T021 | Implement validate_inventory_availability() | WP05 | P1 | Yes |
| T022 | Create test_material_inventory_service.py | WP06 | P1 | No |
| T023 | Test get_fifo_inventory() | WP06 | P1 | Yes |
| T024 | Test calculate_available_inventory() | WP06 | P1 | Yes |
| T025 | Test consume_material_fifo() single-lot | WP06 | P1 | Yes |
| T026 | Test consume_material_fifo() multi-lot | WP06 | P1 | Yes |
| T027 | Test consume_material_fifo() shortfall | WP06 | P1 | Yes |
| T028 | Test validate_inventory_availability() | WP06 | P1 | Yes |
| T029 | Update purchase service for inventory creation | WP07 | P1 | No |
| T030 | Remove weighted average logic | WP07 | P1 | No |
| T031 | Add unit conversion on purchase | WP07 | P1 | No |
| T032 | Add purchase integration tests | WP07 | P1 | No |
| T033 | Update MaterialProduct export | WP08 | P2 | Yes |
| T034 | Update MaterialProduct import | WP08 | P2 | Yes |
| T035 | Add import/export roundtrip tests | WP08 | P2 | No |
| T036 | Remove cost/inventory columns from UI | WP09 | P2 | Yes |
| T037 | Update column layout | WP09 | P2 | Yes |
| T038 | Remove inventory_value from export service | WP09 | P2 | Yes |
| T039 | Create integration test file | WP10 | P2 | No |
| T040 | Test purchaseâ†’inventory flow | WP10 | P2 | Yes |
| T041 | Test multi-lot FIFO scenario | WP10 | P2 | Yes |
| T042 | Test cost calculation accuracy | WP10 | P2 | Yes |
| T043 | Test pattern consistency | WP10 | P2 | Yes |
| T044 | Test quantity_purchased immutability (FR-015) | WP06 | P1 | Yes |
| T045 | Test cost_per_unit immutability (FR-016) | WP06 | P1 | Yes |
