# Work Packages: Event Planning Restoration

**Inputs**: Design documents from `/kitty-specs/006-event-planning-restoration/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, contracts/, quickstart.md

**Tests**: Testing included per constitution requirement (>70% service layer coverage).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `kitty-specs/006-event-planning-restoration/tasks/planned/` generated by `/spec-kitty.tasks`.

**Key Architecture Note**: Bundle concept eliminated per research decision D1. Package directly references FinishedGood assemblies via PackageFinishedGood junction table.

---

## Work Package WP01: Models Layer - Package & Junction (Priority: P0)

**Goal**: Create PackageFinishedGood junction model and update Package model to use new relationship.
**Independent Test**: Package model can be imported, PackageFinishedGood table created, relationship works.
**Prompt**: `kitty-specs/006-event-planning-restoration/tasks/planned/WP01-models-package-junction.md`

### Included Subtasks
- [ ] T001 Create PackageFinishedGood model in `src/models/package.py`
- [ ] T002 Update Package model relationship from `package_bundles` to `package_finished_goods`
- [ ] T003 Update Package.calculate_cost() to use FinishedGood.total_cost
- [ ] T004 Add Package.get_item_count() method (renamed from get_bundle_count)
- [ ] T005 Update `src/models/__init__.py` to export PackageFinishedGood

### Implementation Notes
- PackageFinishedGood replaces the removed PackageBundle model
- Foreign keys: package_id (CASCADE), finished_good_id (RESTRICT)
- Include indexes: idx_package_fg_package, idx_package_fg_finished_good
- Cost calculation chains: Package -> PackageFinishedGood -> FinishedGood.total_cost

### Parallel Opportunities
- T001-T004 must be sequential (model definition first)
- T005 depends on T001-T004

### Dependencies
- None (starting package for models layer)
- Requires existing FinishedGood model (from Features 002-004)

### Risks & Mitigations
- Foreign key constraint errors: Verify FinishedGood table exists before creating junction
- Cost calculation integration: Use FinishedGood.calculate_component_cost() for accurate costs

---

## Work Package WP02: Models Layer - Event & Recipient (Priority: P0)

**Goal**: Re-enable Event, EventRecipientPackage, and verify Recipient models.
**Independent Test**: All models import successfully, relationships work, cost calculations chain.
**Prompt**: `kitty-specs/006-event-planning-restoration/tasks/planned/WP02-models-event-recipient.md`

### Included Subtasks
- [ ] T006 Review and verify `src/models/event.py` Event model works with current schema
- [ ] T007 Review and verify EventRecipientPackage model works with Package relationship
- [ ] T008 Update EventRecipientPackage.calculate_cost() to use Package.calculate_cost()
- [ ] T009 Verify Event.get_total_cost(), get_recipient_count(), get_package_count() methods
- [ ] T010 Verify `src/models/recipient.py` Recipient model is functional
- [ ] T011 Update `src/models/__init__.py` to re-enable Event, EventRecipientPackage, Package

### Implementation Notes
- Event model exists but is disabled due to Bundle dependency
- Remove any Bundle references from event.py
- Verify all foreign key relationships work with current schema
- Recipient model should already be enabled - verify only

### Parallel Opportunities
- T006-T009 (Event) can proceed in parallel with T010 (Recipient)
- T011 depends on all previous subtasks

### Dependencies
- Depends on WP01 (Package model must be updated first)

### Risks & Mitigations
- Circular import issues: Import models carefully in __init__.py
- Missing relationships: Test each model import individually before enabling all

---

## Work Package WP03: Package Service Implementation (Priority: P1)

**Goal**: Implement PackageService with full CRUD, content management, and cost calculation.
**Independent Test**: Create package, add FinishedGoods, calculate cost, verify FIFO chain.
**Prompt**: `kitty-specs/006-event-planning-restoration/tasks/planned/WP03-package-service.md`

### Included Subtasks
- [ ] T012 Create `src/services/package_service.py` with basic structure
- [ ] T013 Implement get_package_by_id, get_package_by_name, get_all_packages
- [ ] T014 Implement create_package, update_package, delete_package
- [ ] T015 Implement add_finished_good_to_package, remove_finished_good_from_package
- [ ] T016 Implement update_finished_good_quantity, get_package_contents
- [ ] T017 Implement calculate_package_cost, get_package_cost_breakdown
- [ ] T018 Implement search_packages, get_template_packages
- [ ] T019 Implement get_packages_containing_finished_good, check_package_has_event_assignments
- [ ] T020 Implement duplicate_package
- [ ] T021 [P] Create custom exception classes (PackageNotFoundError, PackageInUseError, etc.)
- [ ] T022 Write unit tests in `src/tests/test_package_service.py`

### Implementation Notes
- Rewrite from scratch per research decision D4
- Reference contracts/package_service.md for full interface specification
- Cost calculation must use FinishedGood.calculate_component_cost() which chains to FIFO
- Deletion must check EventRecipientPackage assignments (FR-015)

### Parallel Opportunities
- T021 (exception classes) can proceed in parallel with T012-T20
- T22 (tests) should follow implementation

### Dependencies
- Depends on WP01, WP02 (models must be complete)

### Risks & Mitigations
- FIFO cost chain accuracy: Verify integration with RecipeService.calculate_actual_cost()
- Performance: Use eager loading for relationships when calculating costs

---

## Work Package WP04: Event Service Implementation (Priority: P1)

**Goal**: Implement EventService with event CRUD, assignments, and aggregation calculations.
**Independent Test**: Create event, assign packages to recipients, calculate totals.
**Prompt**: `kitty-specs/006-event-planning-restoration/tasks/planned/WP04-event-service.md`

### Included Subtasks
- [ ] T023 Create `src/services/event_service.py` with basic structure
- [ ] T024 Implement get_event_by_id, get_event_by_name, get_all_events, get_events_by_year
- [ ] T025 Implement get_available_years for year filter dropdown
- [ ] T026 Implement create_event, update_event, delete_event (with cascade option)
- [ ] T027 Implement assign_package_to_recipient, update_assignment, remove_assignment
- [ ] T028 Implement get_event_assignments, get_recipient_assignments_for_event
- [ ] T029 Implement get_event_total_cost, get_event_recipient_count, get_event_package_count
- [ ] T030 Implement get_event_summary (FR-027)
- [ ] T031 Implement get_recipe_needs (FR-025) - batch count aggregation
- [ ] T032 Implement get_shopping_list (FR-026) - ingredient shortfall calculation
- [ ] T033 [P] Create custom exception classes (EventNotFoundError, EventHasAssignmentsError, etc.)
- [ ] T034 Write unit tests in `src/tests/test_event_service.py`

### Implementation Notes
- Rewrite from scratch - old service imports non-existent Bundle
- Reference contracts/event_service.md for full interface specification
- get_recipe_needs traverses: assignments -> packages -> finished_goods -> compositions -> finished_units -> recipes
- get_shopping_list integrates with PantryService for on-hand inventory (FR-029)

### Parallel Opportunities
- T033 (exception classes) can proceed in parallel with T023-T032
- T034 (tests) should follow implementation

### Dependencies
- Depends on WP03 (PackageService must be complete for cost calculations)

### Risks & Mitigations
- Recipe needs aggregation complexity: Use iterative traversal, avoid recursion
- Performance with 50+ assignments: Eager load all relationships, batch queries

---

## Work Package WP05: Recipient Service Verification (Priority: P1)

**Goal**: Verify RecipientService is functional or implement missing methods.
**Independent Test**: CRUD operations work, dependency checking for deletion works.
**Prompt**: `kitty-specs/006-event-planning-restoration/tasks/planned/WP05-recipient-service.md`

### Included Subtasks
- [ ] T035 Review existing `src/services/recipient_service.py` for functionality
- [ ] T036 Verify/implement get_recipient_by_id, get_recipient_by_name, get_all_recipients
- [ ] T037 Verify/implement create_recipient, update_recipient, delete_recipient
- [ ] T038 Implement check_recipient_has_assignments, get_recipient_assignment_count
- [ ] T039 Implement get_recipient_events for finding events with recipient assignments
- [ ] T040 Implement search_recipients, get_recipients_by_household
- [ ] T041 Write unit tests in `src/tests/test_recipient_service.py`

### Implementation Notes
- Recipient model is already enabled - service may be partially functional
- Reference contracts/recipient_service.md for full interface specification
- Deletion with force flag should cascade delete EventRecipientPackage records

### Parallel Opportunities
- Can proceed in parallel with WP04 after WP02 is complete

### Dependencies
- Depends on WP02 (Recipient model verification)

### Risks & Mitigations
- Service may not exist or be broken - create if missing

---

## Work Package WP06: UI - Packages Tab (Priority: P2)

**Goal**: Restore/update Packages tab UI using PackageService.
**Independent Test**: User can create, edit, delete packages; add/remove FinishedGoods; see costs.
**Prompt**: `kitty-specs/006-event-planning-restoration/tasks/planned/WP06-ui-packages-tab.md`

### Included Subtasks
- [ ] T042 Review existing `src/ui/packages_tab.py` for reusable patterns
- [ ] T043 Create/update PackagesTab frame with package list view
- [ ] T044 Implement Add Package dialog with name, description, is_template fields
- [ ] T045 Implement package content editor (add/remove FinishedGoods with quantities)
- [ ] T046 Display package cost (calculated from FinishedGood costs)
- [ ] T047 Implement Edit/Delete package functionality with dependency warnings
- [ ] T048 Add search functionality for packages

### Implementation Notes
- Use CustomTkinter for UI components
- Follow layered architecture: UI calls PackageService only, no direct DB access
- Reference spec.md User Story 2 for acceptance scenarios

### Parallel Opportunities
- Can proceed in parallel with WP07 after WP03 is complete

### Dependencies
- Depends on WP03 (PackageService must be complete)

### Risks & Mitigations
- UI may reference obsolete Bundle patterns - rewrite affected code

---

## Work Package WP07: UI - Recipients Tab (Priority: P2)

**Goal**: Verify/update Recipients tab UI using RecipientService.
**Independent Test**: User can create, edit, delete recipients with dependency warnings.
**Prompt**: `kitty-specs/006-event-planning-restoration/tasks/planned/WP07-ui-recipients-tab.md`

### Included Subtasks
- [ ] T049 Review existing `src/ui/recipients_tab.py` for functionality
- [ ] T050 Verify/update RecipientsTab frame with recipient list view
- [ ] T051 Verify/update Add Recipient dialog with name, household, address, notes
- [ ] T052 Implement deletion with assignment warning confirmation
- [ ] T053 Add search functionality for recipients

### Implementation Notes
- Recipient UI may already be functional - verify before rewriting
- Follow spec.md User Story 3 acceptance scenarios

### Parallel Opportunities
- Can proceed in parallel with WP06 after WP05 is complete

### Dependencies
- Depends on WP05 (RecipientService must be complete)

### Risks & Mitigations
- Minor - recipients are simpler than packages

---

## Work Package WP08: UI - Events Tab (Priority: P2)

**Goal**: Restore/update Events tab UI with year filtering.
**Independent Test**: User can create, filter by year, edit, delete events; opens EventDetailWindow.
**Prompt**: `kitty-specs/006-event-planning-restoration/tasks/planned/WP08-ui-events-tab.md`

### Included Subtasks
- [ ] T054 Review existing `src/ui/events_tab.py` for reusable patterns
- [ ] T055 Create/update EventsTab frame with event list view
- [ ] T056 Implement Add Event dialog with name, event_date, year, notes
- [ ] T057 Implement year filter dropdown (FR-020)
- [ ] T058 Implement Edit/Delete event functionality with cascade confirmation
- [ ] T059 Implement double-click to open EventDetailWindow

### Implementation Notes
- Year filter uses EventService.get_available_years() to populate dropdown
- Delete with assignments requires cascade confirmation (FR-022)
- Follow spec.md User Story 4 acceptance scenarios

### Parallel Opportunities
- Can proceed in parallel with WP06, WP07 after WP04 is complete

### Dependencies
- Depends on WP04 (EventService must be complete)

### Risks & Mitigations
- UI may reference obsolete patterns - rewrite affected code

---

## Work Package WP09: UI - EventDetailWindow (Priority: P1)

**Goal**: Restore EventDetailWindow with 4 tabs: Assignments, Recipe Needs, Shopping List, Summary.
**Independent Test**: All 4 tabs load and display data correctly for an event with assignments.
**Prompt**: `kitty-specs/006-event-planning-restoration/tasks/planned/WP09-ui-event-detail-window.md`

### Included Subtasks
- [ ] T060 Create EventDetailWindow base frame with tab container
- [ ] T061 Implement Assignments tab - CRUD for recipient-package assignments (FR-024)
- [ ] T062 Implement Recipe Needs tab - display aggregated batch counts (FR-025)
- [ ] T063 Implement Shopping List tab - ingredients with on-hand and shortfall (FR-026)
- [ ] T064 Implement Summary tab - total cost, counts, cost by recipient (FR-027)
- [ ] T065 Ensure all tabs load within 2 seconds for 50 assignments (SC-004)
- [ ] T066 Handle empty state for events with no assignments

### Implementation Notes
- Window opens when user double-clicks an event in Events tab
- Each tab calls EventService methods for data
- Performance critical: <2s load time (SC-004)
- Follow spec.md User Stories 5-8 for acceptance scenarios

### Parallel Opportunities
- T061-T064 can proceed in parallel once T060 is complete

### Dependencies
- Depends on WP04 (EventService must be complete)
- Depends on WP06 (Package display patterns)

### Risks & Mitigations
- Performance: Use background threading for slow calculations
- Complex UI: Break into separate frame classes per tab

---

## Work Package WP10: Integration & Polish (Priority: P3)

**Goal**: Integration testing, FIFO accuracy verification, and polish.
**Independent Test**: Full workflow completes in <5 minutes (SC-001), costs match manual verification (SC-002).
**Prompt**: `kitty-specs/006-event-planning-restoration/tasks/planned/WP10-integration-polish.md`

### Included Subtasks
- [ ] T067 Write integration test for full workflow in `src/tests/test_event_planning_workflow.py`
- [ ] T068 Verify FIFO cost accuracy against manual calculation (SC-002)
- [ ] T069 Verify shopping list shortfall accuracy (SC-003)
- [ ] T070 Performance testing: 50 assignments load in <2s (SC-004)
- [ ] T071 Edge case testing: empty states, missing costs, large datasets
- [ ] T072 Update test_data/sample_data.json if needed for event planning data
- [ ] T073 Final code cleanup and documentation review

### Implementation Notes
- Integration test should cover: create package -> add FinishedGoods -> create event -> assign to recipient -> verify costs
- FIFO accuracy test: Create multi-batch pantry scenario, verify cost chain
- Reference quickstart.md for validation scenarios

### Parallel Opportunities
- T067-T071 can proceed in parallel

### Dependencies
- Depends on all previous work packages

### Risks & Mitigations
- FIFO chain errors: Use known test data with manually calculated expected costs
- Performance issues: Profile and optimize hotspots

---

## Dependency & Execution Summary

- **Sequence**: WP01 -> WP02 -> WP03 -> WP04/WP05 (parallel) -> WP06/WP07/WP08 (parallel) -> WP09 -> WP10
- **Parallelization**:
  - After WP02: WP03 starts
  - After WP03: WP04 and WP05 can proceed in parallel
  - After WP04/WP05: WP06, WP07, WP08 can proceed in parallel
  - WP09 requires WP04 and WP06
- **MVP Scope**: WP01-WP05 + WP09 (models, services, EventDetailWindow) - enables core gift planning workflow

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Create PackageFinishedGood model | WP01 | P0 | No |
| T002 | Update Package relationship | WP01 | P0 | No |
| T003 | Update Package.calculate_cost() | WP01 | P0 | No |
| T004 | Add Package.get_item_count() | WP01 | P0 | No |
| T005 | Update __init__.py exports | WP01 | P0 | No |
| T006 | Verify Event model | WP02 | P0 | Yes |
| T007 | Verify EventRecipientPackage | WP02 | P0 | Yes |
| T008 | Update ERP.calculate_cost() | WP02 | P0 | Yes |
| T009 | Verify Event aggregation methods | WP02 | P0 | Yes |
| T010 | Verify Recipient model | WP02 | P0 | Yes |
| T011 | Re-enable models in __init__.py | WP02 | P0 | No |
| T012 | Create PackageService structure | WP03 | P1 | No |
| T013 | Implement package getters | WP03 | P1 | No |
| T014 | Implement package CRUD | WP03 | P1 | No |
| T015 | Implement add/remove FinishedGood | WP03 | P1 | No |
| T016 | Implement quantity/contents | WP03 | P1 | No |
| T017 | Implement cost calculation | WP03 | P1 | No |
| T018 | Implement search/templates | WP03 | P1 | No |
| T019 | Implement dependency checks | WP03 | P1 | No |
| T020 | Implement duplicate_package | WP03 | P1 | No |
| T021 | Create exception classes | WP03 | P1 | Yes |
| T022 | Write PackageService tests | WP03 | P1 | No |
| T023 | Create EventService structure | WP04 | P1 | No |
| T024 | Implement event getters | WP04 | P1 | No |
| T025 | Implement get_available_years | WP04 | P1 | No |
| T026 | Implement event CRUD | WP04 | P1 | No |
| T027 | Implement assignment operations | WP04 | P1 | No |
| T028 | Implement assignment queries | WP04 | P1 | No |
| T029 | Implement event cost/counts | WP04 | P1 | No |
| T030 | Implement get_event_summary | WP04 | P1 | No |
| T031 | Implement get_recipe_needs | WP04 | P1 | No |
| T032 | Implement get_shopping_list | WP04 | P1 | No |
| T033 | Create exception classes | WP04 | P1 | Yes |
| T034 | Write EventService tests | WP04 | P1 | No |
| T035 | Review RecipientService | WP05 | P1 | No |
| T036 | Verify recipient getters | WP05 | P1 | No |
| T037 | Verify recipient CRUD | WP05 | P1 | No |
| T038 | Implement assignment checks | WP05 | P1 | No |
| T039 | Implement get_recipient_events | WP05 | P1 | No |
| T040 | Implement search | WP05 | P1 | No |
| T041 | Write RecipientService tests | WP05 | P1 | No |
| T042 | Review packages_tab.py | WP06 | P2 | No |
| T043 | Create PackagesTab frame | WP06 | P2 | No |
| T044 | Implement Add Package dialog | WP06 | P2 | No |
| T045 | Implement content editor | WP06 | P2 | No |
| T046 | Display package cost | WP06 | P2 | No |
| T047 | Implement Edit/Delete | WP06 | P2 | No |
| T048 | Add search functionality | WP06 | P2 | No |
| T049 | Review recipients_tab.py | WP07 | P2 | No |
| T050 | Verify RecipientsTab frame | WP07 | P2 | No |
| T051 | Verify Add Recipient dialog | WP07 | P2 | No |
| T052 | Implement deletion warning | WP07 | P2 | No |
| T053 | Add search functionality | WP07 | P2 | No |
| T054 | Review events_tab.py | WP08 | P2 | No |
| T055 | Create EventsTab frame | WP08 | P2 | No |
| T056 | Implement Add Event dialog | WP08 | P2 | No |
| T057 | Implement year filter | WP08 | P2 | No |
| T058 | Implement Edit/Delete | WP08 | P2 | No |
| T059 | Open EventDetailWindow | WP08 | P2 | No |
| T060 | Create EventDetailWindow base | WP09 | P1 | No |
| T061 | Implement Assignments tab | WP09 | P1 | Yes |
| T062 | Implement Recipe Needs tab | WP09 | P1 | Yes |
| T063 | Implement Shopping List tab | WP09 | P1 | Yes |
| T064 | Implement Summary tab | WP09 | P1 | Yes |
| T065 | Performance optimization | WP09 | P1 | No |
| T066 | Handle empty states | WP09 | P1 | No |
| T067 | Write integration test | WP10 | P3 | Yes |
| T068 | Verify FIFO accuracy | WP10 | P3 | Yes |
| T069 | Verify shopping list accuracy | WP10 | P3 | Yes |
| T070 | Performance testing | WP10 | P3 | Yes |
| T071 | Edge case testing | WP10 | P3 | Yes |
| T072 | Update sample_data.json | WP10 | P3 | Yes |
| T073 | Final cleanup | WP10 | P3 | No |
