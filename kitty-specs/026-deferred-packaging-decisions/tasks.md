# Work Packages: Deferred Packaging Decisions

**Inputs**: Design documents from `/kitty-specs/026-deferred-packaging-decisions/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, quickstart.md

**Tests**: Unit tests required for service layer (>70% coverage). Integration tests for full workflows.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/planned/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Schema & Models (Priority: P0)

**Goal**: Database schema changes and model definitions.
**Independent Test**: Models import without errors; schema migrations apply cleanly.
**Prompt**: `/tasks/planned/WP01-schema-and-models.md`

### Included Subtasks
- [ ] T001 Add `is_generic` column to Composition model in `src/models/composition.py`
- [ ] T002 Create CompositionAssignment model in `src/models/composition_assignment.py`
- [ ] T003 Update `src/models/__init__.py` exports
- [ ] T004 Document schema migration steps in feature docs

### Implementation Notes
- Follow Constitution VI: export/reset/import cycle for schema changes
- `is_generic` defaults to False for backward compatibility
- CompositionAssignment has FK to compositions (CASCADE) and inventory_items (RESTRICT)

### Parallel Opportunities
- None (foundational - must complete first)

### Dependencies
- None (starting package)

### Risks & Mitigations
- Risk: Schema mismatch with existing data
- Mitigation: Default False ensures existing compositions unchanged

---

## Work Package WP02: Packaging Service Core (Priority: P0)

**Goal**: Core business logic for generic packaging operations.
**Independent Test**: All service methods pass unit tests with mock data.
**Prompt**: `/tasks/planned/WP02-packaging-service-core.md`

### Included Subtasks
- [ ] T005 Create `src/services/packaging_service.py` with base structure
- [ ] T006 Implement `get_generic_products()` - list available generic product types
- [ ] T007 Implement `get_generic_inventory_summary(product_name)` - total + breakdown by brand
- [ ] T008 Implement `get_estimated_cost(product_name, quantity)` - average price calculation
- [ ] T009 Implement `create_generic_requirement()` - set up generic composition
- [ ] T010 Implement `assign_materials()` - create assignment records with validation
- [ ] T011 Implement `get_pending_requirements()` - find unassigned generics
- [ ] T012 Implement `is_fully_assigned()` - check assignment status
- [ ] T013 [P] Create `src/tests/services/test_packaging_service.py` with unit tests

### Implementation Notes
- Follow session management pattern: accept optional `session=None` parameter
- Use SQLAlchemy 2.x style queries
- Cost calculation uses weighted average across available inventory

### Parallel Opportunities
- T013 (tests) can be written alongside implementation

### Dependencies
- Depends on WP01

### Risks & Mitigations
- Risk: Cost calculation accuracy
- Mitigation: Use same costing logic as existing FIFO system

---

## Work Package WP03: Service Integration (Priority: P1) - GEMINI CANDIDATE

**Goal**: Update existing services to support generic packaging.
**Independent Test**: Existing service tests continue to pass; new generic-aware methods work.
**Prompt**: `/tasks/planned/WP03-service-integration.md`

### Included Subtasks
- [ ] T014 [P] Update `src/services/composition_service.py` - support `is_generic` flag in create/update
- [ ] T015 [P] Update `src/services/assembly_service.py` - add `check_packaging_assigned()` validation
- [ ] T016 [P] Update `src/services/shopping_list_service.py` - group generic packaging by `product_name`
- [ ] T017 Add bypass flag support to assembly completion flow

### Implementation Notes
- Composition service: add `is_generic` parameter to creation methods
- Assembly service: validate assignments before allowing completion (with bypass option)
- Shopping list: aggregate by `product_name` for generic items, show estimated costs

### Parallel Opportunities
- T014, T015, T016 can proceed in parallel (different service files)
- **SUITABLE FOR GEMINI DELEGATION** - Independent service file updates

### Dependencies
- Depends on WP02

### Risks & Mitigations
- Risk: Breaking existing service behavior
- Mitigation: Default values preserve existing behavior; run existing test suite

---

## Work Package WP04: Planning UI (Priority: P1) - User Story 1

**Goal**: Enable generic packaging selection during event planning.
**Independent Test**: User can create composition with `is_generic=True` via UI.
**Prompt**: `/tasks/planned/WP04-planning-ui.md`

### Included Subtasks
- [ ] T018 Add radio button toggle in composition editor: "Specific material" / "Generic product"
- [ ] T019 Create generic product dropdown (distinct `product_name` values from packaging products)
- [ ] T020 Add inventory summary widget showing total and breakdown by brand
- [ ] T021 Display estimated cost with "Estimated" label
- [ ] T022 Persist `is_generic=True` when saving generic compositions
- [ ] T023 Update UI validation logic for generic vs specific modes

### Implementation Notes
- Modify `src/ui/composition_editor.py` (or equivalent assembly/package editing screen)
- Use CTkRadioButton for mode toggle
- Inventory summary should show clickable expansion

### Parallel Opportunities
- None within this package (sequential UI flow)

### Dependencies
- Depends on WP02

### Risks & Mitigations
- Risk: UI complexity confusing users
- Mitigation: Clear visual distinction between modes; "Estimated" badge prominent

---

## Work Package WP05: Assignment Dialog (Priority: P1) - User Story 2

**Goal**: Material assignment interface for generic requirements.
**Independent Test**: User can assign specific inventory items to fulfill generic requirement.
**Prompt**: `/tasks/planned/WP05-assignment-dialog.md`

### Included Subtasks
- [ ] T024 Create `src/ui/packaging_assignment_dialog.py` - new dialog class
- [ ] T025 Implement available products list with checkbox + quantity input for each
- [ ] T026 Add running total display: "Assigned: X / Y needed"
- [ ] T027 Implement validation before save (sum must equal requirement)
- [ ] T028 Integrate dialog into assembly screen (trigger from pending indicator)
- [ ] T029 Update cost display after assignment (switch from estimated to actual)

### Implementation Notes
- Dialog shows only products matching the generic `product_name`
- Quantity inputs bounded by available inventory per item
- Clear visual feedback when total matches requirement

### Parallel Opportunities
- None within this package

### Dependencies
- Depends on WP02, WP04

### Risks & Mitigations
- Risk: Quantity validation UX confusing
- Mitigation: Disable save until valid; show clear error states

---

## Work Package WP06: Dashboard & Shopping List (Priority: P2) - GEMINI CANDIDATE

**Goal**: Visual indicators for pending decisions and shopping list integration.
**Independent Test**: Dashboard shows pending indicators; shopping list groups generics correctly.
**Prompt**: `/tasks/planned/WP06-dashboard-and-shopping-list.md`

### Included Subtasks
- [ ] T030 [P] Add pending indicator icon to dashboard items with unassigned generic packaging
- [ ] T031 [P] Make indicators clickable (navigate to assignment dialog)
- [ ] T032 [P] Add tooltip: "Packaging needs selection"
- [ ] T033 [P] Add filter option to show only pending items
- [ ] T034 [P] Update shopping list generation to group by `product_name` for generics
- [ ] T035 [P] Display generic items as "Cellophane Bags 6x10: 50 needed" format
- [ ] T036 [P] Show estimated costs with "Estimated" label in shopping list

### Implementation Notes
- Dashboard indicators use warning icon (orange/yellow)
- Shopping list groups items under generic product type header
- Filter toggles between "All items" and "Needs attention"

### Parallel Opportunities
- T030-T033 (dashboard) and T034-T036 (shopping list) can proceed in parallel
- **SUITABLE FOR GEMINI DELEGATION** - Dashboard and shopping list are separate UI components

### Dependencies
- Depends on WP02

### Risks & Mitigations
- Risk: Indicator overload on dashboard
- Mitigation: Subtle icons; filter reduces noise

---

## Work Package WP07: Assembly Enforcement (Priority: P1) - User Story 5

**Goal**: Prompt about unassigned packaging at assembly completion.
**Independent Test**: Completing assembly with unassigned packaging shows prompt; bypass works.
**Prompt**: `/tasks/planned/WP07-assembly-enforcement.md`

### Included Subtasks
- [ ] T037 Add check in assembly completion flow for unassigned generic packaging
- [ ] T038 Create prompt dialog with three options:
  - "Quick Assign" - open assignment dialog
  - "Assembly Details" - navigate to full assembly screen
  - "Record Assembly Anyway" - bypass with flag
- [ ] T039 Flag event for reconciliation when bypass used
- [ ] T040 Add visual indicator for bypassed assemblies needing reconciliation

### Implementation Notes
- Prompt appears before final confirmation
- Bypass sets a flag on AssemblyRun for later reconciliation
- Reconciliation list shows all bypassed items

### Parallel Opportunities
- None within this package

### Dependencies
- Depends on WP05

### Risks & Mitigations
- Risk: Blocking workflow annoys users
- Mitigation: Bypass option always available with clear consequences

---

## Work Package WP08: BOM Modification (Priority: P2)

**Goal**: Allow packaging changes during assembly.
**Independent Test**: User can add/remove packaging from assembly definition; costs recalculate.
**Prompt**: `/tasks/planned/WP08-bom-modification.md`

### Included Subtasks
- [ ] T041 Enable add/remove of packaging components in assembly definition
- [ ] T042 Clear previous assignments when requirements change
- [ ] T043 Recalculate costs and availability after changes
- [ ] T044 Warn if changes affect other pending productions

### Implementation Notes
- Changing packaging requirement clears existing assignments (user must re-assign)
- Show warning dialog before clearing assignments
- Cross-production impact check uses event scope

### Parallel Opportunities
- None within this package

### Dependencies
- Depends on WP05

### Risks & Mitigations
- Risk: Losing assignment data unexpectedly
- Mitigation: Confirmation dialog before clearing; activity log records changes

---

## Work Package WP09: Testing & Polish (Priority: P2)

**Goal**: Comprehensive testing and refinement.
**Independent Test**: All tests pass; user acceptance complete.
**Prompt**: `/tasks/planned/WP09-testing-and-polish.md`

### Included Subtasks
- [ ] T045 [P] Unit test coverage >80% for packaging_service
- [ ] T046 [P] Integration tests for full workflow: plan with generic -> assign -> complete assembly
- [ ] T047 [P] Edge case testing: shortage scenarios, re-assignment, bypass reconciliation
- [ ] T048 Update import/export for new fields (`is_generic`, composition_assignments)
- [ ] T049 User acceptance testing with primary user
- [ ] T050 Update CLAUDE.md if needed
- [ ] T051 Validate quickstart.md scenario works end-to-end

### Implementation Notes
- Run full test suite before acceptance
- Export/import must handle new fields gracefully
- Document any migration notes for existing users

### Parallel Opportunities
- T045, T046, T047 (tests) can proceed in parallel
- **SUITABLE FOR GEMINI DELEGATION** - Test writing is independent work

### Dependencies
- Depends on all previous packages

### Risks & Mitigations
- Risk: Regression in existing functionality
- Mitigation: Full test suite run; manual smoke testing

---

## Dependency & Execution Summary

```
WP01 (Schema)
    |
    v
WP02 (Service Core)
    |
    +---> WP03 (Service Integration) [GEMINI]
    |
    +---> WP04 (Planning UI)
    |         |
    |         v
    |     WP05 (Assignment Dialog)
    |         |
    |         +---> WP07 (Assembly Enforcement)
    |         |
    |         +---> WP08 (BOM Modification)
    |
    +---> WP06 (Dashboard & Shopping List) [GEMINI]
              |
              v
          WP09 (Testing & Polish) [GEMINI - tests]
```

- **Sequence**: WP01 -> WP02 -> {WP03, WP04, WP06} parallel -> WP05 -> {WP07, WP08} -> WP09
- **Parallelization**: After WP02, three streams can proceed concurrently
- **MVP Scope**: WP01, WP02, WP04, WP05, WP07 (core planning and assignment workflow)

## Gemini Delegation Candidates

| Work Package | Rationale | Files Affected |
|--------------|-----------|----------------|
| WP03 | Independent service file updates | `composition_service.py`, `assembly_service.py`, `shopping_list_service.py` |
| WP06 | Dashboard and shopping list are separate UI components | `dashboard.py`, shopping list component |
| WP09 (partial) | Test writing is independent, read-only work | `test_packaging_service.py`, integration tests |

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Add is_generic to Composition | WP01 | P0 | No |
| T002 | Create CompositionAssignment model | WP01 | P0 | No |
| T003 | Update model exports | WP01 | P0 | No |
| T004 | Document schema migration | WP01 | P0 | No |
| T005 | Create packaging_service.py | WP02 | P0 | No |
| T006 | Implement get_generic_products() | WP02 | P0 | No |
| T007 | Implement get_generic_inventory_summary() | WP02 | P0 | No |
| T008 | Implement get_estimated_cost() | WP02 | P0 | No |
| T009 | Implement create_generic_requirement() | WP02 | P0 | No |
| T010 | Implement assign_materials() | WP02 | P0 | No |
| T011 | Implement get_pending_requirements() | WP02 | P0 | No |
| T012 | Implement is_fully_assigned() | WP02 | P0 | No |
| T013 | Create packaging service tests | WP02 | P0 | Yes |
| T014 | Update composition_service.py | WP03 | P1 | Yes |
| T015 | Update assembly_service.py | WP03 | P1 | Yes |
| T016 | Update shopping_list_service.py | WP03 | P1 | Yes |
| T017 | Add bypass flag support | WP03 | P1 | No |
| T018 | Add radio button toggle | WP04 | P1 | No |
| T019 | Create generic product dropdown | WP04 | P1 | No |
| T020 | Add inventory summary widget | WP04 | P1 | No |
| T021 | Display estimated cost | WP04 | P1 | No |
| T022 | Persist is_generic flag | WP04 | P1 | No |
| T023 | Update UI validation | WP04 | P1 | No |
| T024 | Create packaging_assignment_dialog.py | WP05 | P1 | No |
| T025 | Implement products list with quantities | WP05 | P1 | No |
| T026 | Add running total display | WP05 | P1 | No |
| T027 | Implement save validation | WP05 | P1 | No |
| T028 | Integrate dialog into assembly screen | WP05 | P1 | No |
| T029 | Update cost display after assignment | WP05 | P1 | No |
| T030 | Add pending indicator to dashboard | WP06 | P2 | Yes |
| T031 | Make indicators clickable | WP06 | P2 | Yes |
| T032 | Add tooltip for pending items | WP06 | P2 | Yes |
| T033 | Add filter for pending items | WP06 | P2 | Yes |
| T034 | Update shopping list grouping | WP06 | P2 | Yes |
| T035 | Display generic item format | WP06 | P2 | Yes |
| T036 | Show estimated costs in shopping list | WP06 | P2 | Yes |
| T037 | Add assembly completion check | WP07 | P1 | No |
| T038 | Create prompt dialog with options | WP07 | P1 | No |
| T039 | Flag event for reconciliation | WP07 | P1 | No |
| T040 | Add bypassed assembly indicator | WP07 | P1 | No |
| T041 | Enable packaging add/remove | WP08 | P2 | No |
| T042 | Clear assignments on requirement change | WP08 | P2 | No |
| T043 | Recalculate costs after changes | WP08 | P2 | No |
| T044 | Warn about cross-production impact | WP08 | P2 | No |
| T045 | Unit test coverage >80% | WP09 | P2 | Yes |
| T046 | Integration tests for full workflow | WP09 | P2 | Yes |
| T047 | Edge case testing | WP09 | P2 | Yes |
| T048 | Update import/export | WP09 | P2 | No |
| T049 | User acceptance testing | WP09 | P2 | No |
| T050 | Update CLAUDE.md | WP09 | P2 | No |
| T051 | Validate quickstart.md | WP09 | P2 | No |
