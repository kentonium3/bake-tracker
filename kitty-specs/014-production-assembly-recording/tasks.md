# Work Packages: Production & Assembly Recording UI

**Inputs**: Design documents from `/kitty-specs/014-production-assembly-recording/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, contracts/, quickstart.md

**Tests**: Testing included per constitution requirement (>70% service layer coverage).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/planned/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Core Reusable Widgets (Priority: P0)

**Goal**: Create the foundational widgets needed by all dialogs - availability display and history tables.
**Independent Test**: Widgets can be instantiated with mock data and render correctly.
**Prompt**: `tasks/planned/WP01-core-reusable-widgets.md`

### Included Subtasks
- [ ] T001 Create AvailabilityDisplay widget in `src/ui/widgets/availability_display.py`
- [ ] T002 [P] Create ProductionHistoryTable in `src/ui/widgets/production_history_table.py`
- [ ] T003 [P] Create AssemblyHistoryTable in `src/ui/widgets/assembly_history_table.py`
- [ ] T004 Update `src/ui/widgets/__init__.py` with new exports

### Implementation Notes
1. AvailabilityDisplay: CTkFrame with scrollable list, color-coded status items
2. History tables: Subclass existing DataTable, override `_get_row_values()`
3. Follow existing widget patterns from `src/ui/widgets/data_table.py`
4. Use constants from `src/utils/constants.py` for colors

### Parallel Opportunities
- T002 and T003 can proceed in parallel (separate files, same pattern)

### Dependencies
- None (foundational package)

### Risks & Mitigations
- Widget styling inconsistency: Use existing constants and patterns
- DataTable API changes: Verify base class interface before starting

---

## Work Package WP02: Production Recording Dialog (Priority: P1) MVP

**Goal**: Implement the Record Production dialog with availability check and batch input.
**Independent Test**: Dialog opens, shows availability, accepts input, and returns result dict.
**Prompt**: `tasks/planned/WP02-production-recording-dialog.md`

### Included Subtasks
- [ ] T005 Create RecordProductionDialog in `src/ui/forms/record_production_dialog.py`
- [ ] T006 Implement dialog layout (batch count, yield, notes, availability display)
- [ ] T007 Implement availability check on dialog open
- [ ] T008 Implement "Refresh Availability" button handler
- [ ] T009 Implement Confirm button with service integration
- [ ] T010 Add validation (batch count >= 1, yield >= 0)

### Implementation Notes
1. Follow CTkToplevel modal pattern from existing forms
2. Use AvailabilityDisplay widget from WP01
3. Calculate expected yield: `batches * finished_unit.items_per_batch`
4. Disable Confirm button when `can_produce == False`
5. Call `record_batch_production()` via UIServiceIntegrator

### Parallel Opportunities
- None within this package (sequential implementation)

### Dependencies
- Depends on WP01 (AvailabilityDisplay widget)

### Risks & Mitigations
- Service error handling: Use UIServiceIntegrator for consistent UX
- Race condition on availability: Re-check before confirm

---

## Work Package WP03: FinishedUnit Detail Dialog (Priority: P1) MVP

**Goal**: Create the FinishedUnit detail modal with production history and Record Production button.
**Independent Test**: Dialog displays FinishedUnit info, shows history, Record Production opens sub-dialog.
**Prompt**: `tasks/planned/WP03-finished-unit-detail-dialog.md`

### Included Subtasks
- [ ] T011 Create FinishedUnitDetailDialog in `src/ui/forms/finished_unit_detail.py`
- [ ] T012 Implement header section (name, category)
- [ ] T013 Implement info section (recipe link, inventory count, unit cost)
- [ ] T014 Integrate ProductionHistoryTable widget
- [ ] T015 Implement "Record Production" button opening RecordProductionDialog
- [ ] T016 Implement inventory refresh after successful recording
- [ ] T017 Add `on_inventory_changed` callback support

### Implementation Notes
1. Follow modal pattern with sections: header, info, history, actions
2. Use ProductionHistoryTable from WP01
3. Open RecordProductionDialog from WP02 when button clicked
4. After recording success, refresh own data and call callback

### Parallel Opportunities
- None within this package

### Dependencies
- Depends on WP01 (ProductionHistoryTable)
- Depends on WP02 (RecordProductionDialog)

### Risks & Mitigations
- Dialog stacking: Ensure modal behavior works with nested dialogs
- Stale data after recording: Force refresh on dialog return

---

## Work Package WP04: FinishedUnits Tab Integration (Priority: P1) MVP

**Goal**: Wire FinishedUnitsTab to open detail dialog on row selection/double-click.
**Independent Test**: Double-clicking a FinishedUnit in the list opens detail dialog.
**Prompt**: `tasks/planned/WP04-finished-units-tab-integration.md`

### Included Subtasks
- [ ] T018 Add "View Details" button to FinishedUnitsTab action bar
- [ ] T019 Implement `_show_detail_dialog()` method
- [ ] T020 Wire double-click handler to show detail dialog
- [ ] T021 Pass `on_inventory_changed` callback to refresh list
- [ ] T022 Update `src/ui/forms/__init__.py` with new dialog exports

### Implementation Notes
1. Add button alongside existing Edit/Delete buttons
2. Reuse existing selection validation pattern
3. Refresh data table after dialog closes if inventory changed

### Parallel Opportunities
- None within this package

### Dependencies
- Depends on WP03 (FinishedUnitDetailDialog)

### Risks & Mitigations
- Button state management: Follow existing enable/disable pattern
- List refresh timing: Callback ensures immediate update

---

## Work Package WP05: Assembly Recording Dialog (Priority: P2)

**Goal**: Implement the Record Assembly dialog with component availability check.
**Independent Test**: Dialog opens, shows component availability, accepts quantity, returns result.
**Prompt**: `tasks/planned/WP05-assembly-recording-dialog.md`

### Included Subtasks
- [ ] T023 Create RecordAssemblyDialog in `src/ui/forms/record_assembly_dialog.py`
- [ ] T024 Implement dialog layout (quantity, notes, availability display)
- [ ] T025 Implement availability check on dialog open
- [ ] T026 Implement "Refresh Availability" button handler
- [ ] T027 Implement Confirm button with service integration
- [ ] T028 Add validation (quantity >= 1)

### Implementation Notes
1. Similar structure to RecordProductionDialog
2. Use AvailabilityDisplay with component data (FUs, FGs, packaging)
3. Call `record_assembly()` via UIServiceIntegrator

### Parallel Opportunities
- Can proceed in parallel with WP04 after WP01 complete

### Dependencies
- Depends on WP01 (AvailabilityDisplay widget)

### Risks & Mitigations
- Component type display: Format appropriately for FU vs packaging

---

## Work Package WP06: FinishedGood Detail Dialog (Priority: P2)

**Goal**: Create the FinishedGood detail modal with composition, assembly history, and Record Assembly button.
**Independent Test**: Dialog displays FinishedGood info, shows composition and history, Record Assembly works.
**Prompt**: `tasks/planned/WP06-finished-good-detail-dialog.md`

### Included Subtasks
- [ ] T029 Create FinishedGoodDetailDialog in `src/ui/forms/finished_good_detail.py`
- [ ] T030 Implement header section (name)
- [ ] T031 Implement info section (inventory count, total cost)
- [ ] T032 Implement composition display section
- [ ] T033 Integrate AssemblyHistoryTable widget
- [ ] T034 Implement "Record Assembly" button opening RecordAssemblyDialog
- [ ] T035 Implement inventory refresh after successful assembly
- [ ] T036 Add `on_inventory_changed` callback support

### Implementation Notes
1. Composition section: List FU components with quantities
2. Handle case where no composition defined (disable Record Assembly)
3. Use AssemblyHistoryTable from WP01

### Parallel Opportunities
- None within this package

### Dependencies
- Depends on WP01 (AssemblyHistoryTable)
- Depends on WP05 (RecordAssemblyDialog)

### Risks & Mitigations
- Missing composition: Graceful handling with disabled button + tooltip

---

## Work Package WP07: FinishedGoods Tab Integration (Priority: P2)

**Goal**: Wire FinishedGoodsTab to open detail dialog on row selection/double-click.
**Independent Test**: Double-clicking a FinishedGood in the list opens detail dialog.
**Prompt**: `tasks/planned/WP07-finished-goods-tab-integration.md`

### Included Subtasks
- [ ] T037 Add "View Details" button to FinishedGoodsTab action bar
- [ ] T038 Implement `_show_detail_dialog()` method
- [ ] T039 Wire double-click handler to show detail dialog
- [ ] T040 Pass `on_inventory_changed` callback to refresh list
- [ ] T041 Update `src/ui/forms/__init__.py` with assembly dialog exports

### Implementation Notes
1. Mirror pattern from WP04 (FinishedUnitsTab integration)
2. May need to create finished_goods_tab.py if it doesn't exist

### Parallel Opportunities
- Can proceed in parallel with WP06 once WP05 complete

### Dependencies
- Depends on WP06 (FinishedGoodDetailDialog)

### Risks & Mitigations
- Tab may not exist: Check and create if needed

---

## Work Package WP08: Production Dashboard Tab (Priority: P3)

**Goal**: Create the new Production Dashboard tab replacing old production_tab.py.
**Independent Test**: Tab displays recent production and assembly runs, navigation links work.
**Prompt**: `tasks/planned/WP08-production-dashboard-tab.md`

### Included Subtasks
- [ ] T042 Create ProductionDashboardTab in `src/ui/production_dashboard_tab.py`
- [ ] T043 Implement CTkTabview with Production/Assembly sub-tabs
- [ ] T044 Implement recent production runs table (30 days)
- [ ] T045 Implement recent assembly runs table (30 days)
- [ ] T046 Add navigation links to FinishedUnits/FinishedGoods tabs
- [ ] T047 Update main_window.py to use new tab
- [ ] T048 Mark old production_tab.py as deprecated

### Implementation Notes
1. Use CTkTabview for sub-tab organization
2. Reuse ProductionHistoryTable and AssemblyHistoryTable from WP01
3. Call `get_production_history()` and `get_assembly_history()` with date filter
4. Navigation: Access parent tab control to switch tabs

### Parallel Opportunities
- T044 and T045 can proceed in parallel

### Dependencies
- Depends on WP01 (history tables)
- Should complete after WP04 and WP07 for full workflow testing

### Risks & Mitigations
- Old tab references: Search codebase before deprecating
- Tab navigation: May require parent reference or event system

---

## Dependency & Execution Summary

```
WP01 (Widgets) ──────┬──────────────────────────────────────┐
                     │                                      │
                     ▼                                      ▼
           WP02 (Prod Dialog)                     WP05 (Asm Dialog)
                     │                                      │
                     ▼                                      ▼
           WP03 (FU Detail)                       WP06 (FG Detail)
                     │                                      │
                     ▼                                      ▼
           WP04 (FU Tab) ◄──────────────────────► WP07 (FG Tab)
                     │                                      │
                     └──────────────┬───────────────────────┘
                                    ▼
                           WP08 (Dashboard)
```

- **Sequence**: WP01 → (WP02, WP05 parallel) → (WP03, WP06) → (WP04, WP07) → WP08
- **Parallelization**: After WP01, production (WP02-04) and assembly (WP05-07) tracks can proceed in parallel
- **MVP Scope**: WP01 + WP02 + WP03 + WP04 (Production recording complete)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | AvailabilityDisplay widget | WP01 | P0 | No |
| T002 | ProductionHistoryTable | WP01 | P0 | Yes |
| T003 | AssemblyHistoryTable | WP01 | P0 | Yes |
| T004 | Widget exports | WP01 | P0 | No |
| T005 | RecordProductionDialog class | WP02 | P1 | No |
| T006 | Production dialog layout | WP02 | P1 | No |
| T007 | Availability check on open | WP02 | P1 | No |
| T008 | Refresh availability button | WP02 | P1 | No |
| T009 | Confirm with service | WP02 | P1 | No |
| T010 | Production dialog validation | WP02 | P1 | No |
| T011 | FinishedUnitDetailDialog class | WP03 | P1 | No |
| T012 | FU detail header | WP03 | P1 | No |
| T013 | FU detail info section | WP03 | P1 | No |
| T014 | FU history table integration | WP03 | P1 | No |
| T015 | Record Production button | WP03 | P1 | No |
| T016 | Inventory refresh | WP03 | P1 | No |
| T017 | Callback support | WP03 | P1 | No |
| T018 | FU tab View Details button | WP04 | P1 | No |
| T019 | FU tab show detail method | WP04 | P1 | No |
| T020 | FU tab double-click handler | WP04 | P1 | No |
| T021 | FU tab callback wiring | WP04 | P1 | No |
| T022 | Form exports update | WP04 | P1 | No |
| T023 | RecordAssemblyDialog class | WP05 | P2 | No |
| T024 | Assembly dialog layout | WP05 | P2 | No |
| T025 | Assembly availability check | WP05 | P2 | No |
| T026 | Assembly refresh button | WP05 | P2 | No |
| T027 | Assembly confirm with service | WP05 | P2 | No |
| T028 | Assembly dialog validation | WP05 | P2 | No |
| T029 | FinishedGoodDetailDialog class | WP06 | P2 | No |
| T030 | FG detail header | WP06 | P2 | No |
| T031 | FG detail info section | WP06 | P2 | No |
| T032 | FG composition display | WP06 | P2 | No |
| T033 | FG history table integration | WP06 | P2 | No |
| T034 | Record Assembly button | WP06 | P2 | No |
| T035 | FG inventory refresh | WP06 | P2 | No |
| T036 | FG callback support | WP06 | P2 | No |
| T037 | FG tab View Details button | WP07 | P2 | No |
| T038 | FG tab show detail method | WP07 | P2 | No |
| T039 | FG tab double-click handler | WP07 | P2 | No |
| T040 | FG tab callback wiring | WP07 | P2 | No |
| T041 | Assembly form exports | WP07 | P2 | No |
| T042 | ProductionDashboardTab class | WP08 | P3 | No |
| T043 | Dashboard CTkTabview | WP08 | P3 | No |
| T044 | Dashboard production table | WP08 | P3 | Yes |
| T045 | Dashboard assembly table | WP08 | P3 | Yes |
| T046 | Dashboard navigation links | WP08 | P3 | No |
| T047 | main_window.py update | WP08 | P3 | No |
| T048 | Deprecate old production_tab | WP08 | P3 | No |
