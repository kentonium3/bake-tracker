# Implementation Plan: Production & Assembly Recording UI

**Branch**: `014-production-assembly-recording` | **Date**: 2025-12-10 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/kitty-specs/014-production-assembly-recording/spec.md`

## Summary

Add UI components for recording batch production and assembly operations. This includes modal detail views for FinishedUnit and FinishedGood, recording dialogs with availability checks, and a Production Dashboard tab replacing the existing production_tab.py.

**Technical Approach**: Create new modal dialog classes following existing CustomTkinter patterns with modernized styling. Use UIServiceIntegrator for all service calls. Replace (not refactor) the existing production tab.

## Technical Context

**Language/Version**: Python 3.10+
**Primary Dependencies**: CustomTkinter (UI), SQLAlchemy 2.x (ORM)
**Storage**: SQLite with WAL mode
**Testing**: pytest
**Target Platform**: Desktop (Windows, macOS, Linux)
**Project Type**: Single desktop application
**Performance Goals**: Availability check < 1 second, dialog open < 500ms
**Constraints**: Single user, modal dialogs, follow existing patterns
**Scale/Scope**: Single user, ~10-50 recipes, ~100 inventory items

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Desktop Phase Checks

| Check | Status | Notes |
|-------|--------|-------|
| Does this design block web deployment? | PASS | Service layer already separated; UI is desktop-specific by design |
| Is the service layer UI-independent? | PASS | Using existing Feature 013 services unchanged |
| Are business rules in services, not UI? | PASS | All FIFO, costing, validation in services |
| What's the web migration cost? | LOW | Dialogs would become React components; API already exists in services |

### Architecture Compliance

| Principle | Status | Evidence |
|-----------|--------|----------|
| User-Centric Design | PASS | Modal dialogs confirmed with user; availability check before commit |
| Data Integrity & FIFO | PASS | Using existing Feature 013 atomic transactions |
| Layered Architecture | PASS | UI calls services via UIServiceIntegrator |
| Test-Driven Development | PASS | Unit tests for dialogs, integration tests for workflows |

## Project Structure

### Documentation (this feature)

```
kitty-specs/014-production-assembly-recording/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 research findings
├── data-model.md        # Entity documentation
├── quickstart.md        # Development guide
├── contracts/           # UI component contracts
│   └── ui-components.md
├── research/            # Evidence trail
│   ├── evidence-log.csv
│   └── source-register.csv
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Generated by /spec-kitty.tasks
```

### Source Code (repository root)

```
src/
├── ui/
│   ├── forms/
│   │   ├── record_production_dialog.py   # NEW
│   │   ├── record_assembly_dialog.py     # NEW
│   │   ├── finished_unit_detail.py       # NEW
│   │   └── finished_good_detail.py       # NEW
│   ├── widgets/
│   │   ├── availability_display.py       # NEW
│   │   ├── production_history_table.py   # NEW
│   │   └── assembly_history_table.py     # NEW
│   ├── production_dashboard_tab.py       # NEW (replaces production_tab.py)
│   ├── finished_units_tab.py             # MODIFY
│   ├── finished_goods_tab.py             # MODIFY
│   └── main_window.py                    # MODIFY
├── services/
│   ├── batch_production_service.py       # EXISTS (Feature 013)
│   └── assembly_service.py               # EXISTS (Feature 013)
└── tests/
    └── ui/
        ├── test_record_production_dialog.py   # NEW
        ├── test_record_assembly_dialog.py     # NEW
        ├── test_finished_unit_detail.py       # NEW
        ├── test_finished_good_detail.py       # NEW
        └── test_production_dashboard_tab.py   # NEW
```

**Structure Decision**: Single desktop application structure. New UI components added to existing `src/ui/` hierarchy following established patterns.

## Complexity Tracking

*No constitution violations requiring justification.*

## Design Decisions

### 1. Dialog Pattern

**Decision**: New separate dialog classes (not extending form dialogs)
**Rationale**: User confirmed; detail views have different purpose than CRUD forms
**Files**: `finished_unit_detail.py`, `finished_good_detail.py`

### 2. Production Tab Replacement

**Decision**: Create new `ProductionDashboardTab`, deprecate old `production_tab.py`
**Rationale**: User confirmed; existing tab has event-based structure incompatible with new requirements
**Migration**: Update `main_window.py` imports, keep old file initially for reference

### 3. Availability Check Timing

**Decision**: Check on dialog open + manual "Refresh" button
**Rationale**: User confirmed; avoids real-time API calls during typing
**Implementation**: Call service on dialog init, add "Refresh Availability" button

### 4. Styling Approach

**Decision**: Follow existing patterns but modernize styling
**Rationale**: User confirmed consistency with incremental improvement
**Changes**: Consistent corner_radius, improved spacing, clear visual hierarchy

## Component Specifications

### AvailabilityDisplay Widget

Reusable widget showing availability check results with color coding.

**Properties**:
- Scrollable frame for long ingredient lists
- Green/red status indicators per item
- "Need X, have Y" format for insufficient items
- Overall status indicator

**Used by**: RecordProductionDialog, RecordAssemblyDialog

### RecordProductionDialog

Modal dialog for batch production recording.

**Inputs**:
- Batch count (integer, default 1, min 1)
- Actual yield (integer, default calculated, min 0)
- Notes (optional text)

**Behavior**:
- Calculates expected yield from batch count and FinishedUnit.items_per_batch
- Disables Confirm when availability insufficient
- Calls `record_batch_production()` on confirm

### RecordAssemblyDialog

Modal dialog for assembly recording.

**Inputs**:
- Quantity (integer, default 1, min 1)
- Notes (optional text)

**Behavior**:
- Disables Confirm when availability insufficient
- Calls `record_assembly()` on confirm

### FinishedUnitDetailDialog

Modal showing FinishedUnit details with production capability.

**Sections**:
1. Header (name, category)
2. Info (recipe, inventory count, unit cost)
3. Production history table
4. Action buttons (Record Production, Close)

**Callbacks**: `on_inventory_changed` to notify parent

### FinishedGoodDetailDialog

Modal showing FinishedGood details with assembly capability.

**Sections**:
1. Header (name)
2. Info (inventory count, total cost)
3. Composition list (components)
4. Assembly history table
5. Action buttons (Record Assembly, Close)

**Callbacks**: `on_inventory_changed` to notify parent

### ProductionDashboardTab

Tab with recent production and assembly activity.

**Layout**: CTkTabview with two sub-tabs
- "Production Runs" - recent 30 days
- "Assembly Runs" - recent 30 days

**Navigation**: Links to FinishedUnits and FinishedGoods tabs

## Implementation Phases

### Phase 1: Core Widgets (P1)

1. AvailabilityDisplay widget
2. ProductionHistoryTable widget
3. AssemblyHistoryTable widget

### Phase 2: Production Recording (P1)

4. RecordProductionDialog
5. FinishedUnitDetailDialog
6. Update FinishedUnitsTab (add detail view trigger)

### Phase 3: Assembly Recording (P2)

7. RecordAssemblyDialog
8. FinishedGoodDetailDialog
9. Update FinishedGoodsTab (add detail view trigger)

### Phase 4: Dashboard (P3)

10. ProductionDashboardTab
11. Update main_window.py
12. Deprecate old production_tab.py

## Testing Strategy

### Unit Tests

- Dialog field validation
- Availability display rendering
- History table formatting
- Button state management

### Integration Tests

- Full recording workflow (dialog -> service -> database)
- Inventory count updates
- History display after recording

### Manual Acceptance Tests

- Complete production recording workflow
- Complete assembly recording workflow
- Dashboard navigation
- Error handling (insufficient inventory)

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Old production_tab.py has external references | Medium | Search codebase before deprecation |
| Feature 013 API changes | Low | Services are stable; verify compatibility |
| UI inconsistency with modernized styling | Low | Incremental changes, user review |

## Definition of Done

- [ ] All P1 user stories have passing acceptance tests
- [ ] All P2 user stories have passing acceptance tests
- [ ] All P3 user stories have passing acceptance tests
- [ ] Unit test coverage > 70% for new UI components
- [ ] Integration tests pass for full workflows
- [ ] No regressions in existing tests
- [ ] Code follows existing patterns and constitution
- [ ] Documentation updated (quickstart.md accurate)
