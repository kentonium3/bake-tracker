# Work Packages: Ingredient Aggregation for Batch Decisions

**Inputs**: Design documents from `/kitty-specs/074-ingredient-aggregation/`
**Prerequisites**: plan.md (required), spec.md (user stories)

**Tests**: Unit tests required per TDD principle (Constitution IV).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Service Foundation & Single-Recipe Aggregation (Priority: P0) MVP

**Goal**: Create ingredient aggregation service with dataclass and implement single-recipe ingredient scaling.
**Independent Test**: Can aggregate ingredients for a single recipe with batch decision.
**Prompt**: `/tasks/WP01-service-foundation.md`
**Estimated Size**: ~300 lines

### Included Subtasks
- [ ] T001 Create IngredientTotal dataclass in `src/services/ingredient_aggregation_service.py`
- [ ] T002 Create service file structure with session management pattern
- [ ] T003 Implement `_scale_recipe_ingredients()` helper function
- [ ] T004 Implement `aggregate_ingredients_for_event()` for single-recipe case
- [ ] T005 Write unit tests for single-recipe aggregation in `src/tests/test_ingredient_aggregation_service.py`

### Implementation Notes
1. Follow CLAUDE.md session management pattern (all public functions accept `session=None`)
2. Use existing models: BatchDecision, Recipe, RecipeIngredient, Ingredient
3. Key formula: `scaled_qty = recipe_ingredient.quantity × batch_decision.batches`
4. Return Dict[Tuple[int, str], IngredientTotal] keyed by (ingredient_id, unit)

### Parallel Opportunities
- None within this WP - sequential implementation required

### Dependencies
- None (foundation package)

### Risks & Mitigations
- Session detachment: Follow CLAUDE.md session passing pattern strictly
- Model relationship loading: Use eager loading via existing relationship definitions

---

## Work Package WP02: Cross-Recipe Aggregation & Edge Cases (Priority: P1)

**Goal**: Extend aggregation to handle multiple recipes sharing ingredients and all edge cases.
**Independent Test**: Can aggregate ingredients across 2+ recipes, handling same ingredient in different units.
**Prompt**: `/tasks/WP02-cross-recipe-aggregation.md`
**Estimated Size**: ~280 lines
**Dependencies**: WP01

### Included Subtasks
- [ ] T006 Implement cross-recipe aggregation (same ingredient_id + unit = combined total)
- [ ] T007 Handle edge cases: empty event, recipe with no ingredients, zero batches
- [ ] T008 Implement 3-decimal precision rounding for final totals
- [ ] T009 Write unit tests for cross-recipe aggregation scenarios
- [ ] T010 Write unit tests for edge cases and precision

### Implementation Notes
1. Aggregation key is (ingredient_id, unit) tuple - same ingredient in different units stays separate
2. Use `round(value, 3)` only on final output, not intermediate calculations
3. Empty event returns empty dict, not error
4. Recipe with no ingredients is skipped silently

### Parallel Opportunities
- T009 and T010 can be written in parallel (different test scenarios)

### Dependencies
- Depends on WP01 (service structure must exist)

### Risks & Mitigations
- Floating point drift: Round only at output, not during accumulation
- Unit mismatch: Explicitly documented as separate entries (FR-003)

---

## Dependency & Execution Summary

- **Sequence**: WP01 → WP02
- **Parallelization**: WP01 must complete first; within WP02, test subtasks can parallelize
- **MVP Scope**: WP01 provides core functionality; WP02 adds robustness

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Create IngredientTotal dataclass | WP01 | P0 | No |
| T002 | Create service file structure | WP01 | P0 | No |
| T003 | Implement _scale_recipe_ingredients() | WP01 | P0 | No |
| T004 | Implement aggregate_ingredients_for_event() | WP01 | P0 | No |
| T005 | Write single-recipe unit tests | WP01 | P0 | No |
| T006 | Implement cross-recipe aggregation | WP02 | P1 | No |
| T007 | Handle edge cases | WP02 | P1 | No |
| T008 | Implement precision rounding | WP02 | P1 | No |
| T009 | Write cross-recipe unit tests | WP02 | P1 | Yes |
| T010 | Write edge case unit tests | WP02 | P1 | Yes |
