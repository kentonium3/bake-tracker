# Implementation Plan: Streamlined Inventory Entry

**Branch**: `029-streamlined-inventory-entry` | **Date**: 2025-12-24 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `kitty-specs/029-streamlined-inventory-entry/spec.md`

## Summary

Transform inventory entry from a tedious 15-20 minute workflow to a 5-minute flow-optimized experience. Key enhancements include type-ahead filtering on Category/Ingredient/Product dropdowns, recency intelligence (30-day temporal OR 3+ frequency in 90 days), session memory for supplier/category persistence, inline product creation with smart defaults, and price suggestions from purchase history.

**Technical Approach**:
- SessionState singleton in UI layer (`src/ui/session_state.py`)
- TypeAheadComboBox reusable widget (`src/ui/widgets/type_ahead_combobox.py`)
- Recency queries extend `inventory_item_service.py`
- No database schema changes (all in-memory structures)

## Technical Context

**Language/Version**: Python 3.10+ (type hints, modern syntax)
**Primary Dependencies**: CustomTkinter (UI), SQLAlchemy 2.x (ORM)
**Storage**: SQLite with WAL mode (existing, no changes)
**Testing**: pytest with fixtures
**Target Platform**: Desktop (macOS/Windows/Linux)
**Project Type**: Single desktop application
**Performance Goals**: <100ms dropdown filtering, <200ms recency queries
**Constraints**: Client-side filtering only, in-memory session state
**Scale/Scope**: Single user, ~500 products, ~300 ingredients, ~20 suppliers

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Evidence |
|-----------|--------|----------|
| I. User-Centric Design | PASS | Optimizes for common case (bulk shopping trip entry) |
| II. Data Integrity & FIFO | PASS | No changes to FIFO logic; session state is non-critical |
| III. Future-Proof Schema | PASS | No schema changes; recency queries support future analytics |
| IV. Test-Driven Development | PASS | Unit tests for session state, recency queries, widgets |
| V. Layered Architecture | PASS | SessionState in UI layer, recency queries in services |
| VI. Schema Change Strategy | PASS | N/A - no schema changes required |
| VII. Pragmatic Aspiration | PASS | Pragmatic widget approach, no over-engineering |

**Post-Phase 1 Re-check**: PASSED - Design maintains layer separation, all new code is testable.

## Project Structure

### Documentation (this feature)

```
kitty-specs/029-streamlined-inventory-entry/
├── spec.md              # Feature specification (6 user stories, 34 FRs)
├── plan.md              # This file
├── research.md          # Phase 0 research findings
├── data-model.md        # Entity documentation
├── quickstart.md        # Development quickstart guide
├── research/
│   ├── evidence-log.csv # Research evidence audit trail
│   └── source-register.csv # Source references
├── checklists/
│   └── requirements.md  # Specification quality checklist
└── tasks.md             # Phase 2 output (generated by /spec-kitty.tasks)
```

### Source Code (repository root)

```
src/
├── models/              # Existing - no changes
├── services/
│   └── inventory_item_service.py  # MODIFY: Add recency queries
├── ui/
│   ├── session_state.py           # NEW: SessionState singleton
│   ├── widgets/
│   │   ├── type_ahead_combobox.py # NEW: TypeAheadComboBox widget
│   │   └── dropdown_builders.py   # NEW: Recency-aware builders
│   └── dialogs/
│       └── add_inventory_dialog.py # MODIFY: Major refactor
├── utils/
│   └── category_defaults.py       # NEW: Category-to-unit mapping
└── tests/
    ├── ui/
    │   └── test_session_state.py  # NEW: Session state tests
    ├── services/
    │   └── test_inventory_item_service.py # MODIFY: Add recency tests
    ├── utils/
    │   └── test_category_defaults.py # NEW: Defaults tests
    └── integration/
        └── test_add_inventory_dialog.py # NEW: Dialog integration tests
```

**Structure Decision**: Single project layout (existing bake-tracker pattern). New files created in logical locations following established directory structure.

## Planning Decisions

### PD-001: Session State Architecture

**Decision**: Application-level SessionState singleton in `src/ui/session_state.py`

**Implementation**:
```python
class SessionState:
    _instance = None

    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
            cls._instance.last_supplier_id = None
            cls._instance.last_category = None
        return cls._instance

    def reset(self):
        """For test isolation"""
        self.last_supplier_id = None
        self.last_category = None
```

**Checklist**:
- [ ] Create `src/ui/session_state.py` with SessionState singleton
- [ ] Add `reset()` method for test isolation
- [ ] Dialogs import and use `get_session_state()`
- [ ] Update session state only on successful "Add" action
- [ ] Unit tests verify singleton behavior and persistence

---

### PD-002: Type-Ahead Widget

**Decision**: Custom `TypeAheadComboBox` widget in `src/ui/widgets/type_ahead_combobox.py`

**Implementation Notes**:
- Subclass `CTkFrame`, wrap `CTkComboBox`
- Implement filtering logic (contains + word boundary prioritization)
- Do NOT override CTk's dropdown rendering (use built-in)
- Do NOT reimplement keyboard navigation (use CTk's native)
- Focus on filtering algorithm correctness

**Filtering Algorithm**:
```python
def _filter_values(self, typed: str) -> List[str]:
    typed_lower = typed.lower()
    word_boundary = []  # Higher priority
    contains = []       # Lower priority

    for value in self.full_values:
        words = value.lower().split()
        if any(word.startswith(typed_lower) for word in words):
            word_boundary.append(value)
        elif typed_lower in value.lower():
            contains.append(value)

    return word_boundary + contains
```

---

### PD-003: Recency Query Location

**Decision**: Extend `src/services/inventory_item_service.py`

**Methods to Add**:
```python
def get_recent_products(
    ingredient_id: int,
    days: int = 30,
    min_frequency: int = 3,
    frequency_days: int = 90,
    limit: int = 20,
    session: Optional[Session] = None
) -> List[int]:
    """Return product IDs meeting recency criteria."""

def get_recent_ingredients(
    category: str,
    days: int = 30,
    min_frequency: int = 3,
    frequency_days: int = 90,
    limit: int = 20,
    session: Optional[Session] = None
) -> List[int]:
    """Return ingredient IDs meeting recency criteria."""
```

---

### PD-004: Category-to-Unit Defaults

**Decision**: Configuration dict in `src/utils/category_defaults.py`

```python
CATEGORY_DEFAULT_UNITS = {
    'Baking': 'lb',
    'Chocolate': 'oz',
    'Dairy': 'lb',
    'Spices': 'oz',
    'Liquids': 'fl oz',
    'Nuts': 'lb',
    'Fruits': 'lb',
    'Sweeteners': 'lb',
    'Leavening': 'oz',
    'Oils': 'fl oz',
    'Grains': 'lb',
}

def get_default_unit_for_category(category: str) -> str:
    return CATEGORY_DEFAULT_UNITS.get(category, 'lb')
```

---

## Implementation Phases

### Phase 1: Foundation (No UI Changes)
1. SessionState singleton with tests
2. Category defaults utility with tests
3. Recency query methods with tests

### Phase 2: Widget Layer
4. TypeAheadComboBox widget with tests
5. Dropdown builders (recency-aware) with tests

### Phase 3: Dialog Integration
6. AddInventoryDialog refactor - type-ahead dropdowns
7. AddInventoryDialog refactor - session memory
8. AddInventoryDialog refactor - inline product creation
9. AddInventoryDialog refactor - price suggestions
10. AddInventoryDialog refactor - validation warnings

### Phase 4: Polish & Testing
11. Integration tests for full workflow
12. User acceptance testing
13. Performance validation

## Complexity Tracking

*No constitution violations. All implementations follow existing patterns.*

| Decision | Complexity | Justification |
|----------|------------|---------------|
| SessionState singleton | Low | Simple pattern, well-tested |
| TypeAheadComboBox | Medium | Reusable widget, focused scope |
| Recency queries | Medium | SQL queries, cached results |
| Dialog refactor | High | Many interacting features |

## Dependencies

| Dependency | Status | Notes |
|------------|--------|-------|
| F027 Product Catalog | COMPLETE | Product/Supplier entities available |
| F028 Purchase Tracking | COMPLETE | Price history queries available |

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Type-ahead performance | Client-side filtering, limit to 20 results |
| Session state loss on crash | Documented as expected, non-critical data |
| Dialog complexity | Progressive disclosure, phased implementation |

## References

- Design Document: `docs/design/F029_streamlined_inventory_entry.md`
- Research: `kitty-specs/029-streamlined-inventory-entry/research.md`
- Data Model: `kitty-specs/029-streamlined-inventory-entry/data-model.md`
- Constitution: `.kittify/memory/constitution.md`
