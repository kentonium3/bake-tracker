# Work Packages: MaterialUnit Schema Refactor

**Inputs**: Design documents from `kitty-specs/084-material-unit-schema-refactor/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: Service layer tests required (>80% coverage target per SC-007).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Wave 1: Schema Foundation (Sequential)

These work packages must complete before Wave 2 can begin.

---

## Work Package WP01: MaterialUnit FK Change (Priority: P0)

**Goal**: Change MaterialUnit's parent from Material to MaterialProduct via FK refactor.
**Independent Test**: MaterialUnit model can be created with material_product_id FK; old material_id FK no longer exists.
**Prompt**: `tasks/WP01-materialunit-fk-change.md`
**Estimated Size**: ~350 lines (5 subtasks)

### Included Subtasks
- [x] T001 Update MaterialUnit model FK from material_id to material_product_id in `src/models/material_unit.py`
- [x] T002 Add UniqueConstraint for (material_product_id, slug) and (material_product_id, name) in `src/models/material_unit.py`
- [x] T003 Add material_units relationship to MaterialProduct in `src/models/material_product.py`
- [x] T004 Remove units relationship from Material in `src/models/material.py`
- [x] T005 Update MaterialUnit model tests in `src/tests/test_material_unit.py`

### Implementation Notes
1. Change FK definition: `material_id` ‚Üí `material_product_id` with CASCADE delete
2. Update relationship: `material` ‚Üí `material_product` with `lazy="joined"`
3. Add compound unique constraints scoped to product
4. Update back_populates on both sides

### Parallel Opportunities
- None within this WP (model changes are interdependent)

### Dependencies
- None (starting package)

### Risks & Mitigations
- Schema change breaks existing tests ‚Üí Run tests after each model change to catch issues early

---

## Work Package WP02: Composition material_id Removal (Priority: P0)

**Goal**: Remove material_id from Composition model and update XOR constraint to 4-way.
**Independent Test**: Composition model has 4-way XOR constraint; material_id field and factory method removed.
**Prompt**: `tasks/WP02-composition-material-id-removal.md`
**Estimated Size**: ~400 lines (7 subtasks)

### Included Subtasks
- [x] T006 Remove material_id column from Composition in `src/models/composition.py`
- [x] T007 Update XOR CheckConstraint from 5-way to 4-way in `src/models/composition.py`
- [x] T008 Remove create_material_placeholder_composition() factory method in `src/models/composition.py`
- [x] T009 Update component_type, component_id, component_name properties in `src/models/composition.py`
- [x] T010 Remove material branch from get_component_cost() and _estimate_material_cost() in `src/models/composition.py`
- [x] T011 Update validate_polymorphic_constraint() for 4-way validation in `src/models/composition.py`
- [x] T012 Update Composition model tests in `src/tests/test_composition.py`

### Implementation Notes
1. Remove material_id column and material_component relationship
2. Rewrite XOR constraint to only include 4 component types
3. Update all helper methods that reference material_id
4. Remove _estimate_material_cost() entirely (no longer needed)

### Parallel Opportunities
- T009, T010, T011 can proceed in parallel after T006-T008

### Dependencies
- Depends on WP01 (MaterialUnit FK must exist before Composition cleanup)

### Risks & Mitigations
- Breaking existing Compositions with material_id ‚Üí Handled by migration script (WP09)

---

## Wave 2: Service Layer (Parallel after Wave 1)

These work packages can execute in parallel once Wave 1 is complete.

---

## Work Package WP03: MaterialUnit Service Updates (Priority: P1)

**Goal**: Update MaterialUnit service to use new material_product_id FK with validation.
**Independent Test**: MaterialUnit service creates/updates units with material_product_id; name uniqueness enforced per product.
**Prompt**: `tasks/WP03-materialunit-service-updates.md`
**Estimated Size**: ~380 lines (5 subtasks)

### Included Subtasks
- [x] T013 Update MaterialUnit service CRUD to use material_product_id in `src/services/material_unit_service.py`
- [ ] T014 Add name uniqueness validation scoped to product in `src/services/material_unit_service.py`
- [ ] T015 [P] Add slug generation scoped to product in `src/services/material_unit_service.py`
- [ ] T016 Add deletion validation (prevent if referenced by Composition) in `src/services/material_unit_service.py`
- [ ] T017 Update MaterialUnit service tests in `src/tests/test_material_unit_service.py`

### Implementation Notes
1. Change all material_id references to material_product_id
2. Slug uniqueness now scoped to material_product_id (not global)
3. Name uniqueness validation prevents duplicates within same product
4. Deletion check queries Composition table for references

### Parallel Opportunities
- T015 (slug generation) can proceed alongside T014 (name validation)

### Dependencies
- Depends on WP01, WP02 (schema changes must be complete)

### Risks & Mitigations
- Service calls may fail if models not updated ‚Üí Verify model changes before starting

---

## Work Package WP04: Auto-Generation in MaterialProduct Service (Priority: P1) üéØ MVP

**Goal**: Auto-generate MaterialUnit when creating MaterialProduct with package_count.
**Independent Test**: Creating MaterialProduct with package_count=100 auto-creates "1 {name}" MaterialUnit.
**Prompt**: `tasks/WP04-auto-generation-materialproduct.md`
**Estimated Size**: ~350 lines (5 subtasks)

### Included Subtasks
- [ ] T018 Add auto-generation logic to create_material_product() in `src/services/material_product_service.py`
- [ ] T019 Implement _should_auto_generate_unit() helper in `src/services/material_product_service.py`
- [ ] T020 Implement _create_auto_generated_unit() helper in `src/services/material_product_service.py`
- [ ] T021 [P] Add slug generation for auto-generated units in `src/services/material_product_service.py`
- [ ] T022 Add MaterialProduct service tests for auto-generation in `src/tests/test_material_product_service.py`

### Implementation Notes
1. Auto-generate only when: package_count IS NOT NULL AND package_length_m IS NULL AND package_sq_m IS NULL
2. Unit name format: "1 {product.name}"
3. quantity_per_unit: 1.0
4. Use session from parent transaction to ensure atomicity

### Parallel Opportunities
- T021 (slug generation) can proceed alongside T019-T020

### Dependencies
- Depends on WP01, WP03 (MaterialUnit FK and service must work)

### Risks & Mitigations
- Auto-generation creates unwanted units ‚Üí Allow deletion if not referenced

---

## Work Package WP05: Composition Service Cleanup (Priority: P1)

**Goal**: Remove material_id support from Composition service layer.
**Independent Test**: CompositionService no longer accepts or returns material_id; only material_unit_id works.
**Prompt**: `tasks/WP05-composition-service-cleanup.md`
**Estimated Size**: ~280 lines (4 subtasks)

### Included Subtasks
- [ ] T023 Remove material_id support from CompositionService in `src/services/composition_service.py`
- [ ] T024 Update create_composition() to reject material_id parameter in `src/services/composition_service.py`
- [ ] T025 Update get_compositions() to not return material_id in `src/services/composition_service.py`
- [ ] T026 Update Composition service tests in `src/tests/test_composition_service.py`

### Implementation Notes
1. Remove any create_material_composition() or similar methods
2. Ensure material_unit_id remains the only path for material components
3. Update any queries that filter/join on material_id

### Parallel Opportunities
- Can run in parallel with WP03 and WP04 (different service files)

### Dependencies
- Depends on WP02 (Composition model cleanup)

### Risks & Mitigations
- Existing code may call removed methods ‚Üí Search for usages before removing

---

## Wave 3: Export/Import & UI (Parallel after Wave 2)

These work packages can execute in parallel once Wave 2 is complete.

---

## Work Package WP06: Export/Import Updates (Priority: P2)

**Goal**: Update export/import to use material_product_slug for MaterialUnits.
**Independent Test**: Export‚ÜíImport round-trip preserves MaterialUnit relationships via material_product_slug.
**Prompt**: `tasks/WP06-export-import-updates.md`
**Estimated Size**: ~380 lines (5 subtasks)

### Included Subtasks
- [ ] T027 Update MaterialUnit export to use material_product_slug in `src/services/import_export_service.py`
- [ ] T028 Update MaterialUnit import to resolve material_product_slug in `src/services/catalog_import_service.py`
- [ ] T029 [P] Update Composition export to not include material_id in `src/services/import_export_service.py`
- [ ] T030 [P] Update Composition import to skip records with material_id in `src/services/catalog_import_service.py`
- [ ] T031 Add export/import tests for MaterialUnit with new FK in `src/tests/test_import_export_service.py`

### Implementation Notes
1. Export: Replace material_slug with material_product_slug
2. Import: Build lookup dict for MaterialProduct slugs
3. Composition import: Log skipped records with material_id for user review
4. Follow existing FK resolution pattern from other services

### Parallel Opportunities
- T029-T030 (Composition changes) can proceed alongside T027-T028 (MaterialUnit changes)

### Dependencies
- Depends on WP03 (MaterialUnit service must handle material_product_id)

### Risks & Mitigations
- Existing exports may have material_slug ‚Üí Migration script handles transformation

---

## Work Package WP07: MaterialProduct Form Sub-Section UI (Priority: P2)

**Goal**: Add MaterialUnits sub-section to MaterialProduct create/edit form.
**Independent Test**: MaterialProduct form displays MaterialUnits list with Add/Edit/Delete functionality.
**Prompt**: `tasks/WP07-materialproduct-form-subsection.md`
**Estimated Size**: ~400 lines (5 subtasks)

### Included Subtasks
- [ ] T032 Add MaterialUnits list display in MaterialProduct form in `src/ui/tabs/materials_tab.py`
- [ ] T033 Add conditional "Add Unit" button (hidden for package_count products) in `src/ui/tabs/materials_tab.py`
- [ ] T034 [P] Add edit/delete functionality for MaterialUnits in `src/ui/tabs/materials_tab.py`
- [ ] T035 [P] Add MaterialUnit create/edit dialog in `src/ui/dialogs/material_unit_dialog.py`
- [ ] T036 Integrate MaterialUnits with MaterialProduct save workflow in `src/ui/tabs/materials_tab.py`

### Implementation Notes
1. Follow Recipe‚ÜíFinishedUnits sub-form pattern from recipes_tab.py
2. List columns: Name, Quantity per Unit
3. "Add Unit" button only visible when package_count is NULL (linear/area products)
4. Auto-generated units are fully editable

### Parallel Opportunities
- T034-T035 (edit/delete, dialog) can proceed alongside T032-T033 (list, button)

### Dependencies
- Depends on WP03, WP04 (MaterialUnit and MaterialProduct services)

### Risks & Mitigations
- UI pattern mismatch ‚Üí Study Recipe‚ÜíFinishedUnits pattern before implementing

---

## Work Package WP08: Units Tab Read-Only + Detail Popup (Priority: P2)

**Goal**: Update Materials‚ÜíUnits tab to read-only list with detail popup.
**Independent Test**: Units tab displays all MaterialUnits; clicking row shows MaterialProduct popup; no "Add Unit" button.
**Prompt**: `tasks/WP08-units-tab-readonly-popup.md`
**Estimated Size**: ~320 lines (4 subtasks)

### Included Subtasks
- [ ] T037 Update Units tab to read-only (remove "Add Unit" button) in `src/ui/tabs/materials_tab.py`
- [ ] T038 Update Units tab columns (Name, Material, Product, Quantity per Unit) in `src/ui/tabs/materials_tab.py`
- [ ] T039 [P] Create MaterialProduct detail popup dialog in `src/ui/dialogs/material_product_popup.py`
- [ ] T040 Add click handler to show popup on row click in `src/ui/tabs/materials_tab.py`

### Implementation Notes
1. Remove any "Add Unit" or "Create" buttons from Units tab
2. Add "Product" column to show parent MaterialProduct name
3. Popup shows MaterialProduct details (not full edit form)
4. Changed from accordion to popup per planning decision

### Parallel Opportunities
- T039 (popup dialog) can proceed alongside T037-T038 (tab updates)

### Dependencies
- Depends on WP03 (MaterialUnit service for queries with product info)

### Risks & Mitigations
- Existing "Add Unit" functionality may be relied upon ‚Üí Document in release notes

---

## Wave 4: Migration (Sequential after Wave 3)

---

## Work Package WP09: Migration Transformation Script (Priority: P3)

**Goal**: Create standalone script to transform old-format exports to new schema.
**Independent Test**: Script transforms MaterialUnits from material_slug to material_product_slug with N√óM duplication.
**Prompt**: `tasks/WP09-migration-script.md`
**Estimated Size**: ~380 lines (5 subtasks)

### Included Subtasks
- [ ] T041 Create scripts/migrate_material_units.py skeleton with CLI interface
- [ ] T042 Implement MaterialUnit duplication transformation (N products √ó M units) in `scripts/migrate_material_units.py`
- [ ] T043 Implement orphan detection (Materials with 0 products ‚Üí unmigrateable) in `scripts/migrate_material_units.py`
- [ ] T044 Implement Composition material_id skip logging in `scripts/migrate_material_units.py`
- [ ] T045 Add migration script tests in `src/tests/test_migrate_material_units.py`

### Implementation Notes
1. CLI: `python scripts/migrate_material_units.py input.json output.json`
2. For each MaterialUnit with material_slug:
   - Find all MaterialProducts for that Material
   - Create N copies with material_product_slug
3. Log orphaned MaterialUnits (no products to assign)
4. Log Compositions with material_id (user must fix)

### Parallel Opportunities
- T043-T044 (orphan detection, skip logging) can proceed alongside T042 (transformation)

### Dependencies
- Depends on WP06 (must match final export/import format)

### Risks & Mitigations
- Migration creates too many duplicates ‚Üí Log count for user awareness

---

## Dependency & Execution Summary

```
Wave 1 (Sequential):
  WP01 ‚Üí WP02

Wave 2 (Parallel, after Wave 1):
  WP03 ‚îÄ‚îÄ‚îê
  WP04 ‚îÄ‚îÄ‚îº‚îÄ‚îÄ (parallel)
  WP05 ‚îÄ‚îÄ‚îò

Wave 3 (Parallel, after Wave 2):
  WP06 ‚îÄ‚îÄ‚îê
  WP07 ‚îÄ‚îÄ‚îº‚îÄ‚îÄ (parallel)
  WP08 ‚îÄ‚îÄ‚îò

Wave 4 (Sequential, after Wave 3):
  WP09
```

**MVP Scope**: WP01 + WP02 + WP03 + WP04 deliver the core schema change and auto-generation functionality.

**Parallelization**: After WP01-WP02 complete, up to 3 agents can work on WP03-WP05 simultaneously. After Wave 2, up to 3 agents can work on WP06-WP08.

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | MaterialUnit FK change | WP01 | P0 | No |
| T002 | Add unique constraints | WP01 | P0 | No |
| T003 | Add MaterialProduct.material_units | WP01 | P0 | No |
| T004 | Remove Material.units | WP01 | P0 | No |
| T005 | MaterialUnit model tests | WP01 | P0 | No |
| T006 | Remove Composition.material_id | WP02 | P0 | No |
| T007 | Update XOR constraint | WP02 | P0 | No |
| T008 | Remove factory method | WP02 | P0 | No |
| T009 | Update component properties | WP02 | P0 | Yes |
| T010 | Remove cost methods | WP02 | P0 | Yes |
| T011 | Update validation | WP02 | P0 | Yes |
| T012 | Composition model tests | WP02 | P0 | No |
| T013 | MaterialUnit service CRUD | WP03 | P1 | No |
| T014 | Name uniqueness validation | WP03 | P1 | No |
| T015 | Slug generation scoped | WP03 | P1 | Yes |
| T016 | Deletion validation | WP03 | P1 | No |
| T017 | MaterialUnit service tests | WP03 | P1 | No |
| T018 | Auto-generation logic | WP04 | P1 | No |
| T019 | _should_auto_generate_unit() | WP04 | P1 | No |
| T020 | _create_auto_generated_unit() | WP04 | P1 | No |
| T021 | Slug generation for auto-gen | WP04 | P1 | Yes |
| T022 | MaterialProduct service tests | WP04 | P1 | No |
| T023 | Remove material_id support | WP05 | P1 | No |
| T024 | Update create_composition() | WP05 | P1 | No |
| T025 | Update get_compositions() | WP05 | P1 | No |
| T026 | Composition service tests | WP05 | P1 | No |
| T027 | MaterialUnit export update | WP06 | P2 | No |
| T028 | MaterialUnit import update | WP06 | P2 | No |
| T029 | Composition export update | WP06 | P2 | Yes |
| T030 | Composition import skip | WP06 | P2 | Yes |
| T031 | Export/import tests | WP06 | P2 | No |
| T032 | MaterialUnits list display | WP07 | P2 | No |
| T033 | Conditional "Add Unit" button | WP07 | P2 | No |
| T034 | Edit/delete functionality | WP07 | P2 | Yes |
| T035 | MaterialUnit dialog | WP07 | P2 | Yes |
| T036 | Save workflow integration | WP07 | P2 | No |
| T037 | Units tab read-only | WP08 | P2 | No |
| T038 | Units tab columns update | WP08 | P2 | No |
| T039 | MaterialProduct popup dialog | WP08 | P2 | Yes |
| T040 | Row click handler | WP08 | P2 | No |
| T041 | Migration script skeleton | WP09 | P3 | No |
| T042 | Duplication transformation | WP09 | P3 | No |
| T043 | Orphan detection | WP09 | P3 | Yes |
| T044 | Composition skip logging | WP09 | P3 | Yes |
| T045 | Migration script tests | WP09 | P3 | No |
