# Work Packages: Dual-Yield Recipe Output Support

**Inputs**: Design documents from `kitty-specs/083-dual-yield-recipe-output-support/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: Included for service layer validation per TDD constitution principle.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Model Layer – Add yield_type Field (Priority: P0)

**Goal**: Add `yield_type` column with constraints to FinishedUnit model.
**Independent Test**: Model can be instantiated with yield_type='EA' or 'SERVING'; constraints reject invalid values.
**Prompt**: `tasks/WP01-model-layer-yield-type.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [x] T001 Add yield_type column to FinishedUnit model in `src/models/finished_unit.py`
- [x] T002 Add CHECK constraint `ck_finished_unit_yield_type_valid` for valid values ('EA', 'SERVING')
- [x] T003 Add UNIQUE constraint `uq_finished_unit_recipe_item_unit_yield_type` on (recipe_id, item_unit, yield_type)
- [x] T004 Add index `idx_finished_unit_yield_type` for query performance
- [x] T005 Write model-level unit tests in `src/tests/models/test_finished_unit_yield_type.py`

### Implementation Notes
1. Add column after `yield_mode` in model definition
2. Default value is 'SERVING' (conservative default for existing data)
3. Follow existing constraint naming patterns: `ck_<table>_<description>`, `uq_<table>_<columns>`
4. Constraint patterns documented in research.md Q2

### Parallel Opportunities
- T001-T004 must be sequential (column must exist before constraints)
- T005 can be written in parallel once column is defined

### Dependencies
- None (starting package)

### Risks & Mitigations
- Constraint may reject existing data during import → Migration (WP05) handles by adding yield_type='SERVING' to all records first

---

## Work Package WP02: Service Layer – yield_type Validation (Priority: P0)

**Goal**: Add service-layer validation for yield_type during FinishedUnit CRUD operations.
**Independent Test**: Service rejects invalid yield_type values with clear error messages.
**Prompt**: `tasks/WP02-service-layer-validation.md`
**Estimated Size**: ~300 lines

### Included Subtasks
- [x] T006 Add VALID_YIELD_TYPES constant and validate_yield_type() function in `src/services/finished_unit_service.py`
- [x] T007 Update create_finished_unit() to accept and validate yield_type parameter
- [x] T008 Update update_finished_unit() to validate yield_type changes
- [x] T009 Write service-level unit tests in `src/tests/services/test_finished_unit_yield_type.py`

### Implementation Notes
1. Follow existing validation pattern: return `List[str]` of error messages
2. Accept optional `session=None` parameter for transaction sharing
3. Validation pattern documented in research.md Q4

### Parallel Opportunities
- T006-T008 are sequential (constant must exist before functions use it)
- T009 can be written incrementally as each function is implemented

### Dependencies
- Depends on WP01 (model must have yield_type column)

### Risks & Mitigations
- Breaking change to function signatures → Ensure backward compatibility by making yield_type optional with default='SERVING'

---

## Work Package WP03: Export/Import – yield_type Field (Priority: P1)

**Goal**: Update export to include yield_type; update import to read and validate yield_type.
**Independent Test**: Export → import round-trip preserves yield_type values correctly.
**Prompt**: `tasks/WP03-export-import-yield-type.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [x] T010 [P] Update `_export_finished_units()` to include yield_type field in `src/services/coordinated_export_service.py`
- [x] T011 [P] Update import to read yield_type with default='SERVING' for backward compatibility
- [x] T012 Add import validation for yield_type values (must be 'EA' or 'SERVING')
- [x] T013 Handle UNIQUE constraint violations during import (recipe_id + item_unit + yield_type)
- [x] T014 Write export/import round-trip tests in `src/tests/services/test_export_import_yield_type.py`

### Implementation Notes
1. Export pattern documented in research.md Q3
2. Import must handle missing yield_type field (old exports) → default to 'SERVING'
3. UNIQUE violation during import should log warning and skip duplicate, not fail entire import

### Parallel Opportunities
- T010 (export) and T011 (import) can be developed in parallel
- T012-T013 depend on T011
- T014 depends on all previous tasks

### Dependencies
- Depends on WP02 (service validation functions must exist)

### Risks & Mitigations
- Old exports without yield_type → Default to 'SERVING' provides backward compatibility
- UNIQUE constraint violation → Skip duplicate with warning, continue import

---

## Work Package WP04: UI – yield_type Dropdown (Priority: P1)

**Goal**: Add yield_type dropdown to recipe form; update displays to show yield_type.
**Independent Test**: User can select EA or SERVING for each finished unit; value persists after save.
**Prompt**: `tasks/WP04-ui-yield-type-dropdown.md`
**Estimated Size**: ~450 lines

### Included Subtasks
- [x] T015 Add yield_type dropdown to YieldTypeRow component in `src/ui/forms/recipe_form.py`
- [x] T016 Update grid configuration and column headers to include "Type" column
- [x] T017 Update form validation to require yield_type selection
- [x] T018 Update `_save_yield_types()` in `src/ui/recipes_tab.py` to persist yield_type
- [x] T019 Update recipe detail display to show yield_type in `src/ui/recipes_tab.py`
- [ ] T020 [P] Update FinishedGoodDataTable yield info display in `src/ui/widgets/data_table.py`

### Implementation Notes
1. UI patterns documented in research.md Q5
2. Use `CTkOptionMenu` with values=["SERVING", "EA"]
3. Column order: Name | Unit | Type | Qty | Remove
4. Default selection: "SERVING" (most common case)

### Parallel Opportunities
- T015-T019 are sequential (component must be modified before it can be used)
- T020 can be developed in parallel (separate file, separate component)

### Dependencies
- Depends on WP02 (service layer must support yield_type)

### Risks & Mitigations
- UI complexity increase → Minimal: single dropdown, clear label
- User confusion → Default to "SERVING" which is correct for most baked goods

---

## Work Package WP05: Migration – Transform Existing Data (Priority: P2)

**Goal**: Create migration script and documentation for upgrading existing databases.
**Independent Test**: Export pre-migration data → transform → import post-migration → no data loss.
**Prompt**: `tasks/WP05-migration-yield-type.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [ ] T021 Create migration script `scripts/migrate_add_yield_type.py` to transform export JSON
- [ ] T022 Document migration procedure in `docs/migrations/083-dual-yield-migration.md`
- [ ] T023 Test full export → transform → import cycle
- [ ] T024 Verify no data loss after migration (record counts, field values)

### Implementation Notes
1. Constitutional schema change strategy: export → reset → import
2. Transformation: add `"yield_type": "SERVING"` to each finished_unit record
3. Migration script should be idempotent (safe to run multiple times)

### Parallel Opportunities
- T021 (script) and T022 (docs) can be developed in parallel
- T023-T024 depend on script completion

### Dependencies
- Depends on WP01 (model), WP03 (export/import)
- Should be tested after WP04 (UI) to verify end-to-end

### Risks & Mitigations
- Data loss during migration → Export provides rollback point
- UNIQUE constraint violation → Migration adds yield_type='SERVING' to all, ensuring uniqueness

---

## Dependency & Execution Summary

```
WP01: Model Layer
    │
    └──> WP02: Service Layer
              │
              ├──> WP03: Export/Import ──┐
              │                          │
              └──> WP04: UI ─────────────┼──> WP05: Migration
                                         │
                                         └───────────────────
```

- **Sequence**: WP01 → WP02 → [WP03 ║ WP04] → WP05
- **Parallelization**: WP03 and WP04 can run in parallel after WP02 completes
- **MVP Scope**: WP01 + WP02 + WP03 = minimum for export/import to work; WP04 adds UI; WP05 required for production deployment

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Add yield_type column | WP01 | P0 | No |
| T002 | Add CHECK constraint | WP01 | P0 | No |
| T003 | Add UNIQUE constraint | WP01 | P0 | No |
| T004 | Add yield_type index | WP01 | P0 | No |
| T005 | Model unit tests | WP01 | P0 | Yes |
| T006 | Add validation function | WP02 | P0 | No |
| T007 | Update create function | WP02 | P0 | No |
| T008 | Update update function | WP02 | P0 | No |
| T009 | Service unit tests | WP02 | P0 | Yes |
| T010 | Update export | WP03 | P1 | Yes |
| T011 | Update import (read) | WP03 | P1 | Yes |
| T012 | Import validation | WP03 | P1 | No |
| T013 | Handle UNIQUE violations | WP03 | P1 | No |
| T014 | Export/import tests | WP03 | P1 | No |
| T015 | Add yield_type dropdown | WP04 | P1 | No |
| T016 | Update grid/headers | WP04 | P1 | No |
| T017 | Form validation | WP04 | P1 | No |
| T018 | Update save function | WP04 | P1 | No |
| T019 | Update detail display | WP04 | P1 | No |
| T020 | Update data table | WP04 | P1 | Yes |
| T021 | Migration script | WP05 | P2 | Yes |
| T022 | Migration docs | WP05 | P2 | Yes |
| T023 | Migration test | WP05 | P2 | No |
| T024 | Verify no data loss | WP05 | P2 | No |
