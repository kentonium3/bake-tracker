# Work Packages: UI Import/Export with v3.0 Schema

**Inputs**: Design documents from `/kitty-specs/009-ui-import-export/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, quickstart.md

**Tests**: Integration tests for round-trip data integrity; unit tests for service layer functions.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/planned/` generated by `/spec-kitty.tasks`. Treat this file as the high-level checklist; keep deep implementation detail inside the prompt files.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: v3.0 Specification Document (Priority: P0)

**Goal**: Create the authoritative v3.0 import/export specification document and archive v2.0.
**Independent Test**: Specification document exists at `docs/design/import_export_specification.md`, covers all 16 entities with examples, and documents dependency order.
**Prompt**: `/tasks/planned/WP01-v3-specification.md`

### Included Subtasks
- [x] T001 Archive v2.0 specification to `docs/archive/import_export_specification_v2.md`
- [x] T002 Create v3.0 specification document at `docs/design/import_export_specification.md`
- [x] T003 Document all 16 exportable entities with JSON examples
- [x] T004 Document import dependency order for referential integrity
- [x] T005 Document validation rules and error handling

### Implementation Notes
- Use `data-model.md` as primary source for entity definitions
- Include changelog section noting changes from v2.0
- Add clear "Version 3.0 Only" notice per FR-018

### Parallel Opportunities
- None - this is foundational documentation.

### Dependencies
- None (starting package).

### Risks & Mitigations
- Entity definitions may drift from actual models â†’ validate against `src/models/` during implementation.

---

## Work Package WP02: Service Layer - Export Functions (Priority: P1) ðŸŽ¯ MVP

**Goal**: Extend `import_export_service.py` with export functions for all v3.0 entities.
**Independent Test**: `export_all_to_json()` produces valid v3.0 JSON with all 16 entity types populated.
**Prompt**: `/tasks/planned/WP02-export-functions.md`

### Included Subtasks
- [x] T006 Add `ExportResult` class enhancements (record counts per entity)
- [x] T007 [P] Implement `export_finished_units_to_json()` in `src/services/import_export_service.py`
- [x] T008 [P] Implement `export_compositions_to_json()` in `src/services/import_export_service.py`
- [x] T009 [P] Implement `export_package_finished_goods_to_json()` in `src/services/import_export_service.py`
- [x] T010 [P] Implement `export_production_records_to_json()` in `src/services/import_export_service.py`
- [x] T011 Update `export_all_to_json()` to include new entities and v3.0 header
- [x] T012 Add unit tests for new export functions in `src/tests/services/test_import_export_service.py`

### Implementation Notes
- Follow existing export function patterns (use `session_scope()`, return `List[Dict]`)
- Ensure datetime fields use ISO 8601 format with 'Z' suffix
- Add `version: "3.0"` and `exported_at` to export header

### Parallel Opportunities
- T007-T010 can proceed in parallel (independent entity functions)

### Dependencies
- Depends on WP01 (specification must be finalized first)

### Risks & Mitigations
- Model field names may differ from spec â†’ verify against actual SQLAlchemy models

---

## Work Package WP03: Service Layer - Import Functions with Mode Support (Priority: P1) ðŸŽ¯ MVP

**Goal**: Extend `import_export_service.py` with import functions supporting Merge and Replace modes.
**Independent Test**: Import with both modes works; Merge skips duplicates, Replace clears then imports; v3.0 version validation enforced.
**Prompt**: `/tasks/planned/WP03-import-functions.md`

### Included Subtasks
- [x] T013 Add `mode` parameter to `import_all_from_json()` ("merge" or "replace")
- [x] T014 Implement `_clear_all_tables()` helper for Replace mode
- [x] T015 Add v3.0 version detection and rejection of non-v3.0 files (FR-018)
- [x] T016 [P] Implement `import_finished_units_from_json()` in `src/services/import_export_service.py`
- [x] T017 [P] Implement `import_compositions_from_json()` in `src/services/import_export_service.py`
- [x] T018 [P] Implement `import_package_finished_goods_from_json()` in `src/services/import_export_service.py`
- [x] T019 [P] Implement `import_production_records_from_json()` in `src/services/import_export_service.py`
- [x] T020 Update `import_all_from_json()` to call new entity imports in dependency order
- [x] T021 Enhance `ImportResult` with per-entity counts and skip tracking
- [x] T022 Add unit tests for import modes and version validation

### Implementation Notes
- Merge mode: Use existing duplicate detection logic, skip and count
- Replace mode: Clear tables in reverse dependency order, then import
- Version check must occur before any data operations
- Transaction rollback on any error (existing pattern)

### Parallel Opportunities
- T016-T019 can proceed in parallel (independent entity functions)

### Dependencies
- Depends on WP02 (export functions needed for round-trip testing)

### Risks & Mitigations
- Replace mode data loss â†’ implement confirmation requirement in UI (WP04)
- Foreign key violations â†’ enforce strict dependency order

---

## Work Package WP04: UI - Menu Bar and Dialogs (Priority: P1) ðŸŽ¯ MVP

**Goal**: Add File menu with Import/Export dialogs to the main window.
**Independent Test**: User can access File menu, trigger export to save JSON file, trigger import with mode selection.
**Prompt**: `/tasks/planned/WP04-ui-menu-dialogs.md`

### Included Subtasks
- [x] T023 Add menu bar to `src/ui/main_window.py` with File menu
- [x] T024 Create `src/ui/import_export_dialog.py` with `ImportDialog` class
- [x] T025 Create `ExportDialog` class in same file
- [x] T026 Implement file dialogs with JSON filter (FR-004)
- [x] T027 Add mode selection (Merge/Replace) to ImportDialog (FR-013)
- [x] T028 Add Replace mode confirmation dialog (FR-013b)
- [x] T029 Implement progress indication for large datasets
- [x] T030 Add success/error message dialogs with user-friendly text (FR-006, FR-007, FR-008)
- [x] T031 Wire dialogs to service layer functions
- [x] T032 Add tab refresh after successful import

### Implementation Notes
- Use tkinter `Menu` widget (works with CustomTkinter per research.md)
- Use `CTkToplevel` for dialogs (see `migration_wizard_dialog.py` pattern)
- Default export filename: `bake-tracker-backup-YYYY-MM-DD.json`
- Error messages must be user-friendly (no stack traces per SC-006)

### Parallel Opportunities
- T024 and T025 can proceed in parallel (separate dialog classes)

### Dependencies
- Depends on WP03 (import service functions must exist)

### Risks & Mitigations
- Menu bar styling may not match CustomTkinter theme â†’ accept native styling as per research
- Long operations may freeze UI â†’ implement progress callback pattern

---

## Work Package WP05: Sample Data & Integration Testing (Priority: P2)

**Goal**: Update sample data to v3.0 format and verify round-trip integrity.
**Independent Test**: `test_data/sample_data.json` imports with zero errors; round-trip test achieves 100% data integrity.
**Prompt**: `/tasks/planned/WP05-sample-data-integration.md`

### Included Subtasks
- [x] T033 Update `test_data/sample_data.json` to v3.0 format
- [x] T034 Add realistic test data for all 16 entity types
- [x] T035 Add integration test for sample data import
- [x] T036 Add round-trip test (export -> clear -> import -> verify)
- [x] T037 Add performance test for <60s import of typical dataset
- [x] T038 Validate all success criteria (SC-001 through SC-007)

### Implementation Notes
- Sample data should include realistic holiday baking scenario
- Include at least 2-3 items per entity type for meaningful testing
- Round-trip test must verify record counts and key field values

### Parallel Opportunities
- T033-T034 (sample data) can proceed while T035-T038 (tests) are written

### Dependencies
- Depends on WP04 (UI must be functional for full integration)

### Risks & Mitigations
- Sample data may not cover edge cases â†’ include variety in test data

---

## Dependency & Execution Summary

- **Sequence**: WP01 â†’ WP02 â†’ WP03 â†’ WP04 â†’ WP05
- **Parallelization**: Within each WP, subtasks marked [P] can run concurrently
- **MVP Scope**: WP01-WP04 constitute the minimal release (File menu operational)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Archive v2.0 spec | WP01 | P0 | No |
| T002 | Create v3.0 spec document | WP01 | P0 | No |
| T003 | Document 16 entities with examples | WP01 | P0 | No |
| T004 | Document import dependency order | WP01 | P0 | No |
| T005 | Document validation rules | WP01 | P0 | No |
| T006 | ExportResult enhancements | WP02 | P1 | No |
| T007 | export_finished_units_to_json() | WP02 | P1 | Yes |
| T008 | export_compositions_to_json() | WP02 | P1 | Yes |
| T009 | export_package_finished_goods_to_json() | WP02 | P1 | Yes |
| T010 | export_production_records_to_json() | WP02 | P1 | Yes |
| T011 | Update export_all_to_json() | WP02 | P1 | No |
| T012 | Export unit tests | WP02 | P1 | No |
| T013 | Add mode parameter to import | WP03 | P1 | No |
| T014 | Implement _clear_all_tables() | WP03 | P1 | No |
| T015 | v3.0 version validation | WP03 | P1 | No |
| T016 | import_finished_units_from_json() | WP03 | P1 | Yes |
| T017 | import_compositions_from_json() | WP03 | P1 | Yes |
| T018 | import_package_finished_goods_from_json() | WP03 | P1 | Yes |
| T019 | import_production_records_from_json() | WP03 | P1 | Yes |
| T020 | Update import_all_from_json() | WP03 | P1 | No |
| T021 | ImportResult enhancements | WP03 | P1 | No |
| T022 | Import unit tests | WP03 | P1 | No |
| T023 | Add menu bar to main_window.py | WP04 | P1 | No |
| T024 | Create ImportDialog class | WP04 | P1 | Yes |
| T025 | Create ExportDialog class | WP04 | P1 | Yes |
| T026 | File dialogs with JSON filter | WP04 | P1 | No |
| T027 | Mode selection in ImportDialog | WP04 | P1 | No |
| T028 | Replace mode confirmation | WP04 | P1 | No |
| T029 | Progress indication | WP04 | P1 | No |
| T030 | Success/error message dialogs | WP04 | P1 | No |
| T031 | Wire dialogs to service layer | WP04 | P1 | No |
| T032 | Tab refresh after import | WP04 | P1 | No |
| T033 | Update sample_data.json to v3.0 | WP05 | P2 | Yes |
| T034 | Add realistic test data | WP05 | P2 | Yes |
| T035 | Sample data import test | WP05 | P2 | No |
| T036 | Round-trip integrity test | WP05 | P2 | No |
| T037 | Performance test | WP05 | P2 | No |
| T038 | Validate success criteria | WP05 | P2 | No |
