# Work Packages: Import/Export v4.0 Upgrade

**Inputs**: Design documents from `kitty-specs/040-import-export-v4/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, quickstart.md

**Tests**: Unit tests included per work package as the feature involves complex calculations and data transformations.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/planned/` generated by `/spec-kitty.tasks`.

**Parallelization Strategy**:
- Phase 1 (WP01-WP04): Sequential - establishes v4.0 foundation
- Phase 2 (WP05-WP06 + WP07-WP08): Parallel - Claude handles purchases, Gemini handles inventory
- Phase 3 (WP09-WP10): Sequential - integration and documentation

---

## Work Package WP01: Recipe Export v4.0 (Priority: P0)

**Goal**: Update recipe export to include F037 fields (base_recipe_slug, variant_name, is_production_ready) and linked FinishedUnits with yield_mode.
**Independent Test**: Export a database with variant recipes, verify JSON contains all new fields correctly.
**Prompt**: `tasks/planned/WP01-recipe-export-v4.md`
**Assignee**: Claude

### Included Subtasks
- [ ] T001 [P] Export base_recipe_slug (lookup from base_recipe_id) in `src/services/import_export_service.py`
- [ ] T002 [P] Export variant_name field
- [ ] T003 [P] Export is_production_ready field
- [ ] T004 Export finished_units[] array with yield_mode for each recipe
- [ ] T005 Unit tests for recipe export v4.0 in `src/tests/services/test_import_export_service.py`

### Implementation Notes
- Modify `export_recipes_to_json()` function
- Use session.query to lookup base_recipe by ID to get slug
- Include all FinishedUnits related to recipe via `recipe.finished_units` relationship

### Parallel Opportunities
- T001-T003 can be implemented in parallel (separate fields)

### Dependencies
- None (starting package)

### Risks & Mitigations
- Performance with many recipes: Use joinedload for finished_units

---

## Work Package WP02: Recipe Import v4.0 (Priority: P0)

**Goal**: Update recipe import to handle F037 fields with proper dependency ordering (base recipes before variants).
**Independent Test**: Import a JSON file with variant recipes, verify database contains correct relationships.
**Prompt**: `tasks/planned/WP02-recipe-import-v4.md`
**Assignee**: Claude

### Included Subtasks
- [ ] T006 Sort recipes for import order - base recipes (no base_recipe_slug) first, then variants
- [ ] T007 Resolve base_recipe_slug to base_recipe_id via slug lookup
- [ ] T008 [P] Import variant_name, is_production_ready fields
- [ ] T009 Import finished_units[] with yield_mode, creating FinishedUnit records
- [ ] T010 Validation for recipe import - ensure base_recipe exists, ingredient_slugs valid
- [ ] T011 Unit tests for recipe import v4.0

### Implementation Notes
- Two-pass import: first pass imports base recipes, second pass imports variants
- Alternatively, sort recipes by dependency before single-pass import
- FinishedUnit import requires recipe to exist first

### Parallel Opportunities
- T008 can proceed in parallel with T007

### Dependencies
- Depends on WP01 (export must work to test round-trip)

### Risks & Mitigations
- Circular variant references: Validate no cycles before import

---

## Work Package WP03: Event Export/Import v4.0 (Priority: P0)

**Goal**: Add output_mode field to event export/import with validation against target types.
**Independent Test**: Export/import event with output_mode="bundled", verify field preserved and targets validated.
**Prompt**: `tasks/planned/WP03-event-export-import-v4.md`
**Assignee**: Claude

### Included Subtasks
- [ ] T012 [P] Export output_mode field for events in event export function
- [ ] T013 [P] Import output_mode field for events
- [ ] T014 Validation: warn if output_mode="bundled" but no assembly_targets, warn if output_mode="bulk_count" but no production_targets
- [ ] T015 Unit tests for event export/import v4.0

### Implementation Notes
- output_mode is nullable enum: bulk_count, bundled, packaged
- EventAssemblyTarget and EventProductionTarget already exported in v3.6
- Only add output_mode field and validation logic

### Parallel Opportunities
- T012 and T013 can proceed in parallel

### Dependencies
- None (independent of recipe changes)

### Risks & Mitigations
- Existing events may have null output_mode: Handle gracefully, default to null on export

---

## Work Package WP04: Version Bump and Function Rename (Priority: P0)

**Goal**: Bump schema version to "4.0", rename functions, update version validation.
**Independent Test**: Export file shows version "4.0", v3.x import is rejected with clear error.
**Prompt**: `tasks/planned/WP04-version-bump.md`
**Assignee**: Claude

### Included Subtasks
- [ ] T016 Change version from "3.5" to "4.0" in export functions
- [ ] T017 Rename `import_all_from_json_v3()` to `import_all_from_json_v4()`
- [ ] T018 Update version validation to require "4.0", reject "3.5" with clear message

### Implementation Notes
- Keep v3 function as deprecated alias with deprecation warning
- Update all references in codebase
- Error message: "Unsupported file version: [X]. This application only supports v4.0 format."

### Parallel Opportunities
- All subtasks affect same code area, best done sequentially

### Dependencies
- Depends on WP01, WP02, WP03 (all new fields must be in place before version bump)

### Risks & Mitigations
- Breaking change for users with v3.5 files: Document migration path (re-export from updated app)

---

## Work Package WP05: Purchase Import Service (Priority: P1) - Claude

**Goal**: Implement `import_purchases_from_bt_mobile()` function for UPC-based purchase import.
**Independent Test**: Import JSON file with known UPCs, verify Purchase and InventoryItem records created.
**Prompt**: `tasks/planned/WP05-purchase-import-service.md`
**Assignee**: Claude

### Included Subtasks
- [ ] T019 Create `import_purchases_from_bt_mobile(file_path)` function signature and schema validation
- [ ] T020 Implement UPC matching logic: `Product.upc_code == purchase.upc`
- [ ] T021 Create Purchase + InventoryItem records for matched UPCs
- [ ] T022 Collect unmatched UPCs into separate list for resolution
- [ ] T023 Return ImportResult with matched_count, unmatched_count, error_count
- [ ] T024 Unit tests for purchase import service

### Implementation Notes
- Schema validation: schema_version="4.0", import_type="purchases"
- Use session_scope() with proper session passing pattern
- Resolve supplier by name, create if not exists
- InventoryItem.current_quantity = Purchase.quantity_purchased

### Parallel Opportunities
- None - sequential implementation required

### Dependencies
- Depends on WP04 (version validation in place)

### Risks & Mitigations
- Duplicate UPC imports: Check for existing purchase with same UPC + date + price

---

## Work Package WP06: UPC Resolution Dialog (Priority: P1) - Claude

**Goal**: Create CustomTkinter dialog for resolving unknown UPCs during purchase import.
**Independent Test**: Dialog displays, user can map/create/skip, resulting actions complete successfully.
**Prompt**: `tasks/planned/WP06-upc-resolution-dialog.md`
**Assignee**: Claude

### Included Subtasks
- [ ] T025 Create `src/ui/dialogs/upc_resolution_dialog.py` with dialog structure
- [ ] T026 Implement "Map to existing product" option with product search/dropdown
- [ ] T027 Implement "Create new product" option with ingredient/brand/name form
- [ ] T028 Implement "Skip" option with logging

### Implementation Notes
- Dialog shows: UPC, price, scan timestamp
- On map: Update Product.upc_code for future matching
- On create: Create Product with UPC, then Purchase
- Iterate through unmatched UPCs one at a time or batch display

### Parallel Opportunities
- T026, T027, T028 can be implemented in parallel (different UI paths)

### Dependencies
- Depends on WP05 (service layer collects unmatched UPCs)

### Risks & Mitigations
- UI complexity: Keep simple, focus on core workflow

---

## Work Package WP07: Inventory Update Service (Priority: P1) - Gemini

**Goal**: Implement `import_inventory_updates_from_bt_mobile()` function for percentage-based inventory corrections.
**Independent Test**: Import JSON with percentage updates, verify InventoryItem.current_quantity adjusted correctly.
**Prompt**: `tasks/planned/WP07-inventory-update-service.md`
**Assignee**: Gemini

### Included Subtasks
- [ ] T029 Create `import_inventory_updates_from_bt_mobile(file_path)` function signature and schema validation
- [ ] T030 Implement UPC to Product lookup
- [ ] T031 Implement FIFO InventoryItem selection (oldest purchase_date first, current_quantity > 0)
- [ ] T032 Implement percentage calculation: target = original * (pct/100), adjustment = target - current
- [ ] T033 Create InventoryDepletion record, update InventoryItem.current_quantity

### Implementation Notes
- Schema validation: schema_version="4.0", import_type="inventory_updates"
- Get original quantity from inventory_item.purchase.quantity_purchased
- Use Decimal for precision: `Decimal(str(percentage)) / Decimal(100)`
- Validate adjustment won't result in negative inventory

### Parallel Opportunities
- None - sequential implementation required

### Dependencies
- Depends on WP04 (version validation in place)
- Can run in parallel with WP05-WP06 (different files)

### Risks & Mitigations
- No linked purchase: Error with clear message "Cannot calculate percentage - no linked purchase"

---

## Work Package WP08: Inventory Update Tests (Priority: P1) - Gemini

**Goal**: Comprehensive unit tests for inventory update service covering edge cases.
**Independent Test**: All tests pass with >90% coverage of WP07 code.
**Prompt**: `tasks/planned/WP08-inventory-update-tests.md`
**Assignee**: Gemini

### Included Subtasks
- [ ] T034 [P] Basic unit tests for import_inventory_updates_from_bt_mobile
- [ ] T035 [P] Test percentage calculation edge cases (0%, 100%, rounding)
- [ ] T036 [P] Test FIFO selection with multiple inventory items
- [ ] T037 [P] Test error handling (no product, no inventory, no purchase, negative result)

### Implementation Notes
- Use pytest fixtures for test data setup
- Test both depletion (current > target) and addition (current < target) scenarios
- Test boundary conditions: exactly 0%, exactly 100%

### Parallel Opportunities
- All test subtasks can proceed in parallel (separate test cases)

### Dependencies
- Depends on WP07 (code must exist to test)

### Risks & Mitigations
- Test isolation: Use separate test database/session per test

---

## Work Package WP09: Integration Tests (Priority: P2)

**Goal**: End-to-end tests validating full export/import round-trips for all entity types.
**Independent Test**: All integration tests pass, data integrity verified across round-trips.
**Prompt**: `tasks/planned/WP09-integration-tests.md`
**Assignee**: Claude

### Included Subtasks
- [ ] T038 [P] Full export -> import round-trip test (all entities)
- [ ] T039 [P] Recipe variants round-trip (base + variant preserved)
- [ ] T040 [P] Event output_mode round-trip
- [ ] T041 Mode testing: merge vs replace behavior

### Implementation Notes
- Create comprehensive test database with all entity types
- Export, reset database, import, compare counts and key fields
- Verify relationships intact after round-trip

### Parallel Opportunities
- All test subtasks can proceed in parallel

### Dependencies
- Depends on WP01-WP04 (core schema complete)

### Risks & Mitigations
- Test database state: Use fresh database per test run

---

## Work Package WP10: Sample Data & Documentation (Priority: P2)

**Goal**: Update sample data files to v4.0 format, create BT Mobile sample files.
**Independent Test**: Sample files import successfully, documentation accurate.
**Prompt**: `tasks/planned/WP10-sample-data-docs.md`
**Assignee**: Claude

### Included Subtasks
- [ ] T042 [P] Update `test_data/sample_data.json` to v4.0 format
- [ ] T043 [P] Create `test_data/bt_mobile_purchase_sample.json`
- [ ] T044 [P] Create `test_data/bt_mobile_inventory_sample.json`

### Implementation Notes
- sample_data.json: Add base_recipe_slug, variant_name, is_production_ready, finished_units, output_mode
- BT Mobile samples: Use realistic UPCs and percentages for testing

### Parallel Opportunities
- All subtasks can proceed in parallel (separate files)

### Dependencies
- Depends on WP01-WP08 (all import functions ready to validate samples)

### Risks & Mitigations
- Sample data drift: Keep samples minimal but representative

---

## Dependency & Execution Summary

```
Phase 1 (Sequential - Claude):
  WP01 → WP02 → WP03 → WP04

Phase 2 (Parallel):
  Claude: WP05 → WP06
  Gemini: WP07 → WP08

Phase 3 (Sequential - Claude):
  WP09 → WP10
```

**MVP Scope**: WP01-WP04 (core schema upgrade) - enables F037/F039 testing without BT Mobile features.

**Full Scope**: WP01-WP10 (all features including BT Mobile import)

---

## Subtask Index (Reference)

| Subtask | Summary | WP | Priority | Parallel? |
|---------|---------|-----|----------|-----------|
| T001 | Export base_recipe_slug | WP01 | P0 | Yes |
| T002 | Export variant_name | WP01 | P0 | Yes |
| T003 | Export is_production_ready | WP01 | P0 | Yes |
| T004 | Export finished_units[] | WP01 | P0 | No |
| T005 | Recipe export tests | WP01 | P0 | No |
| T006 | Sort recipes for import | WP02 | P0 | No |
| T007 | Resolve base_recipe_slug | WP02 | P0 | No |
| T008 | Import variant fields | WP02 | P0 | Yes |
| T009 | Import finished_units | WP02 | P0 | No |
| T010 | Recipe import validation | WP02 | P0 | No |
| T011 | Recipe import tests | WP02 | P0 | No |
| T012 | Export event output_mode | WP03 | P0 | Yes |
| T013 | Import event output_mode | WP03 | P0 | Yes |
| T014 | Output mode validation | WP03 | P0 | No |
| T015 | Event export/import tests | WP03 | P0 | No |
| T016 | Version bump to 4.0 | WP04 | P0 | No |
| T017 | Rename v3 to v4 functions | WP04 | P0 | No |
| T018 | Version validation update | WP04 | P0 | No |
| T019 | Purchase import function | WP05 | P1 | No |
| T020 | UPC matching logic | WP05 | P1 | No |
| T021 | Create Purchase + Inventory | WP05 | P1 | No |
| T022 | Collect unmatched UPCs | WP05 | P1 | No |
| T023 | Return ImportResult | WP05 | P1 | No |
| T024 | Purchase import tests | WP05 | P1 | No |
| T025 | Create UPC dialog | WP06 | P1 | No |
| T026 | Map to existing option | WP06 | P1 | Yes |
| T027 | Create new option | WP06 | P1 | Yes |
| T028 | Skip option | WP06 | P1 | Yes |
| T029 | Inventory update function | WP07 | P1 | No |
| T030 | UPC to Product lookup | WP07 | P1 | No |
| T031 | FIFO selection | WP07 | P1 | No |
| T032 | Percentage calculation | WP07 | P1 | No |
| T033 | Create InventoryDepletion | WP07 | P1 | No |
| T034 | Basic inventory tests | WP08 | P1 | Yes |
| T035 | Percentage edge cases | WP08 | P1 | Yes |
| T036 | FIFO selection tests | WP08 | P1 | Yes |
| T037 | Error handling tests | WP08 | P1 | Yes |
| T038 | Full round-trip test | WP09 | P2 | Yes |
| T039 | Variants round-trip | WP09 | P2 | Yes |
| T040 | Output mode round-trip | WP09 | P2 | Yes |
| T041 | Mode testing | WP09 | P2 | No |
| T042 | Update sample_data.json | WP10 | P2 | Yes |
| T043 | Create purchase sample | WP10 | P2 | Yes |
| T044 | Create inventory sample | WP10 | P2 | Yes |
