# Implementation Plan: Import/Export v4.0 Upgrade

**Branch**: `040-import-export-v4` | **Date**: 2026-01-06 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `kitty-specs/040-import-export-v4/spec.md`

## Summary

Upgrade import/export system from v3.5 to v4.0 to support:
1. **F037 Recipe fields**: base_recipe_id, variant_name, is_production_ready, and linked FinishedUnits with yield_mode
2. **F039 Event fields**: output_mode with conditional target validation
3. **BT Mobile purchase import**: UPC-based product matching with resolution UI
4. **BT Mobile inventory updates**: Percentage-based quantity corrections

**Parallelization Strategy**: Staged parallel
- Phase 1 (Sequential): Core schema upgrade - Claude leads
- Phase 2 (Parallel): BT Mobile workflows - Claude (purchases) + Gemini (inventory updates)

## Technical Context

**Language/Version**: Python 3.10+
**Primary Dependencies**: SQLAlchemy 2.x, CustomTkinter
**Storage**: SQLite with WAL mode
**Testing**: pytest
**Target Platform**: Desktop (macOS/Windows)
**Project Type**: Single desktop application
**Performance Goals**: 500 records import/export in under 30 seconds
**Constraints**: Atomic transactions, FIFO ordering for inventory
**Scale/Scope**: Single user, ~500 total records typical

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. User-Centric Design | PASS | Reduces manual data entry, enables backup/restore |
| II. Data Integrity & FIFO | PASS | FIFO for inventory updates, atomic transactions |
| III. Future-Proof Schema | PASS | Using existing nullable fields (upc_code, gtin) |
| IV. Test-Driven Development | PASS | Unit tests required for each service function |
| V. Layered Architecture | PASS | All logic in services, UI only for resolution dialog |
| VI. Schema Change Strategy | N/A | No model changes required |
| VII. Pragmatic Aspiration | PASS | Desktop-focused, web-ready service layer |

**Post-Design Re-check**: PASS - No violations identified

## Project Structure

### Documentation (this feature)

```
kitty-specs/040-import-export-v4/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 research findings
├── data-model.md        # JSON schemas and entity mappings
├── quickstart.md        # Implementation quickstart
├── research/
│   ├── evidence-log.csv
│   └── source-register.csv
└── tasks.md             # Generated by /spec-kitty.tasks
```

### Source Code (repository root)

```
src/
├── services/
│   └── import_export_service.py  # Main changes (Parts 1, 2, 3)
├── ui/
│   └── dialogs/
│       └── upc_resolution_dialog.py  # New file (Part 2 only)
└── tests/
    └── services/
        └── test_import_export_service.py  # Existing + new tests
```

**Structure Decision**: Single project structure. All import/export logic stays in `import_export_service.py`. One new UI dialog for UPC resolution.

## Implementation Phases

### Phase 1: Core Schema Upgrade (Sequential - Claude)

**WP01: Recipe Export v4.0** (3-4 hrs)
- Update `export_recipes_to_json()` to include:
  - `base_recipe_slug` (lookup from base_recipe_id)
  - `variant_name`
  - `is_production_ready`
  - `finished_units[]` with yield_mode
- Maintain backward compatibility in export format

**WP02: Recipe Import v4.0** (4-5 hrs)
- Update recipe import in `import_all_from_json_v4()`:
  - Import base recipes before variants (dependency ordering)
  - Resolve `base_recipe_slug` to `base_recipe_id`
  - Import `variant_name`, `is_production_ready`
  - Import linked `finished_units[]` with yield_mode
- Validation: base_recipe must exist, ingredient_slugs valid

**WP03: Event Export/Import v4.0** (2-3 hrs)
- Add `output_mode` to event export
- Add `output_mode` validation on import
- Warning if output_mode="bundled" but no assembly_targets
- Warning if output_mode="bulk_count" but no production_targets

**WP04: Version Bump and Function Rename** (1-2 hrs)
- Change version from "3.5" to "4.0" in exports
- Rename `import_all_from_json_v3()` to `import_all_from_json_v4()`
- Keep v3 as deprecated alias with warning
- Update version validation to require "4.0"

### Phase 2: BT Mobile Workflows (Parallel)

#### Claude: Purchase Import (WP05-WP06)

**WP05: Purchase Import Service** (4-5 hrs)
- New function `import_purchases_from_bt_mobile(file_path)`
- Schema validation (schema_version, import_type)
- UPC matching: `Product.upc_code == purchase.upc`
- Create Purchase + InventoryItem for matches
- Collect unmatched UPCs for resolution
- Return ImportResult with matched/unmatched counts

**WP06: UPC Resolution Dialog** (3-4 hrs)
- New CustomTkinter dialog: `src/ui/dialogs/upc_resolution_dialog.py`
- Display: UPC, price, scan time
- Options: (a) Map to existing product (dropdown), (b) Create new (form), (c) Skip
- On map: Update Product.upc_code, create Purchase
- On create: Create Product with UPC, create Purchase
- On skip: Log and continue

#### Gemini: Inventory Updates (WP07-WP08)

**WP07: Inventory Update Service** (3-4 hrs)
- New function `import_inventory_updates_from_bt_mobile(file_path)`
- Schema validation (schema_version, import_type)
- UPC lookup to Product, then to active InventoryItems
- FIFO selection (oldest purchase_date first)
- Percentage calculation: `target = original * (pct/100)`
- Create InventoryDepletion, update current_quantity
- Return ImportResult with update/skip/error counts

**WP08: Inventory Update Tests** (2-3 hrs)
- Test percentage calculation edge cases
- Test FIFO selection with multiple inventory items
- Test error handling (no product, no inventory, no purchase)
- Test positive adjustment (increase from lower current)

### Phase 3: Integration & Documentation (Sequential - Claude)

**WP09: Integration Tests** (2-3 hrs)
- Full export -> import round-trip test
- Recipe with variants round-trip
- Event with output_mode round-trip
- Mode testing (merge vs replace)

**WP10: Sample Data & Documentation** (2-3 hrs)
- Update `test_data/sample_data.json` to v4.0
- Create `test_data/bt_mobile_purchase_sample.json`
- Create `test_data/bt_mobile_inventory_sample.json`
- Update `docs/design/spec_import_export.md` (already done)

## Parallelization Plan

```
Timeline:
=========
Day 1-2: Phase 1 (Claude sequential)
  WP01 -> WP02 -> WP03 -> WP04

Day 3-4: Phase 2 (Claude + Gemini parallel)
  Claude: WP05 -> WP06
  Gemini: WP07 -> WP08

Day 5: Phase 3 (Claude sequential)
  WP09 -> WP10
```

**File Boundaries for Parallel Work**:
| Agent | Files Modified | Files Read-Only |
|-------|---------------|-----------------|
| Claude (WP05-06) | import_export_service.py, upc_resolution_dialog.py, test_import_export_service.py | models/*.py |
| Gemini (WP07-08) | import_export_service.py (new functions only), test_import_export_service.py (new tests only) | models/*.py |

**Conflict Prevention**:
- Claude adds `import_purchases_from_bt_mobile()` at end of file
- Gemini adds `import_inventory_updates_from_bt_mobile()` after Claude's function
- Test files: Claude adds purchase tests, Gemini adds inventory update tests in separate test classes

## Complexity Tracking

*No Constitution violations - no entries needed*

## Dependencies

**Upstream (Required)**:
- F037 Recipe Redesign: COMPLETE (models exist)
- F039 Planning Workspace: COMPLETE (output_mode exists)

**Downstream (This Unblocks)**:
- User testing of F037/F039 features
- Sample data loading
- BT Mobile integration (future)

## Success Criteria Mapping

| Success Criteria | Work Package | Validation |
|-----------------|--------------|------------|
| SC-001: 500 records in 30s | WP09 | Performance test |
| SC-002: Recipe round-trip | WP01, WP02, WP09 | Integration test |
| SC-003: Event round-trip | WP03, WP09 | Integration test |
| SC-004: 90%+ UPC match rate | WP05 | Unit test with sample data |
| SC-005: 30s UPC resolution | WP06 | Manual testing |
| SC-006: Percentage calc accuracy | WP07 | Unit test |
| SC-007: Actionable error messages | All WPs | Review error strings |
| SC-008: Atomic transactions | WP02, WP05, WP07 | Test rollback on error |

## Next Steps

1. Run `/spec-kitty.tasks` to generate work packages
2. Execute WP01-WP04 sequentially (Phase 1)
3. Delegate WP07-WP08 to Gemini while Claude works on WP05-WP06
4. Complete WP09-WP10 for integration
5. Run `/spec-kitty.review` and `/spec-kitty.accept`
