# Work Packages: User-Friendly Ingredient Density Input

**Inputs**: Design documents from `/kitty-specs/010-user-friendly-ingredient/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, quickstart.md

**Tests**: Testing tasks included for service layer (>70% coverage target per constitution).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/planned/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Model & Constants Changes (Priority: P0) ‚úÖ COMPLETE

**Goal**: Replace `density_g_per_ml` with 4-field density model and remove hardcoded fallback.
**Independent Test**: Ingredient model can calculate density from 4 fields; constants no longer contain density data.
**Prompt**: `tasks/for_review/WP01-model-constants-changes.md`

### Included Subtasks
- [x] T001 Remove `density_g_per_ml` field from `src/models/ingredient.py`
- [x] T002 Add 4 density fields to `src/models/ingredient.py`
- [x] T003 Add `get_density_g_per_ml()` method to Ingredient model
- [x] T004 Add `format_density_display()` method to Ingredient model
- [x] T005 [P] Remove `INGREDIENT_DENSITIES` dict from `src/utils/constants.py`
- [x] T006 [P] Remove `get_ingredient_density()` function from `src/utils/constants.py`
- [x] T007 Add tests for `get_density_g_per_ml()` method in `src/tests/models/`

### Implementation Notes
1. Modify Ingredient model first (T001-T004)
2. Remove constants in parallel (T005-T006)
3. Add tests to verify method works correctly (T007)
4. Database will need recreation (delete + reimport strategy)

### Parallel Opportunities
- T005 and T006 can proceed in parallel after model changes
- T007 can be written alongside T003-T004

### Dependencies
- None (foundation package)

### Risks & Mitigations
- Circular import risk (model importing converter) ‚Üí Use local import in method
- Breaking existing tests ‚Üí Will be fixed in subsequent packages

---

## Work Package WP02: Service Layer - Unit Converter (Priority: P0) ‚úÖ COMPLETE

**Goal**: Update unit converter to use Ingredient object instead of hardcoded density lookup.
**Independent Test**: Conversion functions accept Ingredient parameter and calculate correctly.
**Prompt**: `tasks/for_review/WP02-unit-converter-updates.md`

### Included Subtasks
- [x] T008 Update `convert_volume_to_weight()` to accept `ingredient` parameter in `src/services/unit_converter.py`
- [x] T009 Update `convert_weight_to_volume()` to accept `ingredient` parameter
- [x] T010 Update `convert_any_units()` to accept `ingredient` parameter
- [x] T011 Remove import of `get_ingredient_density` from unit_converter.py
- [x] T012 Update unit converter tests in `src/tests/services/test_unit_converter.py`

### Implementation Notes
1. Update function signatures to accept `ingredient: Ingredient = None`
2. Call `ingredient.get_density_g_per_ml()` instead of constant lookup
3. Keep `density_g_per_ml` override parameter for testing
4. Update error messages to be user-friendly

### Parallel Opportunities
- T008, T009, T010 modify different functions but are interdependent
- T012 should follow function updates

### Dependencies
- Depends on WP01 (model changes must be complete)

### Risks & Mitigations
- Breaking callers of conversion functions ‚Üí Will fix in WP03/WP04
- Type hints for Ingredient ‚Üí Use TYPE_CHECKING import

---

## Work Package WP03: Service Layer - Ingredient Service (Priority: P1) ‚úÖ COMPLETE üéØ MVP

**Goal**: Add density validation and update CRUD operations for 4-field density.
**Independent Test**: Can create/update ingredients with density; validation rejects partial input.
**Prompt**: `tasks/for_review/WP03-ingredient-service-updates.md`

### Included Subtasks
- [x] T013 Add `validate_density_fields()` function to `src/services/ingredient_service.py`
- [x] T014 Update `create_ingredient()` to accept/validate 4 density fields
- [x] T015 Update `update_ingredient()` to accept/validate 4 density fields
- [x] T016 Add tests for density validation in `src/tests/services/test_ingredient_service.py`
- [x] T017 Fix any broken tests referencing old density field

### Implementation Notes
1. Implement validation function first (all-or-nothing rule)
2. Update create/update to call validation before save
3. Ensure validation error messages are user-friendly
4. Update existing tests that may reference density_g_per_ml

### Parallel Opportunities
- T16 and T17 can proceed in parallel

### Dependencies
- Depends on WP01 (model) and WP02 (converter)

### Risks & Mitigations
- Existing tests may fail ‚Üí T017 handles cleanup
- Validation edge cases ‚Üí Test positive values, valid units

---

## Work Package WP04: Import/Export Updates (Priority: P1) ‚úÖ COMPLETE

**Goal**: Handle 4 density fields in JSON import/export; ignore legacy field.
**Independent Test**: Export includes 4 density fields; import reads them correctly.
**Prompt**: `tasks/for_review/WP04-import-export-updates.md`

### Included Subtasks
- [x] T018 Update `export_ingredients_to_json()` to include 4 density fields in `src/services/import_export_service.py`
- [x] T019 Update `import_ingredients_from_json()` to read 4 density fields
- [x] T020 Update `test_data/sample_data.json` with new density format
- [x] T021 Add import/export tests for density fields in `src/tests/services/test_import_export_service.py`

### Implementation Notes
1. Add 4 density fields to ingredient export dict
2. Read 4 fields on import; ignore `density_g_per_ml` if present
3. Update sample_data.json with realistic density values (e.g., flour: 1 cup = 4.25 oz)
4. Test round-trip: export ‚Üí import ‚Üí verify density intact

### Parallel Opportunities
- T018 and T019 can proceed in parallel
- T020 can be done alongside T18/T19
- T21 follows completion of above

### Dependencies
- Depends on WP01 (model fields must exist)

### Risks & Mitigations
- Legacy data in sample_data.json ‚Üí Remove old density_g_per_ml entries
- Round-trip precision ‚Üí Test with specific values

---

## Work Package WP05: UI - Density Input (Priority: P2) ‚úÖ COMPLETE

**Goal**: Add 4-field density input to ingredients tab and warning when conversion unavailable.
**Independent Test**: Can enter density via UI; warning shown when recipe needs conversion but density missing.
**Prompt**: `tasks/for_review/WP05-ui-density-input.md`

### Included Subtasks
- [x] T022 Create density input frame in `src/ui/ingredients_tab.py`
- [x] T023 Wire density fields to ingredient service layer
- [x] T024 Add density validation display in UI (error messages)
- [ ] T025 Add "Edit Ingredient" warning in recipe UI when conversion fails *(DEFERRED - conversion errors already return actionable messages)*

### Implementation Notes
1. Create 4-field layout: `[value] [unit ‚ñº] = [value] [unit ‚ñº]`
2. Use CTkComboBox for unit dropdowns (VOLUME_UNITS, WEIGHT_UNITS)
3. Show validation errors inline
4. In recipe forms, show warning with action button when density missing

### Parallel Opportunities
- T22-T24 are sequential (same file)
- T25 is in different file, can proceed after T22-T24

### Dependencies
- Depends on WP03 (ingredient service validation)

### Risks & Mitigations
- UI layout complexity ‚Üí Use grid layout for alignment
- Form state loss ‚Üí Preserve state when navigating to fix density

---

## Dependency & Execution Summary

```
WP01 (Model & Constants)
    ‚Üì
WP02 (Unit Converter) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚Üì                       ‚îÇ
WP03 (Ingredient Service) ‚îÄ‚îÄ‚î§
    ‚Üì                       ‚îÇ
WP05 (UI) ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

WP04 (Import/Export) ‚Üê depends only on WP01
```

- **Sequence**: WP01 ‚Üí WP02 ‚Üí WP03 ‚Üí WP05 (main path)
- **Parallelization**: WP04 can proceed after WP01, independent of WP02/WP03
- **MVP Scope**: WP01 + WP02 + WP03 = functional density input without UI polish

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Status |
|------------|---------|--------------|----------|--------|
| T001 | Remove density_g_per_ml field | WP01 | P0 | ‚úÖ |
| T002 | Add 4 density fields | WP01 | P0 | ‚úÖ |
| T003 | Add get_density_g_per_ml() method | WP01 | P0 | ‚úÖ |
| T004 | Add format_density_display() method | WP01 | P0 | ‚úÖ |
| T005 | Remove INGREDIENT_DENSITIES dict | WP01 | P0 | ‚úÖ |
| T006 | Remove get_ingredient_density() function | WP01 | P0 | ‚úÖ |
| T007 | Add tests for get_density_g_per_ml() | WP01 | P0 | ‚úÖ |
| T008 | Update convert_volume_to_weight() | WP02 | P0 | ‚úÖ |
| T009 | Update convert_weight_to_volume() | WP02 | P0 | ‚úÖ |
| T010 | Update convert_any_units() | WP02 | P0 | ‚úÖ |
| T011 | Remove get_ingredient_density import | WP02 | P0 | ‚úÖ |
| T012 | Update unit converter tests | WP02 | P0 | ‚úÖ |
| T013 | Add validate_density_fields() | WP03 | P1 | ‚úÖ |
| T014 | Update create_ingredient() | WP03 | P1 | ‚úÖ |
| T015 | Update update_ingredient() | WP03 | P1 | ‚úÖ |
| T016 | Add density validation tests | WP03 | P1 | ‚úÖ |
| T017 | Fix broken tests | WP03 | P1 | ‚úÖ |
| T018 | Update ingredient export | WP04 | P1 | ‚úÖ |
| T019 | Update ingredient import | WP04 | P1 | ‚úÖ |
| T020 | Update sample_data.json | WP04 | P1 | ‚úÖ |
| T021 | Add import/export tests | WP04 | P1 | ‚úÖ |
| T022 | Create density input frame | WP05 | P2 | ‚úÖ |
| T023 | Wire density fields to service | WP05 | P2 | ‚úÖ |
| T024 | Add UI validation display | WP05 | P2 | ‚úÖ |
| T025 | Add "Edit Ingredient" warning | WP05 | P2 | DEFERRED |
