# Work Packages: Fix MaterialUnit Management and Entry UX

**Inputs**: Design documents from `/kitty-specs/085-fix-material-unit-management-ux/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md

**Tests**: Unit tests required for the new conversion service (WP03).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`.

---

## Work Package WP01: Fix Material Units Tab Query (Priority: P1) üéØ MVP

**Goal**: Fix the Material Units tab to display all MaterialUnits from the database with product context.
**Independent Test**: Open Material Units tab and verify all units appear with their associated product names.
**Prompt**: `/tasks/WP01-fix-material-units-tab.md`
**Estimated Size**: ~250 lines

### Included Subtasks
- [x] T001 Investigate Material Units tab to find the broken query
- [x] T002 Fix query to use MaterialProduct ‚Üí MaterialUnit relationship (F084 schema)
- [x] T003 Add product name column to the listing for context

### Implementation Notes
- The F084 schema change moved MaterialUnit from Material to MaterialProduct
- Query must traverse: MaterialProduct.material_units (not Material.units which was removed)
- Include product.name in the display columns

### Parallel Opportunities
- Can run in parallel with WP02 and WP03 (different concerns)

### Dependencies
- None (starting package)

### Risks & Mitigations
- Query performance with joins ‚Üí Use eager loading with SQLAlchemy relationship

---

## Work Package WP02: Fix Edit/Delete Button Enablement (Priority: P1) üéØ MVP

**Goal**: Fix the Edit and Delete buttons to enable when any MaterialUnit is selected, regardless of material type.
**Independent Test**: Open Edit Product dialog for a linear product, select a unit, verify Edit/Delete buttons enable.
**Prompt**: `/tasks/WP02-fix-button-enablement.md`
**Estimated Size**: ~200 lines

### Included Subtasks
- [x] T004 Debug _on_units_tree_select handler to identify why buttons stay disabled
- [x] T005 Fix button enablement to work for all material types (each, linear_cm, square_cm)

### Implementation Notes
- Handler at `materials_tab.py:794-804` appears correct
- Likely issue: event binding or conditional logic elsewhere
- Add debug logging to trace execution path

### Parallel Opportunities
- Can run in parallel with WP01 and WP03 (different concerns)

### Dependencies
- None

### Risks & Mitigations
- Root cause unknown ‚Üí Start with debug logging before making changes

---

## Work Package WP03: Create Unit Conversion Service (Priority: P2)

**Goal**: Create a service module for linear unit conversions with proper test coverage.
**Independent Test**: Run `pytest src/tests/test_unit_conversion.py -v` and verify all tests pass.
**Prompt**: `/tasks/WP03-unit-conversion-service.md`
**Estimated Size**: ~300 lines

### Included Subtasks
- [x] T006 Create `src/services/unit_conversion_service.py` with LINEAR_UNITS dict
- [x] T007 Implement `convert_to_cm()` and `get_linear_unit_options()` functions
- [x] T008 Write comprehensive tests for the conversion service

### Implementation Notes
- Conversion factors: cm=1.0, in=2.54, ft=30.48, yd=91.44, m=100.0
- Service maintains layered architecture (business logic in services layer)
- Tests should cover: valid conversions, edge cases (zero, negative), invalid units

### Parallel Opportunities
- [P] Can run in parallel with WP01 and WP02 (no shared code)

### Dependencies
- None

### Risks & Mitigations
- Floating point precision ‚Üí Use round() for display, exact values for storage

---

## Work Package WP04: Enhance MaterialUnit Dialog (Priority: P2)

**Goal**: Add user-friendly unit selection dropdown for linear products with automatic conversion to cm.
**Independent Test**: Create a "8-inch ribbon" unit by entering "8" and selecting "inches", verify stored as 20.32 cm.
**Prompt**: `/tasks/WP04-enhance-dialog.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [x] T009 Detect linear product and conditionally show unit dropdown
- [ ] T010 Add CTkComboBox with unit options from conversion service
- [ ] T011 Implement conversion on save using `convert_to_cm()`
- [ ] T012 Update placeholder text and add conversion hint display

### Implementation Notes
- Only show dropdown for linear products (base_unit_type == 'linear_cm')
- Get base_unit_type: MaterialProduct ‚Üí Material.base_unit_type
- Default to 'cm' in dropdown, convert on save
- Show converted value before save for user confirmation

### Parallel Opportunities
- None (linear dependency on WP03)

### Dependencies
- Depends on WP03 (needs unit_conversion_service)

### Risks & Mitigations
- Complex dialog state ‚Üí Keep UI logic simple, delegate math to service

---

## Dependency & Execution Summary

```
WP01 ‚îÄ‚îê
WP02 ‚îÄ‚îº‚îÄ‚îÄ‚ñ∫ (parallel, independent)
WP03 ‚îÄ‚îò
       ‚îÇ
       ‚îî‚îÄ‚îÄ‚ñ∫ WP04 (depends on WP03)
```

- **Parallelization**: WP01, WP02, WP03 can all run simultaneously
- **Sequential**: WP04 must wait for WP03 to complete
- **MVP Scope**: WP01 + WP02 (fixes critical bugs, enables basic management)
- **Full Scope**: All 4 work packages (adds user-friendly unit entry)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Investigate Material Units tab query | WP01 | P1 | No |
| T002 | Fix query for F084 schema | WP01 | P1 | No |
| T003 | Add product name column | WP01 | P1 | No |
| T004 | Debug button handler | WP02 | P1 | No |
| T005 | Fix button enablement | WP02 | P1 | No |
| T006 | Create conversion service file | WP03 | P2 | Yes |
| T007 | Implement conversion functions | WP03 | P2 | No |
| T008 | Write conversion tests | WP03 | P2 | No |
| T009 | Detect linear product in dialog | WP04 | P2 | No |
| T010 | Add unit dropdown | WP04 | P2 | No |
| T011 | Implement conversion on save | WP04 | P2 | No |
| T012 | Update placeholder and hints | WP04 | P2 | No |
