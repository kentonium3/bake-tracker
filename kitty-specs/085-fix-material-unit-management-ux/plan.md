# Implementation Plan: Fix MaterialUnit Management and Entry UX

**Branch**: `085-fix-material-unit-management-ux` | **Date**: 2026-01-30 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/kitty-specs/085-fix-material-unit-management-ux/spec.md`

## Summary

Fix three issues with MaterialUnit management introduced after the F084 schema refactor (MaterialUnit moved from Material to MaterialProduct):
1. **Material Units tab empty** - Query needs to traverse MaterialProduct → MaterialUnit relationship
2. **Edit/Delete buttons disabled** - Selection handler not enabling buttons for linear product units
3. **Manual cm conversion required** - Add unit dropdown with auto-conversion for user-friendly entry

Technical approach: UI-layer fixes for issues 1-2, add conversion utility to service layer for issue 3.

## Technical Context

**Language/Version**: Python 3.10+
**Primary Dependencies**: CustomTkinter, SQLAlchemy 2.x, tkinter.ttk (Treeview)
**Storage**: SQLite with WAL mode
**Testing**: pytest
**Target Platform**: Desktop (Windows/macOS/Linux)
**Project Type**: Single desktop application
**Performance Goals**: N/A (simple CRUD operations)
**Constraints**: None
**Scale/Scope**: Single user, ~50 MaterialUnits maximum

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. User-Centric Design | ✅ PASS | Improves UX - users can enter familiar units instead of cm |
| II. Data Integrity | ✅ PASS | No changes to FIFO or cost calculations |
| III. Future-Proof Schema | ✅ PASS | No schema changes required |
| IV. Test-Driven Development | ✅ PASS | Will add tests for unit conversion utility |
| V. Layered Architecture | ✅ PASS | Conversion logic in service layer, UI calls service |
| VI. Schema Change Strategy | ✅ N/A | No schema changes |
| VII. Pragmatic Aspiration | ✅ PASS | Simple fix, low web migration cost |

**Gate Result**: PASSED - No violations requiring justification.

## Project Structure

### Documentation (this feature)

```
kitty-specs/085-fix-material-unit-management-ux/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 output (minimal - no unknowns)
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks/               # Work packages (generated by /spec-kitty.tasks)
```

### Source Code (files to modify)

```
src/
├── ui/
│   ├── materials_tab.py           # Fix tab listing query, button enablement
│   └── dialogs/
│       └── material_unit_dialog.py # Add unit dropdown, conversion on save
├── services/
│   └── unit_conversion_service.py  # NEW: Linear unit conversion utility
└── tests/
    └── test_unit_conversion.py     # NEW: Tests for conversion service
```

**Structure Decision**: Follows existing single-project layout. New service file for conversion logic maintains layered architecture principle.

## Technical Design

### Issue 1: Material Units Tab Empty

**Root Cause Hypothesis**: The Material Units tab query likely references the old Material → MaterialUnit relationship instead of MaterialProduct → MaterialUnit.

**Solution**: Update the query in `materials_tab.py` to:
1. Query `MaterialUnit` joined with `MaterialProduct`
2. Include product name in the listing for context
3. Ensure refresh triggers when units are created/edited/deleted

### Issue 2: Edit/Delete Buttons Disabled

**Root Cause Hypothesis**: The `_on_units_tree_select` handler may have a conditional that prevents enabling buttons for linear products, or the handler isn't being bound correctly.

**Solution**:
1. Debug the selection handler to identify why buttons stay disabled
2. Ensure buttons enable for ANY selected unit regardless of material type
3. The handler at line 794-804 in `materials_tab.py` should work - investigate binding

### Issue 3: Manual cm Conversion

**Solution**:
1. Create `unit_conversion_service.py` with conversion functions
2. Add unit dropdown to `MaterialUnitDialog` for linear products only
3. Convert user input to cm on save using service
4. Show converted value as confirmation (optional enhancement)

### Unit Conversion Service API

```python
# src/services/unit_conversion_service.py

LINEAR_UNITS = {
    'cm': 1.0,           # Base unit
    'in': 2.54,          # 1 inch = 2.54 cm
    'ft': 30.48,         # 1 foot = 30.48 cm
    'yd': 91.44,         # 1 yard = 91.44 cm
    'm': 100.0,          # 1 meter = 100 cm
}

def convert_to_cm(value: float, from_unit: str) -> float:
    """Convert a linear measurement to centimeters."""
    ...

def get_linear_unit_options() -> list[tuple[str, str]]:
    """Return list of (code, display_name) for dropdown."""
    ...
```

## Complexity Tracking

*No violations requiring justification.*

## Phase 0: Research

No unknowns requiring research. The solution approach is straightforward:
- Standard SQLAlchemy query adjustment
- Standard tkinter event handler debugging
- Simple arithmetic conversion

**research.md**: Will document the investigation findings for issues 1 and 2.

## Phase 1: Design Complete

- **data-model.md**: Not needed - no schema changes
- **contracts/**: Not needed - no API changes
- **quickstart.md**: Not needed - simple bug fixes

## Work Package Outline (for /spec-kitty.tasks)

Suggested breakdown:
1. **WP01**: Investigate and fix Material Units tab query
2. **WP02**: Debug and fix Edit/Delete button enablement
3. **WP03**: Create unit conversion service with tests
4. **WP04**: Add unit dropdown to MaterialUnitDialog

Dependencies: WP03 must complete before WP04 (dialog needs conversion service).
