# Work Packages: Packaging & BOM Foundation

**Feature Branch**: `011-packaging-bom-foundation`
**Inputs**: Design documents from `/kitty-specs/011-packaging-bom-foundation/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, contracts/, quickstart.md

**Tests**: Test coverage required per Constitution Principle IV (TDD). Service layer must exceed 70% coverage.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/planned/` generated by `/spec-kitty.tasks`.

---

## Work Package WP01: Schema Updates & Model Changes (Priority: P0)

**Goal**: Update Ingredient and Composition models with packaging support; ensure database auto-creates correctly.
**Independent Test**: Models can be imported; new columns exist; XOR constraints work.
**Prompt**: `tasks/planned/WP01-schema-model-updates.md`

### Included Subtasks
- [x] T001 Add `is_packaging` boolean column to Ingredient model in `src/models/ingredient.py`
- [x] T002 Add `package_id` FK column to Composition model in `src/models/composition.py`
- [x] T003 Add `packaging_product_id` FK column to Composition model
- [x] T004 Change `component_quantity` from Integer to Float in Composition model
- [x] T005 Update CheckConstraint for parent XOR (assembly_id OR package_id)
- [x] T006 Update CheckConstraint for component XOR (3-way: finished_unit_id, finished_good_id, packaging_product_id)
- [x] T007 Add new indexes and unique constraints for packaging columns
- [x] T008 Add `packaging_product` relationship to Composition model
- [x] T009 Add `package` relationship to Composition model
- [x] T010 Add `packaging_compositions` back-reference to Package model in `src/models/package.py`
- [x] T011 Update `src/models/__init__.py` to ensure proper import order

### Implementation Notes
1. Backup existing data with export before testing
2. Delete database and let SQLAlchemy auto-create
3. Verify all existing tests still pass (regression check)

### Parallel Opportunities
- T001 (Ingredient) can proceed independently of T002-T010 (Composition/Package)

### Dependencies
- None (foundational package)

### Risks & Mitigations
- Risk: Existing data loss during schema change
- Mitigation: Export/backup before changes; reimport after validation

---

## Work Package WP02: Ingredient Service Packaging Extensions (Priority: P1)

**Goal**: Extend ingredient_service to support packaging flag and filtering.
**Independent Test**: Can create packaging ingredient; can filter packaging vs food ingredients.
**Prompt**: `tasks/planned/WP02-ingredient-service.md`

### Included Subtasks
- [x] T012 Add `PACKAGING_CATEGORIES` constant list to `src/services/ingredient_service.py`
- [x] T013 Update `create_ingredient()` to accept `is_packaging` parameter
- [x] T014 Update `update_ingredient()` to support `is_packaging` flag changes with protection
- [x] T015 [P] Implement `get_packaging_ingredients()` method
- [x] T016 [P] Implement `get_food_ingredients()` method
- [x] T017 [P] Implement `is_packaging_ingredient(ingredient_id)` helper
- [x] T018 [P] Implement `validate_packaging_category(category)` helper
- [x] T019 Add unit tests for all new methods in `src/tests/test_services.py`

### Implementation Notes
- Follow existing service patterns in ingredient_service.py
- Category warning (not rejection) when is_packaging=True but category not in PACKAGING_CATEGORIES

### Parallel Opportunities
- T015-T018 are independent query methods; can be implemented in parallel

### Dependencies
- Depends on WP01 (model changes)

### Risks & Mitigations
- Risk: Breaking existing ingredient workflows
- Mitigation: is_packaging defaults to False; existing behavior unchanged

---

## Work Package WP03: Composition Service Packaging Extensions (Priority: P1)

**Goal**: Extend composition_service to support packaging compositions for both FinishedGood and Package.
**Independent Test**: Can add/remove/update packaging on FinishedGood; can add packaging on Package.
**Prompt**: `tasks/planned/WP03-composition-service.md`

### Included Subtasks
- [x] T020 Update `create_composition()` to accept `package_id` and `packaging_product_id` parameters
- [x] T021 Implement `add_packaging_to_assembly()` method
- [x] T022 Implement `add_packaging_to_package()` method
- [x] T023 [P] Implement `get_assembly_packaging(assembly_id)` method
- [x] T024 [P] Implement `get_package_packaging(package_id)` method
- [x] T025 Implement `update_packaging_quantity(composition_id, quantity)` method
- [x] T026 Implement `remove_packaging(composition_id)` method
- [x] T027 Add validation: verify product is packaging before adding to composition
- [x] T028 Add validation: block deletion of products referenced in compositions (catch IntegrityError)
- [x] T029 Add unit tests for all new methods

### Implementation Notes
- Use existing factory methods pattern from Composition model as reference
- Validate packaging product by checking ingredient.is_packaging

### Parallel Opportunities
- T023 and T024 are independent query methods

### Dependencies
- Depends on WP01 (model changes)
- Depends on WP02 (is_packaging_ingredient helper)

### Risks & Mitigations
- Risk: XOR constraint violations
- Mitigation: Service layer validates before insert; constraint catches edge cases

---

## Work Package WP04: Event Service Shopping List Extensions (Priority: P2)

**Goal**: Extend event_service to aggregate and display packaging needs on shopping lists.
**Independent Test**: Event with packaging definitions shows packaging section in shopping list.
**Prompt**: `tasks/planned/WP04-shopping-list-packaging.md`

### Included Subtasks
- [x] T030 Add `PackagingNeed` dataclass to `src/services/event_service.py`
- [x] T031 Add `PackagingSource` dataclass (optional detailed breakdown)
- [x] T032 Implement `get_event_packaging_needs(event_id)` method
- [x] T033 Implement `_aggregate_packaging(event_id)` internal helper
- [x] T034 Implement `_get_packaging_on_hand(product_id)` inventory lookup helper
- [x] T035 Update `get_event_shopping_list()` to include `packaging` section in return dict
- [x] T036 [P] Implement `get_event_packaging_breakdown(event_id)` for detailed sourcing (optional)
- [x] T037 Add unit tests for packaging aggregation logic
- [x] T038 Add integration test: event with FG and Package packaging aggregates correctly

### Implementation Notes
- Traverse: Event -> ERP -> Package -> packaging_compositions
- Traverse: Event -> ERP -> Package -> package_finished_goods -> FG -> components (where packaging_product_id)
- Aggregate by product_id; subtract on_hand inventory

### Parallel Opportunities
- T036 (breakdown) is optional and independent of core aggregation

### Dependencies
- Depends on WP01, WP03 (packaging compositions must exist)

### Risks & Mitigations
- Risk: Empty packaging section when no packaging defined
- Mitigation: Only include "packaging" key if needs exist; UI handles empty gracefully

---

## Work Package WP05: Import/Export Service Updates (Priority: P2)

**Goal**: Update import/export to preserve all packaging data through export/import cycle.
**Independent Test**: Export with packaging; import to fresh DB; all data restored correctly.
**Prompt**: `tasks/planned/WP05-import-export-packaging.md`

### Included Subtasks
- [x] T039 Update ingredient export to include `is_packaging` field
- [x] T040 Update ingredient import to handle `is_packaging` (default False if missing)
- [x] T041 Update composition export to include `package_id` and `packaging_product_id`
- [x] T042 Update composition import to handle new fields (null defaults)
- [x] T043 Update composition import to handle Float `component_quantity`
- [x] T044 Add validation during import: reject invalid parent/component combinations
- [x] T045 Increment `format_version` in export metadata to "2.0"
- [x] T046 Add integration test: full export/import cycle preserves packaging data

### Implementation Notes
- Follow existing import/export patterns
- No backward compatibility required per FR-017

### Parallel Opportunities
- T039-T040 (ingredient) independent of T041-T044 (composition)

### Dependencies
- Depends on WP01, WP02, WP03 (all schema and service changes)

### Risks & Mitigations
- Risk: Data loss during format migration
- Mitigation: Clear error messages for old format; user exports before update

---

## Work Package WP06: UI Integration (Priority: P2)

**Goal**: Add packaging sections to existing dialogs for FinishedGood and Package editing.
**Independent Test**: User can add/view/edit packaging on FinishedGood; same for Package.
**Prompt**: `tasks/planned/WP06-ui-integration.md`

### Included Subtasks
- [x] T047 Update Ingredients tab to show is_packaging indicator/column
- [x] T048 Update ingredient create/edit dialog with is_packaging checkbox
- [x] T049 Add packaging category dropdown when is_packaging=True
- [x] T050 Add "Packaging" section to FinishedGood assembly dialog
- [x] T051 Implement packaging product selector (filter to is_packaging=True products)
- [x] T052 Implement quantity input (support decimals) for packaging
- [x] T053 Add "Packaging" section to Package dialog
- [x] T054 Update shopping list display to show separate "Packaging" section
- [x] T055 [P] Add visual distinction for packaging in My Pantry view

### Implementation Notes
- Reuse existing composition editing patterns
- Keep UI changes minimal per planning decision Q3
- Shopping list: "Ingredients" section then "Packaging" section

### Parallel Opportunities
- T047-T049 (Ingredient UI) independent of T050-T052 (FG UI) and T053 (Package UI)

### Dependencies
- Depends on WP01-WP04 (all service layer work)

### Risks & Mitigations
- Risk: UI complexity for non-technical user
- Mitigation: Simple inline forms; reuse existing patterns; user testing

---

## Work Package WP07: Validation & Edge Cases (Priority: P3)

**Goal**: Handle edge cases and ensure referential integrity works correctly.
**Independent Test**: Deletion blocked when product referenced; empty states handled.
**Prompt**: `tasks/planned/WP07-validation-edge-cases.md`

### Included Subtasks
- [x] T056 Implement user-friendly error when trying to delete packaging product in use
- [x] T057 Test: shopping list with no packaging shows only ingredients (no empty section)
- [x] T058 Test: packaging ingredient with no products is allowed
- [x] T059 Test: fractional quantities (0.5, 1.5) work correctly
- [x] T060 Test: same packaging product used in FG and Package aggregates correctly
- [x] T061 Test: cascade delete of Package removes its packaging compositions
- [x] T062 Test: cascade delete of FinishedGood removes its packaging compositions
- [x] T063 Verify RESTRICT on packaging_product_id FK works with SQLite

### Implementation Notes
- Focus on edge cases identified in spec
- Ensure FK constraints with PRAGMA foreign_keys=ON

### Parallel Opportunities
- All tests can run independently

### Dependencies
- Depends on WP01-WP06 (full implementation)

### Risks & Mitigations
- Risk: SQLite FK behavior differs from PostgreSQL
- Mitigation: Explicit tests verify SQLite RESTRICT behavior

---

## Dependency & Execution Summary

```
WP01 (Schema) ──┬──> WP02 (Ingredient Service) ──┬──> WP06 (UI)
                │                                 │
                ├──> WP03 (Composition Service) ──┤
                │                                 │
                └──> WP04 (Shopping List) ────────┤
                                                  │
                     WP05 (Import/Export) ────────┘
                                                  │
                                            WP07 (Validation)
```

- **Sequence**: WP01 → (WP02, WP03 parallel) → (WP04, WP05, WP06 parallel) → WP07
- **Parallelization**: After WP01, WP02 and WP03 can proceed in parallel. After those, WP04-WP06 can proceed in parallel.
- **MVP Scope**: WP01 + WP02 + WP03 delivers core packaging inventory and composition capability (User Story 1 complete, partial User Story 2-3)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Add is_packaging to Ingredient | WP01 | P0 | Yes |
| T002 | Add package_id FK to Composition | WP01 | P0 | No |
| T003 | Add packaging_product_id FK to Composition | WP01 | P0 | No |
| T004 | Change component_quantity to Float | WP01 | P0 | No |
| T005 | Update parent XOR constraint | WP01 | P0 | No |
| T006 | Update component XOR constraint | WP01 | P0 | No |
| T007 | Add indexes/unique constraints | WP01 | P0 | No |
| T008 | Add packaging_product relationship | WP01 | P0 | No |
| T009 | Add package relationship | WP01 | P0 | No |
| T010 | Add packaging_compositions to Package | WP01 | P0 | No |
| T011 | Update models __init__.py | WP01 | P0 | No |
| T012 | Add PACKAGING_CATEGORIES constant | WP02 | P1 | No |
| T013 | Update create_ingredient() | WP02 | P1 | No |
| T014 | Update update_ingredient() | WP02 | P1 | No |
| T015 | Implement get_packaging_ingredients() | WP02 | P1 | Yes |
| T016 | Implement get_food_ingredients() | WP02 | P1 | Yes |
| T017 | Implement is_packaging_ingredient() | WP02 | P1 | Yes |
| T018 | Implement validate_packaging_category() | WP02 | P1 | Yes |
| T019 | Add ingredient service tests | WP02 | P1 | No |
| T020 | Update create_composition() | WP03 | P1 | No |
| T021 | Implement add_packaging_to_assembly() | WP03 | P1 | No |
| T022 | Implement add_packaging_to_package() | WP03 | P1 | No |
| T023 | Implement get_assembly_packaging() | WP03 | P1 | Yes |
| T024 | Implement get_package_packaging() | WP03 | P1 | Yes |
| T025 | Implement update_packaging_quantity() | WP03 | P1 | No |
| T026 | Implement remove_packaging() | WP03 | P1 | No |
| T027 | Add packaging product validation | WP03 | P1 | No |
| T028 | Handle product deletion restriction | WP03 | P1 | No |
| T029 | Add composition service tests | WP03 | P1 | No |
| T030 | Add PackagingNeed dataclass | WP04 | P2 | No |
| T031 | Add PackagingSource dataclass | WP04 | P2 | No |
| T032 | Implement get_event_packaging_needs() | WP04 | P2 | No |
| T033 | Implement _aggregate_packaging() | WP04 | P2 | No |
| T034 | Implement _get_packaging_on_hand() | WP04 | P2 | No |
| T035 | Update get_event_shopping_list() | WP04 | P2 | No |
| T036 | Implement get_event_packaging_breakdown() | WP04 | P2 | Yes |
| T037 | Add shopping list unit tests | WP04 | P2 | No |
| T038 | Add shopping list integration test | WP04 | P2 | No |
| T039 | Update ingredient export | WP05 | P2 | Yes |
| T040 | Update ingredient import | WP05 | P2 | Yes |
| T041 | Update composition export | WP05 | P2 | Yes |
| T042 | Update composition import | WP05 | P2 | Yes |
| T043 | Handle Float quantity import | WP05 | P2 | No |
| T044 | Add import validation | WP05 | P2 | No |
| T045 | Increment format_version | WP05 | P2 | No |
| T046 | Add export/import integration test | WP05 | P2 | No |
| T047 | Update Ingredients tab UI | WP06 | P2 | Yes |
| T048 | Update ingredient dialog | WP06 | P2 | Yes |
| T049 | Add packaging category dropdown | WP06 | P2 | Yes |
| T050 | Add FG packaging section | WP06 | P2 | Yes |
| T051 | Implement packaging product selector | WP06 | P2 | No |
| T052 | Implement decimal quantity input | WP06 | P2 | No |
| T053 | Add Package packaging section | WP06 | P2 | Yes |
| T054 | Update shopping list display | WP06 | P2 | No |
| T055 | Add pantry packaging visual distinction | WP06 | P2 | Yes |
| T056 | Friendly delete error message | WP07 | P3 | No |
| T057 | Test: empty packaging handling | WP07 | P3 | Yes |
| T058 | Test: ingredient with no products | WP07 | P3 | Yes |
| T059 | Test: fractional quantities | WP07 | P3 | Yes |
| T060 | Test: aggregation across FG and Package | WP07 | P3 | Yes |
| T061 | Test: Package cascade delete | WP07 | P3 | Yes |
| T062 | Test: FG cascade delete | WP07 | P3 | Yes |
| T063 | Verify SQLite RESTRICT behavior | WP07 | P3 | No |
