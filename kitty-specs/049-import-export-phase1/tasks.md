# Work Packages: Import/Export System Phase 1

**Inputs**: Design documents from `/kitty-specs/049-import-export-phase1/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md

**Tests**: Unit tests required per constitution principle IV. Integration tests in WP8.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/planned/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

## Path Conventions
- **Services**: `src/services/`
- **UI**: `src/ui/dialogs/`
- **Tests**: `src/tests/services/`, `src/tests/integration/`
- **Docs**: `docs/design/`

---

## Work Package WP01: Complete System Backup (Priority: P1) - MVP

**Goal**: Export all 16 entity types with manifest for complete system backup/restore.
**Independent Test**: Export full backup, verify 16 entity files + manifest.json with accurate counts.
**Prompt**: `tasks/planned/WP01-complete-system-backup.md`
**Agent**: Claude

### Included Subtasks
- [ ] T001 Add finished_goods exporter in `src/services/coordinated_export_service.py`
- [ ] T002 [P] Add events exporter
- [ ] T003 [P] Add production_runs exporter
- [ ] T004 [P] Add inventory_depletions exporter
- [ ] T005 Update DEPENDENCY_ORDER constant with 4 new entities
- [ ] T006 Update manifest generation to include all 16 entities
- [ ] T007 Add unit tests for new entity exporters in `src/tests/services/test_coordinated_export_service.py`
- [ ] T008 Verify empty arrays exported for entities with zero records

### Implementation Notes
- Follow existing exporter pattern (suppliers, ingredients, products)
- Each entity exports to numbered file (e.g., `07_materials.json`)
- Manifest includes sha256 hash and record count per entity
- Use slug-based FK references throughout

### Parallel Opportunities
- T002-T008 can proceed in parallel after T001 establishes pattern
- Tests (T011) can be written alongside implementation

### Dependencies
- None (foundation work package)

### Risks & Mitigations
- FK resolution complexity → follow existing patterns exactly
- Missing relationships → verify against model definitions

---

## Work Package WP02: Materials Catalog Import (Priority: P2)

**Goal**: Import materials and material_products from JSON, matching ingredient import pattern.
**Independent Test**: Import materials JSON, verify records visible in Materials tab.
**Prompt**: `tasks/planned/WP02-materials-catalog-import.md`
**Agent**: Gemini

### Included Subtasks
- [ ] T013 Add `import_materials()` function in `src/services/catalog_import_service.py`
- [ ] T014 Add `import_material_products()` with slug resolution
- [ ] T015 Support ADD_ONLY mode for materials
- [ ] T016 Support AUGMENT mode for materials (update null fields only)
- [ ] T017 Add validation for circular category references
- [ ] T018 Add unit tests in `src/tests/services/test_catalog_import_service.py`
- [ ] T019 Verify import result counts (created/updated/skipped/errors)

### Implementation Notes
- Mirror `import_ingredients()` structure exactly (SC-013)
- Material_products resolve `material_slug` to parent material
- Protected fields: slug, display_name, id, date_added, category
- Augmentable fields: description, notes, other nullable fields

### Parallel Opportunities
- T015 and T016 can proceed in parallel
- Tests (T018) can be written alongside implementation

### Dependencies
- Depends on WP01 (for coordinated export to verify round-trip)

### Risks & Mitigations
- Pattern mismatch with ingredients → code review against ingredient import
- Circular references → validate hierarchy before insert

---

## Work Package WP03: Context-Rich Export (Priority: P3)

**Goal**: Export ingredients, materials, recipes with hierarchy paths and computed values.
**Independent Test**: Export ingredients context-rich, verify hierarchy paths and inventory totals.
**Prompt**: `tasks/planned/WP03-context-rich-export.md`
**Agent**: Gemini

### Included Subtasks
- [ ] T020 Add `export_ingredients_view()` in `src/services/denormalized_export_service.py`
- [ ] T021 Include hierarchy paths (e.g., "Flours & Starches > Wheat Flours > All-Purpose")
- [ ] T022 Include related products as nested array
- [ ] T023 Include computed inventory totals and average costs
- [ ] T024 [P] Add `export_materials_view()` with hierarchy paths
- [ ] T025 [P] Add `export_recipes_view()` with embedded ingredients
- [ ] T026 Include computed recipe costs
- [ ] T027 Add `_meta` section with editable/readonly field lists
- [ ] T028 Add unit tests in `src/tests/services/test_denormalized_export_service.py`

### Implementation Notes
- Follow existing `export_products_view()` pattern
- `_meta` section enables auto-detection for import
- Editable fields: description, notes, instructions
- Readonly fields: id, slug, computed values, hierarchy paths

### Parallel Opportunities
- T024 (materials) and T025 (recipes) can proceed in parallel after T020-T23

### Dependencies
- None (independent of other WPs)

### Risks & Mitigations
- Performance on large datasets → use eager loading, batch queries
- Hierarchy path calculation → handle missing parents gracefully

---

## Work Package WP04: Purchase Transaction Import (Priority: P4)

**Goal**: Import purchase transactions, create Purchase + InventoryItem records, update costs.
**Independent Test**: Import purchases JSON, verify inventory quantities increased.
**Prompt**: `tasks/planned/WP04-purchase-transaction-import.md`
**Agent**: Gemini

### Included Subtasks
- [ ] T029 Create `src/services/transaction_import_service.py` with `import_purchases()`
- [ ] T030 Validate positive quantities (reject negative)
- [ ] T031 Resolve product_slug to Product record
- [ ] T032 Create Purchase record for each transaction
- [ ] T033 Create InventoryItem record linked to Purchase
- [ ] T034 Recalculate weighted average costs
- [ ] T035 Implement duplicate detection (product_slug + date + cost)
- [ ] T036 Return ImportResult with counts
- [ ] T037 Add unit tests in `src/tests/services/test_transaction_import_service.py`

### Implementation Notes
- New service file for transaction imports (separate from catalog imports)
- Uses existing ImportResult class from import_export_service
- Duplicate purchases skipped with warning (not error)
- All operations atomic - rollback on any failure

### Parallel Opportunities
- T030-T35 can be developed in sequence within single session
- Tests (T37) can be written alongside implementation

### Dependencies
- Depends on WP01 (for export to verify round-trip)

### Risks & Mitigations
- Cost calculation errors → verify against existing purchase service
- Duplicate detection false positives → use three-field combination

---

## Work Package WP05: Inventory Adjustment Import (Priority: P5)

**Goal**: Import inventory adjustments (spoilage, waste, corrections), decrease inventory.
**Independent Test**: Import adjustments JSON with negative quantities, verify inventory decreased.
**Prompt**: `tasks/planned/WP05-inventory-adjustment-import.md`
**Agent**: Gemini

### Included Subtasks
- [ ] T038 Add `import_adjustments()` in `src/services/transaction_import_service.py`
- [ ] T039 Validate negative quantities only (reject positive)
- [ ] T040 Require reason_code (spoilage, waste, correction, other)
- [ ] T041 Validate reason_code against allowed list
- [ ] T042 Resolve product_slug to Product and find InventoryItem (FIFO)
- [ ] T043 Prevent adjustments exceeding available inventory
- [ ] T044 Create adjustment record (consumption or depletion)
- [ ] T045 Update InventoryItem.current_quantity
- [ ] T046 Add unit tests for adjustment import

### Implementation Notes
- Extend transaction_import_service.py (same file as WP04)
- FIFO: adjust oldest inventory item first
- Allowed reason codes: spoilage, waste, correction, other
- Return clear error if adjustment would create negative inventory

### Parallel Opportunities
- Can proceed in parallel with WP04 if file coordination managed

### Dependencies
- WP04 (creates transaction_import_service.py)

### Risks & Mitigations
- FIFO selection edge cases → test with multiple inventory items
- Negative inventory prevention → validate before any DB writes

---

## Work Package WP06: Context-Rich Import with Auto-Detection (Priority: P6)

**Goal**: Auto-detect format, extract editable fields from context-rich imports, ignore computed.
**Independent Test**: Import context-rich file, verify editable fields updated, computed ignored.
**Prompt**: `tasks/planned/WP06-context-rich-import.md`
**Agent**: Claude

### Included Subtasks
- [ ] T047 Add `detect_format()` in `src/services/enhanced_import_service.py`
- [ ] T048 Detect context-rich by `_meta` field presence
- [ ] T049 Detect normalized by `version` + `application` fields
- [ ] T050 Extract editable fields only from context-rich records
- [ ] T051 Ignore readonly/computed fields during import
- [ ] T052 Merge editable fields with existing records
- [ ] T053 Return detection result for UI confirmation
- [ ] T054 Add unit tests in `src/tests/services/test_enhanced_import_service.py`

### Implementation Notes
- Detection algorithm based on _meta.editable_fields presence
- Editable fields from _meta section drive import behavior
- Computed fields (inventory totals, hierarchy paths) silently ignored
- Merge mode: update existing records, don't create duplicates

### Parallel Opportunities
- Tests (T054) can be written alongside implementation

### Dependencies
- WP03 (must have context-rich exports to test against)

### Risks & Mitigations
- Format detection ambiguity → test with varied file formats
- Field extraction errors → validate against _meta editable_fields list

---

## Work Package WP07: Redesigned Import/Export UI (Priority: P7)

**Goal**: Clear UI distinguishing 3 export types and 4 import purposes with auto-detection.
**Independent Test**: Navigate dialogs, verify clear labels and appropriate options per type.
**Prompt**: `tasks/planned/WP07-redesigned-ui.md`
**Agent**: Gemini

### Included Subtasks
- [ ] T055 Redesign export dialog with 3 tabs in `src/ui/dialogs/import_export_dialog.py`
- [ ] T056 Full Backup tab: no entity selection, exports all 16
- [ ] T057 Catalog Export tab: entity selection, format selection
- [ ] T058 Context-Rich Export tab: entity selection for views
- [ ] T059 Add purpose explanations for each export type
- [ ] T060 Redesign import dialog with 4 purpose options
- [ ] T061 Backup Restore: full restore, no mode selection
- [ ] T062 Catalog Import: entity selection, ADD_ONLY/AUGMENT mode
- [ ] T063 Purchases Import: file selection, validation preview
- [ ] T064 Adjustments Import: file selection, validation preview
- [ ] T065 Integrate auto-detection with confirmation display
- [ ] T066 Add progress indicator during import/export

### Implementation Notes
- Use CustomTkinter CTkTabview for export types
- Import dialog shows detected format before proceeding
- Call service layer methods - no business logic in UI
- Follow existing dialog patterns in codebase

### Parallel Opportunities
- Export (T055-T59) and Import (T060-T65) can proceed in parallel

### Dependencies
- WP01 (full backup service), WP02 (materials import), WP03 (context-rich export)
- WP04 (purchase import), WP05 (adjustment import), WP06 (auto-detection)

### Risks & Mitigations
- UI complexity → start with working wireframe, iterate
- Service integration → mock services for UI development

---

## Work Package WP08: Integration Testing (Priority: P8)

**Goal**: Comprehensive integration tests validating all workflows end-to-end.
**Independent Test**: All integration tests pass, >70% service coverage.
**Prompt**: `tasks/planned/WP08-integration-testing.md`
**Agent**: Claude

### Included Subtasks
- [ ] T067 Create `src/tests/integration/test_import_export_roundtrip.py`
- [ ] T068 Test: full backup export → reset DB → import → verify counts
- [ ] T069 Test: context-rich export → modify editable → import → verify changes
- [ ] T070 Test: purchase import → verify inventory increased
- [ ] T071 Test: adjustment import → verify inventory decreased
- [ ] T072 Test: error handling and rollback on failure
- [ ] T073 Test: format auto-detection accuracy
- [ ] T074 Verify >70% coverage on new service code
- [ ] T075 Document test fixtures and data requirements

### Implementation Notes
- Use pytest fixtures for database setup/teardown
- Create sample JSON files for each import type
- Test both happy path and error conditions
- Verify atomic rollback on partial failures

### Parallel Opportunities
- Individual test files can be developed in parallel

### Dependencies
- All previous WPs must be complete

### Risks & Mitigations
- Test data complexity → use minimal representative datasets
- Flaky tests → ensure proper isolation between test cases

---

## Work Package WP09: Documentation Update (Priority: P9)

**Goal**: Update spec_import_export.md with all new capabilities for AI system reference.
**Independent Test**: Documentation accurately describes all new schemas and workflows.
**Prompt**: `tasks/planned/WP09-documentation-update.md`
**Agent**: Gemini

### Included Subtasks
- [ ] T076 Update entity list to 14 types in `docs/design/spec_import_export.md`
- [ ] T077 Document manifest format with new entities
- [ ] T078 Add materials and material_products import schemas
- [ ] T079 Document context-rich export schemas (ingredients, materials, recipes)
- [ ] T080 Document `_meta` section format for views
- [ ] T081 Add purchase transaction import schema
- [ ] T082 Add inventory adjustment import schema
- [ ] T083 Document format auto-detection rules
- [ ] T084 Update Appendix sections (categories, units, examples)
- [ ] T085 Add complete JSON examples for each new format

### Implementation Notes
- Follow existing documentation style in spec_import_export.md
- Include schema tables with field, type, required, description
- Provide complete JSON examples for each format
- This document is referenced by AI systems (BT Mobile)

### Parallel Opportunities
- Different sections (T076-T85) can be drafted in parallel

### Dependencies
- WP01-WP06 (need implementation details for accurate docs)

### Risks & Mitigations
- Documentation drift → review against implemented code
- Missing examples → test examples against actual import/export

---

## Dependency & Execution Summary

- **Sequence**: WP01 → Wave 1 (WP02, WP03, WP07) → Wave 2 (WP04, WP05, WP06, WP09) → WP08
- **Parallelization**:
  - Wave 1: WP02, WP03, WP07 (all Gemini, different files)
  - Wave 2: WP04, WP05, WP09 (Gemini); WP06 (Claude, depends on WP03)
- **MVP Scope**: WP01 (Complete System Backup) - enables database reset/restore workflow

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Finished goods exporter | WP01 | P1 | No |
| T002-T004 | Events, production_runs, inventory_depletions exporters | WP01 | P1 | Yes |
| T005-T008 | DEPENDENCY_ORDER, manifest, tests, empty arrays | WP01 | P1 | No |
| T013-T019 | Materials import | WP02 | P2 | Partial |
| T020-T028 | Context-rich export | WP03 | P3 | Partial |
| T029-T037 | Purchase import | WP04 | P4 | No |
| T038-T046 | Adjustment import | WP05 | P5 | No |
| T047-T054 | Format auto-detection | WP06 | P6 | No |
| T055-T066 | UI redesign | WP07 | P7 | Partial |
| T067-T075 | Integration tests | WP08 | P8 | Partial |
| T076-T085 | Documentation | WP09 | P9 | Yes |

---

## Agent Assignment Summary

| Work Package | Agent | Est Hours | Files |
|--------------|-------|-----------|-------|
| WP01 | Claude | 3-4 | coordinated_export_service.py |
| WP02 | Gemini | 2-3 | catalog_import_service.py |
| WP03 | Gemini | 3-4 | denormalized_export_service.py |
| WP04 | Gemini | 3-4 | transaction_import_service.py (NEW) |
| WP05 | Gemini | 3-4 | transaction_import_service.py |
| WP06 | Claude | 2-3 | enhanced_import_service.py |
| WP07 | Gemini | 3-4 | import_export_dialog.py |
| WP08 | Claude | 2-3 | integration tests |
| WP09 | Gemini | 2-3 | spec_import_export.md |

**Total**: 9 work packages, 85 subtasks
**Claude**: 3 WPs (WP01, WP06, WP08)
**Gemini**: 6 WPs (WP02, WP03, WP04, WP05, WP07, WP09)
