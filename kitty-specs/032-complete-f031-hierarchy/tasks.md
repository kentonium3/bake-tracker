# Work Packages: Complete F031 Hierarchy UI

**Inputs**: Design documents from `kitty-specs/032-complete-f031-hierarchy/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, quickstart.md

**Tests**: Manual UI testing only (no automated test requirements specified).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/planned/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Ingredients Grid Columns (Priority: P1) MVP

**Goal**: Replace deprecated "Category" column with three-tier hierarchy columns (L0, L1, Name) in Ingredients tab.
**Independent Test**: Open Ingredients tab, verify columns show Root Category, Subcategory, and Name for all ingredients.
**Prompt**: `tasks/planned/WP01-ingredients-grid-columns.md`
**User Story**: US1 - View Ingredients by Hierarchy

### Included Subtasks
- [ ] T001 Build hierarchy cache using `get_ancestors()` for efficient display
- [ ] T002 Replace "Category" column header with "Root (L0)" column in grid configuration
- [ ] T003 Add "Subcategory (L1)" column to grid configuration
- [ ] T004 Update `_update_ingredient_display()` to populate L0/L1 columns from cache
- [ ] T005 Ensure column sorting works for each hierarchy column
- [ ] T006 Display dash ("--") for empty hierarchy levels (L0/L1 items)

### Implementation Notes
- Reference: `src/ui/forms/add_product_dialog.py` for hierarchy service usage
- Service: `ingredient_hierarchy_service.get_ancestors(ingredient_id)`
- Build cache once per display refresh, not per row
- Ancestors returns `[immediate_parent, grandparent, ...]` - L1 is index 0, L0 is index 1 for leaf ingredients

### Parallel Opportunities
- T001 cache building can be developed independently from T002-T003 column configuration

### Dependencies
- None (starting package)

### Risks & Mitigations
- Performance with large ingredient lists: Cache mitigates N+1 queries
- Column width issues: May need to adjust column widths for longer hierarchy names

---

## Work Package WP02: Ingredients Level Filter (Priority: P1) MVP

**Goal**: Replace deprecated category dropdown with hierarchy level filter in Ingredients tab.
**Independent Test**: Select each filter option (All, L0, L1, L2) and verify correct ingredients appear.
**Prompt**: `tasks/planned/WP02-ingredients-level-filter.md`
**User Story**: US2 - Filter Ingredients by Hierarchy Level

### Included Subtasks
- [ ] T007 Remove deprecated category dropdown from filter area
- [ ] T008 Add level filter dropdown with options: All Levels, Root (L0), Subcategory (L1), Leaf (L2)
- [ ] T009 Update `_apply_filters()` to filter by `hierarchy_level` field
- [ ] T010 Ensure search works across all hierarchy levels regardless of filter
- [ ] T011 Add Clear button to reset all filters

### Implementation Notes
- Use `get_ingredients_by_level(level)` or filter locally on `hierarchy_level` field
- Filter options map to: All=None, Root=0, Subcategory=1, Leaf=2
- Search should apply after level filter (AND logic)

### Parallel Opportunities
- [P] T007-T008 UI changes can proceed in parallel with T009 filter logic

### Dependencies
- Depends on WP01 (grid columns must exist before filtering makes sense to test)

### Risks & Mitigations
- Filter state persistence: Reset filter on tab switch or keep state? Default: reset

---

## Work Package WP03: Ingredient Edit Form Hierarchy (Priority: P1) MVP

**Goal**: Replace category dropdown with cascading L0/L1 dropdowns in ingredient edit form.
**Independent Test**: Create a new L2 ingredient by selecting L0, then L1, then entering name; verify it saves correctly.
**Prompt**: `tasks/planned/WP03-ingredient-edit-form.md`
**User Story**: US3 - Create/Edit Ingredients with Hierarchy Position

### Included Subtasks
- [ ] T012 Remove deprecated category dropdown from edit form
- [ ] T013 Add ingredient type selector (Root/Subcategory/Leaf) to control form behavior
- [ ] T014 Add L0 (Root Category) dropdown populated from `get_root_ingredients()`
- [ ] T015 Add L1 (Subcategory) dropdown with cascading behavior
- [ ] T016 Implement `_on_category_change()` to populate L1 from `get_children()`
- [ ] T017 Pre-populate L0/L1 dropdowns when editing existing ingredient using `get_ancestors()`
- [ ] T018 Apply withdraw/deiconify modal pattern for dialog stability
- [ ] T019 Handle edge case: L0 with no children shows "(No subcategories)" disabled

### Implementation Notes
- Pattern reference: `src/ui/forms/add_product_dialog.py` (cascading dropdown implementation)
- Modal pattern: `withdraw()` before build, `deiconify()` after, try/except on `wait_visibility()`
- When editing: ancestors[0] = L1 parent, ancestors[1] = L0 grandparent (for L2)
- Creating L0: no parent selected; Creating L1: only L0 selected; Creating L2: both L0 and L1 selected

### Parallel Opportunities
- [P] T012-T13 form layout can proceed in parallel with T16-T17 business logic

### Dependencies
- None (can proceed in parallel with WP01/WP02)

### Risks & Mitigations
- Modal visibility issues: Apply proven withdraw/deiconify pattern from previous fixes
- Type selector UX: May need iteration based on user feedback

---

## Work Package WP04: Products Tab Hierarchy (Priority: P2)

**Goal**: Add hierarchy path display and cascading hierarchy filters to Products tab.
**Independent Test**: Select L0 filter "Chocolate", verify all chocolate-derived products appear with full hierarchy path.
**Prompt**: `tasks/planned/WP04-products-tab-hierarchy.md`
**User Story**: US4 - Filter Products by Ingredient Hierarchy

### Included Subtasks
- [ ] T020 Add or modify ingredient column to show full hierarchy path (L0 -> L1 -> L2)
- [ ] T021 Build hierarchy path display helper using `get_ancestors()`
- [ ] T022 Remove deprecated category filter from Products tab
- [ ] T023 Add cascading hierarchy filters (L0 dropdown -> L1 dropdown -> L2 dropdown)
- [ ] T024 Implement filter logic to show products matching any ingredient under selected hierarchy
- [ ] T025 [P] Update column widths to accommodate hierarchy path

### Implementation Notes
- Path format: "Chocolate -> Dark Chocolate -> Semi-Sweet Chips"
- L0 filter shows all products with ingredients under that root
- L1 filter narrows further; L2 filter shows exact ingredient match
- Each dropdown level enables the next (L1 disabled until L0 selected)

### Parallel Opportunities
- [P] T020-T21 display changes can proceed in parallel with T22-T24 filter changes

### Dependencies
- Depends on Phase 1 completion (WP01-WP03) for pattern consistency

### Risks & Mitigations
- Filter complexity: Keep filter logic simple - exact hierarchy membership, not fuzzy match

---

## Work Package WP05: Inventory Grid Hierarchy (Priority: P2)

**Goal**: Replace category column with hierarchy columns in Inventory tab grid.
**Independent Test**: View inventory items and verify hierarchy columns display correctly.
**Prompt**: `tasks/planned/WP05-inventory-grid-hierarchy.md`
**User Story**: US5 - View Inventory with Hierarchy Information

### Included Subtasks
- [ ] T026 Remove deprecated category column from Inventory grid
- [ ] T027 Add hierarchy columns (L0, L1, L2) or single path column
- [ ] T028 Build hierarchy display cache for inventory items (via product -> ingredient)
- [ ] T029 Update inventory display method to populate hierarchy from cache
- [ ] T030 [P] Remove deprecated category filter from Inventory tab
- [ ] T031 [P] Add hierarchy-based filtering to Inventory tab

### Implementation Notes
- Inventory -> Product -> Ingredient chain for hierarchy lookup
- Same cache pattern as WP01 but traversing through product relationship
- Consider single "Ingredient" path column vs three separate columns (user preference)

### Parallel Opportunities
- [P] T026-T29 display changes can proceed in parallel with T30-T31 filter changes

### Dependencies
- Depends on WP04 (Products tab) for pattern consistency

### Risks & Mitigations
- Relationship depth: Cache must handle product -> ingredient -> ancestors efficiently

---

## Work Package WP06: Inventory Form Hierarchy Display (Priority: P2)

**Goal**: Display read-only hierarchy information in inventory add/edit forms.
**Independent Test**: Open inventory edit form, verify L0/L1/L2 labels display correctly for the item's ingredient.
**Prompt**: `tasks/planned/WP06-inventory-form-hierarchy.md`
**User Story**: US5 - View Inventory with Hierarchy Information

### Included Subtasks
- [ ] T032 Add read-only hierarchy labels (L0, L1, L2) to inventory add dialog
- [ ] T033 Add read-only hierarchy labels to inventory edit dialog
- [ ] T034 Populate hierarchy labels from product -> ingredient relationship
- [ ] T035 Handle display when ingredient hierarchy is incomplete (dash for missing levels)

### Implementation Notes
- Labels are informational only, not editable
- Look up ingredient via product_id, then use `get_ancestors()` for hierarchy
- Position labels near product selection for context

### Parallel Opportunities
- [P] T032 add dialog and T033 edit dialog can proceed in parallel

### Dependencies
- Depends on WP05 (Inventory grid) for consistency

### Risks & Mitigations
- Form layout: May need to adjust spacing to fit three hierarchy labels

---

## Work Package WP07: Leaf-Only Validation (Priority: P2)

**Goal**: Prevent products and recipes from being assigned to non-leaf (L0/L1) ingredients.
**Independent Test**: Attempt to assign a product to an L0 ingredient; verify error is displayed and save is blocked.
**Prompt**: `tasks/planned/WP07-leaf-only-validation.md`
**User Story**: US6 - Prevent Invalid Hierarchy Assignments

### Included Subtasks
- [ ] T036 Update product ingredient selector to use `get_leaf_ingredients()` only
- [ ] T037 Add validation error message for non-leaf selection attempts
- [ ] T038 Update recipe ingredient selector to use `get_leaf_ingredients()` only
- [ ] T039 Verify add_product_dialog already enforces leaf-only (reference implementation)
- [ ] T040 Add user-friendly error message: "Only leaf ingredients (L2) can be assigned to products"

### Implementation Notes
- `get_leaf_ingredients()` returns only L2 ingredients for dropdown population
- Validation should occur at form level (prevent selection) and save level (belt and suspenders)
- Recipe ingredient validation follows same pattern

### Parallel Opportunities
- [P] T036-T37 product validation and T038 recipe validation can proceed in parallel

### Dependencies
- Depends on WP03 (edit form patterns established)

### Risks & Mitigations
- Existing data with invalid assignments: This is UI-only; existing data should already be valid from backend

---

## Work Package WP08: Manual Testing & Cleanup (Priority: P3)

**Goal**: Execute all test cases from bug specification and verify no deprecated UI elements remain.
**Independent Test**: All 10 test cases from BUG_F031 spec pass.
**Prompt**: `tasks/planned/WP08-manual-testing-cleanup.md`
**User Story**: All user stories (validation phase)

### Included Subtasks
- [ ] T041 Execute test case 1: Ingredients tab shows L0, L1, Name columns
- [ ] T042 Execute test case 2: Level filter works correctly
- [ ] T043 Execute test case 3: Ingredient edit form cascading dropdowns work
- [ ] T044 Execute test case 4: Can create L0, L1, L2 ingredients
- [ ] T045 Execute test case 5: Products tab shows hierarchy path
- [ ] T046 Execute test case 6: Products tab hierarchy filter works
- [ ] T047 Execute test case 7: Inventory tab shows hierarchy
- [ ] T048 Execute test case 8: Inventory form shows hierarchy labels
- [ ] T049 Execute test case 9: Leaf-only validation works
- [ ] T050 Execute test case 10: No deprecated "category" UI elements remain
- [ ] T051 Code review: Search for remaining "category" references in affected UI files
- [ ] T052 User acceptance testing with Marianne

### Implementation Notes
- Test cases defined in `docs/bugs/BUG_F031_incomplete_hierarchy_ui.md`
- Search pattern for cleanup: grep for "category" in `src/ui/` files modified by this feature
- User testing: Walk through each tab with primary user

### Parallel Opportunities
- [P] T041-T050 test cases can be executed in parallel by different testers

### Dependencies
- Depends on all previous work packages (WP01-WP07)

### Risks & Mitigations
- User availability: Schedule testing session in advance
- Regression risk: Run full app smoke test after all changes

---

## Dependency & Execution Summary

**Sequence**:
```
WP01 (Grid Columns) ─┬─> WP02 (Level Filter) ─┬─> WP04 (Products Tab) ─> WP05 (Inventory Grid) ─> WP06 (Inventory Form)
                     │                        │
WP03 (Edit Form) ────┴────────────────────────┴─> WP07 (Validation) ─────────────────────────────> WP08 (Testing)
```

**Parallelization**:
- WP01 and WP03 can proceed in parallel (different concerns: display vs form)
- WP02 should follow WP01 (filter needs columns to make sense)
- WP04-WP06 are sequential (Products -> Inventory pattern)
- WP07 can proceed after WP03 (validation builds on edit form)

**MVP Scope**: WP01 + WP02 + WP03 (Phase 1: Ingredients Tab complete)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Build hierarchy cache | WP01 | P1 | No |
| T002 | Add L0 column header | WP01 | P1 | No |
| T003 | Add L1 column header | WP01 | P1 | No |
| T004 | Update display method | WP01 | P1 | No |
| T005 | Implement column sorting | WP01 | P1 | No |
| T006 | Handle empty levels display | WP01 | P1 | No |
| T007 | Remove category dropdown | WP02 | P1 | Yes |
| T008 | Add level filter dropdown | WP02 | P1 | Yes |
| T009 | Update filter logic | WP02 | P1 | No |
| T010 | Search across levels | WP02 | P1 | No |
| T011 | Add Clear button | WP02 | P1 | No |
| T012 | Remove category dropdown from form | WP03 | P1 | Yes |
| T013 | Add type selector | WP03 | P1 | Yes |
| T014 | Add L0 dropdown | WP03 | P1 | No |
| T015 | Add L1 dropdown | WP03 | P1 | No |
| T016 | Implement cascade logic | WP03 | P1 | No |
| T017 | Pre-populate on edit | WP03 | P1 | No |
| T018 | Apply modal pattern | WP03 | P1 | No |
| T019 | Handle no children edge case | WP03 | P1 | No |
| T020 | Add hierarchy path column | WP04 | P2 | Yes |
| T021 | Build path display helper | WP04 | P2 | Yes |
| T022 | Remove category filter | WP04 | P2 | No |
| T023 | Add cascading filters | WP04 | P2 | No |
| T024 | Implement filter logic | WP04 | P2 | No |
| T025 | Update column widths | WP04 | P2 | Yes |
| T026 | Remove category column | WP05 | P2 | No |
| T027 | Add hierarchy columns | WP05 | P2 | No |
| T028 | Build inventory hierarchy cache | WP05 | P2 | No |
| T029 | Update inventory display | WP05 | P2 | No |
| T030 | Remove category filter | WP05 | P2 | Yes |
| T031 | Add hierarchy filter | WP05 | P2 | Yes |
| T032 | Add labels to add dialog | WP06 | P2 | Yes |
| T033 | Add labels to edit dialog | WP06 | P2 | Yes |
| T034 | Populate hierarchy labels | WP06 | P2 | No |
| T035 | Handle incomplete hierarchy | WP06 | P2 | No |
| T036 | Product selector leaf-only | WP07 | P2 | Yes |
| T037 | Product validation message | WP07 | P2 | Yes |
| T038 | Recipe selector leaf-only | WP07 | P2 | Yes |
| T039 | Verify add_product_dialog | WP07 | P2 | No |
| T040 | Add error message | WP07 | P2 | No |
| T041-T050 | Manual test cases | WP08 | P3 | Yes |
| T051 | Code review cleanup | WP08 | P3 | No |
| T052 | User acceptance testing | WP08 | P3 | No |
