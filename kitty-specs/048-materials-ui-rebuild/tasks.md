# Work Packages: Materials UI Rebuild

**Inputs**: Design documents from `/kitty-specs/048-materials-ui-rebuild/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, quickstart.md

**Tests**: Not explicitly required by stakeholders. Manual acceptance testing covers validation.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/planned/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Core Tab Structure (Priority: P0)

**Goal**: Establish the 3-tab `MaterialsTab` container with `CTkTabview` and basic grid views.
**Independent Test**: Materials tab opens with 3 visible sub-tabs; each tab shows an empty grid with correct column headers.
**Prompt**: `tasks/planned/WP01-core-tab-structure.md`

### Included Subtasks
- [x] T001 Create new `MaterialsTab` class structure in `src/ui/materials_tab.py`
- [x] T002 Implement `CTkTabview` with 3 tabs: Materials Catalog, Material Products, Material Units
- [x] T003 [P] Create `MaterialsCatalogTab` inner class with grid skeleton
- [x] T004 [P] Create `MaterialProductsTab` inner class with grid skeleton
- [x] T005 [P] Create `MaterialUnitsTab` inner class with grid skeleton
- [x] T006 Wire up lazy loading and `refresh()` pattern from parent
- [x] T007 Add status bar to each tab

### Implementation Notes
- Replace entire `src/ui/materials_tab.py` (backup existing as reference)
- Copy imports and base patterns from `src/ui/ingredients_tab.py`
- Use `ttk.Treeview` with `show="headings"` for all grids
- Configure column headings per plan.md D3: Grid Columns

### Parallel Opportunities
- T003, T004, T005 can proceed in parallel (different inner classes)

### Dependencies
- None (starting package)

### Risks & Mitigations
- Risk: Breaking existing functionality during replacement
- Mitigation: Preserve current file as `materials_tab_old.py` until testing complete

---

## Work Package WP02: Materials Catalog Grid & Filters (Priority: P1) - User Story 1

**Goal**: Implement full Materials Catalog tab with grid, cascading filters, search, and level filter matching Ingredients pattern.
**Independent Test**: Open Materials Catalog tab; verify grid shows materials with L0/L1/Name/Unit columns; test search, L0/L1 cascading dropdowns, level filter, and Clear button.
**Prompt**: `tasks/planned/WP02-materials-catalog-grid.md`

### Included Subtasks
- [x] T008 Implement grid columns: l0, l1, name, base_unit with proper widths
- [x] T009 Implement `_load_all_materials()` to fetch materials across all subcategories
- [x] T010 Implement `_build_hierarchy_cache()` for L0/L1 display values
- [x] T011 Implement `_update_display()` with filter application and grid population
- [x] T012 [P] Implement search filter with `_on_search()` handler
- [x] T013 Implement cascading L0 dropdown with `_load_filter_data()` and `_on_l0_filter_change()`
- [x] T014 Implement cascading L1 dropdown with `_on_l1_filter_change()`
- [x] T015 Implement level filter dropdown with `_on_level_filter_change()`
- [x] T016 Implement Clear button with `_clear_filters()`
- [x] T017 Implement column header click sorting with `_on_header_click()`
- [x] T018 Implement selection handling: `_on_select()`, `_on_double_click()`
- [x] T019 Implement button state management: `_enable_selection_buttons()`, `_disable_selection_buttons()`

### Implementation Notes
- Copy `_build_hierarchy_path_cache()` pattern from ingredients_tab.py:333-380
- Use `_updating_filters` re-entry guard for cascading updates
- Use `material_catalog_service.list_categories()`, `.list_subcategories()`, `.list_materials()`

### Parallel Opportunities
- T012 (search) is independent of T013-T15 (filter dropdowns)

### Dependencies
- Depends on WP01

### Risks & Mitigations
- Risk: Service API doesn't return expected hierarchy data
- Mitigation: Services already work with current UI; verify method signatures match

---

## Work Package WP03: Material Form Dialog (Priority: P1) - User Story 2

**Goal**: Implement `MaterialFormDialog` for add/edit with cascading L0/L1 dropdowns and CRUD wiring.
**Independent Test**: Click Add Material, verify dialog opens with Name, L0, L1, Base Unit fields; L1 cascades from L0; Save creates material; Edit pre-populates; Delete removes (with confirmation).
**Prompt**: `tasks/planned/WP03-material-form-dialog.md`

### Included Subtasks
- [x] T020 Create `MaterialFormDialog` class with modal pattern (withdraw/deiconify/grab_set)
- [x] T021 Implement form fields: Name entry, L0 dropdown, L1 dropdown, Base Unit dropdown
- [x] T022 Implement `_build_l0_options()` to populate categories
- [x] T023 Implement `_on_l0_change()` to cascade subcategories to L1
- [x] T024 Implement `_populate_form()` for edit mode
- [x] T025 Implement `_validate_and_save()` with required field validation
- [x] T026 Implement Delete button with confirmation dialog
- [x] T027 Wire `_add_material()` handler in `MaterialsCatalogTab`
- [x] T028 Wire `_edit_material()` handler in `MaterialsCatalogTab`
- [x] T029 Wire delete flow through dialog

### Implementation Notes
- Copy dialog structure from `IngredientFormDialog` (lines 1048-1741)
- Base Unit dropdown values: `["linear_inches", "each", "sheets", "sq_inches"]`
- Use `material_catalog_service.create_material()`, `.update_material()`, `.delete_material()`
- Dialog geometry: ~500x400 to fit all fields

### Parallel Opportunities
- None within this package (sequential dialog construction)

### Dependencies
- Depends on WP02 (needs working grid to display created materials)

### Risks & Mitigations
- Risk: Delete fails on materials with products
- Mitigation: Show error message from service exception

---

## Work Package WP04: Material Products Tab (Priority: P1) - User Story 3

**Goal**: Implement Material Products tab with grid, material filter, inventory/cost formatting.
**Independent Test**: Open Material Products tab; verify grid shows Material/Name/Inventory/Cost/Supplier columns; filter by material; verify inventory format "4,724 inches" and cost format "$0.0016".
**Prompt**: `tasks/planned/WP04-material-products-tab.md`

### Included Subtasks
- [x] T030 Implement grid columns: material, name, inventory, unit_cost, supplier
- [x] T031 Implement `_load_all_products()` to fetch products across all materials
- [x] T032 Implement inventory formatting: `f"{qty:,.1f} {unit}"`
- [x] T033 Implement cost formatting: `f"${cost:.4f}"` or "-"
- [x] T034 Implement `_update_display()` with filter and formatting
- [x] T035 Implement Material filter dropdown with `_load_material_dropdown()`
- [x] T036 [P] Implement search filter for product name
- [x] T037 Implement Clear button
- [x] T038 Implement selection handling and button states

### Implementation Notes
- Use `material_catalog_service.list_products(material_id)` for each material
- Get inventory from `product.current_inventory`, cost from `product.weighted_avg_cost`
- Supplier from `product.supplier.name` or "-" if None

### Parallel Opportunities
- T036 (search) is independent of T035 (material filter)

### Dependencies
- Depends on WP01

### Risks & Mitigations
- Risk: Performance with many products
- Mitigation: ttk.Treeview handles large datasets; same pattern as Ingredients

---

## Work Package WP05: Product CRUD & Purchase Recording (Priority: P2) - User Stories 4 & 5

**Goal**: Implement product add/edit dialog, Record Purchase dialog, and Adjust Inventory dialog.
**Independent Test**: Add new product, edit it, record a purchase (verify auto-calculations), adjust inventory, verify grid updates.
**Prompt**: `tasks/planned/WP05-product-crud-and-purchase.md`

### Included Subtasks
- [x] T039 Create `MaterialProductFormDialog` with Material dropdown, Name, Package Qty, Package Unit, Supplier, SKU, Notes
- [x] T040 Implement `_populate_form()` for edit mode
- [x] T041 Implement `_validate_and_save()` with service calls
- [x] T042 Wire `_add_product()` and `_edit_product()` handlers
- [x] T043 Create `RecordPurchaseDialog` with Supplier, Date, Packages, Total Price, Notes
- [x] T044 Implement auto-calculation: total units = packages * package_quantity
- [x] T045 Implement auto-calculation: unit cost = total_price / total_units
- [x] T046 Wire `_record_purchase()` handler with `material_purchase_service.record_purchase()`
- [x] T047 Create `AdjustInventoryDialog` with mode (set/percentage), value, notes
- [x] T048 Wire `_adjust_inventory()` handler with `material_purchase_service.adjust_inventory()`
- [x] T049 Implement button enable/disable for Record Purchase and Adjust Inventory

### Implementation Notes
- RecordPurchaseDialog shows calculated values in real-time (bind to KeyRelease)
- Use date picker defaulting to `date.today()`
- Supplier dropdown from `supplier_service.get_all_suppliers()`

### Parallel Opportunities
- T043-T046 (purchase dialog) parallel to T047-T048 (adjust dialog)

### Dependencies
- Depends on WP04 (needs working products grid)

### Risks & Mitigations
- Risk: Purchase/adjustment fails validation
- Mitigation: Display validation error from service; keep dialog open for correction

---

## Work Package WP06: Material Units Tab (Priority: P2)

**Goal**: Implement Material Units tab with grid, material filter, and unit CRUD.
**Independent Test**: Open Material Units tab; verify grid shows Material/Name/Qty per Unit/Available/Cost columns; add unit, edit unit, verify available/cost computed values.
**Prompt**: `tasks/planned/WP06-material-units-tab.md`
**Note**: US6 "Adjust Inventory" is covered by WP05 (T047-T048). This WP implements the Material Units tab (third tab per plan.md D1).

### Included Subtasks
- [x] T050 Implement grid columns: material, name, qty_per_unit, available, cost
- [x] T051 Implement `_load_all_units()` to fetch units across all materials
- [x] T052 Implement available inventory computation via `material_unit_service.get_available_inventory()`
- [x] T053 Implement cost computation via `material_unit_service.get_current_cost()`
- [x] T054 Implement `_update_display()` with formatting
- [x] T055 Implement Material filter dropdown
- [x] T056 [P] Implement search filter
- [x] T057 Implement selection handling and button states
- [x] T058 Create `MaterialUnitFormDialog` with Material, Name, Qty per Unit, Description
- [x] T059 Wire `_add_unit()` and `_edit_unit()` handlers

### Implementation Notes
- Use `material_unit_service.list_units(material_id)` for each material
- Available and Cost are computed per-row (may be slow if many units)
- Consider caching if performance is an issue

### Parallel Opportunities
- T056 (search) parallel to T055 (material filter)
- T058-T059 (dialog) parallel to T050-T057 (grid)

### Dependencies
- Depends on WP01

### Risks & Mitigations
- Risk: get_available_inventory() or get_current_cost() slow with many calls
- Mitigation: These are already used in current UI; performance acceptable for expected scale

---

## Work Package WP07: Polish & Acceptance (Priority: P3)

**Goal**: Final polish, status bar refinements, edge case handling, and acceptance validation.
**Independent Test**: Run through all 6 user story acceptance scenarios; verify SC-002 (visual match to Ingredients).
**Prompt**: `tasks/planned/WP07-polish-and-acceptance.md`

### Included Subtasks
- [x] T060 Review and standardize status bar messages across all 3 tabs
- [x] T061 Implement empty state messages when no items match filters
- [x] T062 Verify button spacing and sizing matches Ingredients tab
- [x] T063 Verify dialog sizing and field alignment (120px label column)
- [x] T064 Test deletion prevention for materials with products
- [x] T065 Test filter persistence when switching tabs
- [x] T066 Run full acceptance scenario walkthrough (US1-US6)
- [x] T067 Verify no regression in data (materials, products, inventory intact)

### Implementation Notes
- Compare Materials tab side-by-side with Ingredients tab
- Use same status message patterns: "N items", "Showing N of M", "N items (filtered)"

### Parallel Opportunities
- T060-T63 (UI polish) parallel to T64-T67 (testing)

### Dependencies
- Depends on WP02-WP06 (all functionality complete)

### Risks & Mitigations
- Risk: Visual discrepancies with Ingredients
- Mitigation: Detailed comparison using screenshot overlay

---

## Dependency & Execution Summary

```
WP01 (Core Structure)
  ├── WP02 (Catalog Grid) ──── WP03 (Material Dialog)
  ├── WP04 (Products Tab) ──── WP05 (Product CRUD/Purchase)
  └── WP06 (Units Tab)
        └── All ──────────────── WP07 (Polish)
```

- **Sequence**: WP01 → (WP02, WP04, WP06 in parallel) → (WP03, WP05) → WP07
- **Parallelization**: WP02, WP04, WP06 can proceed in parallel once WP01 complete
- **MVP Scope**: WP01 + WP02 + WP03 delivers Materials Catalog functionality (User Stories 1-2)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Create MaterialsTab class structure | WP01 | P0 | No |
| T002 | Implement CTkTabview with 3 tabs | WP01 | P0 | No |
| T003 | Create MaterialsCatalogTab inner class | WP01 | P0 | Yes |
| T004 | Create MaterialProductsTab inner class | WP01 | P0 | Yes |
| T005 | Create MaterialUnitsTab inner class | WP01 | P0 | Yes |
| T006 | Wire up lazy loading and refresh | WP01 | P0 | No |
| T007 | Add status bar to each tab | WP01 | P0 | No |
| T008 | Implement catalog grid columns | WP02 | P1 | No |
| T009 | Implement _load_all_materials | WP02 | P1 | No |
| T010 | Implement _build_hierarchy_cache | WP02 | P1 | No |
| T011 | Implement _update_display | WP02 | P1 | No |
| T012 | Implement search filter | WP02 | P1 | Yes |
| T013 | Implement L0 cascading dropdown | WP02 | P1 | No |
| T014 | Implement L1 cascading dropdown | WP02 | P1 | No |
| T015 | Implement level filter dropdown | WP02 | P1 | No |
| T016 | Implement Clear button | WP02 | P1 | No |
| T017 | Implement column header sorting | WP02 | P1 | No |
| T018 | Implement selection handling | WP02 | P1 | No |
| T019 | Implement button state management | WP02 | P1 | No |
| T020 | Create MaterialFormDialog class | WP03 | P1 | No |
| T021 | Implement form fields | WP03 | P1 | No |
| T022 | Implement _build_l0_options | WP03 | P1 | No |
| T023 | Implement _on_l0_change cascade | WP03 | P1 | No |
| T024 | Implement _populate_form | WP03 | P1 | No |
| T025 | Implement _validate_and_save | WP03 | P1 | No |
| T026 | Implement Delete with confirmation | WP03 | P1 | No |
| T027 | Wire _add_material handler | WP03 | P1 | No |
| T028 | Wire _edit_material handler | WP03 | P1 | No |
| T029 | Wire delete flow | WP03 | P1 | No |
| T030 | Implement products grid columns | WP04 | P1 | No |
| T031 | Implement _load_all_products | WP04 | P1 | No |
| T032 | Implement inventory formatting | WP04 | P1 | No |
| T033 | Implement cost formatting | WP04 | P1 | No |
| T034 | Implement products _update_display | WP04 | P1 | No |
| T035 | Implement Material filter dropdown | WP04 | P1 | No |
| T036 | Implement product search filter | WP04 | P1 | Yes |
| T037 | Implement products Clear button | WP04 | P1 | No |
| T038 | Implement products selection/buttons | WP04 | P1 | No |
| T039 | Create MaterialProductFormDialog | WP05 | P2 | No |
| T040 | Implement product _populate_form | WP05 | P2 | No |
| T041 | Implement product _validate_and_save | WP05 | P2 | No |
| T042 | Wire product add/edit handlers | WP05 | P2 | No |
| T043 | Create RecordPurchaseDialog | WP05 | P2 | No |
| T044 | Implement total units calculation | WP05 | P2 | No |
| T045 | Implement unit cost calculation | WP05 | P2 | No |
| T046 | Wire _record_purchase handler | WP05 | P2 | No |
| T047 | Create AdjustInventoryDialog | WP05 | P2 | No |
| T048 | Wire _adjust_inventory handler | WP05 | P2 | No |
| T049 | Implement purchase/adjust button states | WP05 | P2 | No |
| T050 | Implement units grid columns | WP06 | P2 | No |
| T051 | Implement _load_all_units | WP06 | P2 | No |
| T052 | Implement available inventory compute | WP06 | P2 | No |
| T053 | Implement cost compute | WP06 | P2 | No |
| T054 | Implement units _update_display | WP06 | P2 | No |
| T055 | Implement units Material filter | WP06 | P2 | No |
| T056 | Implement units search filter | WP06 | P2 | Yes |
| T057 | Implement units selection/buttons | WP06 | P2 | No |
| T058 | Create MaterialUnitFormDialog | WP06 | P2 | No |
| T059 | Wire unit add/edit handlers | WP06 | P2 | No |
| T060 | Standardize status bar messages | WP07 | P3 | No |
| T061 | Implement empty state messages | WP07 | P3 | No |
| T062 | Verify button spacing/sizing | WP07 | P3 | No |
| T063 | Verify dialog sizing/alignment | WP07 | P3 | No |
| T064 | Test deletion prevention | WP07 | P3 | No |
| T065 | Test filter persistence | WP07 | P3 | No |
| T066 | Run acceptance walkthrough | WP07 | P3 | No |
| T067 | Verify no data regression | WP07 | P3 | No |
