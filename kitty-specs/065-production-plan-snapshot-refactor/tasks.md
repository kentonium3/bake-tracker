# Work Packages: Production Plan Snapshot Refactor

**Inputs**: Design documents from `/kitty-specs/065-production-plan-snapshot-refactor/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: Unit tests required for all service layer changes per constitution (>70% coverage).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

## Path Conventions
- **Single project**: `src/`, `src/tests/`
- Paths match existing bake-tracker structure.

---

## Work Package WP01: ProductionPlanSnapshot Model Cleanup (Priority: P0)

**Goal**: Remove calculation cache fields and staleness tracking from ProductionPlanSnapshot model.
**Independent Test**: Model compiles without calculation_results or staleness fields; existing tests updated.
**Prompt**: `tasks/WP01-pps-model-cleanup.md`

### Included Subtasks
- [x] T001 [P] Remove calculation_results JSON field from ProductionPlanSnapshot
- [x] T002 [P] Remove staleness tracking fields (requirements_updated_at, recipes_updated_at, bundles_updated_at)
- [x] T003 [P] Remove staleness state fields (is_stale, stale_reason)
- [x] T004 Remove staleness-related methods (get_recipe_batches, get_shopping_list, get_aggregated_ingredients, mark_stale, mark_fresh)

### Implementation Notes
- File: `src/models/production_plan_snapshot.py`
- Remove Column definitions and method implementations
- Update docstring to reflect new "lightweight container" role
- Keep: event_id, calculated_at, input_hash, shopping_complete, shopping_completed_at

### Parallel Opportunities
- T001-T003 can be done in parallel (different field groups)
- T004 depends on T001-T003 (methods reference removed fields)

### Dependencies
- None (starting package, foundation work)

### Risks & Mitigations
- Risk: Other code references removed fields â†’ Run grep for field names before removing
- Risk: Tests fail â†’ Update/remove tests that reference removed fields

---

## Work Package WP02: Snapshot Model FK Updates (Priority: P0)

**Goal**: Add snapshot foreign keys to target models and make RecipeSnapshot.production_run_id nullable.
**Independent Test**: Models compile; FK relationships defined; migration pattern ready.
**Prompt**: `tasks/WP02-snapshot-model-fks.md`

### Included Subtasks
- [x] T005 Make RecipeSnapshot.production_run_id nullable for planning context
- [x] T006 [P] Add recipe_snapshot_id FK to EventProductionTarget model
- [x] T007 [P] Add finished_good_snapshot_id FK to EventAssemblyTarget model
- [x] T008 Add relationship definitions for new FKs on target models
- [x] T009 Verify FinishedGoodSnapshot supports planning context (F064 check)

### Implementation Notes
- Files: `src/models/recipe_snapshot.py`, `src/models/event.py`
- FKs are nullable for backward compatibility
- ON DELETE RESTRICT for snapshot FKs (preserve integrity)
- Add index on new FK columns

### Parallel Opportunities
- T006, T007 can be done in parallel (different models)
- WP02 can run in parallel with WP01

### Dependencies
- None (foundation work, parallel with WP01)

### Risks & Mitigations
- Risk: F064 didn't add planning_snapshot_id â†’ Add it in this WP if missing
- Risk: Unique constraint issues â†’ Ensure recipe_snapshot_id FK doesn't conflict with existing constraints

---

## Work Package WP03: Recipe Snapshot Service Planning Context (Priority: P1)

**Goal**: Update recipe_snapshot_service to support creating snapshots without production_run_id.
**Independent Test**: Can create RecipeSnapshot with production_run_id=None; session parameter flows correctly.
**Prompt**: `tasks/WP03-recipe-snapshot-planning.md`

### Included Subtasks
- [x] T010 Update create_recipe_snapshot() to accept optional production_run_id parameter
- [x] T011 Ensure create_recipe_snapshot() properly accepts and uses session parameter
- [x] T012 Add validation logic for planning context (production_run_id can be None when called for planning)
- [x] T013 Unit tests for recipe snapshot creation with planning context

### Implementation Notes
- File: `src/services/recipe_snapshot_service.py`
- Follow session management pattern from CLAUDE.md
- Return snapshot dict with id for linking to targets

### Parallel Opportunities
- Can run in parallel with WP05, WP06 after WP02 completes

### Dependencies
- Depends on WP02 (needs nullable production_run_id)

### Risks & Mitigations
- Risk: Session detachment â†’ Follow CLAUDE.md session management patterns exactly
- Risk: Existing callers break â†’ Ensure backward compatibility (production_run_id still works as before)

---

## Work Package WP04: Planning Service Snapshot Creation (Priority: P1) ðŸŽ¯ MVP

**Goal**: Update planning service to create and link snapshots at plan creation time.
**Independent Test**: Creating a plan creates RecipeSnapshots/FinishedGoodSnapshots and links them to targets.
**Prompt**: `tasks/WP04-planning-snapshot-creation.md`

### Included Subtasks
- [x] T014 Refactor calculate_plan() to create_plan() entry point for snapshot-based planning
- [x] T015 Create RecipeSnapshot for each EventProductionTarget during plan creation
- [x] T016 Create FinishedGoodSnapshot for each EventAssemblyTarget during plan creation
- [x] T017 Link snapshots to targets (set recipe_snapshot_id on EventProductionTarget)
- [x] T018 Link snapshots to targets (set finished_good_snapshot_id on EventAssemblyTarget)
- [x] T019 Ensure atomic transaction: all snapshot creation in single session_scope
- [x] T020 Pass session through all nested service calls per CLAUDE.md patterns

### Implementation Notes
- File: `src/services/planning/planning_service.py`
- Call recipe_snapshot_service.create_recipe_snapshot() for each production target
- Call finished_good_service.create_finished_good_snapshot() for each assembly target
- Use session parameter throughout to maintain transaction atomicity
- Target.recipe_snapshot_id = snapshot["id"] pattern

### Parallel Opportunities
- T015/T017 (recipe) and T016/T018 (assembly) can be developed in parallel

### Dependencies
- Depends on WP02 (FK fields on targets), WP03 (recipe snapshot service planning support)

### Risks & Mitigations
- Risk: Partial snapshot creation on failure â†’ Single transaction with rollback
- Risk: Session detachment â†’ Pass session through all calls
- Risk: FinishedGoodSnapshot service not ready â†’ Verify F064 completion first

---

## Work Package WP05: Production Service Snapshot Reuse (Priority: P1)

**Goal**: Update batch_production_service to reuse planning snapshots instead of creating new ones.
**Independent Test**: Production for planned event reuses target's recipe_snapshot_id; legacy production creates new snapshot.
**Prompt**: `tasks/WP05-production-snapshot-reuse.md`

### Included Subtasks
- [x] T021 Add/verify event_id parameter in record_batch_production() signature
- [x] T022 Query EventProductionTarget for recipe_snapshot_id when event_id provided
- [x] T023 Implement reuse logic: use existing snapshot if available, create new only for legacy/ad-hoc
- [x] T024 Unit tests for production snapshot reuse scenarios

### Implementation Notes
- File: `src/services/batch_production_service.py`
- If event_id provided: check target for recipe_snapshot_id
- If snapshot exists: reuse it (don't create new)
- If no snapshot (legacy/ad-hoc): create at production time (current behavior)

### Parallel Opportunities
- Can run in parallel with WP06 after WP02 completes

### Dependencies
- Depends on WP02 (recipe_snapshot_id FK on target)

### Risks & Mitigations
- Risk: Incorrect snapshot used â†’ Match on (event_id, recipe_id) to find correct target
- Risk: Legacy production breaks â†’ Maintain fallback to create-at-execution

---

## Work Package WP06: Assembly Service Snapshot Reuse (Priority: P1)

**Goal**: Update assembly_service to reuse planning snapshots instead of creating new ones.
**Independent Test**: Assembly for planned event reuses target's finished_good_snapshot_id; legacy assembly creates new snapshot.
**Prompt**: `tasks/WP06-assembly-snapshot-reuse.md`

### Included Subtasks
- [ ] T025 Add/verify event_id parameter in record_assembly() signature
- [ ] T026 Query EventAssemblyTarget for finished_good_snapshot_id when event_id provided
- [ ] T027 Implement reuse logic: use existing snapshot if available, create new only for legacy/ad-hoc
- [ ] T028 Unit tests for assembly snapshot reuse scenarios

### Implementation Notes
- File: `src/services/assembly_service.py`
- Mirror pattern from WP05 (production reuse)
- If event_id provided: check target for finished_good_snapshot_id
- If snapshot exists: reuse it
- If no snapshot: create at assembly time (F064 pattern)

### Parallel Opportunities
- Can run in parallel with WP05 after WP02 completes

### Dependencies
- Depends on WP02 (finished_good_snapshot_id FK on target)

### Risks & Mitigations
- Risk: F064 service not compatible â†’ Verify create_finished_good_snapshot() returns reusable snapshot
- Risk: Recursive snapshot issue â†’ FinishedGoodSnapshot already handles component snapshots

---

## Work Package WP07: On-Demand Calculation (Priority: P2)

**Goal**: Replace cached calculation_results with on-demand calculation from snapshots.
**Independent Test**: get_plan_summary() returns batch requirements, shopping list, aggregated ingredients calculated from snapshots in <5 seconds.
**Prompt**: `tasks/WP07-ondemand-calculation.md`

### Included Subtasks
- [ ] T029 Create get_plan_summary(event_id, session=None) function signature and structure
- [ ] T030 Implement batch requirements calculation from linked RecipeSnapshots
- [ ] T031 Implement shopping list calculation from snapshot data
- [ ] T032 Implement ingredient aggregation from snapshot data
- [ ] T033 Remove staleness detection code (_check_staleness_impl and related methods)
- [ ] T034 Performance verification: ensure calculation completes in <5 seconds

### Implementation Notes
- File: `src/services/planning/planning_service.py`
- Load event with targets and their linked snapshots (eager load)
- Calculate from snapshot data (recipe_data, ingredients_data JSON)
- No caching - calculate fresh each time
- Return dict matching old calculate_plan() response shape for UI compatibility

### Parallel Opportunities
- T030-T032 can be developed in parallel (different calculation types)

### Dependencies
- Depends on WP01 (cache fields removed), WP04 (snapshots exist to calculate from)

### Risks & Mitigations
- Risk: Performance regression â†’ Profile typical event; optimize queries if needed
- Risk: Different results than cached â†’ Verify calculation logic matches original
- Risk: Missing snapshot data â†’ Handle gracefully (calculate from live definitions as fallback)

---

## Work Package WP08: UI Layer Updates (Priority: P2)

**Goal**: Update UI to use on-demand calculation and remove staleness warnings.
**Independent Test**: Plan view displays correctly; no staleness warnings; <5 second load time.
**Prompt**: `tasks/WP08-ui-updates.md`

### Included Subtasks
- [ ] T035 Identify UI components referencing calculation_results or staleness fields
- [ ] T036 Update plan display view to call get_plan_summary()
- [ ] T037 Update shopping list generation to use on-demand calculation
- [ ] T038 Remove staleness warning UI components
- [ ] T039 Verify UI responsiveness meets <5 second target

### Implementation Notes
- Files: `src/ui/` planning-related views
- Replace snapshot.get_recipe_batches() with get_plan_summary()["recipe_batches"]
- Remove any is_stale checks and warning displays
- Test with typical event size to verify performance

### Parallel Opportunities
- T036, T037, T038 can be developed in parallel (different UI areas)

### Dependencies
- Depends on WP07 (get_plan_summary() must exist)

### Risks & Mitigations
- Risk: UI breaks on missing data â†’ Handle empty/null gracefully
- Risk: Performance too slow â†’ Add loading indicator while calculating

---

## Work Package WP09: Integration Testing & Cleanup (Priority: P3)

**Goal**: Comprehensive testing of full workflow and code cleanup.
**Independent Test**: All integration tests pass; no unused code; >70% service coverage.
**Prompt**: `tasks/WP09-integration-testing.md`

### Included Subtasks
- [ ] T040 Integration test: plan creation â†’ production â†’ verify snapshot reuse
- [ ] T041 Integration test: plan creation â†’ assembly â†’ verify snapshot reuse
- [ ] T042 Backward compatibility test: legacy events without snapshots still work
- [ ] T043 Code cleanup: remove unused imports, dead code, update docstrings
- [ ] T044 Verify test coverage >70% for affected services

### Implementation Notes
- Files: `src/tests/integration/`, service test files
- Test full workflow: create event â†’ create plan â†’ record production â†’ verify same snapshot
- Test legacy: record production for event without plan â†’ new snapshot created
- Run coverage report: `pytest --cov=src/services`

### Parallel Opportunities
- T040, T041, T042 can be developed in parallel (different test scenarios)

### Dependencies
- Depends on WP05, WP06, WP08 (all functionality must be complete)

### Risks & Mitigations
- Risk: Integration test environment setup â†’ Use existing test fixtures
- Risk: Coverage below 70% â†’ Add additional unit tests for uncovered paths

---

## Dependency & Execution Summary

```
Phase 0 (Foundation - Parallel):
  WP01 â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ WP07 â†’ WP08 â†’ WP09
            â”‚                                              â†‘
  WP02 â”€â”€â”€â”€â”€â”¼â†’ WP03 â†’ WP04 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚          â†‘
            â”œâ†’ WP05 â”€â”€â”€â”¤ (parallel)
            â””â†’ WP06 â”€â”€â”€â”˜

Sequence:
  WP01, WP02 (parallel) â†’ WP03, WP05, WP06 (parallel after WP02) â†’ WP04 â†’ WP07 â†’ WP08 â†’ WP09
```

- **Parallelization**: WP01+WP02 can run simultaneously. After WP02: WP03, WP05, WP06 can run in parallel.
- **MVP Scope**: WP01-WP04 constitute the minimal release (snapshot creation at planning time).
- **Full Feature**: WP05-WP06 add snapshot reuse; WP07-WP08 add UI integration; WP09 ensures quality.

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Remove calculation_results field | WP01 | P0 | Yes |
| T002 | Remove staleness timestamp fields | WP01 | P0 | Yes |
| T003 | Remove staleness state fields | WP01 | P0 | Yes |
| T004 | Remove staleness methods | WP01 | P0 | No |
| T005 | Make production_run_id nullable | WP02 | P0 | No |
| T006 | Add recipe_snapshot_id FK | WP02 | P0 | Yes |
| T007 | Add finished_good_snapshot_id FK | WP02 | P0 | Yes |
| T008 | Add FK relationships | WP02 | P0 | No |
| T009 | Verify F064 FinishedGoodSnapshot | WP02 | P0 | No |
| T010 | Update create_recipe_snapshot params | WP03 | P1 | No |
| T011 | Ensure session parameter flow | WP03 | P1 | No |
| T012 | Add planning context validation | WP03 | P1 | No |
| T013 | Unit tests for planning context | WP03 | P1 | No |
| T014 | Refactor to create_plan() | WP04 | P1 | No |
| T015 | Create RecipeSnapshots at plan time | WP04 | P1 | Yes |
| T016 | Create FinishedGoodSnapshots at plan time | WP04 | P1 | Yes |
| T017 | Link recipe snapshots to targets | WP04 | P1 | Yes |
| T018 | Link FG snapshots to targets | WP04 | P1 | Yes |
| T019 | Atomic transaction for snapshots | WP04 | P1 | No |
| T020 | Session management compliance | WP04 | P1 | No |
| T021 | Add event_id to production service | WP05 | P1 | No |
| T022 | Query target for snapshot_id | WP05 | P1 | No |
| T023 | Implement production reuse logic | WP05 | P1 | No |
| T024 | Unit tests for production reuse | WP05 | P1 | No |
| T025 | Add event_id to assembly service | WP06 | P1 | No |
| T026 | Query target for FG snapshot_id | WP06 | P1 | No |
| T027 | Implement assembly reuse logic | WP06 | P1 | No |
| T028 | Unit tests for assembly reuse | WP06 | P1 | No |
| T029 | Create get_plan_summary() | WP07 | P2 | No |
| T030 | Batch requirements calculation | WP07 | P2 | Yes |
| T031 | Shopping list calculation | WP07 | P2 | Yes |
| T032 | Ingredient aggregation | WP07 | P2 | Yes |
| T033 | Remove staleness detection code | WP07 | P2 | No |
| T034 | Performance verification | WP07 | P2 | No |
| T035 | Identify UI staleness references | WP08 | P2 | No |
| T036 | Update plan display view | WP08 | P2 | Yes |
| T037 | Update shopping list UI | WP08 | P2 | Yes |
| T038 | Remove staleness warning UI | WP08 | P2 | Yes |
| T039 | UI performance verification | WP08 | P2 | No |
| T040 | Integration test: planâ†’production | WP09 | P3 | Yes |
| T041 | Integration test: planâ†’assembly | WP09 | P3 | Yes |
| T042 | Backward compatibility test | WP09 | P3 | Yes |
| T043 | Code cleanup | WP09 | P3 | No |
| T044 | Coverage verification | WP09 | P3 | No |
