# Work Packages: F046 Finished Goods, Bundles & Assembly Tracking

**Inputs**: Design documents from `kitty-specs/046-finished-goods-bundles-assembly/`
**Prerequisites**: plan.md (required), spec.md (user stories), research/research.md, research/data-model.md

**Tests**: Only include explicit testing work when requested. This feature focuses on fixing broken code paths.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`. Lane status is stored in YAML frontmatter (`lane: planned|doing|for_review|done`).

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Paths are relative to project root.

---

## Work Package WP01: Dynamic Cost Calculation Methods (Priority: P0)

**Goal**: Add `calculate_current_cost()` methods to FinishedUnit and FinishedGood models - the foundation for all cost fixes.
**Independent Test**: Method returns correct values when queried directly; returns `Decimal("0.0000")` for entities with no production history.
**Prompt**: `tasks/WP01-dynamic-cost-methods.md`

### Included Subtasks
- [ ] T001 Add `calculate_current_cost()` method to FinishedUnit model in `src/models/finished_unit.py`
- [ ] T002 Add `calculate_current_cost()` method to FinishedGood model in `src/models/finished_good.py`

### Implementation Notes
1. **T001**: FinishedUnit calculates weighted average from `self.production_runs`
   - Sum of `(run.per_unit_cost * run.actual_yield)` / total yield
   - Return `Decimal("0.0000")` if no runs or total yield is 0
   - Use 4 decimal places for precision
2. **T002**: FinishedGood sums component costs via Composition
   - Iterate `self.components` relationship
   - For FinishedUnit components: `component.finished_unit_component.calculate_current_cost() * quantity`
   - For FinishedGood components (nested): recursive call
   - Ignore `packaging_product_id` (out of F046 scope)

### Parallel Opportunities
- T001 and T002 cannot run in parallel (T002 depends on T001)

### Dependencies
- None (this is the foundational package)

### Risks & Mitigations
- **Risk**: Performance with large production history -> **Mitigation**: Consider limiting to recent runs if needed
- **Risk**: Circular references in nested FGs -> **Mitigation**: Model already has cycle detection

---

## Work Package WP02: Fix Composition & Package Models (Priority: P0)

**Goal**: Fix broken model methods that reference removed `total_cost` and `unit_cost` fields.
**Independent Test**: `Composition.get_component_cost()` and `Package.calculate_cost()` return correct values without AttributeError.
**Prompt**: `tasks/WP02-fix-model-methods.md`

### Included Subtasks
- [ ] T003 [P] Fix `Composition.get_component_cost()` in `src/models/composition.py`
- [ ] T004 [P] Fix `Composition.get_total_cost()` in `src/models/composition.py`
- [ ] T005 Fix `Package.calculate_cost()` in `src/models/package.py`
- [ ] T006 Fix `Package.get_cost_breakdown()` in `src/models/package.py`
- [ ] T007 Fix `PackageFinishedGood.get_line_cost()` in `src/models/package.py`

### Implementation Notes
1. **T003-T004**: Composition methods use `calculate_current_cost()`:
   ```python
   if self.finished_unit_component:
       return float(self.finished_unit_component.calculate_current_cost())
   elif self.finished_good_component:
       return float(self.finished_good_component.calculate_current_cost())
   ```
2. **T005-T007**: Package methods use `fg.calculate_current_cost()` instead of `fg.total_cost`

### Parallel Opportunities
- T003 and T004 can run in parallel (same file, different methods)
- T005, T006, T007 should be done sequentially (same file, related methods)

### Dependencies
- Depends on WP01 (methods rely on `calculate_current_cost()`)

### Risks & Mitigations
- **Risk**: Breaking existing functionality -> **Mitigation**: Methods were already broken, this fixes them

---

## Work Package WP03: Fix Assembly Service Cost Capture (Priority: P1) MVP

**Goal**: Fix `assembly_service.record_assembly()` to capture actual costs instead of hardcoded zeros.
**Independent Test**: Recording an assembly creates AssemblyFinishedUnitConsumption records with non-zero costs when production history exists.
**Prompt**: `tasks/WP03-fix-assembly-service.md`

### Included Subtasks
- [ ] T008 Fix cost calculation for FinishedUnit components in `src/services/assembly_service.py` (lines 341-356)
- [ ] T009 Fix cost calculation for nested FinishedGood components in `src/services/assembly_service.py` (lines 370-376)
- [ ] T010 Verify finished_good_service.py works correctly with new cost methods

### Implementation Notes
1. **T008**: Replace hardcoded `Decimal("0.0000")` with actual cost:
   ```python
   # OLD (wrong):
   unit_cost = Decimal("0.0000")
   cost = Decimal("0.0000")

   # NEW (correct):
   unit_cost = fu.calculate_current_cost()
   cost = unit_cost * Decimal(str(needed))
   ```
2. **T009**: Same fix for nested FinishedGood components
3. **T010**: Verify `_recalculate_assembly_cost()` and other methods work correctly

### Parallel Opportunities
- T008 and T009 should be done together (same function, related logic)
- T010 can start after T008/T009 complete

### Dependencies
- Depends on WP01 (uses `calculate_current_cost()`)

### Risks & Mitigations
- **Risk**: Existing assembly records have zero costs -> **Mitigation**: This is expected; only new assemblies will have costs

---

## Work Package WP04: UI Verification & Polish (Priority: P2)

**Goal**: Verify UI displays costs correctly in appropriate contexts (no costs in CATALOG, costs in MAKE/PLAN).
**Independent Test**: Manual verification that all UI screens work without errors and display appropriate data.
**Prompt**: `tasks/WP04-ui-verification.md`

### Included Subtasks
- [ ] T011 [P] Verify Finished Goods tab shows no cost columns in `src/ui/finished_goods_tab.py`
- [ ] T012 [P] Verify Assembly tab shows cost history in `src/ui/tabs/assembly_tab.py`
- [ ] T013 [P] Verify Record Assembly dialog shows cost preview in `src/ui/forms/record_assembly_dialog.py`
- [ ] T014 [P] Verify Event Planning package cost calculation works without errors
- [ ] T015 Run full test suite and fix any failures

### Implementation Notes
1. **T011**: Check grid column configuration - should NOT have cost columns
2. **T012**: Should display `per_unit_cost` and `total_component_cost` from AssemblyRun
3. **T013**: Should show current component costs calculated dynamically
4. **T014**: Navigate to event planning, assign package, verify cost displays
5. **T015**: Run `pytest src/tests -v` and fix any failures related to cost changes

### Parallel Opportunities
- T011, T012, T013, T014 can all run in parallel (different files/areas)
- T015 should run after all other subtasks complete

### Dependencies
- Depends on WP01, WP02, WP03 (all model/service fixes must be complete)

### Risks & Mitigations
- **Risk**: UI may need more changes than verification -> **Mitigation**: Existing UI was built for this; should be minimal changes

---

## Dependency & Execution Summary

```
WP01 (Dynamic Cost Methods) - P0 - FOUNDATION
    |
    v
WP02 (Fix Model Methods) - P0
    |
    v
WP03 (Fix Assembly Service) - P1 - MVP
    |
    v
WP04 (UI Verification) - P2
```

- **Sequence**: WP01 -> WP02 -> WP03 -> WP04
- **Parallelization**: Within WP02 (T003/T004), within WP04 (T011-T014)
- **MVP Scope**: WP01 + WP02 + WP03 constitute the minimal viable release (cost calculation works). WP04 is verification.

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Add FinishedUnit.calculate_current_cost() | WP01 | P0 | No |
| T002 | Add FinishedGood.calculate_current_cost() | WP01 | P0 | No |
| T003 | Fix Composition.get_component_cost() | WP02 | P0 | Yes |
| T004 | Fix Composition.get_total_cost() | WP02 | P0 | Yes |
| T005 | Fix Package.calculate_cost() | WP02 | P0 | No |
| T006 | Fix Package.get_cost_breakdown() | WP02 | P0 | No |
| T007 | Fix PackageFinishedGood.get_line_cost() | WP02 | P0 | No |
| T008 | Fix assembly_service FinishedUnit cost calc | WP03 | P1 | No |
| T009 | Fix assembly_service nested FG cost calc | WP03 | P1 | No |
| T010 | Verify finished_good_service.py | WP03 | P1 | No |
| T011 | Verify Finished Goods tab (no costs) | WP04 | P2 | Yes |
| T012 | Verify Assembly tab (cost history) | WP04 | P2 | Yes |
| T013 | Verify Record Assembly dialog (cost preview) | WP04 | P2 | Yes |
| T014 | Verify Event Planning (package costs) | WP04 | P2 | Yes |
| T015 | Run full test suite | WP04 | P2 | No |

---

## User Story Mapping

| User Story | Work Packages |
|------------|---------------|
| US1: Define Finished Good | WP04 (T011) - verification only, CRUD exists |
| US2: Record Assembly | WP03 (T008-T010), WP04 (T012-T013) |
| US3: Event Planning | WP01, WP02 (T005-T007), WP04 (T014) |
| US4: Edit/Delete FG | WP04 (T011) - verification only |
| US5: View Assembly History | WP04 (T012) |
