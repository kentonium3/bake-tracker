# Work Packages: Recipe Decomposition & Aggregation

**Inputs**: Design documents from `/kitty-specs/072-recipe-decomposition-aggregation/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md

**Tests**: Included per constitution requirement (TDD for service layer).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Core Service Foundation (Priority: P1)

**Goal**: Create planning_service.py with the recursive decomposition algorithm and tests for basic functionality.
**Independent Test**: Unit tests pass for single atomic FG and single bundle decomposition.
**Prompt**: `tasks/WP01-core-service-foundation.md`
**Estimated Size**: ~350 lines

### Included Subtasks
- [x] T001 Create planning_service.py module with imports and boilerplate
- [x] T002 Implement `_decompose_fg_to_recipes()` recursive function with cycle detection
- [x] T003 Implement `calculate_recipe_requirements()` public API
- [x] T004 Write unit tests for single atomic FG
- [x] T005 Write unit tests for single bundle decomposition
- [x] T006 Write unit tests for recipe aggregation (multiple FGs same recipe)

### Implementation Notes
- Follow session parameter pattern from planning_snapshot_service.py
- Reuse CircularReferenceError, MaxDepthExceededError, MAX_FG_NESTING_DEPTH from event_service.py
- Test file: `src/tests/test_planning_service.py`

### Parallel Opportunities
- T004, T005, T006 can be written in parallel once T001-T003 complete

### Dependencies
- None (starting package)

### Risks & Mitigations
- Import cycles: Use deferred imports if needed for circular model dependencies

---

## Work Package WP02: Nested Bundle Support (Priority: P2)

**Goal**: Verify multi-level nesting works correctly with comprehensive tests.
**Independent Test**: Unit tests pass for 2-level, 3-level, and DAG bundle structures.
**Prompt**: `tasks/WP02-nested-bundle-support.md`
**Estimated Size**: ~280 lines

### Included Subtasks
- [x] T007 Write unit tests for 2-level nested bundles
- [x] T008 Write unit tests for 3+ level nested bundles
- [x] T009 Write unit tests for DAG patterns (same FG in multiple branches)
- [x] T010 Write unit tests for mixed atomic/bundle events

### Implementation Notes
- Tests require complex fixture setup with multiple bundle levels
- DAG test validates that path-based (not global) cycle detection is used
- All tests in `src/tests/test_planning_service.py`

### Parallel Opportunities
- All test subtasks (T007-T010) can be written in parallel

### Dependencies
- Depends on WP01 (core implementation must exist)

### Risks & Mitigations
- Test fixture complexity: Create reusable fixture factories for bundle hierarchies

---

## Work Package WP03: Edge Cases & Validation (Priority: P3)

**Goal**: Implement and test all edge case handling for robustness.
**Independent Test**: All edge case tests pass (circular reference, empty event, missing recipe, zero-quantity).
**Prompt**: `tasks/WP03-edge-cases-validation.md`
**Estimated Size**: ~300 lines

### Included Subtasks
- [x] T011 Implement and test circular reference detection
- [x] T012 Implement and test empty event handling
- [x] T013 Implement and test missing recipe validation
- [x] T014 Implement and test zero-quantity component handling

### Implementation Notes
- Circular reference test needs to create invalid bundle structure (bypassing normal constraints)
- Empty event should return empty dict without error
- Missing recipe should raise ValidationError with clear message
- Zero-quantity components should be skipped during decomposition

### Parallel Opportunities
- T011, T012, T013, T014 can be implemented in parallel

### Dependencies
- Depends on WP01 (core implementation must exist)

### Risks & Mitigations
- Circular reference fixture may be tricky: Create directly in session without going through service validation

---

## Dependency & Execution Summary

- **Sequence**: WP01 (foundation) → WP02, WP03 (can run in parallel after WP01)
- **Parallelization**: WP02 and WP03 have no interdependencies; can run concurrently
- **MVP Scope**: WP01 delivers core functionality; WP02+WP03 complete the feature

```
WP01 (Core Service) ─┬─→ WP02 (Nested Bundles)
                     └─→ WP03 (Edge Cases)
```

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001       | Create planning_service.py module | WP01 | P1 | No |
| T002       | Implement _decompose_fg_to_recipes() | WP01 | P1 | No |
| T003       | Implement calculate_recipe_requirements() | WP01 | P1 | No |
| T004       | Test single atomic FG | WP01 | P1 | Yes |
| T005       | Test single bundle decomposition | WP01 | P1 | Yes |
| T006       | Test recipe aggregation | WP01 | P1 | Yes |
| T007       | Test 2-level nested bundles | WP02 | P2 | Yes |
| T008       | Test 3+ level nested bundles | WP02 | P2 | Yes |
| T009       | Test DAG patterns | WP02 | P2 | Yes |
| T010       | Test mixed atomic/bundle events | WP02 | P2 | Yes |
| T011       | Circular reference detection | WP03 | P3 | Yes |
| T012       | Empty event handling | WP03 | P3 | Yes |
| T013       | Missing recipe validation | WP03 | P3 | Yes |
| T014       | Zero-quantity component handling | WP03 | P3 | Yes |
