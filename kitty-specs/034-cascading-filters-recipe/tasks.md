# Work Packages: Cascading Filters & Recipe Integration

**Inputs**: Design documents from `/kitty-specs/034-cascading-filters-recipe/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: Integration tests included in WP03 for validation.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/planned/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Products Tab Cascading Fix (Priority: P1) - MVP

**Goal**: Fix cascading filter behavior in Products tab and add Clear Filters button.
**Agent**: Claude
**Independent Test**: Select an L0 category, verify L1 dropdown updates to show only children of that L0.
**Prompt**: `tasks/planned/WP01-products-tab-cascading-fix.md`

### Included Subtasks
- [x] T001 Debug `_on_l0_filter_change()` to identify cascading issue in `src/ui/products_tab.py`
- [x] T002 Add debug logging to trace event handler flow
- [x] T003 Fix cascading logic so L1 updates correctly when L0 changes
- [x] T004 Fix cascading logic so L2 updates correctly when L1 changes
- [x] T005 Add re-entry guards if event handlers are recursing
- [x] T006 Add "Clear Filters" button to filter frame
- [x] T007 Implement `_clear_filters()` method to reset all dropdowns
- [x] T008 Manual testing: verify all acceptance scenarios from spec

### Implementation Notes
1. Review existing code at `products_tab.py:479-554` - logic appears correct but bug exists
2. Check if `ingredient_hierarchy_service.get_children()` returns expected data
3. Follow Clear button pattern from `ingredients_tab.py:163-170`
4. Test with real database containing L0/L1/L2 ingredients

### Parallel Opportunities
- None - all subtasks in same file, execute sequentially

### Dependencies
- None (starting package)

### Risks & Mitigations
- Bug may be in service layer: Add logging to verify service calls return expected data
- Event loop issues: Add re-entry guards with `self._updating_filters = True/False` flag

---

## Work Package WP02: Inventory Tab Cascading Fix (Priority: P2) [P]

**Goal**: Apply same cascading fix pattern from WP01 to Inventory tab.
**Agent**: Gemini (parallel with WP03)
**Independent Test**: Select an L0 category in Inventory tab, verify L1 dropdown updates correctly.
**Prompt**: `tasks/planned/WP02-inventory-tab-cascading-fix.md`

### Included Subtasks
- [x] T009 [P] Review WP01 fix pattern from `src/ui/products_tab.py`
- [x] T010 [P] Apply same fix to `_on_l0_filter_change()` in `src/ui/inventory_tab.py`
- [x] T011 [P] Apply same fix to `_on_l1_filter_change()` in `src/ui/inventory_tab.py`
- [x] T012 [P] Add re-entry guards matching WP01 pattern
- [x] T013 [P] Add "Clear Filters" button matching WP01 pattern
- [x] T014 [P] Implement `_clear_filters()` method
- [x] T015 [P] Manual testing: verify acceptance scenarios

### Implementation Notes
1. Code structure in `inventory_tab.py:426-500` is nearly identical to `products_tab.py`
2. Apply exact same pattern from WP01 - this is a copy-paste with minor adaptations
3. Ensure filter variable names match (may differ slightly from products tab)

### Parallel Opportunities
- Entire WP can run in parallel with WP03 (different files)
- All subtasks are safe to parallelize as they touch only `inventory_tab.py`

### Dependencies
- Depends on WP01 for fix pattern (pattern sharing, not code dependency)

### Risks & Mitigations
- Pattern mismatch: Carefully review WP01 implementation before applying
- Variable name differences: Verify filter variable names in inventory_tab.py

---

## Work Package WP03: Recipe Integration Verification (Priority: P1) [P]

**Goal**: Verify recipe ingredient selection enforces L2-only and uses proper hierarchy navigation.
**Agent**: Claude (parallel with WP02)
**Independent Test**: Open recipe form, attempt to add ingredient, verify only L2 can be selected.
**Prompt**: `tasks/planned/WP03-recipe-integration-verification.md`

### Included Subtasks
- [x] T016 [P] Review `IngredientSelectionDialog` in `src/ui/forms/recipe_form.py`
- [x] T017 [P] Verify `IngredientTreeWidget` has `leaf_only=True` configuration
- [x] T018 [P] Manual test: Try to select L0 ingredient - should be blocked
- [x] T019 [P] Manual test: Try to select L1 ingredient - should be blocked
- [x] T020 [P] Manual test: Select L2 ingredient - should succeed
- [x] T021 [P] Document any issues found (create bug file if needed)
- [x] T022 [P] Fix issues if any discovered (expected: none)

### Implementation Notes
1. Research found recipe form already uses `IngredientTreeWidget` with `leaf_only=True`
2. This is primarily a verification task - no code changes expected
3. Tree widget provides hierarchical browsing, not cascading dropdowns
4. If issues found, document in `docs/bugs/` and fix if scope allows

### Parallel Opportunities
- Entire WP can run in parallel with WP02 (different files)
- Verification tasks are read-only and safe to parallelize

### Dependencies
- None (independent verification)

### Risks & Mitigations
- Tree widget may have hidden issues: Thorough manual testing required
- If major issues found: Document and escalate, may require separate bug fix

---

## Work Package WP04: Integration Tests (Priority: P3) - COMPLETE

**Goal**: Write integration tests to prevent regression of cascading filter behavior.
**Agent**: Claude
**Status**: COMPLETE - 14 integration tests added, all passing.
**Independent Test**: Tests pass in CI and cover all cascading scenarios.
**Prompt**: `tasks/for_review/WP04-integration-tests.md`

### Included Subtasks
- [x] T023 Create test file `src/tests/ui/test_cascading_filters.py`
- [x] T024 Test: L0 selection updates L1 options in products tab
- [x] T025 Test: L1 selection updates L2 options in products tab
- [x] T026 Test: Clear button resets all dropdowns in products tab
- [x] T027 Test: Same cascading tests for inventory tab
- [x] T028 Test: Recipe ingredient selection enforces L2-only
- [x] T029 Run full test suite to verify no regressions

### Implementation Notes
1. UI testing may require mocking or integration test framework
2. Consider using pytest fixtures for database setup
3. May need to use CustomTkinter test utilities if available
4. Focus on behavioral tests, not implementation details

### Parallel Opportunities
- Tests can be written after WP01+WP02 complete
- Different test cases can be written in parallel by multiple developers

### Dependencies
- Depends on WP01, WP02, WP03 (tests validate their implementations)

### Risks & Mitigations
- UI testing complexity: Consider manual testing if automation too complex
- Test flakiness: Use deterministic test data and avoid timing dependencies

---

## Dependency & Execution Summary

```
Phase A (Sequential):
  Claude: WP01 - Products tab fix (establishes pattern)

Phase B (Parallel):
  Gemini: WP02 - Inventory tab fix (uses WP01 pattern)
  Claude: WP03 - Recipe verification

Phase C (Sequential):
  Either: WP04 - Integration tests (validates all fixes)
```

- **Sequence**: WP01 → [WP02 || WP03] → WP04
- **Parallelization**: WP02 and WP03 can run simultaneously after WP01 pattern established
- **MVP Scope**: WP01 alone delivers value for Products tab users

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Debug _on_l0_filter_change() | WP01 | P1 | No |
| T002 | Add debug logging | WP01 | P1 | No |
| T003 | Fix L0->L1 cascading | WP01 | P1 | No |
| T004 | Fix L1->L2 cascading | WP01 | P1 | No |
| T005 | Add re-entry guards | WP01 | P1 | No |
| T006 | Add Clear button | WP01 | P1 | No |
| T007 | Implement _clear_filters() | WP01 | P1 | No |
| T008 | Manual testing | WP01 | P1 | No |
| T009 | Review WP01 pattern | WP02 | P2 | Yes |
| T010 | Fix L0 handler | WP02 | P2 | Yes |
| T011 | Fix L1 handler | WP02 | P2 | Yes |
| T012 | Add re-entry guards | WP02 | P2 | Yes |
| T013 | Add Clear button | WP02 | P2 | Yes |
| T014 | Implement _clear_filters() | WP02 | P2 | Yes |
| T015 | Manual testing | WP02 | P2 | Yes |
| T016 | Review IngredientSelectionDialog | WP03 | P1 | Yes |
| T017 | Verify leaf_only=True | WP03 | P1 | Yes |
| T018 | Test L0 selection blocked | WP03 | P1 | Yes |
| T019 | Test L1 selection blocked | WP03 | P1 | Yes |
| T020 | Test L2 selection works | WP03 | P1 | Yes |
| T021 | Document issues | WP03 | P1 | Yes |
| T022 | Fix issues if any | WP03 | P1 | Yes |
| T023 | Create test file | WP04 | P3 | No |
| T024 | Test L0->L1 products | WP04 | P3 | No |
| T025 | Test L1->L2 products | WP04 | P3 | No |
| T026 | Test Clear button | WP04 | P3 | No |
| T027 | Test inventory cascading | WP04 | P3 | No |
| T028 | Test recipe L2-only | WP04 | P3 | No |
| T029 | Run full test suite | WP04 | P3 | No |
