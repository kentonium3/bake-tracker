# Work Packages: Event Reporting & Production Dashboard

**Inputs**: Design documents from `/kitty-specs/017-event-reporting-production/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, quickstart.md

**Tests**: Unit tests included for new service methods per plan.md Testing Strategy.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/planned/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Includes precise file paths.

---

## Work Package WP01: Service Layer Foundation (Priority: P1)

**Goal**: Add CSV export and cost analysis service methods that UI components will depend on.
**Independent Test**: New service methods pass unit tests; existing 680+ tests continue passing.
**Prompt**: `tasks/planned/WP01-service-layer-foundation.md`

### Included Subtasks
- [x] T001 Add `export_shopping_list_csv(event_id, file_path)` to `src/services/event_service.py`
- [x] T002 [P] Add `get_event_cost_analysis(event_id)` to `src/services/event_service.py`
- [x] T003 [P] Enhance `get_recipient_history()` to include fulfillment_status in `src/services/event_service.py`
- [x] T004 [P] Add unit tests for `export_shopping_list_csv()` in `src/tests/services/test_event_service_reporting.py`
- [x] T005 [P] Add unit tests for `get_event_cost_analysis()` in `src/tests/services/test_event_service_reporting.py`
- [x] T006 [P] Add unit tests for enhanced `get_recipient_history()` in `src/tests/services/test_event_service_reporting.py`

### Implementation Notes
1. `export_shopping_list_csv()`: Use Python's csv module; call existing `get_shopping_list()` and format output
2. `get_event_cost_analysis()`: Query ProductionRun.total_cost and AssemblyRun.total_cost aggregated by recipe/finished_good
3. `get_recipient_history()`: Add `fulfillment_status` field to returned dict (already exists on EventRecipientPackage model)

### Parallel Opportunities
- T002, T003 can run in parallel after T001 (same file, different sections)
- T004, T005, T006 can all run in parallel (different test functions)

### Dependencies
- None (foundational work package)

### Risks & Mitigations
- CSV encoding issues: Use UTF-8 with BOM for Excel compatibility
- Cost calculation accuracy: Use cost_at_time from consumption records, not current prices

---

## Work Package WP02: Dashboard Restructuring (Priority: P1)

**Goal**: Make Production Dashboard the default view; rename old Dashboard to "Summary".
**Independent Test**: Launch app, verify Production tab is selected by default and Summary tab shows old Dashboard content.
**Prompt**: `tasks/planned/WP02-dashboard-restructuring.md`

### Included Subtasks
- [x] T007 Reorder tabs in `src/ui/main_window.py` (Production first)
- [x] T008 Rename "Dashboard" tab to "Summary" in `src/ui/main_window.py`
- [x] T009 Update default tab selection to Production in `src/ui/main_window.py`
- [x] T010 Update `_on_tab_change` callback for renamed tab in `src/ui/main_window.py`

### Implementation Notes
1. Tab order change: Move `self.tabview.add("Production")` before `self.tabview.add("Dashboard")`
2. Rename: Change `self.tabview.add("Dashboard")` to `self.tabview.add("Summary")`
3. Default: Change `self.tabview.set("Dashboard")` to `self.tabview.set("Production")`
4. Callback: Update `if current_tab == "Dashboard"` to `if current_tab == "Summary"`

### Parallel Opportunities
- None (all changes in same file with dependencies)

### Dependencies
- None (can run parallel with WP01)

### Risks & Mitigations
- Tab refresh breaks: Test that `_on_tab_change()` still triggers refresh for Summary tab

---

## Work Package WP03: Production Dashboard Event Progress (Priority: P1) - MVP

**Goal**: Add event selector and progress tracking to Production Dashboard (User Stories 1 & 2).
**Independent Test**: Select event from dropdown, see production/assembly progress bars with accurate percentages.
**Prompt**: `tasks/planned/WP03-production-dashboard-progress.md`

### Included Subtasks
- [ ] T011 Add event selector dropdown to `src/ui/production_dashboard_tab.py`
- [ ] T012 Add production progress section with progress bars in `src/ui/production_dashboard_tab.py`
- [ ] T013 Add assembly progress section with progress bars in `src/ui/production_dashboard_tab.py`
- [ ] T014 Handle "no targets" case with message and link in `src/ui/production_dashboard_tab.py`
- [ ] T015 Add navigation link to Event Detail for target management in `src/ui/production_dashboard_tab.py`

### Implementation Notes
1. Event selector: CTkComboBox populated from `get_all_events()`
2. Progress bars: CTkProgressBar with label showing "2/4 (50%)" format
3. Use existing `get_production_progress()` and `get_assembly_progress()` from event_service
4. "No targets" message: Show CTkLabel with "No production targets set" and CTkButton to navigate

### Parallel Opportunities
- None (all changes build on each other in same UI component)

### Dependencies
- WP01 (uses service methods)
- WP02 (Production tab must be renamed/reordered)

### Risks & Mitigations
- Layout complexity: Use CTkScrollableFrame for progress lists
- Progress >100%: Display as-is (shows over-production, which is valid)

---

## Work Package WP04: Shopping List CSV Export (Priority: P2)

**Goal**: Enable CSV export of shopping list from Event Detail window (User Story 3).
**Independent Test**: Click "Export CSV" on event shopping list, verify file created with correct columns.
**Prompt**: `tasks/planned/WP04-csv-export.md`

### Included Subtasks
- [ ] T016 Add "Export CSV" button to Shopping tab in `src/ui/event_detail_window.py`
- [ ] T017 Implement file save dialog with default filename in `src/ui/event_detail_window.py`
- [ ] T018 Call export service method and handle errors in `src/ui/event_detail_window.py`
- [ ] T019 Show success/failure notification in `src/ui/event_detail_window.py`

### Implementation Notes
1. Button placement: Near top of Shopping tab, after "Shopping List for [Event]" header
2. File dialog: Use `tkinter.filedialog.asksaveasfilename()` with default `{event-slug}-shopping-list.csv`
3. Call `export_shopping_list_csv(event_id, file_path)` from event_service
4. Show `messagebox.showinfo()` on success, `messagebox.showerror()` on failure

### Parallel Opportunities
- None (sequential UI changes)

### Dependencies
- WP01 (needs `export_shopping_list_csv()` service method)

### Risks & Mitigations
- File permissions: Catch IOError and show user-friendly message
- User cancels dialog: Check for None return from filedialog

---

## Work Package WP05: Event Summary Enhancement (Priority: P2)

**Goal**: Add planned vs actual reporting to Event Detail summary (User Story 4).
**Independent Test**: View event summary, see production/assembly/package counts and cost variance.
**Prompt**: `tasks/planned/WP05-event-summary-enhancement.md`

### Included Subtasks
- [ ] T020 Add planned vs actual production section to Summary tab in `src/ui/event_detail_window.py`
- [ ] T021 Add planned vs actual assembly section to Summary tab in `src/ui/event_detail_window.py`
- [ ] T022 Add package fulfillment status counts in `src/ui/event_detail_window.py`
- [ ] T023 Add cost variance display (estimated vs actual) in `src/ui/event_detail_window.py`

### Implementation Notes
1. Production section: Table with columns [Recipe, Target, Actual, %]
2. Assembly section: Table with columns [Finished Good, Target, Actual, %]
3. Package counts: "Pending: X | Ready: Y | Delivered: Z"
4. Cost variance: "Estimated: $X.XX | Actual: $Y.YY | Variance: $Z.ZZ"

### Parallel Opportunities
- T020, T021, T022, T023 can technically run in parallel (different sections)

### Dependencies
- WP01 (needs `get_event_cost_analysis()` service method)

### Risks & Mitigations
- No production data: Show "No production recorded" instead of empty table
- Cost calculation: Estimated from shopping list, actual from consumption records

---

## Work Package WP06: Recipient History (Priority: P3)

**Goal**: Add package history to recipient detail view (User Story 6).
**Independent Test**: View recipient detail, see all packages received across events with fulfillment status.
**Prompt**: `tasks/planned/WP06-recipient-history.md`

### Included Subtasks
- [ ] T024 Add history section to recipient detail view in `src/ui/recipients_tab.py`
- [ ] T025 Display events, packages, quantities, fulfillment status in `src/ui/recipients_tab.py`
- [ ] T026 Sort history by event date descending in `src/ui/recipients_tab.py`

### Implementation Notes
1. Find or create recipient detail section in RecipientsTab
2. Add "Package History" frame with CTkTreeview or table
3. Columns: Event Name | Event Date | Package | Qty | Status
4. Call `get_recipient_history(recipient_id)` from event_service
5. Sort order handled by service (already sorted by event date DESC)

### Parallel Opportunities
- None (sequential UI build)

### Dependencies
- WP01 (needs enhanced `get_recipient_history()` with fulfillment_status)

### Risks & Mitigations
- No history: Show "No package history" message
- Long history: Use scrollable frame

---

## Dependency & Execution Summary

```
WP01 (Service Layer) ─────┬─────────────→ WP04 (CSV Export)
                          │
WP02 (Dashboard Restructure) ──┬──→ WP03 (Progress) ──→ WP05 (Summary)
                               │                            │
                               │                            ↓
                               └────────────────────→ WP06 (Recipient History)
```

**Execution Order**:
1. **WP01 + WP02** can run in parallel (independent foundations)
2. **WP03** after WP01 and WP02 complete
3. **WP04** after WP01 complete
4. **WP05** after WP01 and WP03 complete
5. **WP06** after WP01 complete

**MVP Scope**: WP01 + WP02 + WP03 delivers core value (Production Dashboard as default with event progress).

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Add export_shopping_list_csv() | WP01 | P1 | No |
| T002 | Add get_event_cost_analysis() | WP01 | P1 | Yes |
| T003 | Enhance get_recipient_history() | WP01 | P1 | Yes |
| T004 | Unit tests for CSV export | WP01 | P1 | Yes |
| T005 | Unit tests for cost analysis | WP01 | P1 | Yes |
| T006 | Unit tests for recipient history | WP01 | P1 | Yes |
| T007 | Reorder tabs (Production first) | WP02 | P1 | No |
| T008 | Rename Dashboard to Summary | WP02 | P1 | No |
| T009 | Update default tab selection | WP02 | P1 | No |
| T010 | Update tab change callback | WP02 | P1 | No |
| T011 | Add event selector dropdown | WP03 | P1 | No |
| T012 | Add production progress bars | WP03 | P1 | No |
| T013 | Add assembly progress bars | WP03 | P1 | No |
| T014 | Handle "no targets" case | WP03 | P1 | No |
| T015 | Add navigation link to Event Detail | WP03 | P1 | No |
| T016 | Add Export CSV button | WP04 | P2 | No |
| T017 | Implement file save dialog | WP04 | P2 | No |
| T018 | Call export service method | WP04 | P2 | No |
| T019 | Show success/failure notification | WP04 | P2 | No |
| T020 | Planned vs actual production section | WP05 | P2 | Yes |
| T021 | Planned vs actual assembly section | WP05 | P2 | Yes |
| T022 | Package fulfillment status counts | WP05 | P2 | Yes |
| T023 | Cost variance display | WP05 | P2 | Yes |
| T024 | Add history section to recipient detail | WP06 | P3 | No |
| T025 | Display history table columns | WP06 | P3 | No |
| T026 | Sort by event date descending | WP06 | P3 | No |
