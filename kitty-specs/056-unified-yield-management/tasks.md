# Work Packages: Unified Yield Management

**Feature**: 056-unified-yield-management
**Inputs**: Design documents from `/kitty-specs/056-unified-yield-management/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: Tests required per Constitution IV (TDD). Service layer must maintain >70% coverage.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`.

---

## Work Package WP01: Model & Validation Foundation (Priority: P0)

**Goal**: Establish data model changes and service layer validation without breaking existing functionality.
**Independent Test**: Recipe yield fields are nullable; validation rejects recipes without complete FinishedUnits.
**Prompt**: `tasks/WP01-model-validation-foundation.md`

### Included Subtasks
- [ ] T001 Make Recipe yield fields nullable in `src/models/recipe.py`
- [ ] T002 [P] Add item_unit validation to FinishedUnit in `src/models/finished_unit.py`
- [ ] T003 Add `validate_recipe_has_finished_unit()` to `src/services/recipe_service.py`
- [ ] T004 [P] Add tests for recipe validation logic in `src/tests/test_recipe_service.py`

### Implementation Notes
- Change `nullable=False` to `nullable=True` for yield_quantity, yield_unit
- Add deprecation comments to Recipe model
- Validation function returns list of error strings
- Service layer validation should not break existing UI yet (enforcement comes in WP05)

### Parallel Opportunities
- T002 and T004 can run in parallel after T001/T003 complete

### Dependencies
- None (starting package)

### Risks & Mitigations
- Existing tests may fail with nullable changes ‚Üí Update test fixtures
- Breaking existing recipe creation ‚Üí Validation only warns initially

---

## Work Package WP02: Transformation Script (Priority: P0)

**Goal**: Create standalone script to convert legacy yield data to FinishedUnit structure.
**Independent Test**: Script transforms sample_data_min.json correctly; output passes JSON validation.
**Prompt**: `tasks/WP02-transformation-script.md`

### Included Subtasks
- [ ] T005 Create `scripts/transform_yield_data.py` with core transformation logic
- [ ] T006 Implement slug generation with collision handling
- [ ] T007 Transform `test_data/sample_data_min.json`
- [ ] T008 Transform `test_data/sample_data_all.json`

### Implementation Notes
- Script reads JSON, transforms recipes, writes to output file
- Slug pattern: `{recipe_slug}_{yield_suffix}` where suffix = slugify(yield_description) or "standard"
- Collision handling: append _2, _3, etc.
- display_name generation: use yield_description or "Standard {recipe_name}"

### Parallel Opportunities
- T007 and T008 can run in parallel after T005/T006 complete

### Dependencies
- None (can proceed independently of WP01)

### Risks & Mitigations
- Malformed JSON in test data ‚Üí Add validation and error messages
- Missing yield_unit values ‚Üí Use "each" as default

---

## Work Package WP03: Export Service Updates (Priority: P1)

**Goal**: Enable export of FinishedUnits in coordinated backup/export operations.
**Independent Test**: Export includes finished_units.json with all FinishedUnit fields.
**Prompt**: `tasks/WP03-export-service-updates.md`

### Included Subtasks
- [ ] T009 Add `_export_finished_units()` function to `src/services/coordinated_export_service.py`
- [ ] T010 Add "finished_units" to DEPENDENCY_ORDER after "recipes"
- [ ] T011 [P] Add tests for FinishedUnit export in `src/tests/services/test_coordinated_export.py`

### Implementation Notes
- Export fields: uuid, slug, display_name, recipe_name, category, yield_mode, items_per_batch, item_unit, batch_percentage, portion_description, inventory_count, is_archived
- Recipe reference uses recipe_name for lookup during import
- Follow existing export patterns in the service

### Parallel Opportunities
- T011 can proceed alongside T009/T010

### Dependencies
- Depends on WP01 (model changes)

### Risks & Mitigations
- Missing recipe reference ‚Üí Use recipe.name as FK lookup key

---

## Work Package WP04: Import Service Updates (Priority: P1)

**Goal**: Enable import of FinishedUnits and handle legacy recipe data that lacks FinishedUnits.
**Independent Test**: Import creates FinishedUnits from explicit data and from legacy recipe yield fields.
**Prompt**: `tasks/WP04-import-service-updates.md`

### Included Subtasks
- [ ] T012 Add "finished_units" to VALID_ENTITIES in `src/services/catalog_import_service.py`
- [ ] T013 Add `_import_finished_units_impl()` function
- [ ] T014 Add legacy recipe yield handling (auto-create FinishedUnit when missing)
- [ ] T015 [P] Add tests for FinishedUnit import and legacy handling in `src/tests/test_catalog_import_service.py`

### Implementation Notes
- Import must resolve recipe_name to recipe_id
- Legacy handling: if recipe has yield fields but no FinishedUnits, create one
- display_name generation: use yield_description or "Standard {recipe_name}"
- Slug generation follows same pattern as transformation script

### Parallel Opportunities
- T015 can proceed alongside T012-T014

### Dependencies
- Depends on WP01 (model changes)
- Depends on WP03 (export must exist for roundtrip testing)

### Risks & Mitigations
- Duplicate FinishedUnit creation ‚Üí Check for existing before creating
- Recipe not found ‚Üí Skip with warning, continue import

---

## Work Package WP05: UI Updates (Priority: P1) üéØ MVP

**Goal**: Unify yield editing in recipe form with 3-field yield type rows; remove legacy fields.
**Independent Test**: Recipe form shows yield type rows with Description, Unit, Quantity; no top-level yield fields.
**Prompt**: `tasks/WP05-ui-updates.md`

### Included Subtasks
- [ ] T016 Add item_unit field to YieldTypeRow widget in `src/ui/forms/recipe_form.py`
- [ ] T017 Remove legacy yield_quantity and yield_unit fields from recipe form
- [ ] T018 Add validation requiring at least one complete yield type
- [ ] T019 Disable Remove button when only one row exists
- [ ] T020 [P] Verify Finished Units tab displays item_unit correctly in `src/ui/finished_units_tab.py`

### Implementation Notes
- YieldTypeRow needs: item_unit entry field (text input with common suggestions)
- Update `get_data()` to return item_unit
- Update `__init__()` to accept item_unit parameter
- Validation: block save if no complete yield types (display_name + item_unit + items_per_batch)
- Remove: yield_quantity_entry, yield_unit_combo from form layout

### Parallel Opportunities
- T020 can proceed independently of T016-T19

### Dependencies
- Depends on WP01 (model validation)
- Depends on WP04 (import must work to load test data)

### Risks & Mitigations
- User confusion ‚Üí Add clear placeholder text and validation messages
- Data loss on save ‚Üí Preserve existing FinishedUnits when editing

---

## Work Package WP06: Integration & Data Migration (Priority: P2)

**Goal**: End-to-end validation and migration of test data files.
**Independent Test**: Full export/transform/import cycle works; Finished Units tab shows all records.
**Prompt**: `tasks/WP06-integration-data-migration.md`

### Included Subtasks
- [ ] T021 Run full export/transform/import workflow
- [ ] T022 Verify Finished Units tab displays all records after import
- [ ] T023 Test creating new recipe with yield types
- [ ] T024 Test editing existing recipe yield types
- [ ] T025 Verify batch calculation still works with FinishedUnit data

### Implementation Notes
- Workflow: backup ‚Üí transform ‚Üí reset DB ‚Üí import
- Verify record counts match before/after
- Test all CRUD operations on yield types
- Ensure planning batch calculation uses FinishedUnit.items_per_batch

### Parallel Opportunities
- T023-T025 can run in parallel after T021-T22 complete

### Dependencies
- Depends on WP02 (transformation script)
- Depends on WP04 (import service)
- Depends on WP05 (UI updates)

### Risks & Mitigations
- Data loss ‚Üí Always backup before transformation
- Incomplete migration ‚Üí Validate 100% of recipes have FinishedUnits

---

## Dependency & Execution Summary

```
WP01 (Foundation) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚ñ∫ WP03 (Export) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                        ‚îÇ                          ‚îÇ
WP02 (Transform) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚ñ∫ WP04 (Import) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚ñ∫ WP06 (Integration)
                        ‚îÇ                          ‚îÇ
                        ‚îî‚îÄ‚îÄ‚îÄ‚ñ∫ WP05 (UI) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

- **Sequence**: WP01 ‚Üí WP03/WP04 ‚Üí WP05 ‚Üí WP06
- **Parallelization**: WP02 can run independently; WP03/WP04 can run in parallel after WP01
- **MVP Scope**: WP01 + WP02 + WP04 + WP05 = Minimum for functional yield management

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Make Recipe yield fields nullable | WP01 | P0 | No |
| T002 | Add item_unit validation to FinishedUnit | WP01 | P0 | Yes |
| T003 | Add validate_recipe_has_finished_unit() | WP01 | P0 | No |
| T004 | Add tests for recipe validation | WP01 | P0 | Yes |
| T005 | Create transform_yield_data.py | WP02 | P0 | No |
| T006 | Implement slug generation | WP02 | P0 | No |
| T007 | Transform sample_data_min.json | WP02 | P0 | Yes |
| T008 | Transform sample_data_all.json | WP02 | P0 | Yes |
| T009 | Add _export_finished_units() | WP03 | P1 | No |
| T010 | Add finished_units to DEPENDENCY_ORDER | WP03 | P1 | No |
| T011 | Add tests for FinishedUnit export | WP03 | P1 | Yes |
| T012 | Add finished_units to VALID_ENTITIES | WP04 | P1 | No |
| T013 | Add _import_finished_units_impl() | WP04 | P1 | No |
| T014 | Add legacy recipe yield handling | WP04 | P1 | No |
| T015 | Add tests for import and legacy handling | WP04 | P1 | Yes |
| T016 | Add item_unit to YieldTypeRow | WP05 | P1 | No |
| T017 | Remove legacy yield fields from form | WP05 | P1 | No |
| T018 | Add validation for complete yield type | WP05 | P1 | No |
| T019 | Disable Remove button for last row | WP05 | P1 | No |
| T020 | Verify Finished Units tab displays | WP05 | P1 | Yes |
| T021 | Run full export/transform/import | WP06 | P2 | No |
| T022 | Verify Finished Units tab after import | WP06 | P2 | No |
| T023 | Test creating new recipe | WP06 | P2 | Yes |
| T024 | Test editing existing recipe | WP06 | P2 | Yes |
| T025 | Verify batch calculation | WP06 | P2 | Yes |
