# Work Packages: Event-Centric Production Model

**Inputs**: Design documents from `/kitty-specs/016-event-centric-production/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, contracts/, quickstart.md

**Tests**: Testing work is required per Constitution Principle IV (TDD) with >70% service layer coverage.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/planned/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Model Layer - Schema Changes (Priority: P0)

**Goal**: Add all schema changes for event-centric production: new models, FK additions, and relationships.
**Independent Test**: Models can be imported without error; database creates successfully with new tables.
**Prompt**: `tasks/planned/WP01-model-layer-schema-changes.md`

### Included Subtasks
- [X] T001 Add `FulfillmentStatus` enum to `src/models/event.py`
- [X] T002 [P] Add `EventProductionTarget` model to `src/models/event.py` with unique constraint on (event_id, recipe_id)
- [X] T003 [P] Add `EventAssemblyTarget` model to `src/models/event.py` with unique constraint on (event_id, finished_good_id)
- [X] T004 Add `event_id` FK column to `src/models/production_run.py` (nullable, RESTRICT on delete)
- [X] T005 [P] Add `event_id` FK column to `src/models/assembly_run.py` (nullable, RESTRICT on delete)
- [X] T006 Add `fulfillment_status` column to `EventRecipientPackage` in `src/models/event.py`
- [X] T007 Add relationships to `Event` model: `production_runs`, `assembly_runs`, `production_targets`, `assembly_targets`
- [X] T008 Update `src/models/__init__.py` to export new classes: `FulfillmentStatus`, `EventProductionTarget`, `EventAssemblyTarget`
- [X] T009 Update `to_dict()` methods in ProductionRun and AssemblyRun to include event_id/event_name

### Implementation Notes
1. Add FulfillmentStatus enum first (T001) as EventRecipientPackage depends on it
2. New target models (T002, T003) can be created in parallel
3. FK additions (T004, T005) can be done in parallel
4. Add relationships to Event (T007) after FK columns exist
5. Export updates (T008) last to avoid import errors

### Parallel Opportunities
- T002 and T003 can proceed in parallel (separate models)
- T004 and T005 can proceed in parallel (different files)

### Dependencies
- None (base layer)

### Risks & Mitigations
- Circular imports: Event needs to import from ProductionRun/AssemblyRun for relationships. Use string references for forward declarations.
- Migration: Remember to export data before recreating database.

---

## Work Package WP02: Service Layer - Event ID Parameters (Priority: P0)

**Goal**: Update BatchProductionService and AssemblyService to accept and store event_id.
**Independent Test**: Record production/assembly with event_id; verify it persists correctly.
**Prompt**: `tasks/planned/WP02-service-layer-event-id-params.md`

### Included Subtasks
- [X] T010 Update `BatchProductionService.record_batch_production()` to accept optional `event_id` parameter
- [X] T011 Update `AssemblyService.record_assembly()` to accept optional `event_id` parameter
- [X] T012 Write unit tests for record_batch_production with event_id in `src/tests/services/test_batch_production_service.py`
- [X] T013 Write unit tests for record_assembly with event_id in `src/tests/services/test_assembly_service.py`

### Implementation Notes
1. Add `event_id: Optional[int] = None` as final parameter (backward compatible)
2. Validate event exists if event_id provided
3. Set `production_run.event_id = event_id` before session.add()
4. Tests: verify event_id persists, verify None works, verify invalid event_id raises error

### Parallel Opportunities
- T010 and T011 can proceed in parallel (different service files)
- T012 and T013 can proceed in parallel (different test files)

### Dependencies
- Depends on WP01 (models must exist)

### Risks & Mitigations
- Breaking existing callers: Adding as optional parameter with default None ensures backward compatibility.

---

## Work Package WP03: Service Layer - Target CRUD (Priority: P1) MVP

**Goal**: Implement EventService methods for creating, reading, updating, and deleting production/assembly targets.
**Independent Test**: Create targets via service; verify they persist with correct constraints.
**Prompt**: `tasks/planned/WP03-service-layer-target-crud.md`

### Included Subtasks
- [X] T014 Implement `EventService.set_production_target()` with create/update logic
- [X] T015 [P] Implement `EventService.set_assembly_target()` with create/update logic
- [X] T016 Implement `EventService.get_production_targets()` with eager loading
- [X] T017 [P] Implement `EventService.get_assembly_targets()` with eager loading
- [X] T018 Implement `EventService.delete_production_target()`
- [X] T019 [P] Implement `EventService.delete_assembly_target()`
- [X] T020 Write unit tests for target CRUD in `src/tests/services/test_event_service_targets.py`

### Implementation Notes
1. set_* methods use upsert pattern: query for existing, update if found, create if not
2. Validate target_batches/target_quantity > 0 before insert
3. Eager load recipe/finished_good relationships in get_* methods
4. delete_* returns True if deleted, False if not found
5. Tests: create, update existing, get all, get empty, delete existing, delete not found

### Parallel Opportunities
- Production and assembly methods can proceed in parallel (T014/T015, T016/T017, T018/T019)

### Dependencies
- Depends on WP01 (models)

### Risks & Mitigations
- Unique constraint violation: Handle gracefully in set_* methods by checking first.

---

## Work Package WP04: Service Layer - Progress Calculation (Priority: P1) MVP

**Goal**: Implement EventService methods for calculating production and assembly progress.
**Independent Test**: Set targets, record attributed production, verify progress percentages.
**Prompt**: `tasks/planned/WP04-service-layer-progress-calculation.md`

### Included Subtasks
- [X] T021 Implement `EventService.get_production_progress()` with aggregate query
- [X] T022 [P] Implement `EventService.get_assembly_progress()` with aggregate query
- [X] T023 Implement `EventService.get_event_overall_progress()` summary method
- [X] T024 Write unit tests for progress calculation in `src/tests/services/test_event_service_progress.py`

### Implementation Notes
1. Progress query: JOIN targets with runs, aggregate by recipe/finished_good
2. Only count runs where event_id matches the target's event
3. Calculate: produced / target * 100 (allow > 100 for over-production)
4. is_complete flag: True when produced >= target
5. Overall progress: count targets complete, count packages by status
6. Tests: 0%, 50%, 100%, 125% (over-production), no targets case

### Parallel Opportunities
- T021 and T022 can proceed in parallel (similar logic, different entities)

### Dependencies
- Depends on WP02 (event_id must be storable) and WP03 (targets must exist)

### Risks & Mitigations
- Performance: Use efficient aggregate queries, not N+1 pattern. Consider indexing.

---

## Work Package WP05: Service Layer - Fulfillment Status (Priority: P1)

**Goal**: Implement fulfillment status update and query methods with sequential workflow enforcement.
**Independent Test**: Update status pending→ready→delivered; verify invalid transitions rejected.
**Prompt**: `tasks/planned/WP05-service-layer-fulfillment-status.md`

### Included Subtasks
- [ ] T025 Implement `EventService.update_fulfillment_status()` with transition validation
- [ ] T026 Implement `EventService.get_packages_by_status()` with optional status filter
- [ ] T027 Write unit tests for fulfillment status in `src/tests/services/test_event_service_fulfillment.py`

### Implementation Notes
1. Valid transitions: pending→ready, ready→delivered
2. Raise ValueError on invalid transition with clear message
3. get_packages_by_status: return all if status=None, filter if provided
4. Eager load recipient and package relationships
5. Tests: valid transitions, invalid transitions (skip, reverse), filter by status

### Parallel Opportunities
- None (sequential logic)

### Dependencies
- Depends on WP01 (fulfillment_status column)

### Risks & Mitigations
- Data integrity: Enforce transitions in service layer, not just UI.

---

## Work Package WP06: Import/Export (Priority: P1)

**Goal**: Extend import/export to handle new entities and modified fields.
**Independent Test**: Export database, recreate, import; verify all event-production data preserved.
**Prompt**: `tasks/planned/WP06-import-export.md`

### Included Subtasks
- [ ] T028 Add `EventProductionTarget` to export in `src/services/import_export_service.py`
- [ ] T029 [P] Add `EventAssemblyTarget` to export in `src/services/import_export_service.py`
- [ ] T030 Add `event_name` field to ProductionRun export
- [ ] T031 [P] Add `event_name` field to AssemblyRun export
- [ ] T032 Add `fulfillment_status` field to EventRecipientPackage export
- [ ] T033 Implement import for new entities (resolve event_name to event_id)
- [ ] T034 Handle null event_name in import (standalone production)
- [ ] T035 Write import/export tests in `src/tests/integration/test_import_export_016.py`

### Implementation Notes
1. Export order: Targets after Events, Runs after Targets
2. Use event.name for event_name in export (resolve on import)
3. Handle null event_name → event_id = None
4. Import validation: ensure referenced events exist before importing targets/runs
5. Tests: round-trip with all entity types, null event handling

### Parallel Opportunities
- T028/T029 and T030/T031 can proceed in parallel

### Dependencies
- Depends on WP01-WP05 (all models and services)

### Risks & Mitigations
- Import order dependencies: Import events first, then targets, then runs.

---

## Work Package WP07: UI - Event Selectors (Priority: P2)

**Goal**: Add event selector dropdowns to Record Production and Record Assembly dialogs.
**Independent Test**: Open dialog, select event, confirm production; verify event_id saved.
**Prompt**: `tasks/planned/WP07-ui-event-selectors.md`

### Included Subtasks
- [ ] T036 Add event selector dropdown to `src/ui/forms/record_production_dialog.py`
- [ ] T037 [P] Add event selector dropdown to `src/ui/forms/record_assembly_dialog.py`
- [ ] T038 Implement event list loading sorted by event_date ascending
- [ ] T039 Pass selected event_id to service methods on confirm
- [ ] T040 Manual UI testing checklist

### Implementation Notes
1. Dropdown options: "(None - standalone)" + events sorted by event_date ascending
2. Event selector positioned below header, before batch/quantity inputs
3. Use CTkOptionMenu or CTkComboBox
4. Helper method: _get_selected_event_id() returns None or event.id
5. Pass event_id to record_batch_production() / record_assembly()

### Parallel Opportunities
- T036 and T037 can proceed in parallel (different dialog files)

### Dependencies
- Depends on WP02 (service methods accept event_id)

### Risks & Mitigations
- UI layout: Test on different screen sizes.

---

## Work Package WP08: UI - Targets Tab (Priority: P2) MVP

**Goal**: Add Targets tab to Event Detail window with production/assembly progress display.
**Independent Test**: Open event, view Targets tab, add target, see progress bar update.
**Prompt**: `tasks/planned/WP08-ui-targets-tab.md`

### Included Subtasks
- [ ] T041 Add "Targets" tab to `src/ui/event_detail_window.py` (after Assignments)
- [ ] T042 Create Production Targets section with scrollable list
- [ ] T043 [P] Create Assembly Targets section with scrollable list
- [ ] T044 Implement progress display: CTkProgressBar + text label (e.g., "2/4 (50%)")
- [ ] T045 Add "Add Production Target" dialog
- [ ] T046 [P] Add "Add Assembly Target" dialog
- [ ] T047 Implement edit/delete functionality for targets
- [ ] T048 Implement refresh to update progress after production
- [ ] T049 Manual UI testing checklist

### Implementation Notes
1. Insert Targets tab after Assignments (index 1)
2. Two sections: Production Targets, Assembly Targets
3. Each row: name, target, produced/assembled, progress bar, % text, complete checkmark
4. CTkProgressBar.set(value) takes 0.0-1.0; calculate as produced/target
5. Over-production (>100%): full bar, show "5/4 (125%)", checkmark
6. Add Target dialog: recipe/FG dropdown, target count entry, notes
7. Refresh on tab selection and after add/edit/delete

### Parallel Opportunities
- T042/T043 and T045/T046 can proceed in parallel

### Dependencies
- Depends on WP03 (target CRUD) and WP04 (progress calculation)

### Risks & Mitigations
- Performance: Lazy load progress on tab selection, not on window open.

---

## Work Package WP09: UI - Fulfillment Status (Priority: P2)

**Goal**: Add fulfillment status column to package assignments view with sequential workflow.
**Independent Test**: View assignments, change status pending→ready; verify persists and dropdown updates.
**Prompt**: `tasks/planned/WP09-ui-fulfillment-status.md`

### Included Subtasks
- [ ] T050 Add fulfillment status column to package assignments in `src/ui/event_detail_window.py`
- [ ] T051 Implement status dropdown with sequential transition enforcement
- [ ] T052 Style delivered status differently (green checkmark or disabled)
- [ ] T053 Manual UI testing checklist

### Implementation Notes
1. Status column between Quantity and Actions
2. Dropdown shows only valid next status based on current
3. pending → shows "Ready" option only
4. ready → shows "Delivered" option only
5. delivered → disabled dropdown or text-only
6. On change: call update_fulfillment_status(), refresh row

### Parallel Opportunities
- None (single file modifications)

### Dependencies
- Depends on WP05 (fulfillment service methods)

### Risks & Mitigations
- State sync: Refresh from database after update to ensure consistency.

---

## Work Package WP10: Documentation & Validation (Priority: P3)

**Goal**: Update documentation and verify all acceptance criteria met.
**Independent Test**: Run full test suite; verify all spec acceptance scenarios pass.
**Prompt**: `tasks/planned/WP10-documentation-validation.md`

### Included Subtasks
- [ ] T054 Update CLAUDE.md with event-centric model description
- [ ] T055 Update `docs/feature_roadmap.md` to mark Feature 016 complete
- [ ] T056 Perform export/import migration dry-run test
- [ ] T057 Verify all acceptance criteria from spec.md
- [ ] T058 Final manual testing walkthrough

### Implementation Notes
1. CLAUDE.md: Add to Key Design Decisions section about event-production linkage
2. Roadmap: Update Feature 016 status
3. Migration test: Export → delete DB → recreate → import → verify data
4. Acceptance: Walk through each user story scenario
5. Final test: Full workflow from target setup to fulfillment

### Parallel Opportunities
- T054 and T055 can proceed in parallel (documentation updates)

### Dependencies
- Depends on all previous work packages

### Risks & Mitigations
- Regression: Run full test suite before marking complete.

---

## Dependency & Execution Summary

```
WP01 (Model Layer)
  ↓
WP02 (Event ID Params) ────────┐
  ↓                            │
WP03 (Target CRUD) ─────────┐  │
  ↓                         │  │
WP04 (Progress Calc) ───────┼──┤
  ↓                         │  │
WP05 (Fulfillment Status) ──┼──┼───┐
  ↓                         │  │   │
WP06 (Import/Export) ───────┘  │   │
                               │   │
WP07 (UI Event Selectors) ←────┘   │
  ↓                                │
WP08 (UI Targets Tab) ─────────────┤
  ↓                                │
WP09 (UI Fulfillment) ←────────────┘
  ↓
WP10 (Docs & Validation)
```

- **Sequence**: WP01 → WP02 → WP03 → WP04 → WP05 → WP06 → WP07 → WP08 → WP09 → WP10
- **Parallelization**: WP02-WP05 can partially overlap once WP01 complete. WP07 can start after WP02.
- **MVP Scope**: WP01 + WP02 + WP03 + WP04 + WP08 (core progress tracking)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | FulfillmentStatus enum | WP01 | P0 | No |
| T002 | EventProductionTarget model | WP01 | P0 | Yes |
| T003 | EventAssemblyTarget model | WP01 | P0 | Yes |
| T004 | ProductionRun event_id FK | WP01 | P0 | No |
| T005 | AssemblyRun event_id FK | WP01 | P0 | Yes |
| T006 | fulfillment_status column | WP01 | P0 | No |
| T007 | Event relationships | WP01 | P0 | No |
| T008 | __init__.py exports | WP01 | P0 | No |
| T009 | to_dict() updates | WP01 | P0 | No |
| T010 | record_batch_production event_id | WP02 | P0 | No |
| T011 | record_assembly event_id | WP02 | P0 | Yes |
| T012 | BatchProductionService tests | WP02 | P0 | Yes |
| T013 | AssemblyService tests | WP02 | P0 | Yes |
| T014 | set_production_target | WP03 | P1 | No |
| T015 | set_assembly_target | WP03 | P1 | Yes |
| T016 | get_production_targets | WP03 | P1 | No |
| T017 | get_assembly_targets | WP03 | P1 | Yes |
| T018 | delete_production_target | WP03 | P1 | No |
| T019 | delete_assembly_target | WP03 | P1 | Yes |
| T020 | Target CRUD tests | WP03 | P1 | No |
| T021 | get_production_progress | WP04 | P1 | No |
| T022 | get_assembly_progress | WP04 | P1 | Yes |
| T023 | get_event_overall_progress | WP04 | P1 | No |
| T024 | Progress calculation tests | WP04 | P1 | No |
| T025 | update_fulfillment_status | WP05 | P1 | No |
| T026 | get_packages_by_status | WP05 | P1 | No |
| T027 | Fulfillment status tests | WP05 | P1 | No |
| T028 | Export EventProductionTarget | WP06 | P1 | No |
| T029 | Export EventAssemblyTarget | WP06 | P1 | Yes |
| T030 | Export ProductionRun event_name | WP06 | P1 | No |
| T031 | Export AssemblyRun event_name | WP06 | P1 | Yes |
| T032 | Export ERP fulfillment_status | WP06 | P1 | No |
| T033 | Import new entities | WP06 | P1 | No |
| T034 | Import null event handling | WP06 | P1 | No |
| T035 | Import/export tests | WP06 | P1 | No |
| T036 | Production dialog event selector | WP07 | P2 | No |
| T037 | Assembly dialog event selector | WP07 | P2 | Yes |
| T038 | Event list loading | WP07 | P2 | No |
| T039 | Pass event_id on confirm | WP07 | P2 | No |
| T040 | UI event selector testing | WP07 | P2 | No |
| T041 | Add Targets tab | WP08 | P2 | No |
| T042 | Production targets section | WP08 | P2 | No |
| T043 | Assembly targets section | WP08 | P2 | Yes |
| T044 | Progress display implementation | WP08 | P2 | No |
| T045 | Add Production Target dialog | WP08 | P2 | No |
| T046 | Add Assembly Target dialog | WP08 | P2 | Yes |
| T047 | Edit/delete targets | WP08 | P2 | No |
| T048 | Refresh on production | WP08 | P2 | No |
| T049 | UI targets tab testing | WP08 | P2 | No |
| T050 | Fulfillment status column | WP09 | P2 | No |
| T051 | Status dropdown | WP09 | P2 | No |
| T052 | Delivered status styling | WP09 | P2 | No |
| T053 | UI fulfillment testing | WP09 | P2 | No |
| T054 | Update CLAUDE.md | WP10 | P3 | No |
| T055 | Update roadmap | WP10 | P3 | Yes |
| T056 | Migration dry-run | WP10 | P3 | No |
| T057 | Acceptance criteria verification | WP10 | P3 | No |
| T058 | Final testing walkthrough | WP10 | P3 | No |
