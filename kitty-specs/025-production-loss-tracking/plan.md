# Implementation Plan: Production Loss Tracking

**Branch**: `025-production-loss-tracking` | **Date**: 2025-12-21 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/kitty-specs/025-production-loss-tracking/spec.md`

## Summary

Add explicit production loss tracking that enforces complete accounting for every planned unit (produced or lost), categorizes loss reasons for trend analysis, and calculates waste costs for financial reporting. Uses a hybrid schema approach with status fields on ProductionRun and detailed loss records in a new ProductionLoss entity.

**Adjusted Scope**: User Stories 1-5 (P1/P2) in scope. User Stories 6-7 (P3 reporting) deferred to dedicated reporting feature.

## Technical Context

**Language/Version**: Python 3.10+ (type hints, Enum support)
**Primary Dependencies**: CustomTkinter (UI), SQLAlchemy 2.x (ORM)
**Storage**: SQLite with WAL mode
**Testing**: pytest with >70% service layer coverage
**Target Platform**: Desktop (Windows, macOS)
**Project Type**: Single desktop application
**Performance Goals**: N/A for desktop single-user
**Constraints**: Must follow session management pattern (pass session to inner calls)
**Scale/Scope**: Single user, ~100 production runs per season

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. User-Centric Design | PASS | Loss recording adds <30s to workflow; auto-calculation reduces mental math |
| II. Data Integrity & FIFO | PASS | Enforces actual_yield + loss_quantity = expected_yield constraint |
| III. Future-Proof Schema | PASS | ProductionLoss table supports future analytics without schema change |
| IV. Test-Driven Development | PASS | Plan includes unit tests for all service methods |
| V. Layered Architecture | PASS | Business logic in services, UI in forms |
| VI. Schema Change Strategy | PASS | Uses export/reset/import cycle per desktop phase |
| VII. Pragmatic Aspiration | PASS | Desktop-focused, web migration cost is low (services already stateless) |

## Project Structure

### Documentation (this feature)

```
kitty-specs/025-production-loss-tracking/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 output - decisions and rationale
├── data-model.md        # Phase 1 output - schema design
├── research/            # Audit trail
│   ├── evidence-log.csv
│   └── source-register.csv
└── tasks.md             # Phase 2 output (generated by /spec-kitty.tasks)
```

### Source Code (repository root)

```
src/
├── models/
│   ├── production_run.py      # Enhanced with status, loss_quantity
│   ├── production_loss.py     # NEW - detailed loss records
│   └── enums.py               # NEW or enhanced - ProductionStatus, LossCategory
├── services/
│   └── batch_production_service.py  # Enhanced with loss recording
└── ui/
    └── forms/
        └── record_production_dialog.py  # Enhanced with loss section

src/tests/
└── services/
    └── test_batch_production_service.py  # Enhanced with loss tests
```

**Structure Decision**: Single desktop application following existing project layout.

## Complexity Tracking

*No constitution violations - no entries needed.*

## Implementation Phases

### Phase 1: Models & Enums

1. **Create enums** (`src/models/enums.py` or within production modules):
   - `ProductionStatus`: COMPLETE, PARTIAL_LOSS, TOTAL_LOSS
   - `LossCategory`: BURNT, BROKEN, CONTAMINATED, DROPPED, WRONG_INGREDIENTS, OTHER

2. **Enhance ProductionRun** (`src/models/production_run.py`):
   - Add `production_status` column (String, default "complete")
   - Add `loss_quantity` column (Integer, default 0)
   - Add constraints: `loss_quantity >= 0`
   - Add index on `production_status`
   - Add `losses` relationship backref

3. **Create ProductionLoss** (`src/models/production_loss.py`):
   - Full entity per data-model.md
   - Relationships to ProductionRun and FinishedUnit
   - Constraints and indexes per spec

4. **Update models/__init__.py**: Export new model and enums

### Phase 2: Service Layer

1. **Enhance record_batch_production()**:
   - Add parameters: `loss_category`, `loss_notes`
   - Add validation: `actual_yield <= expected_yield`
   - Calculate `loss_quantity = expected_yield - actual_yield`
   - Determine `production_status` from loss_quantity
   - Create ProductionLoss record when loss_quantity > 0
   - Return loss data in result dict

2. **Update get_production_history()**:
   - Include `production_status` and `loss_quantity` in response
   - Optionally eager-load losses relationship

3. **Update export/import functions**:
   - Add new fields to export schema (v1.1)
   - Handle import of loss records
   - Transform v1.0 imports to add default status/loss fields

### Phase 3: UI - RecordProductionDialog

1. **Add loss detection**:
   - Compare actual_yield with expected_yield on entry change
   - Show calculated loss_quantity (read-only)

2. **Add expandable loss details section**:
   - Collapsed by default
   - Auto-expands when loss_quantity > 0
   - Contains: loss category dropdown, notes textbox

3. **Add cost breakdown display**:
   - Show "Good units (N): $X.XX"
   - Show "Lost units (N): $X.XX" when applicable
   - Update in real-time as actual_yield changes

4. **Update validation**:
   - Prevent actual_yield > expected_yield
   - Require loss acknowledgment for losses

5. **Update confirmation dialog**:
   - Include loss information in summary

### Phase 4: UI - Production History

1. **Add loss columns to production history table**:
   - "Loss" column showing loss_quantity (or "-" for 0)
   - "Status" column with visual indicator (color/icon)

2. **Add status-based styling**:
   - Complete: default/green indicator
   - Partial Loss: yellow/warning indicator
   - Total Loss: red/error indicator

### Phase 5: Testing

1. **Unit tests for enhanced record_batch_production()**:
   - Test complete production (no loss)
   - Test partial loss
   - Test total loss
   - Test validation: actual > expected rejected
   - Test loss record creation with category
   - Test loss record creation with notes
   - Test cost calculations

2. **Unit tests for ProductionLoss model**:
   - Test creation and relationships
   - Test constraints

3. **Integration tests**:
   - Test full production flow with losses
   - Test export/import with loss data

### Phase 6: Data Migration

1. **Update export function**: Include new fields
2. **Create migration transform script**: Add default values to existing data
3. **Test export/transform/import cycle**
4. **Document migration procedure**

## Dependencies

- **Feature 013**: Production & Inventory Tracking - foundational (complete)
- **Feature 014**: Production UI - RecordProductionDialog foundation (complete)
- **Feature 016**: Event-Centric Production Model - event linkage (complete)

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Session detachment in nested calls | Follow session passing pattern per CLAUDE.md |
| Import breaks on v1.0 data | Version-aware import with transform |
| UI complexity increases | Expandable section keeps clean default |

## Success Criteria

From spec - verify each on completion:

- [ ] SC-001: Loss recording adds <30s to workflow
- [ ] SC-002: 100% of production runs have complete accounting
- [ ] SC-003: (Deferred) Loss category visibility - reporting feature
- [ ] SC-004: (Deferred) Recipe loss rates - reporting feature
- [ ] SC-005: Event shortfalls visible in existing dashboard (production_status visible)
- [ ] SC-006: (Deferred) Season loss queries - reporting feature

## Files to Modify

| File | Action | Description |
|------|--------|-------------|
| `src/models/enums.py` | Create/Enhance | ProductionStatus, LossCategory enums |
| `src/models/production_run.py` | Modify | Add status, loss_quantity, relationship |
| `src/models/production_loss.py` | Create | New entity |
| `src/models/__init__.py` | Modify | Export new model and enums |
| `src/services/batch_production_service.py` | Modify | Loss recording logic |
| `src/ui/forms/record_production_dialog.py` | Modify | Loss input section, cost display |
| `src/ui/production_dashboard_tab.py` | Modify | History table columns |
| `src/tests/services/test_batch_production_service.py` | Modify | Loss test cases |

## Next Steps

Run `/spec-kitty.tasks` to generate atomic task prompts from this plan.
