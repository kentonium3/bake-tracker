# Work Packages: Import/Export UI Rationalization

**Feature**: 051-import-export-ui-rationalization
**Inputs**: Design documents from `kitty-specs/051-import-export-ui-rationalization/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: Include unit tests for new services only (schema_validation_service, preferences_service).

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Precise file paths included.

---

## Work Package WP01: Schema Validation Service (Priority: P0)

**Goal**: Create reusable JSON schema validation service for import operations.
**User Story**: US4 - Pre-Import Schema Validation
**Independent Test**: Unit tests pass for all entity validators; malformed JSON returns structured errors.
**Prompt**: `tasks/WP01-schema-validation-service.md`

### Included Subtasks
- [ ] T001 [P] Create `src/services/schema_validation_service.py` with ValidationResult, ValidationError, ValidationWarning dataclasses
- [ ] T002 [P] Implement `validate_supplier_schema()` - required: name; optional: slug, contact_info, notes
- [ ] T003 [P] Implement `validate_ingredient_schema()` - required: display_name; optional: category, package_unit, etc.
- [ ] T004 [P] Implement `validate_product_schema()` - required: display_name, ingredient_slug; FK validation
- [ ] T005 [P] Implement `validate_recipe_schema()` - required: name; validate nested ingredients array
- [ ] T006 Implement `validate_import_file()` dispatcher that routes to entity-specific validators
- [ ] T007 [P] Create `src/tests/test_schema_validation_service.py` with test cases for each validator

### Implementation Notes
- Each validator returns `ValidationResult(valid=bool, errors=[], warnings=[])`
- Errors include: field path (e.g., `ingredients[0].display_name`), message, record_number, expected, actual
- Warnings for unexpected fields (import proceeds)
- Follow existing service patterns in `src/services/`

### Parallel Opportunities
- T001-T005 can proceed in parallel (different functions)
- T007 can proceed once any validator exists

### Dependencies
- None (foundational service)

### Risks & Mitigations
- Risk: Inconsistent validation rules across entities ‚Üí Review existing import logic for field requirements

---

## Work Package WP02: Preferences Service (Priority: P0)

**Goal**: Create service for managing directory preferences in app_config table.
**User Story**: US6 - Configurable Directories (foundation)
**Independent Test**: Unit tests pass; preferences round-trip through get/set/reset operations.
**Prompt**: `tasks/WP02-preferences-service.md`

### Included Subtasks
- [ ] T008 [P] Create `src/services/preferences_service.py` with get/set/reset functions
- [ ] T009 Implement `get_import_directory()`, `set_import_directory()`
- [ ] T010 [P] Implement `get_export_directory()`, `set_export_directory()`
- [ ] T011 [P] Implement `get_logs_directory()`, `set_logs_directory()`
- [ ] T012 Implement `reset_all_preferences()` to restore system defaults
- [ ] T013 Implement directory existence validation with graceful fallback
- [ ] T014 [P] Create `src/tests/test_preferences_service.py`

### Implementation Notes
- Use existing `app_config` table with key-value pattern
- Keys: `import_directory`, `export_directory`, `logs_directory`
- System defaults: `~/Documents` for import/export, `<project>/docs/user_testing` for logs
- Handle missing/invalid directories gracefully (return default with warning log)

### Parallel Opportunities
- T009-T011 can proceed in parallel (different preference types)
- T014 can proceed once core functions exist

### Dependencies
- None (foundational service)

### Risks & Mitigations
- Risk: Permission errors on directories ‚Üí Validate write access; fall back gracefully

---

## Work Package WP03: Preferences Dialog (Priority: P1)

**Goal**: Create UI dialog for configuring directory preferences.
**User Story**: US6 - Configurable Directories (completion)
**Independent Test**: Dialog opens from File menu; preferences persist after app restart.
**Prompt**: `tasks/WP03-preferences-dialog.md`

### Included Subtasks
- [ ] T015 Create `src/ui/preferences_dialog.py` with CustomTkinter dialog
- [ ] T016 Add directory picker for Import directory with Browse button
- [ ] T017 [P] Add directory picker for Export directory
- [ ] T018 [P] Add directory picker for Logs directory
- [ ] T019 Add "Restore Defaults" button that calls `reset_all_preferences()`
- [ ] T020 Add Save/Cancel buttons with validation
- [ ] T021 Update main menu to add "Preferences..." item under File

### Implementation Notes
- Follow existing dialog patterns (ImportDialog, ExportDialog)
- Use `filedialog.askdirectory()` for directory pickers
- Validate directories exist before saving; show warning if not
- Modal behavior with transient/grab_set

### Parallel Opportunities
- T016-T018 can proceed in parallel (different fields)

### Dependencies
- Depends on WP02 (preferences_service)

### Risks & Mitigations
- Risk: Main window file not obvious ‚Üí Check `main_window.py` or menu setup location

---

## Work Package WP04: Enhanced Import Logging (Priority: P1)

**Goal**: Upgrade import logging with comprehensive structured sections.
**User Story**: US5 - Comprehensive Import Logging
**Independent Test**: Import operation produces log file with all required sections.
**Prompt**: `tasks/WP04-enhanced-import-logging.md`

### Included Subtasks
- [ ] T022 Refactor `_write_import_log()` in `src/ui/import_export_dialog.py` to use configurable logs directory
- [ ] T023 Add SOURCE section with file path, size, detected format
- [ ] T024 [P] Add OPERATION section with purpose, mode, timestamp
- [ ] T025 [P] Add PREPROCESSING section (for Context-Rich: entity type, records extracted, FK validations)
- [ ] T026 [P] Add SCHEMA VALIDATION section with status, error count, warning details
- [ ] T027 [P] Add IMPORT RESULTS section with per-entity counts
- [ ] T028 [P] Add ERRORS section with entity name, record snippet, expected vs actual, resolution suggestion
- [ ] T029 [P] Add WARNINGS section with context and action taken
- [ ] T030 Add SUMMARY section with total/successful/skipped/failed counts
- [ ] T031 Add METADATA section with app version, log version, duration

### Implementation Notes
- Plain text format with header separators (e.g., `--- SECTION NAME ---`)
- Use `preferences_service.get_logs_directory()` for log location
- Build log content incrementally, write once at end
- Include resolution suggestions from ImportResult error entries

### Parallel Opportunities
- T023-T029 can proceed in parallel (different sections)

### Dependencies
- Depends on WP02 (preferences_service for log directory)

### Risks & Mitigations
- Risk: Log file write failure ‚Üí Handle permission errors; report to user

---

## Work Package WP05: Supplier Export (Priority: P1)

**Goal**: Add supplier export capability to Export Data dialog.
**User Story**: US2 - Supplier Import/Export (part 1)
**Independent Test**: Export with Suppliers checkbox produces JSON file with supplier data including slug field.
**Prompt**: `tasks/WP05-supplier-export.md`

### Included Subtasks
- [ ] T032 Add `export_suppliers()` function to `src/services/import_export_service.py`
- [ ] T033 Include `slug` field in supplier export per F050 format
- [ ] T034 Update `export_all_to_json()` to include suppliers when selected
- [ ] T035 Add "Suppliers" checkbox to ExportDialog Catalog tab (alphabetically positioned)
- [ ] T036 Wire checkbox to `entity_vars['suppliers']` and export logic

### Implementation Notes
- Follow existing export patterns (export_ingredients_to_json, etc.)
- Supplier JSON format: `{"suppliers": [{"name": "...", "slug": "...", "contact_info": "...", "notes": "..."}]}`
- Position checkbox alphabetically among: Ingredients, Materials, Material Products, Products, Recipes, Suppliers

### Parallel Opportunities
- T032-T033 service work can proceed parallel to T035-T036 UI work

### Dependencies
- None (independent)

### Risks & Mitigations
- Risk: Slug field missing from model ‚Üí Verify Supplier model has slug from F050

---

## Work Package WP06: Supplier Import (Priority: P1)

**Goal**: Add supplier import capability to Import Data dialog.
**User Story**: US2 - Supplier Import/Export (part 2)
**Independent Test**: Import suppliers.json through Catalog purpose; verify suppliers created with correct slugs.
**Prompt**: `tasks/WP06-supplier-import.md`

### Included Subtasks
- [ ] T037 Add `suppliers` to `VALID_ENTITIES` in `src/services/catalog_import_service.py`
- [ ] T038 Add `import_suppliers()` function following existing patterns
- [ ] T039 Update import dependency order: suppliers before products
- [ ] T040 Update `detect_format()` in `src/services/enhanced_import_service.py` to recognize supplier files
- [ ] T041 Update detection result display to show supplier record count
- [ ] T042 Validate supplier slug uniqueness during import

### Implementation Notes
- Suppliers must import before products (FK dependency)
- Follow existing import_ingredients(), import_products() patterns
- Generate slug if not provided (using `generate_supplier_slug()`)
- Skip existing suppliers in "Add Only" mode; update in "Augment" mode

### Parallel Opportunities
- T037-T039 service work can proceed parallel to T040-T041 detection work

### Dependencies
- Depends on WP05 (for testing round-trip)

### Risks & Mitigations
- Risk: Duplicate slug conflicts ‚Üí Validate and report clear error

---

## Work Package WP07: Unified Import Dialog with Context-Rich Purpose (Priority: P1) üéØ MVP

**Goal**: Add Context-Rich as 5th purpose type and integrate schema validation.
**User Stories**: US1 - Unified Import Workflow, US3 - Context-Rich Import Purpose, US4 completion
**Independent Test**: Import aug_*.json file; auto-detects as Context-Rich; preprocesses and imports successfully.
**Prompt**: `tasks/WP07-unified-import-dialog.md`

### Included Subtasks
- [ ] T043 Add "Context-Rich" radio button as 5th purpose option in ImportDialog
- [ ] T044 Add description text: "Import AI-augmented files (aug_*.json) with preprocessing"
- [ ] T045 Update `_setup_catalog_options()` to also apply to Context-Rich (mode selection)
- [ ] T046 Update `_detect_format()` to auto-select Context-Rich for aug_*.json files
- [ ] T047 Update `_do_import()` to route Context-Rich to appropriate handler
- [ ] T048 Integrate schema_validation_service before import execution
- [ ] T049 Display validation errors with record numbers in error dialog
- [ ] T050 Update `ImportResultsDialog` to show per-entity counts in modal summary
- [ ] T051 Ensure mode selection appears for both Catalog and Context-Rich purposes

### Implementation Notes
- Context-Rich preprocessing already exists in `enhanced_import_service.import_context_rich_view()`
- Schema validation runs after preprocessing for Context-Rich
- Error dialog must show actionable information (which records, what's wrong, suggestion)
- Modal summary: use existing ImportResultsDialog but ensure entity_counts displayed

### Parallel Opportunities
- T043-T046 UI changes can proceed parallel to T048-T049 validation integration

### Dependencies
- Depends on WP01 (schema_validation_service)
- Depends on WP04 (enhanced logging)

### Risks & Mitigations
- Risk: Regression in existing purposes ‚Üí Test all 5 purposes after changes

---

## Work Package WP08: Menu Cleanup and Multi-Entity Support (Priority: P2)

**Goal**: Remove redundant menu items and ensure multi-entity import works correctly.
**User Stories**: US1 completion, US7 - Multi-Entity Catalog Import
**Independent Test**: File menu shows only "Import Data"; multi-entity file imports all entities in dependency order.
**Prompt**: `tasks/WP08-menu-cleanup-multi-entity.md`

### Included Subtasks
- [ ] T052 Remove "Import Catalog" menu item from File menu
- [ ] T053 Remove "Import Context-Rich" menu item from File menu
- [ ] T054 Remove associated handler code if orphaned
- [ ] T055 Update detection display for multi-entity files (e.g., "Multiple entities: Suppliers (6), Ingredients (45)")
- [ ] T056 Ensure multi-entity import respects dependency order (suppliers ‚Üí ingredients ‚Üí products ‚Üí ...)
- [ ] T057 Hide entity checkboxes for Catalog purpose (rely on auto-detection per FR-009)
- [ ] T058 Verify all existing import workflows still function (regression check)

### Implementation Notes
- Find menu setup in main_window.py or similar
- ImportViewDialog may also need removal if fully superseded
- Multi-entity display: parse detected entities and format with counts
- Dependency order defined in catalog_import_service

### Parallel Opportunities
- T052-T054 menu cleanup parallel to T055-T057 multi-entity work

### Dependencies
- Depends on WP07 (unified dialog complete)

### Risks & Mitigations
- Risk: Breaking change to menu structure ‚Üí Test File menu after changes

---

## Dependency & Execution Summary

```
Phase 0 (Foundational - Independent):
  WP01: Schema Validation Service ‚îÄ‚îÄ‚îê
  WP02: Preferences Service ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚Üí Can start immediately in parallel
  WP05: Supplier Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Phase 1 (Dependent Services):
  WP03: Preferences Dialog ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí After WP02
  WP04: Enhanced Import Logging ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí After WP02
  WP06: Supplier Import ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí After WP05

Phase 2 (Integration):
  WP07: Unified Import Dialog ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí After WP01, WP04 (MVP)

Phase 3 (Cleanup):
  WP08: Menu Cleanup & Multi-Entity ‚Üí After WP07
```

**Parallelization Highlights**:
- WP01, WP02, WP05 can all start simultaneously
- WP03, WP04, WP06 can proceed once their single dependency completes
- WP07 requires WP01 + WP04 complete

**MVP Scope**: WP01 ‚Üí WP02 ‚Üí WP04 ‚Üí WP07 delivers unified import with validation. Other work packages enhance the experience but aren't blocking.

---

## Subtask Index (Reference)

| Subtask | Summary | Work Package | Priority | Parallel? |
|---------|---------|--------------|----------|-----------|
| T001 | Create schema_validation_service.py base | WP01 | P0 | Yes |
| T002 | validate_supplier_schema() | WP01 | P0 | Yes |
| T003 | validate_ingredient_schema() | WP01 | P0 | Yes |
| T004 | validate_product_schema() | WP01 | P0 | Yes |
| T005 | validate_recipe_schema() | WP01 | P0 | Yes |
| T006 | validate_import_file() dispatcher | WP01 | P0 | No |
| T007 | test_schema_validation_service.py | WP01 | P0 | Yes |
| T008 | Create preferences_service.py | WP02 | P0 | Yes |
| T009 | get/set_import_directory() | WP02 | P0 | No |
| T010 | get/set_export_directory() | WP02 | P0 | Yes |
| T011 | get/set_logs_directory() | WP02 | P0 | Yes |
| T012 | reset_all_preferences() | WP02 | P0 | No |
| T013 | Directory validation with fallback | WP02 | P0 | No |
| T014 | test_preferences_service.py | WP02 | P0 | Yes |
| T015 | Create preferences_dialog.py | WP03 | P1 | No |
| T016 | Import directory picker | WP03 | P1 | No |
| T017 | Export directory picker | WP03 | P1 | Yes |
| T018 | Logs directory picker | WP03 | P1 | Yes |
| T019 | Restore Defaults button | WP03 | P1 | No |
| T020 | Save/Cancel with validation | WP03 | P1 | No |
| T021 | Add Preferences menu item | WP03 | P1 | No |
| T022 | Refactor _write_import_log() for config | WP04 | P1 | No |
| T023 | SOURCE log section | WP04 | P1 | No |
| T024 | OPERATION log section | WP04 | P1 | Yes |
| T025 | PREPROCESSING log section | WP04 | P1 | Yes |
| T026 | SCHEMA VALIDATION log section | WP04 | P1 | Yes |
| T027 | IMPORT RESULTS log section | WP04 | P1 | Yes |
| T028 | ERRORS log section | WP04 | P1 | Yes |
| T029 | WARNINGS log section | WP04 | P1 | Yes |
| T030 | SUMMARY log section | WP04 | P1 | No |
| T031 | METADATA log section | WP04 | P1 | No |
| T032 | export_suppliers() function | WP05 | P1 | No |
| T033 | Include slug in supplier export | WP05 | P1 | No |
| T034 | Update export_all_to_json() | WP05 | P1 | No |
| T035 | Suppliers checkbox in ExportDialog | WP05 | P1 | No |
| T036 | Wire checkbox to export logic | WP05 | P1 | No |
| T037 | Add suppliers to VALID_ENTITIES | WP06 | P1 | No |
| T038 | import_suppliers() function | WP06 | P1 | No |
| T039 | Update import dependency order | WP06 | P1 | No |
| T040 | detect_format() for suppliers | WP06 | P1 | No |
| T041 | Detection display for suppliers | WP06 | P1 | No |
| T042 | Supplier slug uniqueness validation | WP06 | P1 | No |
| T043 | Context-Rich radio button | WP07 | P1 | No |
| T044 | Context-Rich description text | WP07 | P1 | No |
| T045 | Mode selection for Context-Rich | WP07 | P1 | No |
| T046 | Auto-detect aug_*.json | WP07 | P1 | No |
| T047 | Route Context-Rich in _do_import() | WP07 | P1 | No |
| T048 | Integrate schema validation | WP07 | P1 | No |
| T049 | Validation error dialog | WP07 | P1 | No |
| T050 | Modal summary per-entity counts | WP07 | P1 | No |
| T051 | Mode selection for both purposes | WP07 | P1 | No |
| T052 | Remove Import Catalog menu item | WP08 | P2 | No |
| T053 | Remove Import Context-Rich menu | WP08 | P2 | No |
| T054 | Remove orphaned handler code | WP08 | P2 | No |
| T055 | Multi-entity detection display | WP08 | P2 | No |
| T056 | Multi-entity dependency order | WP08 | P2 | No |
| T057 | Hide entity checkboxes for Catalog | WP08 | P2 | No |
| T058 | Regression verification | WP08 | P2 | No |
