# Work Packages: Type-Ahead Search Component

**Inputs**: Design documents from `/kitty-specs/101-type-ahead-search-component/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, contracts/, quickstart.md

**Tests**: Tests included in integration WPs to validate callback wiring and end-to-end flow.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`.

---

## Work Package WP01: Core Widget - Entry, Debounce & Dropdown (Priority: P0)

**Goal**: Create the foundational `TypeAheadEntry` widget with text entry, debounce search, floating dropdown, result rendering, mouse selection, and basic dismissal.
**Independent Test**: Widget can be instantiated with mock callbacks; typing triggers debounce and displays results in dropdown; clicking a result fires selection callback.
**Prompt**: `tasks/WP01-core-widget-entry-debounce-dropdown.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [x] T001 Create TypeAheadEntry class skeleton in `src/ui/widgets/type_ahead_entry.py`
- [x] T002 Implement debounce search trigger with after/after_cancel pattern
- [x] T003 Create floating CTkToplevel dropdown with positioning
- [x] T004 Render search results in dropdown with no-match and truncation messages
- [x] T005 Implement mouse-click selection, clear_on_select, dismissal, and cleanup

### Implementation Notes
- Inherit from `ctk.CTkFrame` with `fg_color="transparent"` (matches TypeAheadComboBox pattern)
- CTkEntry with placeholder text as the user-facing input
- Debounce: `self.after()` / `self.after_cancel()` with configurable `debounce_ms` (default 300ms)
- Dropdown: `CTkToplevel` with `overrideredirect(True)` and `wm_attributes("-topmost", True)`
- Position dropdown using `winfo_rootx()` / `winfo_rooty()` + `winfo_height()`
- Result items: CTkLabel widgets with `<Button-1>` bindings inside the dropdown
- Dismissal: Escape key, `<FocusOut>`, `destroy()` override

### Parallel Opportunities
- None within this WP (sequential build-up of widget layers)

### Dependencies
- None (starting package)

### Risks & Mitigations
- CTkToplevel focus behavior on macOS may differ from Linux/Windows → test `overrideredirect` early
- Dropdown positioning when entry is near screen edge → basic positioning in WP01, edge clamping in WP02

---

## Work Package WP02: Keyboard Navigation & Edge Cases (Priority: P0)

**Goal**: Add full keyboard navigation (Up/Down/Enter) with visual highlighting, click-outside detection, screen edge clamping, and edge case hardening.
**Independent Test**: Can navigate dropdown using only keyboard; arrow keys stop at boundaries; Enter selects highlighted item; clicking outside closes dropdown; special characters in queries work correctly.
**Prompt**: `tasks/WP02-keyboard-navigation-edge-cases.md`
**Estimated Size**: ~450 lines

### Included Subtasks
- [x] T006 Implement Down Arrow key navigation with highlight index clamping
- [x] T007 Implement Up Arrow key navigation with highlight index clamping
- [ ] T008 Apply visual highlight styling on active dropdown item
- [ ] T009 Implement Enter key selection (no-op when no highlight)
- [ ] T010 Implement click-outside detection via root window binding
- [ ] T011 Handle screen edge clamping and multiple widget instances
- [ ] T012 Handle edge cases: special characters, rapid typing, exact match

### Implementation Notes
- Track `self._highlight_index` (int, -1 = nothing highlighted)
- Down Arrow: increment, clamp at `len(results) - 1`
- Up Arrow: decrement, clamp at 0 (or -1 to deselect first item)
- Visual highlight: change CTkLabel `fg_color` for highlighted item, reset others
- Click-outside: bind `<Button-1>` on root window, check if click coordinates are outside dropdown bounds
- Screen edge: clamp dropdown x/y using `winfo_screenwidth()` / `winfo_screenheight()`
- Multiple instances: each widget tracks its own `_dropdown`, `_highlight_index`, `_results`

### Parallel Opportunities
- T010 (click-outside) and T011 (screen edge) can be developed alongside T006-T009

### Dependencies
- Depends on WP01 (requires functional dropdown to add keyboard navigation)

### Risks & Mitigations
- Click-outside detection may interfere with dropdown item clicks → check event coordinates before dismissing
- Highlight visual state must reset when results change → clear highlight on new search

---

## Work Package WP03: Ingredient Selection Integration (Priority: P1) MVP

**Goal**: Integrate TypeAheadEntry into the recipe ingredient selection workflow, enabling fast ingredient search with ancestor breadcrumbs.
**Independent Test**: In recipe form, type partial ingredient name → see filtered results with category breadcrumbs → select ingredient → ingredient populates in recipe.
**Prompt**: `tasks/WP03-ingredient-selection-integration.md`
**Estimated Size**: ~400 lines

### Included Subtasks
- [ ] T013 Create ingredient search callback wrapper using ingredient_hierarchy_service
- [ ] T014 Add TypeAheadEntry widget to ingredient selection workflow in recipe form
- [ ] T015 Wire on_select_callback to populate ingredient data in recipe form
- [ ] T016 [P] Format dropdown display with ancestor breadcrumb info
- [ ] T017 [P] Write integration tests for ingredient type-ahead flow

### Implementation Notes
- Callback wrapper calls `ingredient_hierarchy_service.search_ingredients(query, limit=10)`
- Ancestor breadcrumbs: format as "Chocolate Chips (Baking > Chocolate)" using the `ancestors` field
- Integration point: `src/ui/forms/recipe_form.py` or `src/ui/dialogs/ingredient_selection_dialog.py`
- The TypeAheadEntry replaces or supplements the tree-based ingredient selection
- Tests in `src/tests/` verify callback wiring and form state updates

### Parallel Opportunities
- T016 (breadcrumb formatting) and T017 (tests) can proceed in parallel once T013-T015 are complete
- WP03 can be parallelized with WP04 (different files, different integration points)

### Dependencies
- Depends on WP02 (needs complete widget with keyboard navigation for P1 acceptance)

### Risks & Mitigations
- IngredientSelectionDialog modal may conflict with floating dropdown → test layering behavior
- Breadcrumb formatting must handle ingredients with no ancestors (root categories) gracefully

---

## Work Package WP04: Material Selection Integration (Priority: P2)

**Goal**: Integrate TypeAheadEntry into the finished good builder for material product selection, validating component reusability.
**Independent Test**: In FG builder material step, type partial material name → see filtered results → select material → material added to finished good.
**Prompt**: `tasks/WP04-material-selection-integration.md`
**Estimated Size**: ~300 lines

### Included Subtasks
- [ ] T018 Create material search callback wrapper for material_catalog_service
- [ ] T019 Add TypeAheadEntry to finished_good_builder material selection workflow
- [ ] T020 Wire on_select_callback to handle material selection in builder
- [ ] T021 Verify identical UX behavior between ingredient and material contexts

### Implementation Notes
- material_catalog_service has `list_products()` with filter params but no `search_*` function → create a thin search wrapper using ilike or client-side filtering
- Integration point: `src/ui/builders/finished_good_builder.py` (Step 2: Materials)
- Same widget configuration (min_chars=3, debounce_ms=300, max_results=10) to ensure UX consistency
- UX verification: keyboard shortcuts, visual design, debounce timing all identical per US3-AS2

### Parallel Opportunities
- WP04 can be parallelized with WP03 (different files, independent integration)

### Dependencies
- Depends on WP02 (needs complete widget)

### Risks & Mitigations
- material_catalog_service may need a new search function → thin wrapper in the UI callback is acceptable since the widget delegates search to the caller
- Material data structure may differ from ingredient dicts → use configurable `display_key` parameter

---

## Dependency & Execution Summary

- **Sequence**: WP01 → WP02 → WP03 + WP04 (parallel)
- **Parallelization**: WP03 and WP04 can be implemented concurrently after WP02 completes (different files, independent integration points)
- **MVP Scope**: WP01 + WP02 + WP03 = Minimum viable release (US1 + US2 complete). WP04 validates reusability (US3).

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Create TypeAheadEntry class skeleton | WP01 | P0 | No |
| T002 | Implement debounce search trigger | WP01 | P0 | No |
| T003 | Create floating CTkToplevel dropdown | WP01 | P0 | No |
| T004 | Render search results with messages | WP01 | P0 | No |
| T005 | Mouse-click selection and dismissal | WP01 | P0 | No |
| T006 | Down Arrow key navigation | WP02 | P0 | No |
| T007 | Up Arrow key navigation | WP02 | P0 | No |
| T008 | Visual highlight styling | WP02 | P0 | No |
| T009 | Enter key selection (no-op if no highlight) | WP02 | P0 | No |
| T010 | Click-outside detection | WP02 | P0 | Yes |
| T011 | Screen edge clamping + multiple instances | WP02 | P0 | Yes |
| T012 | Edge cases: special chars, rapid typing, exact match | WP02 | P0 | Yes |
| T013 | Ingredient search callback wrapper | WP03 | P1 | No |
| T014 | Add TypeAheadEntry to ingredient selection | WP03 | P1 | No |
| T015 | Wire ingredient selection callback | WP03 | P1 | No |
| T016 | Ancestor breadcrumb display formatting | WP03 | P1 | Yes |
| T017 | Integration tests for ingredient type-ahead | WP03 | P1 | Yes |
| T018 | Material search callback wrapper | WP04 | P2 | No |
| T019 | Add TypeAheadEntry to FG builder materials | WP04 | P2 | No |
| T020 | Wire material selection callback | WP04 | P2 | No |
| T021 | Verify identical UX across contexts | WP04 | P2 | No |
