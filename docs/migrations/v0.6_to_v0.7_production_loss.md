# Migration Guide: v0.6 to v0.7 (Production Loss Tracking)

This guide explains how to migrate your database to support the new production
loss tracking feature (Feature 025).

## Overview

Feature 025 adds the ability to track production losses - when you produce
fewer units than expected due to burning, breaking, contamination, etc.

The migration adds these fields to production runs:
- **production_status**: "complete", "partial_loss", or "total_loss"
- **loss_quantity**: Number of units lost
- **losses**: Detailed loss records with category, notes, and cost

All existing production runs will be marked as "complete" with zero losses,
since we don't have historical loss data.

## Prerequisites

Before starting the migration:

1. **Backup your database file**
   - Default location: `data/bake_tracker.db`
   - Copy this file to a safe location

2. **Have Python environment ready**
   - Ensure your virtual environment is activated
   - All project dependencies installed

## Migration Steps

### Step 1: Export Current Data

Export your production history to a JSON file.

**Option A: Via Application**
1. Open the Bake Tracker application
2. Go to Settings > Data Management > Export All
3. Save as `backup_before_loss_tracking.json`

**Option B: Via Python**
```python
from src.services.batch_production_service import export_production_history
import json

data = export_production_history()
with open("backup_before_loss_tracking.json", "w") as f:
    json.dump(data, f, indent=2)

print(f"Exported {len(data.get('production_runs', []))} production runs")
```

### Step 2: Transform Data to v1.1 Format

Run the migration transform script:

```bash
python scripts/migrate_v1_0_to_v1_1.py backup_before_loss_tracking.json migrated_data.json
```

Expected output:
```
Transformed X production runs from v1.0 to v1.1 format
Output written to: migrated_data.json
```

The script adds default loss tracking fields:
- `production_status`: "complete"
- `loss_quantity`: 0
- `losses`: []

### Step 3: Verify Transformed Data (Optional but Recommended)

Open `migrated_data.json` and verify:
- The `version` field is `"1.1"`
- Each production run has `production_status`, `loss_quantity`, and `losses` fields

### Step 4: Reset Database

**Important: Your backup from Step 1 is your safety net!**

1. Close the Bake Tracker application
2. Delete the database file:
   ```bash
   rm data/bake_tracker.db
   ```
3. Open the application to create a fresh database with the new schema
4. Close the application again

### Step 5: Import Transformed Data

**Option A: Via Application**
1. Open the Bake Tracker application
2. Go to Settings > Data Management > Import
3. Select `migrated_data.json`
4. Verify the import report shows no errors

**Option B: Via Python**
```python
from src.services.batch_production_service import import_production_history
import json

with open("migrated_data.json") as f:
    data = json.load(f)

result = import_production_history(data)
print(f"Imported: {result['imported']}")
print(f"Skipped: {result['skipped']}")
print(f"Errors: {result['errors']}")
```

## Verification Checklist

After import, verify your data:

- [ ] All recipes are present and correct
- [ ] All finished units are present
- [ ] All production runs are present
- [ ] Production history shows "Complete" status for all existing runs
- [ ] Loss column shows "-" for all existing runs (no losses)
- [ ] Application functions normally

## Rollback Procedure

If something goes wrong:

1. Close the application
2. Delete the database file:
   ```bash
   rm data/bake_tracker.db
   ```
3. Open the application (creates fresh schema)
4. Import your original backup:

**Option A: Via Application**
- Go to Settings > Data Management > Import
- Select `backup_before_loss_tracking.json`

**Option B: Via Python**
```python
from src.services.batch_production_service import import_production_history
import json

with open("backup_before_loss_tracking.json") as f:
    data = json.load(f)

result = import_production_history(data)
print(result)
```

Note: The v1.0 backup format is automatically handled by the import function,
which adds default loss fields during import.

## Troubleshooting

### "Recipe not found" errors during import
- Ensure you imported all recipes before production runs
- Check that recipe names match exactly

### "FinishedUnit not found" errors during import
- Ensure finished units exist before importing production runs
- Check that finished unit slugs match exactly

### Production runs missing after import
- Check the `errors` list in the import result
- Verify the JSON file is valid (no syntax errors)

### Application won't start after migration
- Delete the database file and start fresh
- Use the rollback procedure to restore your backup

## What's New After Migration

With the migration complete, you can now:

1. **Record production losses** - When actual yield is less than expected,
   the dialog expands to capture loss details

2. **Track loss categories** - Choose from: Burnt, Broken, Contaminated,
   Dropped, Wrong Ingredients, or Other

3. **Add loss notes** - Document what went wrong for future reference

4. **See loss history** - Production history shows Loss and Status columns
   with visual indicators

5. **Track loss costs** - Per-unit cost is captured at time of loss for
   accurate cost tracking
